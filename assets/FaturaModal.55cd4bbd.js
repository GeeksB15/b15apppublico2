import{_ as ka,r as Q,o as h,p as N,f as t,w as r,C as D,h as da,i as pa,k as M,t as q,d as T,cL as Ya,e as x,j as R,m as fa,Q as B,B as Sa,be as qa,H as ga,P as Ca,F as L,u as J,S as H,T as k,U,N as ba,l as La,z as ao,O as oo,E as to,bq as Va,D as Ia,v as eo,a as io,cN as no,cO as ro,cP as so,cQ as lo,M as ja,G as Ha,I as Ua,J as Qa,K as co,aU as uo}from"./index.f13aeeb6.js";import{D as mo,C as fo}from"./DocumentosFiscais.a3773ae7.js";import{e as po}from"./emitirNFe.35117289.js";import{V as vo}from"./VendaCard.d37280f0.js";import{E as ho}from"./EnvelopeCard.08d73dce.js";const Co={computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{titulo:{},tituloOriginal:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,campos:{valorMulta:0},rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(e){this.$router.push({name:"AtendimentoFatura",params:{id:e}})},async migrarFatura(e){try{await new Promise((o,u)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{o()}).onCancel(()=>{u()})})}catch{return}if(!e&&this.titulo.idContato&&this.titulo.idEmpresa){const o=await $erp().contato.get(this.titulo.idContato)||{};let u=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),C=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();u=u.find(_=>(_.grupo||"").trim().toLowerCase()==="Principal")||u[0]||{},C=C.find(_=>(_.tipoTelefone||"").trim().toLowerCase()==="Principal")||C[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let d=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();d=d.find(_=>_.grupo.trim().toLowerCase()==="Principal")||d[0]||{},e=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:d.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:o.id,idContatoEndereco:u.id||"",numeroDocumentoContato:o.numeroDocumentoNacional||"",descricaoContato:o.nome||"",descricaoContatoEndereco:"".concat(u.logradouro||"",", ",u.numero||""," ",u.complemento||""," - ",u.bairro||""," - ",u.cep||""," - ",u.municipio||"","/",u.uf||""),telefoneContato:C.telefone||"",emailContato:o.email||"",regimeContato:o.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:e})}e.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:e.id},original:this.titulo}),localStorage.setItem("idFatura",e.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(this.titulo.valorDesconto===this.tituloOriginal.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){const e=Number(this.titulo.diasEmAtraso)||0;let o=0;e>0&&(o=Number(this.titulo.valorMulta)||0),this.modalEditar={visivel:!0,campos:{valorMulta:o},rules:[]}},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},cancelarDesconto(){this.titulo=$utils.clonar(this.tituloOriginal),this.modalEditar.visivel=!1},async desconto(){const e=this.titulo.valorDesconto;let o=0,u=0,C=0,a=Number(this.titulo.diasEmAtraso)||0;const d=Number(this.titulo.valor)||0;if(a<0&&(a=0),a>0&&(u=Number(this.titulo.valorMulta)||0,o=Number(this.titulo.valorJuros)||0,C=$utils.arredondar(u+o*a)),await $db.permissao.objeto("PadraoNovo_Financeiro")&&(C=$utils.arredondar(d+u+o*a)),e<0||e>C){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"];return}this.modalEditar.rules=[()=>!0];const f=$utils.arredondar(d-e+u+o*a),g=$utils.arredondar(e*100/(d||1));this.titulo.valorTotal=f,this.titulo.valorARealizar=f,this.titulo.percentualDesconto=g},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((e,o)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{o()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")}},props:{dados:{required:!0,type:Object}},async mounted(){const e=new Date(this.dados.dataVencimento).setHours(0,0,0,0),o=new Date().setHours(0,0,0,0);e<o?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,C=>C!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $db.hibrido.le({table:"documento",id:this.titulo.documentoId})),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(C=>this.visibilidade.botao.editar=C&&!this.tituloOriginal.valorRealizado),this.contatos={};const u={};if(this.titulo.idContato){const C=await $db.contato.le({id:this.titulo.idContato});C&&(u[this.titulo.idContato]=C)}if(this.titulo.idEmpresa){const C=await $db.contato.le({id:this.titulo.idEmpresa});C&&(u[this.titulo.idEmpresa]=C)}this.contatos=u,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leNew({id:this.titulo.idFatura}).then(C=>{this.fatura=C,C.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(_=>_.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},go={class:"col-12 col-md-6 q-pl-none"},bo={class:"col-4 col-md"},$o={key:0,class:"q-my-none"},Fo={class:"q-my-none"},Eo={class:"q-my-none"},Do={class:"col-4 col-md text-right"},wo={class:"col-4 col-md text-right"},Po={class:"col-12 col-md"},yo={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},qo={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},To={class:"col-12 col-md-6"},xo={class:"text-body2"},Mo={class:"col-12 col-md-6 text-right hideonmobile"},_o={class:"col-12 text-right"},ko={class:"col-12 col-md-6"},Vo={class:"text-body2 q-my-none q-mb-md"},Io={class:"col-12 col-sm-4 col-md-2"},zo={class:"text-left q-my-none"},No={class:"col-6 col-md-1"},Oo={class:"text-left q-my-none"},Ro={class:"col-6 col-md-1"},Ao={class:"text-left q-my-none"},Bo={class:"col-12 col-sm-4 col-md-2 text-right"},So={class:"q-ma-none"},Lo={class:"q-mt-xs"},jo={class:"q-mt-xs"},Ho={class:"q-mt-lg text-right q-gutter-md"};function Uo(e,o,u,C,a,d){const _=Q("avatar"),f=Q("row"),g=Q("campo");return h(),N("div",{class:eo([a.tema,"extratoItem bg-white q-pa-sm no-shadow"])},[t(f,{class:"items-center q-mx-none q-px-none q-mb-sm text-tertiary"},{default:r(()=>{var $;return[D("div",go,[t(da,{class:"q-pa-none"},{default:r(()=>[t(_,{imagem:(a.contatos[a.titulo.idContato]||{}).imagem,rotulo:(a.contatos[a.titulo.idContato]||{}).apelido,tamanho:"30"},null,8,["imagem","rotulo"]),t(pa,null,{default:r(()=>[M(q((a.contatos[a.titulo.idContato]||{}).apelido)+" ",1),o[9]||(o[9]=D("br",null,null,-1))]),_:1}),a.titulo.parcela?(h(),T(Ya,{key:0,rounded:"",color:"tertiary",small:""},{default:r(()=>[M(q(a.titulo.parcela),1)]),_:1})):x("",!0)]),_:1})]),D("div",bo,[a.titulo.documentoCodigo?(h(),N("p",$o,q(a.titulo.documentoTipo)+" #"+q(($=a.documento)==null?void 0:$.numero),1)):x("",!0),D("p",Fo,q(a.titulo.formaDePagamento),1),D("p",Eo,q(a.titulo.descricaoPlanoConta),1)]),D("div",Do,[a.titulo.dataVencimentoOriginal?(h(),T(R,{key:0,name:"mdi-calendar-today"})):x("",!0),M(" "+q(e.$filters.data(a.titulo.dataVencimentoOriginal))+" ",1),t(fa,null,{default:r(()=>o[10]||(o[10]=[M("Vencimento original")])),_:1})]),D("div",wo,[a.titulo.dataVencimento?(h(),T(R,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+q(e.$filters.data(a.titulo.dataVencimento))+" ",1),t(fa,null,{default:r(()=>o[11]||(o[11]=[M("Vencimento")])),_:1})]),D("div",Po,[D("p",yo,q(e.$filters.numero(a.titulo.valorTotal,2)),1),D("p",qo,q(e.$filters.numero(a.titulo.valor,2)),1)])]}),_:1}),t(f,{class:"items-center justify-end"},{default:r(()=>[D("div",To,[D("div",xo,q(a.titulo.descricao),1)]),D("div",Mo,[a.visibilidade.botao.remover?(h(),T(B,{key:0,onClick:d.remover,icon:"clear",color:"tertiary",round:"",dense:"",flat:""},{default:r(()=>[t(fa,null,{default:r(()=>[M(" Remover da Fatura #"+q(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):x("",!0),t(B,{onClick:d.alternarDetalhes,icon:`keyboard_arrow_${a.detalhes?"up":"down"}`,color:"tertiary",round:"",dense:"",flat:""},null,8,["onClick","icon"]),a.visibilidade.botao.editar?(h(),T(B,{key:1,onClick:d.editar,icon:"edit",color:"primary",round:"",dense:"",flat:""},null,8,["onClick"])):x("",!0),Sa(e.$slots,"default"),d.mostrarMenuTresPontos?(h(),T(B,{key:2,icon:"more_vert",color:"tertiary",rounded:"",dense:"",flat:""},{default:r(()=>[t(qa,null,{default:r(()=>[ga((h(),T(Ca,{link:"",separator:""},{default:r(()=>[a.mostrarOpcaoMigrarFatura?(h(),N(L,{key:0},[(h(!0),N(L,null,J(a.faturasAbertas,$=>(h(),T(H,{clickable:"",key:$.id,onClick:i=>d.migrarFatura($)},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q("Migrar para fatura #"+($.numero||$.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(H,{clickable:"",onClick:o[0]||(o[0]=$=>d.migrarFatura())},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>o[12]||(o[12]=[M("Migrar para nova fatura")])),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})),[[ba]])]),_:1})]),_:1})):x("",!0)])]),_:3}),t(La,{class:"hideondesktop q-mb-sm q-mt-xs"}),t(f,{class:"q-mx-none q-px-none hideondesktop"},{default:r(()=>[D("div",_o,[a.visibilidade.botao.remover?(h(),T(B,{key:0,onClick:d.remover,icon:"clear",color:"tertiary",round:"",dense:"",flat:""},{default:r(()=>[t(fa,null,{default:r(()=>[M(" Remover da Fatura #"+q(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):x("",!0),t(B,{onClick:d.alternarDetalhes,round:"",dense:"",flat:"",color:"tertiary",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`},null,8,["onClick","icon"]),a.visibilidade.botao.editar?(h(),T(B,{key:1,onClick:d.editar,icon:"edit",color:"primary",round:"",dense:"",flat:""},null,8,["onClick"])):x("",!0),Sa(e.$slots,"default"),d.mostrarMenuTresPontos?(h(),T(B,{key:2,round:"",dense:"",flat:"",icon:"more_vert",color:"tertiary"},{default:r(()=>[t(qa,null,{default:r(()=>[ga((h(),T(Ca,{link:"",separator:""},{default:r(()=>[a.mostrarOpcaoMigrarFatura?(h(),N(L,{key:0},[(h(!0),N(L,null,J(a.faturasAbertas,$=>(h(),T(H,{clickable:"",key:$.id,onClick:i=>d.migrarFatura($)},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q("Migrar para fatura #"+($.numero||$.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(H,{clickable:"",onClick:o[1]||(o[1]=$=>d.migrarFatura())},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>o[13]||(o[13]=[M("Migrar para nova fatura")])),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})),[[ba]])]),_:1})]),_:1})):x("",!0)])]),_:3}),a.detalhes?(h(),T(La,{key:0,class:"hideondesktop q-my-sm"})):x("",!0),a.detalhes?(h(),T(f,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:r(()=>[D("div",ko,[t(da,{class:"u-autoHeight q-pa-none",color:"none",dark:""},{default:r(()=>[t(R,{name:"business"}),t(pa,null,{default:r(()=>[M(q((a.contatos[a.titulo.idEmpresa]||{}).apelido),1)]),_:1})]),_:1}),D("p",Vo,q(a.titulo.observacao),1)]),D("div",Io,[D("p",zo,q(a.titulo.descricaoCentroCusto),1)]),D("div",No,[D("p",Oo,[a.titulo.dataEmissao?(h(),T(R,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+q(e.$filters.data(a.titulo.dataEmissao))+" ",1),t(fa,null,{default:r(()=>o[14]||(o[14]=[M("Emiss\xE3o")])),_:1})])]),D("div",Ro,[D("p",Ao,[a.titulo.dataCompetencia?(h(),T(R,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+q(e.$filters.data(a.titulo.dataCompetencia))+" ",1),t(fa,null,{default:r(()=>o[15]||(o[15]=[M("Compet\xEAncia")])),_:1})])]),D("div",Bo,[o[18]||(o[18]=D("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1)),D("p",So,q(e.$filters.numero(a.titulo.valorDesconto||0,2)),1),a.titulo.diasEmAtraso?(h(),N(L,{key:0},[D("div",Lo,[o[16]||(o[16]=D("small",{class:"block text-caption"},"Multa",-1)),D("strong",null,q(e.$filters.numero(a.titulo.valorMulta||0,2))+" ("+q(e.$filters.numero(a.titulo.percentualMulta||0,2))+"%) ",1)]),D("div",jo,[o[17]||(o[17]=D("small",{class:"block text-caption"},"Juros",-1)),D("strong",null,q(e.$filters.numero(a.titulo.valorTotalJuros||0,2))+" ("+q(e.$filters.numero(a.titulo.percentualJuros||0,2))+"% dia) ",1)])],64)):x("",!0)])]),_:1})):x("",!0),t(Ia,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":o[8]||(o[8]=$=>a.modalEditar.visivel=$),onKeyup:Va(d.cancelarDesconto,["esc"]),persistent:""},{default:r(()=>[t(ao,{style:{"min-width":"30vw"}},{default:r(()=>[t(da,{class:"bg-primary text-white"},{default:r(()=>[t(pa,null,{default:r(()=>o[19]||(o[19]=[M("Editar T\xEDtulo")])),_:1})]),_:1}),t(oo,null,{default:r(()=>[t(to,{onSubmit:d.salvar,class:"q-pa-lg q-gutter-md"},{default:r(()=>[t(g,{modelValue:a.titulo.valor,"onUpdate:modelValue":o[2]||(o[2]=$=>a.titulo.valor=$),rotulo:"Valor",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),t(g,{modelValue:a.titulo.diasEmAtraso,"onUpdate:modelValue":o[3]||(o[3]=$=>a.titulo.diasEmAtraso=$),rotulo:"Dias em Atraso",tipo:"decimal",decimals:"0",zerosDireita:"0",zeros:"","somente-leitura":"",outlined:""},null,8,["modelValue"]),t(g,{modelValue:a.modalEditar.campos.valorMulta,"onUpdate:modelValue":o[4]||(o[4]=$=>a.modalEditar.campos.valorMulta=$),ajuda:`Multa de R$ ${e.$filters.numero(a.titulo.valorMulta,2)}`,rotulo:"Multa",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),t(g,{modelValue:a.titulo.valorTotalJuros,"onUpdate:modelValue":o[5]||(o[5]=$=>a.titulo.valorTotalJuros=$),ajuda:`Juros ao ${a.titulo.tipoJuros} de R$ ${e.$filters.numero(a.titulo.valorJuros,2)}`,rotulo:"Juros",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),t(g,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[o[6]||(o[6]=$=>a.titulo.valorDesconto=$),d.desconto],rotulo:"Desconto",tipo:"decimal",decimals:"2",rules:a.modalEditar.rules,outlined:""},null,8,["modelValue","onUpdate:modelValue","rules"]),t(g,{modelValue:a.titulo.valorTotal,"onUpdate:modelValue":o[7]||(o[7]=$=>a.titulo.valorTotal=$),rotulo:"Total",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),D("div",Ho,[t(B,{color:"tertiary",flat:"",unelevated:"",label:"Cancelar",onClick:d.cancelarDesconto},null,8,["onClick"]),t(B,{color:"primary",unelevated:"",label:"Salvar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],2)}var Qo=ka(Co,[["render",Uo]]),Jo={async enviar(e,o){var u,C;try{const a=o.nome.replace("enviaemail.fatura.",""),d=(u=o.valor)!=null?u:"Impresso",_=(C=o.texto)!=null?C:`Voc\xEA est\xE1 recebendo o ${d} da empresa ${e.descricaoEmpresa}.`,f=await $db.contato.le({id:e.idContato}),g=await $utils.impressaoObterHtml(a,e),$={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:String(f==null?void 0:f.email).trim().toLowerCase(),assunto:`${d}`,mensagem:`${_}`},i=`${d} enviado para ${$.para}, com sucesso!.`,I=`Erro ao enviar e-mail. ${d} n\xE3o enviado.`;$q.loading.show({message:`Enviando ${d} por e-mail...`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const V=[{name:`${d}.pdf`,content:g,method:"html2pdf"}],j={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:$.de,to:$.para,subject:$.assunto,text:$.mensagem,attachments:V},A=await io({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:j});$q.notifyPositive((A==null?void 0:A.status)===200&&i?i:A.data.message)}catch(a){$q.notifyError(errorMsg||"Erro ao enviar e-mail",a)}finally{$q.loading.hide()}}},Go={async finalizar(e,o){var u,C,a,d,_,f,g,$;try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!e)try{await new Promise((s,l)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{s()}).onCancel(()=>{l()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const i=$utils.clonar(this.fatura),I=$utils.clonar(this.vendas),V=$utils.clonar(this.documentosEnvelope),j=$utils.clonar(this.carnes),A=[...I,...V].map(s=>s.id),K=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:A}}),m=$utils.clonar(K);if(j.length>0){const s=j.reduce((l,F)=>(F.idFinanceiroBoleto&&F.codigoFinanceiroTitulo&&(l+=String(F.codigoFinanceiroTitulo)+";"),l),"");if(s)try{$q.loading.show({message:"Baixando boletos..."});const l=`exec sp_Financeiro_BoletoBaixar '${s.slice(0,-1)}'`,F=await $utils.executarSql(l)}catch(l){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",l);return}finally{$q.loading.hide()}}const n=e?i.dataHoraFinalizado:$utils.dataAtual(),c=n,b=await $db.hibrido.le({table:"documento",id:this.$refs.faturamento.idDocumentoCaixa}),S=await $db.formaPagamento.le();this.documentoStatus=[],await this.$refs.faturamento.validar();let Y=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(s=>s.valor),["idFormaPagamento","autorizacao","dataVencimento"]);$utils.verificarErro(I.some(s=>!s.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o.");const oa=$utils.arredondar(this.carnes.reduce((s,l)=>s+(l.valorARealizar||0),0)),$a=$utils.arredondar(Y.reduce((s,l)=>s+(l.valor||0),0));let ta=0;if(e&&(Y=Y.filter(s=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(l=>l.id===s.id))),i.totalDocumento>=0){if(this.carnes.length){if($a<oa)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const l=Y.reduce((F,w)=>{const P=`${w.autorizacao||""}${w.documento||""}${w.idFormaPagamento}`;return F[P]||(F[P]={parcelas:0,formaPagamento:w.formaPagamento}),F[P].parcelas++,F},{});for(const F in l)if(l[F].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${l[F].formaPagamento} acima do permitido.`),!1}}$a<i.totalDocumento&&(ta=1)}let na=ta===1?"Aguardando Pagamento":"Finalizada";if(!e){this.documentoStatus.push({id:$utils.uuid(),idDocumento:i.id,operacao:"Fatura",statusOriginal:i.status,statusFinalizado:na,dataHoraEmissao:n,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:b.id||""}),i.status=na,i.dataHoraFinalizado=n,na="Faturado";const s=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",i.idEmpresa,0))||0;let l=0,F=V.filter(p=>p.status!=="Entregue").length,w=!1,P=!0;if(I.length>0&&s&&(this.$q.loading.hide(),await new Promise((p,E)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{P=!0,p()}).onCancel(()=>{P=!1,p()})}),this.$q.loading.show({message:"Processando..."})),F){let p="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";F>1&&(p=`Nesta Fatura h\xE1 ${F} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise((E,y)=>{this.$q.dialog({cancel:"N\xE3o",message:p,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{w=!0,E()}).onCancel(()=>{y()})})}catch{}this.$q.loading.show({message:"Processando..."})}let v=0;v=$utils.arredondar(m.reduce((p,E)=>(E.total>0&&(p+=E.total),p),v));for(const p of[...I,...V])p.tipo==="Envelope"&&w&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:p.id,operacao:p.operacao,statusOriginal:p.status,statusFinalizado:"Entregue",dataHoraEmissao:n,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),p.status="Entregue"),p.tipo==="Venda"&&P&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:p.id,operacao:p.operacao,statusOriginal:p.status,statusFinalizado:na,dataHoraEmissao:n,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:b.id||""}),p.status="Faturado");for(const p of m){const E=[...I,...V].find(y=>y.id===p.idDocumento);if(p.status=E.status,p.total>0){p.quantidade=p.quantidade||1,p.valorItem=p.valorItem||0,p.descontoItem=p.descontoItem||0,p.descontoTotalRateado=p.descontoTotalRateado||0;let y=(p.valorItem-p.descontoItem)*p.quantidade-p.descontoTotalRateado;const z=$utils.arredondar((i.totalDesconto||0)*y/(v||1)||0);p.descontoFaturaRateado=$utils.arredondar(z),p.valorRealTotal=$utils.arredondar(y-z),p.valorReal=$utils.arredondar(p.valorRealTotal/p.quantidade),l+=z}}if(this.documentosItem=m,this.documentosItemOriginal=K,i.totalDesconto!==$utils.arredondar(l)){const p=$utils.arredondar((i.totalDesconto||0)-(l||0));let E,y=0;for(const z of m)z.total>y&&(y=z.total,E=z);if(E){const z=(E.descontoFaturaRateado||0)+(p||0),X=((E.valorItem||0)-(E.descontoItem||0))*(E.quantidade||1)-(E.descontoTotalRateado||0)-(z||0),ua=(X||0)/(E.quantidade||1);E.descontoFaturaRateado=$utils.arredondar(z),E.valorReal=$utils.arredondar(ua),E.valorRealTotal=$utils.arredondar(X)}}}const Fa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),ca=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Fa}),ra=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ra});const Ea=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),Da=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ea}),Ta=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),za=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ta}),Ja=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),Z=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ja}),Ga=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Na=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ga}),Ka=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),Oa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ka}),Za=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),wa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Za}),Wa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),Xa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Wa}),xa=(u=this.contatos[i.idContato])==null?void 0:u.descontoCondicionadoPercentual;let la=I.reduce((s,l)=>s+l.totalDocumento,0);la=la+V.reduce((s,l)=>s+l.totalDocumento,0),la=$utils.arredondar(la-i.totalDesconto);let sa=i.totalDocumento,W=[];const O=[],Ra=[],Pa=[],Aa=[];let va=1,Ma="",ya=1,ea="";for(const s of Y.filter(l=>!l.sinal)){s.sinal=s.sinal||ta;const l=S.filter(F=>F.id===s.idFormaPagamento)[0];if(sa<0)ea=$utils.uuid(),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:ea,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:$utils.arredondar(sa*-1),descricao:Z.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${i.id})`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:ea,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Xa.id,dataEmissao:n,valorCredito:$utils.arredondar(sa*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${i.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id});else{if(Ma!==s.idFormaPagamento+s.autorizacao&&(Ma=s.idFormaPagamento+s.autorizacao,va=1,ya=Y.reduce((F,w)=>w.idFormaPagamento+w.autorizacao===Ma?F+1:F,0)),l.tipoFinanceiro==="T\xEDtulo Liquidado"&&(ea=$utils.uuid()),oa>0){const F=$utils.uuid(),w=$utils.arredondar(s.valor*(oa/sa));let P=0,v=0,p=0,E=0;if(l.tipo===5){let y=(await $erp().financeiroBanco.toArray()).find(z=>z.codigoBanco===122);y&&(v=y.percentualMulta||0,E=y.percentualJuros||0,P=$utils.arredondar(v/100*w),p=$utils.arredondar(E/100*w))}W.push({id:F,idFinanceiroPlanoConta:ca.id,idContato:i.idContato,dataEmissao:n,dataCompetencia:c,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:w,valorTotal:w,valorARealizar:w,valorMulta:P,percentualMulta:v,valorJuros:p,percentualJuros:E,documentoId:i.id,documentoTipo:"Fatura",parcela:va+"/"+ya,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:l.descricao,carne:l.tipo===5?1:0,dataEmissaoCarne:l.tipo===5?n:"",idDocumentoCaixa:b.id,idFinanceiroMovimentacaoAgrupamento:l.tipoFinanceiro==="T\xEDtulo Liquidado"?ea:""}),s.idFinanceiroTitulo=F,l.tipo===2&&Pa.push({idTitulo:F,idDocumentoCondicaoPagamento:s.id,valor:w,dataVencimento:s.dataVencimento,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,formaPagamento:l}),Aa.push({idTitulo:F,valor:w,desconto:0})}if(la>0){const F=$utils.uuid(),w=$utils.arredondar(s.valor*(la/sa));let P=0,v=0,p=0,E=0;if(l.tipo===5){let y=(await $erp().financeiroBanco.toArray()).find(z=>z.codigoBanco===122);y&&(v=y.percentualMulta||0,E=y.percentualJuros||0,P=$utils.arredondar(v/100*w),p=$utils.arredondar(E/100*w))}W.push({id:F,idFinanceiroPlanoConta:Z.id,idContato:i.idContato,dataEmissao:n,dataCompetencia:c,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:w,valorTotal:w,valorARealizar:w,valorMulta:P,percentualMulta:v,valorJuros:p,percentualJuros:E,documentoId:i.id,documentoTipo:"Fatura",parcela:va+"/"+ya,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:l.descricao,carne:l.tipo===5?1:0,dataEmissaoCarne:l.tipo===5?n:"",idDocumentoCaixa:b.id,idFinanceiroMovimentacaoAgrupamento:l.tipoFinanceiro==="T\xEDtulo Liquidado"?ea:"",descontoCondicionadoValor:xa>0?xa/100*w:0,descontoCondicionadoPercentual:xa}),s.idFinanceiroTitulo=F,l.tipo===2&&Pa.push({idTitulo:F,idDocumentoCondicaoPagamento:s.id,valor:w,dataVencimento:s.dataVencimento,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,formaPagamento:l})}if(l.tipoFinanceiro==="T\xEDtulo Liquidado"&&la>=0){O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:ea,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:aa.id,idFinanceiroTitulo:s.idFinanceiroTitulo,dataEmissao:n,valorCredito:s.valor,valorDebito:0,descricao:aa.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id});let F=l.idFinanceiroPlanoConta;l.tipo===1&&(b||{}).idFinanceiroPlanoContaCaixa&&(F=b.idFinanceiroPlanoContaCaixa);let w=await $db.financeiroPlanoConta.le({id:F}),P="";[3,4].includes(l.tipo)&&(P=(d=(a=(C=W[0])==null?void 0:C.observacao)==null?void 0:a.match(/Autorização\s(\d+)/))==null?void 0:d[1],P&&(P=` (Autoriza\xE7\xE3o ${P})`)),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:ea,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:w.id,idFinanceiroTitulo:s.idFinanceiroTitulo,dataEmissao:n,valorCredito:0,valorDebito:s.valor,descricao:w.descricao+P,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id});for(const v of W)v.idFinanceiroMovimentacaoAgrupamento===ea&&(v.valorRealizado=v.valorARealizar,v.dataPagamento=s.dataVencimento,v.dataMovimento=s.dataVencimento,v.idDocumentoCaixaLiquidacao=b.id)}if(l.aliquota){const F=$utils.uuid(),w=$utils.arredondar(s.valor*(l.aliquota/100));if(W.push({id:F,idFinanceiroPlanoConta:l.idFinanceiroPlanoContaAliquota,idContato:l.idContatoOperadoraCartao,dataEmissao:n,dataCompetencia:c,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:w,valorTotal:w,valorARealizar:w,valorMulta:0,percentualJuros:0,documentoId:i.id,documentoTipo:"Fatura",parcela:va+"/"+ya,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${l.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:l.descricao,idDocumentoCaixa:b.id}),s.idFinanceiroTituloPagar=F,l.tipoFinanceiro==="T\xEDtulo Liquidado"){const P=$utils.uuid();O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Da.id,dataEmissao:n,valorCredito:0,valorDebito:w,descricao:Da.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:F,idContato:l.idContatoOperadoraCartao,idDocumentoCaixa:b.id});let v=l.idFinanceiroPlanoConta;l.tipo===1&&(b||{}).idFinanceiroPlanoContaCaixa&&(v=b.idFinanceiroPlanoContaCaixa);let p=await $db.financeiroPlanoConta.le({id:v});O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:p.id,dataEmissao:n,valorCredito:w,valorDebito:0,descricao:p.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:F,idContato:l.idContatoOperadoraCartao,idDocumentoCaixa:b.id});for(const E of W)E.id===F&&(E.idFinanceiroMovimentacaoAgrupamento=P,E.valorRealizado=w,E.dataPagamento=s.dataVencimento,E.dataMovimento=s.dataVencimento,E.idDocumentoCaixaLiquidacao=b.id)}}va++}}const Ba=[];for(const s of Pa){const l=$utils.uuid(),F=$utils.uuid();for(const P of W)P.id===s.idTitulo&&(P.idFinanceiroMovimentacaoAgrupamento=F,P.valorRealizado=P.valorARealizar,P.dataPagamento=n,P.dataMovimento=n,P.dataVencimento=n,P.dataVencimentoOriginal=n,P.idDocumentoCaixaLiquidacao=b.id);if(Ba.includes(s.idDocumentoCondicaoPagamento))continue;Ba.push(s.idDocumentoCondicaoPagamento);const w=$utils.arredondar(Pa.reduce((P,v)=>v.idDocumentoCondicaoPagamento===s.idDocumentoCondicaoPagamento?P+(v.valor||0):P,0));W.push({id:l,idFinanceiroPlanoConta:za.id,idContato:i.idContato,dataEmissao:n,dataCompetencia:c,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:w,valorTotal:w,valorARealizar:w,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:i.id,documentoTipo:"Fatura",idEmpresa:i.idEmpresa,formaDePagamento:s.formaPagamento.descricao,idDocumentoCaixa:b.id,cheque:1,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${i.id} - C\xF3digoN #${F}`,descricao:"Cheque"}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:F,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:za.id,idFinanceiroTitulo:l,dataEmissao:n,valorCredito:0,valorDebito:w,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,idFinanceiroCheque:l,idDocumentoCaixa:b.id,documentoId:i.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:F,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:aa.id,idFinanceiroTitulo:l,dataEmissao:n,valorCredito:w,valorDebito:0,descricao:aa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,idFinanceiroCheque:l,idDocumentoCaixa:b.id,documentoId:i.id})}if(oa>0){const s=$utils.uuid();O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:aa.id,dataEmissao:n,valorCredito:oa,valorDebito:0,descricao:aa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,idDocumentoCaixa:b.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:ca.id,dataEmissao:n,valorCredito:0,valorDebito:oa,descricao:ca.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Renegocia\xE7\xE3o",documentoId:s,idDocumentoCaixa:b.id});for(const l of Aa)Ra.push({idFinanceiroMovimentacaoN:s,idFinanceiroTitulo:l.idTitulo,dataVencimento:n,valorOriginal:l.valor,valorDesconto:l.desconto,valorTotal:$utils.arredondar(l.valor-l.desconto)});for(const l of j){if(l.idFinanceiroMovimentacaoAgrupamento=s,l.idDocumentoCaixaLiquidacao=b.id,l.dataPagamento=n,l.dataMovimento=n,l.renegociado=1,l.cheque===1){l.valorRealizado=l.valor;continue}if(!l.valorARealizar){l.valorRealizado=l.valorTotal;continue}l.valorRealizado=l.valorARealizar}W=W.concat(j)}if(ta===0){let s=$utils.uuid();const l=i.valorFrete||0;let F=0,w=0;const P=[];if(l>0&&(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:l,descricao:Z.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Oa.id,dataEmissao:n,valorCredito:l,valorDebito:0,descricao:Oa.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id})),!e){s=$utils.uuid();for(const v of m){let p="",E={},y="",z={},X="",ua={};const ma=await $db.item.leNew({id:v.idItem});if(p=v.idPlanoContaEstoque,!p){const G=await $db.perfilContabilItem.le({idPerfilContabil:ma.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:ma.idPerfilContabil,idCfop:v.idCfop}});G.length&&G[0].idPlanoContaEstoque&&(p=G[0].idPlanoContaEstoque)}if(!p&&Na.id&&(p=Na.id),!p&&v.idCfop&&(p=(await $db.cfop.le({id:v.idCfop})).idPlanoContaEstoque),E=await $db.financeiroPlanoConta.le({id:p}),!E.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(y="",!y){const G=await $db.perfilContabilItem.le({idPerfilContabil:ma.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:ma.idPerfilContabil,idCfop:v.idCfop}});G.length&&G[0].idPlanoContaDespesa&&(y=G[0].idPlanoContaDespesa)}if(!y&&wa.id&&(y=wa.id),!y&&v.idCfop&&(y=(await $db.cfop.le({id:v.idCfop})).idPlanoContaDestino),z=await $db.financeiroPlanoConta.le({id:y}),!z.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const _a=$utils.arredondar(v.total-(v.descontoTotalRateado||0)-(v.descontoFaturaRateado||0)),ha=$utils.arredondar(v.valorCustoMedio*v.quantidade);if(ha){if(v.operacaoFator<0?(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:E.id,dataEmissao:v.dataHoraFinalizado||n,valorCredito:ha,valorDebito:0,descricao:E.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:b.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:z.id,dataEmissao:v.dataHoraFinalizado||n,valorCredito:0,valorDebito:ha,descricao:z.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:b.id})):(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:E.id,dataEmissao:v.dataHoraFinalizado||n,valorCredito:0,valorDebito:ha,descricao:E.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:b.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:z.id,dataEmissao:v.dataHoraFinalizado||n,valorCredito:ha,valorDebito:0,descricao:z.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${v.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:b.id})),X=v.idPlanoContaDestino,!X){const ia=await $db.perfilContabilItem.le({idPerfilContabil:ma.idPerfilContabil,idCfop:v.idCfop,and:{idPerfilContabil:ma.idPerfilContabil,idCfop:v.idCfop}});ia.length&&ia[0].idPlanoContaDespesa&&(X=ia[0].idPlanoContaDespesa)}if(!X&&wa.id&&(X=wa.id),!X&&v.idCfop&&(X=(await $db.cfop.le({id:v.idCfop})).idPlanoContaDestino),ua=await $db.financeiroPlanoConta.le({id:X}),!ua.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let G=!0;for(const ia of P)if(ia.idPlanoContaDestino===ua.id&&ia.idPlanoContaEstoque===E.id){ia.valor=$utils.arredondar(ia.valor+_a),G=!1;break}G&&P.push({idPlanoContaDestino:ua.id,idPlanoContaEstoque:E.id,valor:_a}),F+=_a}}for(const v of P)v.valor<0&&(w+=v.valor);for(const v of P)if(v.valor>0){const p=await $db.financeiroPlanoConta.le({id:v.idPlanoContaDestino}),E=$utils.arredondar(w*(v.valor/(F||1)));if(E>0){O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:E,descricao:Z.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:p.id,dataEmissao:n,valorCredito:E,valorDebito:0,descricao:p.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id});for(const y of Y)O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:$utils.arredondar((v.valor-E)*(y.valor/(sa||1))),descricao:Z.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:y.dataVencimento,dataMovimento:y.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:p.id,dataEmissao:n,valorCredito:$utils.arredondar((v.valor-E)*(y.valor/(sa||1))),valorDebito:0,descricao:p.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:y.dataVencimento,dataMovimento:y.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id})}else for(const y of Y){const z=$utils.arredondar(v.valor*(y.valor/(sa||1)));O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:z,descricao:Z.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:y.dataVencimento,dataMovimento:y.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:p.id,dataEmissao:n,valorCredito:z,valorDebito:0,descricao:p.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:y.dataVencimento,dataMovimento:y.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:b.id})}}}}if(this.financeiroTitulo=W,this.financeiroMovimentacao=O,this.financeiroRenegociacao=Ra,this.fatura=i,this.vendas=I,this.documentosEnvelope=V,this.carnes=j,!e){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let l,F,w,P;if(l=await $db.configuracoes.porNome("integracao.bten.business"),F=(f=(_=l[0])==null?void 0:_.valor)!=null?f:!1,l=await $db.configuracoes.porNome("integracao.bten.authorization"),w=($=(g=l[0])==null?void 0:g.valor)!=null?$:!1,P=F&&w,P){const v=[],p=this.contatos[i.idContato],E=await $api.bten.send(p,i);for(let y=0;y<E.length;y++){const z=E[y];z.status?v.push(z.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${z.telefone}!`)}v.length&&this.$q.notifyPositive(`NPS enviado para ${v.join(",")}!`)}}catch(l){l.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${l.message}`),l.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",l)}let s;if(b!=null&&b.idCaixa){const l=await $erp().caixa.get(b==null?void 0:b.idCaixa);l!=null&&l.id&&(s=$db.caixa.tiposCaixa[Number(l.tipo)])}if([...I,...V].length&&~["SAT","NFCe"].indexOf(s))try{await this.$refs.documentosFiscais.emitirCupom(this.fatura.id)}catch{}if(this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"){const l=await $db.configuracoes.le({prefixoNome:"enviaemail.fatura"});let F=l.find(w=>w.idEmpresa===this.fatura.idEmpresa);F||(F=l.find(w=>!w.idEmpresa)),F&&await Jo.enviar(this.fatura,F)}}return!0}catch(i){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",i)}finally{this.$q.loading.hide()}}};const Ko={components:{DocumentoCodigo:no,DocumentoMetas:ro,DocumentosFiscais:mo,Faturamento:so,TituloCard:Qo,VendaCard:vo,EnvelopeCard:ho},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let e=!1;return e=this.fatura.status==="Aberta",e||(e=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!e}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0},vendas:[],vendasOriginal:[],documentosEnvelope:[],documentosEnvelopeOriginal:[],documentosItem:[],documentosItemOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],erroCalculo:!1,erroCalculoMsg:"",sistemaPai:"",impressaoVisivel:!1,configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[po],methods:{async executarRecebimentoMultiplos(e){console.log(e)},async calcularPesoTotal(){var d,_;const e=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),o=[],u={};let C=0,a=0;for(const f of e){const g=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:f.id}});for(const $ of g)o.push($)}for(const f of o)if(f.operacaoFator===-1){if(f.idItem&&!u[f.idItem]){const g=await $erp().item.get(f.idItem);g&&(u[f.idItem]=g)}C+=(((d=u[f.idItem])==null?void 0:d.peso)||0)*(f.quantidade||0),a+=(((_=u[f.idItem])==null?void 0:_.pesoBruto)||0)*(f.quantidade||0)}C=$utils.arredondar(C,4),a=$utils.arredondar(a,4),this.pesoTotal=C?$filters.numeroZerosDireita(C,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,d,_;const e=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),o=[],u={};let C=0;for(const f of e){const g=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:f.id}});for(const $ of g)o.push($)}for(const f of o){if(f.operacaoFator!==-1||f.tipoItem!=="Produto")continue;if(f.idItem&&!u[f.idItem]){const i=await $erp().item.get(f.idItem);i&&(u[f.idItem]=i)}const g=((a=u[f.idItem])==null?void 0:a.altura)*((d=u[f.idItem])==null?void 0:d.largura)*((_=u[f.idItem])==null?void 0:_.comprimento)||0,$=f.quantidade||0;C+=g>0?g*$:0}C=$utils.arredondar(C,4),this.metroCubicoTotal=C?$filters.numeroZerosDireita(C,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...Go,async atualizar(){let e=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.vendas=[],this.documentosEnvelope=[],this.documentosEnvelopeOriginal=[],this.documentosItem=[],this.documentosItemOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.prop.id){const o=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(o.fatura),this.fatura=o.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(o.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=o.condicaoPagamento),this.vendasOriginal=$utils.clonar(o.vendas),this.vendas=o.vendas.sort((a,d)=>new Date(a.dataHoraFinalizado)<new Date(d.dataHoraFinalizado)?-1:1);const u=o.documentosEnvelope.sort((a,d)=>new Date(a.dataHoraFinalizado)<new Date(d.dataHoraFinalizado)?-1:1);if(this.documentosEnvelopeOriginal=$utils.clonar(u),this.documentosEnvelope=$utils.clonar(u),typeof this.receberTitulo.id!="object"&&this.receberTitulo.id&&!o.carnes.find(a=>a.id===this.receberTitulo.id)&&(o.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),e=!0),typeof this.receberTitulo.id=="object")for(let a of this.receberTitulo.id)a&&!o.carnes.find(d=>d.id===a)&&(o.carnes.push(await $db.financeiroTitulo.le({id:a})),e=!0);this.carnesOriginal=$utils.clonar(o.carnes),this.carnes=o.carnes.sort((a,d)=>new Date(a.dataVencimento)<new Date(d.dataVencimento)?-1:1);const C={};if(o.fatura.idContato){const a=o.fatura.idContato;C[a]||(C[a]=await $db.contato.le({id:a}))}this.configuraImpressaoCarne(o.fatura.idEmpresa),this.configuraImpressaoConvenio(o.fatura.idEmpresa),this.configuraImpressaoEnvelope(o.fatura.idEmpresa),this.configuraImpressaoFatura(o.fatura.idEmpresa),this.contatos=C,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal();try{e&&await this.salvarFatura()}catch(a){console.error(a)}}},async executar(e){if(e==="recalcular"){if(this.prop.id){const o=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(o.carnes),this.carnes=o.carnes,await this.calculaTotais()}}else e==="salvarFatura"?(await this.salvarFatura(),await this.atualizar(),this.$emit("executar","atualizarSemFechar")):(await this.atualizar(),this.$emit("executar",e))},async calculaTotais(e){const o=$utils.arredondar(this.vendas.reduce((a,d)=>a+d.totalDocumento||0,0)),u=$utils.arredondar(this.documentosEnvelope.reduce((a,d)=>a+d.totalDocumento||0,0)),C=$utils.arredondar(this.carnes.reduce((a,d)=>a+d.valorARealizar||0,0));if(e||(this.fatura.subTotal=$utils.arredondar(o+u+C),e="desconto"),e==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),e==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.fatura.totalDesconto!==0){const a=o+u;a===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),a>0&&this.fatura.totalDesconto>a&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")}this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0);try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async configuraImpressaoConvenio(e){const o=await $db.configuracoes.porNome("impressao.convenio",e);this.configImpressaoConvenio=[...o.length?o.map(u=>({texto:"Imprimir Conv\xEAnio",...u})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(e){const o=await $db.configuracoes.porNome("impressao.carne",e);this.configImpressaoCarne=[...o.length?o.map(u=>({texto:"Imprimir Carn\xEA",...u})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(e){const o=await $db.configuracoes.porNome("impressao.envelope",e);this.configImpressaoEnvelope=[...o.length?o.map(u=>({texto:"Imprimir Envelope",...u})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(e){const o=await $db.configuracoes.porNome("impressao.fatura",e),u=[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"}];this.sistemaPai==="optisoul"&&u.push({valor:"termoGarantia",texto:"Termo de Garantia"}),this.configImpressaoFatura=[...o.length?o.map(C=>({texto:"Imprimir Fatura",...C})):u]},async reabrir(e){var o;if(!((o=this.fatura)!=null&&o.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!e)try{$q.loading.show(),await lo({idDocumento:this.fatura.id})}catch(u){this.$q.notifyError(u.message);return}finally{$q.loading.hide()}if(!e)try{await new Promise((u,C)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{u()}).onCancel(()=>{C()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const u=$utils.clonar(this.fatura),C=$utils.clonar(this.vendas),a=$utils.clonar(this.documentosEnvelope),d=$utils.clonar(this.documentosItem),_=this.$refs.faturamento.condicaoPagamento.filter(i=>i.valor);if(!e){const i=[];_.reduce((I,V)=>(V.idDocumentoCaixa&&!I[V.idDocumentoCaixa]&&(I[V.idDocumentoCaixa]=!0,i.push($db.hibrido.le({table:"documento",id:V.idDocumentoCaixa}))),I),{});for await(const I of i)if(I.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(i){$q.notifyError(i.message);return}let f=[],g=[],$=[];if(!e){f=await $db.financeiroTitulo.le({documentoId:u.id});for(const n of f)if(n.idFinanceiroBoleto){const c=await $erp().financeiroBoleto.get(n.idFinanceiroBoleto),b=await $db.financeiroBanco.le({id:c.idFinanceiroBanco}),S=await $db.banco.le({id:b.idBanco}),Y=c.revisao,oa=S.baixa,$a=S.registro;if(c.remessaOperacao!==oa){const ta=n.idFinanceiroBoleto,na=$utils.uuid(),Fa={id:na,idFinanceiroBanco:c.idFinanceiroBanco,nossoNumero:c.nossoNumero,nossoNumeroDv:c.nossoNumeroDv,revisao:Y+1,idEmpresa:c.idEmpresa,idContato:c.idContato,empresaNome:c.empresaNome,empresaNumeroDocumento:c.empresaNumeroDocumento,contatoNome:c.contatoNome,contatoNumeroDocumento:c.contatoNumeroDocumento,contatoLogradouro:c.contatoLogradouro,contatoCEP:c.contatoCEP,contatoBairro:c.contatoBairro,contatoCidade:c.contatoCidade,contatoUF:c.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:c.dataVencimento,dataImpressao:c.dataImpressao,valor:c.valor,valorJuros:c.valorJuros,tipoJuros:c.tipoJuros,valorMulta:c.valorMulta,valorDesconto:c.valorDesconto,valorTotal:c.valorTotal,codigoBarras:c.codigoBarras,linhaDigitavel:c.linhaDigitavel,mensagem1:c.mensagem1,mensagem2:c.mensagem2,mensagem3:c.mensagem3,mensagem4:c.mensagem4,mensagem5:c.mensagem5,gerarRemessa:1,remessaOperacao:oa};await $db.financeiroBoleto.grava({atual:Fa});let ca=[];ta&&(ca=await $db.financeiroTitulo.le({idFinanceiroBoleto:ta}));for(const ra of ca){const aa=$utils.clonar(ra);ra.idFinanceiroBoleto=na;let Ea=[];ta&&(Ea=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:ta}));for(const Da of Ea){const Ta={id:$utils.uuid(),idFinanceiroBoleto:na,idFinanceiroTitulo:Da.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:Ta})}await $db.financeiroTitulo.grava({atual:ra,original:aa})}if(c.remessaOperacao===$a&&c.gerarRemessa===1)for(const ra of[c,Fa]){const aa={...ra,gerarRemessa:0};await $db.financeiroBoleto.grava({original:ra,atual:aa})}}}let i=[];this.$refs.faturamento.idDocumentoCaixa&&(i=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),f=await $db.financeiroTitulo.le({idFatura:u.id});let I=await $db.financeiroTitulo.le({idFatura:u.id});for(const n of $utils.clonar(f)){if(!n.idFinanceiroMovimentacaoAgrupamento)continue;const c=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:n.idFinanceiroMovimentacaoAgrupamento});for(const b of c){const S=await $db.financeiroTitulo.le({id:b.idFinanceiroTitulo});S.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(f=f.concat(S))}}let V=!1;for(const n of _){const c=await $db.financeiroTitulo.le({id:n.idFinanceiroTitulo});if(Object.keys(c).length){let b=[];b=i.filter(S=>S.idFinanceiroMovimentacaoN===c.idFinanceiroMovimentacaoAgrupamento),g=g.concat(b),b=i.filter(S=>S.idFinanceiroTitulo===c.id),g=g.concat(b),b=i.filter(S=>S.idFinanceiroCheque===c.id),g=g.concat(b),f=f.concat(c)}n.idFinanceiroTitulo="",n.sinal===1&&(V=!0)}I=await $db.financeiroTitulo.le({idFatura:u.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const n of I){if(!n.idFinanceiroMovimentacaoAgrupamento)continue;const c=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:n.idFinanceiroMovimentacaoAgrupamento});g=g.concat(c);const b=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:n.idFinanceiroMovimentacaoAgrupamento});$=$.concat(b)}if(I=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:u.id}),f=f.concat(I),u.id){let n=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:u.id});g=g.concat(n),n=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:u.id}),g=g.concat(n),n=await $db.financeiroMovimentacao.lerV2({documentoId:u.id});for(const c of n)(await $db.financeiroTitulo.le({id:c.idFinanceiroTitulo})).id||(g=g.concat(c))}const j=await $db.hibrido.lista({table:"documento",where:{idFatura:u.id}});for(const n of j){const c=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:n.id});g=g.concat(c)}let A=[];for(const n in f){const c=f[n].id;A.includes(c)?delete f[n]:A.push(c)}f=f.filter(n=>n),A=[];for(const n in g){const c=g[n].id;A.includes(c)?delete g[n]:A.push(c)}g=g.filter(n=>n),A=[];for(const n in $){const c=$[n].id;A.includes(c)?delete $[n]:A.push(c)}$=$.filter(n=>n);let K=$utils.dataAtual(),m=V?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:u.id,operacao:"Fatura",statusOriginal:u.status,statusFinalizado:m,dataHoraEmissao:K,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],u.status=m,m==="Aberta"&&(u.dataHoraFinalizado=""),m=V?"Aguardando Pagamento":"Aguardando Faturamento";for(const n of C)this.documentoStatus.push({id:$utils.uuid(),idDocumento:n.id,operacao:"Venda de Mercadoria",statusOriginal:n.status,statusFinalizado:m,dataHoraEmissao:K,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),n.status=m;for(const n of a)this.documentoStatus.push({id:$utils.uuid(),idDocumento:n.id,operacao:"Envelope",statusOriginal:n.status,statusFinalizado:n.status,dataHoraEmissao:K,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const n of d)n.status=m;this.fatura=u,this.vendas=C,this.documentosEnvelope=a,this.documentosItem=d}if(this.$q.loading.hide(),e&&await this.finalizar(e),this.$q.loading.show({message:"Processando..."}),e){let i=[],I=[],V=[],j=[],A=[],K=[];i=this.$refs.faturamento.condicaoPagamento.map(m=>m.id),I=this.$refs.faturamento.condicaoPagamentoOriginal.filter(m=>!i.includes(m.id));for(const m of I)if(m.idFinanceiroTitulo&&V.push(m.idFinanceiroTitulo),m.idFormaPagamento){let n;n=await $erp().formaPagamento.get(m.idFormaPagamento),(n||{}).aliquota&&(m.idFinanceiroTituloPagar?V.push(m.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const m of V){let n;if(n=await $erp().financeiroTitulo.get(m),n.id&&j.push(n),n.idFinanceiroMovimentacaoAgrupamento){let c,b;if(c=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:n.idFinanceiroMovimentacaoAgrupamento}}),b=(c.find(S=>S.idFinanceiroCheque)||{}).idFinanceiroCheque,b){let S=await $erp().financeiroTitulo.get(b);S.id&&j.push(S)}A.push(...c)}}for(let m of this.carnes){if(!m.id||(m=await $erp().financeiroTitulo.get(m.id),!(m||{}).idFinanceiroMovimentacaoAgrupamento))continue;let n,c;n=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:m.idFinanceiroMovimentacaoAgrupamento}}),c=await $db.hibrido.lista({table:"financeiroRenegociacao",where:{idFinanceiroMovimentacaoN:m.idFinanceiroMovimentacaoAgrupamento}}),A.push(...n),K.push(...c)}await $db.financeiroTitulo.remove(j),await $db.financeiroMovimentacao.remove(A),await $db.financeiroRenegociacao.remove(K)}else{await $db.financeiroTitulo.remove(f.filter(i=>!(i.carne&&i.idFatura===u.id))),await $db.financeiroMovimentacao.remove(g),await $db.financeiroRenegociacao.remove($);for(const i of f.filter(I=>I.carne&&I.idFatura===u.id))await $db.financeiroTitulo.grava({original:i,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}return await this.salvarFatura(),await this.atualizar(),e?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let e,o,u,C;if(e=this.$refs.faturamento.condicaoPagamentoOriginal,o=this.$refs.faturamento.condicaoPagamento,C=$utils.arredondar(this.fatura.totalDocumento||0),u=$utils.arredondar(o.reduce((a,d)=>a+d.valor||0,0)),u!==C){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(e.length){let a=!1;o.length||(a=!0);for(const d of o)if(!e.find(_=>_.id===d.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,d)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{d()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){var e,o,u,C,a;try{this.$q.loading.show({message:"Processando..."});let d=$utils.clonar(((u=(o=(e=this==null?void 0:this.$refs)==null?void 0:e.faturamento)==null?void 0:o.condicaoPagamento)==null?void 0:u.filter(f=>f==null?void 0:f.valor))||{});for(let f in d)delete d[f].idDocumentoCondicaoPagamento,delete d[f].parcelas,delete d[f].formaPagamento,delete d[f].edicao,delete d[f].codigoDocumento,delete d[f].codigoDocumentoCaixa;const _=(this.carnesOriginal||[]).filter(f=>(this.financeiroTitulo||[]).find(g=>g.id===f.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,documentosEnvelope:this.documentosEnvelope,documentosEnvelopeOriginal:this.documentosEnvelopeOriginal,documentosItemOriginal:this.documentosItemOriginal,documentosItem:this.documentosItem,condicaoPagamentoOriginal:((a=(C=this.$refs)==null?void 0:C.faturamento)==null?void 0:a.condicaoPagamentoOriginal)||{},condicaoPagamento:d,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:_,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id&&typeof this.receberTitulo.id!="object"){let f=this.carnes.find(g=>g.id===this.receberTitulo.id);f.id&&await $db.financeiroTitulo.grava({original:f,atual:{idFatura:this.fatura.id}}),delete this.receberTitulo.id,await this.atualizar()}if(this.receberTitulo.id&&typeof this.receberTitulo.id=="object"){for(let f of this.receberTitulo.id){let g=this.carnes.find($=>$.id===f);g.id&&await $db.financeiroTitulo.grava({original:g,atual:{idFatura:this.fatura.id}})}delete this.receberTitulo.id,await this.atualizar()}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async dialogImpressao(){if(this.carnes.length>0&&(this.fatura.status==="Finalizada"||this.fatura.status!=="Aguardando Pagamento"&&this.fatura.dataHoraFinalizado))return this.impressaoVisivel=!0,new Promise(e=>{this.resolveDialogImpressao=e})},fecharDialogImpressao(){this.impressaoVisivel=!1,this.resolveDialogImpressao()}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},Zo={class:"Fatura round-borders bg-grey-2 q-pb-sm"},Wo={class:"row items-center"},Xo={class:"col q-ma-sm q-title"},Yo={class:"bg-grey-2"},at={class:"q-ma-sm"},ot={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},tt={key:1,class:"q-item-label q-mt-md",style:{color:"#0c0c0c"}},et={class:"col-12 col-md-4 border-1 q-ma-md"},it={class:"col-8 text-right"},nt={class:"col-3"},rt={class:"col-5"},st={class:"col-8 q-mt-sm text-right"},lt={class:"col-8 q-mt-sm text-right"},dt={class:"col-8 q-mt-sm text-right"},ct={class:"col-8 q-mt-sm text-right"},ut={class:"Fatura-faturamento round-borders q-ma-sm q-pa-md"},mt={class:"round-borders q-ma-sm q-pa-md"};function ft(e,o,u,C,a,d){const _=Q("avatar"),f=Q("documento-codigo"),g=Q("documento-metas"),$=Q("VendaCard"),i=Q("EnvelopeCard"),I=Q("titulo-card"),V=Q("row"),j=Q("campo"),A=Q("faturamento"),K=Q("documentos-fiscais");return h(),N(L,null,[D("div",Zo,[t(da,{class:"Fatura-barra bg-grey-2 q-py-md",color:"black",dark:""},{default:r(()=>[t(pa,null,{default:r(()=>[D("div",Wo,[t(_,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"60"},null,8,["imagem","rotulo"]),D("div",Xo,q(a.fatura.descricaoContato),1)])]),_:1}),a.fatura.id?(h(),T(f,{key:0,documento:a.fatura,class:"q-mx-sm"},null,8,["documento"])):x("",!0),a.fatura.status==="Finalizada"||a.fatura.status!=="Aguardando Pagamento"&&a.fatura.dataHoraFinalizado?(h(),T(B,{key:1,icon:"print",size:"md",color:"primary",round:"",flat:""},{default:r(()=>[t(qa,null,{default:r(()=>[ga((h(),T(Ca,{link:"",separator:""},{default:r(()=>[(h(!0),N(L,null,J(a.configImpressaoFatura,m=>(h(),T(H,{clickable:"",key:m.valor,onClick:n=>e.$imprimir(m.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q(m.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(h(!0),N(L,{key:0},J(a.configImpressaoEnvelope,m=>(h(),T(H,{clickable:"",key:m.valor,onClick:n=>e.$imprimir(m.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q(m.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):x("",!0),(h(!0),N(L,null,J(a.configImpressaoCarne,m=>(h(),T(H,{clickable:"",key:m.valor,onClick:n=>e.$imprimir(m.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q(m.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(h(!0),N(L,null,J(a.configImpressaoConvenio,m=>(h(),T(H,{clickable:"",key:m.valor,onClick:n=>e.$imprimir(m.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q(m.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[ba]])]),_:1})]),_:1})):x("",!0),t(B,{icon:"more_vert",size:"md",color:"tertiary",flat:"",round:""},{default:r(()=>[t(qa,null,{default:r(()=>[t(Ca,{link:"",separator:""},{default:r(()=>[a.fatura.id?(h(),T(H,{key:0,clickable:"",onClick:o[0]||(o[0]=m=>e.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"account_balance"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>o[9]||(o[9]=[M("Emitir cupom")])),_:1})]),_:1})]),_:1})):x("",!0),a.fatura.id&&e.$utils.mapearStatus(a.fatura).permiteNota?(h(),N(L,{key:1},[t(H,{clickable:"",onClick:o[1]||(o[1]=m=>e.emitirNFeV2({idFatura:a.fatura.id},1,"Venda"))},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"account_balance"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>o[10]||(o[10]=[M("NFe de Sa\xEDda/Venda")])),_:1})]),_:1})]),_:1}),t(H,{clickable:"",onClick:o[2]||(o[2]=m=>e.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o"))},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"account_balance"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>o[11]||(o[11]=[M("NFe de Entrada/Devolu\xE7\xE3o")])),_:1})]),_:1})]),_:1}),t(H,{clickable:"",onClick:o[3]||(o[3]=m=>e.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa"))},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"account_balance"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>o[12]||(o[12]=[M("NFe de Remessa")])),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),D("div",Yo,[t(g,{ref:"documentoMetas"},null,512)]),D("div",at,[a.vendas.length>0?(h(),N("p",ot,[t(R,{name:"shopping_cart",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),o[13]||(o[13]=M(" Vendas "))])):x("",!0),(h(!0),N(L,null,J(a.vendas,m=>(h(),N("div",{key:m.id,class:"bg-white q-mt-sm round-borders"},[t($,{id:m.id,onAtualizar:d.atualizar,onExecutar:d.executar},null,8,["id","onAtualizar","onExecutar"])]))),128)),(h(!0),N(L,null,J(a.documentosEnvelope,m=>(h(),N("div",{key:m.id,class:"bg-white q-mt-sm round-borders"},[t(i,{id:m.id,onExecutar:d.executar},null,8,["id","onExecutar"])]))),128)),a.carnes.length>0?(h(),N("p",tt,[t(R,{name:"attach_money",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),o[14]||(o[14]=M(" Titulos (Carn\xEAs/Boletos) "))])):x("",!0),(h(!0),N(L,null,J(a.carnes,m=>(h(),N("div",{key:m.id,class:"bg-white q-mt-sm round-borders"},[t(I,{dados:m,class:"q-mt-md",onExecutar:d.executar},null,8,["dados","onExecutar"])]))),128))]),t(V,{class:"justify-end"},{default:r(()=>[D("div",et,[t(V,{class:"q-col-gutter-md q-mb-sm"},{default:r(()=>[o[15]||(o[15]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Subtotal",-1)),D("strong",it,q(e.$filters.numero(a.fatura.subTotal,2)),1)]),_:1}),a.permissaoDesconto?(h(),T(V,{key:0,class:"q-col-gutter-x-sm"},{default:r(()=>[o[16]||(o[16]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"Desconto",-1)),D("div",nt,[t(j,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[o[4]||(o[4]=m=>a.fatura.totalPercentualDesconto=m),o[5]||(o[5]=m=>d.calculaTotais("descontoPercentual"))],tipo:"decimal",decimals:"2",suffix:"%","somente-leitura":d.descontoSomenteLeitura,error:a.erroCalculo},null,8,["modelValue","somente-leitura","error"])]),D("div",rt,[t(j,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[o[6]||(o[6]=m=>a.fatura.totalDesconto=m),o[7]||(o[7]=m=>d.calculaTotais("desconto"))],tipo:"decimal",decimals:"2","somente-leitura":d.descontoSomenteLeitura,error:a.erroCalculo,errorMessage:a.erroCalculoMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])])]),_:1})):x("",!0),t(V,{class:"q-col-gutter-x-sm q-mt-sm"},{default:r(()=>[o[17]||(o[17]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Total",-1)),D("strong",st,q(e.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1}),a.pesoTotal?(h(),T(V,{key:1,class:"q-col-gutter-x-sm q-mt-sm"},{default:r(()=>[o[18]||(o[18]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Total",-1)),D("span",lt,q(a.pesoTotal),1)]),_:1})):x("",!0),a.pesoBrutoTotal?(h(),T(V,{key:2,class:"q-col-gutter-x-sm q-mt-sm"},{default:r(()=>[o[19]||(o[19]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Bruto Total",-1)),D("span",dt,q(a.pesoBrutoTotal),1)]),_:1})):x("",!0),a.metroCubicoTotal?(h(),T(V,{key:3,class:"q-col-gutter-x-sm q-mt-sm"},{default:r(()=>[o[20]||(o[20]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Metro C\xFAbico Total",-1)),D("span",ct,q(a.metroCubicoTotal),1)]),_:1})):x("",!0)])]),_:1}),D("div",ut,[t(A,{documento:a.fatura,ref:"faturamento",onExecutar:d.executar,onSalvarFatura:d.salvarFatura},null,8,["documento","onExecutar","onSalvarFatura"])]),D("div",mt,[t(K,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])]),t(Ia,{modelValue:a.impressaoVisivel,"onUpdate:modelValue":o[8]||(o[8]=m=>a.impressaoVisivel=m),onKeyup:Va(d.fecharDialogImpressao,["esc"]),persistent:""},{default:r(()=>[t(ja,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"350px","max-width":"400px"}},{default:r(()=>[t(Ha,null,{default:r(()=>[t(da,null,{default:r(()=>[t(B,{icon:"arrow_back",flat:"",round:"",dense:"",onClick:d.fecharDialogImpressao},null,8,["onClick"]),t(pa,null,{default:r(()=>o[21]||(o[21]=[M("Imprimir")])),_:1})]),_:1})]),_:1}),t(Ua,null,{default:r(()=>[t(Qa,null,{default:r(()=>[t(Ca,{link:"",separator:""},{default:r(()=>[(h(!0),N(L,null,J(a.configImpressaoFatura,m=>(h(),T(H,{clickable:"",key:m.valor,onClick:n=>e.$imprimir(m.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q(m.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(h(!0),N(L,{key:0},J(a.configImpressaoEnvelope,m=>(h(),T(H,{clickable:"",key:m.valor,onClick:n=>e.$imprimir(m.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q(m.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):x("",!0),(h(!0),N(L,null,J(a.configImpressaoCarne,m=>(h(),T(H,{clickable:"",key:m.valor,onClick:n=>e.$imprimir(m.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q(m.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(h(!0),N(L,null,J(a.configImpressaoConvenio,m=>(h(),T(H,{clickable:"",key:m.valor,onClick:n=>e.$imprimir(m.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(k,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(k,null,{default:r(()=>[t(U,null,{default:r(()=>[M(q(m.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],64)}var pt=ka(Ko,[["render",ft]]);const vt={components:{CpfCnpjNoCupom:fo,Fatura:pt},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let e;try{e=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let o=await $db.hibrido.le({table:"documento",id:this.id});this.fatura=o,await this.verificarPermissoes(),this.desativarBotoes(),o.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),o.status==="Finalizada"||o.status!=="Aguardando Pagamento"&&o.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(o.idContato,$q.notify)}finally{clearTimeout(e),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(e){e.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizar(e){const u={cpfCnpjNoCupom:this.cpfCnpjNoCupom};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(!1,u)){this.lockEsc=!1;return}await this.$refs.fatura.atualizar(),await this.atualizar(),await this.$refs.fatura.dialogImpressao(),this.$emit("executar","finalizar"),this.fechar()},async executar(e){switch(e){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}if(e==="atualizarSemFechar"){await this.atualizar(),this.runOnHide.push(()=>this.$emit("executar","atualizar")),await this.$forceUpdate();return}this.$emit("executar",e),this.fechar()},fechar(){this.visivel=!1},async executarRecebimentoMultiplos(e){return await this.$refs.fatura.executarRecebimentoMultiplos(e)},async mostrar(e={}){this.id=e.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(e=>e()),this.runOnHide=[]},async salvar(){try{await new Promise((e,o)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{o()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria")}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}};function ht(e,o,u,C,a,d){const _=Q("fatura"),f=Q("CpfCnpjNoCupom");return h(),N("div",null,[t(Ia,{modelValue:a.visivel,"onUpdate:modelValue":o[0]||(o[0]=g=>a.visivel=g),onKeyup:Va(d.voltar,["esc"]),onHide:d.onHide,maximized:"",persistent:""},{default:r(()=>[t(ja,{view:"hHh LpR fFf",container:"",class:"bg-grey-4"},{default:r(()=>[t(Ha,null,{default:r(()=>[t(da,null,{default:r(()=>[ga(t(B,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[ba]]),t(pa,null,{default:r(()=>o[3]||(o[3]=[M("Fatura")])),_:1}),a.visibilidade.botao.salvar?(h(),T(B,{key:0,onClick:d.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):x("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(h(),T(B,{key:1,onClick:d.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):x("",!0)]),_:1})]),_:1}),t(Ua,null,{default:r(()=>[t(Qa,{class:"u-container q-py-md"},{default:r(()=>[a.fatura.id?(h(),T(_,{key:0,onExecutar:d.executar,prop:{id:a.fatura.id},receberTitulo:u.receberTitulo,ref:"fatura"},null,8,["onExecutar","prop","receberTitulo"])):x("",!0)]),_:1})]),_:1}),t(co,{class:"bg-light",bordered:""},{default:r(()=>[t(da,{class:"q-pa-sm u-container"},{default:r(()=>[t(uo),a.visibilidade.botao.reabrir?(h(),T(B,{key:0,onClick:d.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):x("",!0),a.visibilidade.botao.reabrir?ga((h(),T(B,{key:1,label:"Fechar",color:"tertiary",flat:"",class:"q-ml-sm"},null,512)),[[ba]]):x("",!0),a.visibilidade.botao.reabrir?x("",!0):(h(),T(B,{key:2,onClick:d.finalizar,disabled:!a.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),t(f,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":o[1]||(o[1]=g=>a.cpfCnpjNoCupom.visivel=g),onConfirmar:o[2]||(o[2]=g=>d.finalizar()),dados:a.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var Et=ka(vt,[["render",ht]]);export{Et as F,Qo as T};
