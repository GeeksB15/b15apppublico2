import{_ as H,r as v,o as m,p as b,f as o,w as a,a$ as M,a_ as O,b5 as T,k as y,t as _,Q as C,d as E,F as q,x as P,aP as z,e as V,m as B,C as h,A as k,P as R,S as U,T as w,j as F,U as A,H as $,b3 as j,b6 as G,b4 as L,O as I,R as J,N as Q,D as K}from"./index.8ee6d6ae.js";import{F as W,T as X}from"./FaturaModal.c6ade159.js";import{_ as Y}from"./Grafico.bd25a7e8.js";import"./DocumentosFiscais.3df6d17b.js";import"./Campo.85a0edf4.js";import"./compactarValidarNFe.cdd74e0c.js";import"./obterItens.e84b4710.js";import"./codigosANP.a6c1a264.js";import"./VendaCard.ccbaa9d8.js";import"./emitirNFe.35117289.js";import"./ModalHistoricoStatus.0fef7d48.js";import"./EnvelopeCard.701351d8.js";import"./Chart.257de45c.js";const Z={components:{FaturaModal:W,TituloCard:X,Grafico:Y},data(){return{contato:{},tab:"tab-1",graficoMensal:{labels:["Em dia","Dentro do m\xEAs","Fora do m\xEAs","Inadimplente","Outros"],datasets:[{backgroundColor:["green","yellow","orange","red","gray"],data:[0,0,0,0,0]}]},graficoOpcoesMensal:{responsive:!0,maintainAspectRatio:!1},historicoColunas:[{name:"dataPagamento",label:"Data",field:"dataPagamento",sortable:!0,format:this.$filters.data},{name:"formaDePagamento",label:"Forma",field:"formaDePagamento",sortable:!0},{name:"parcela",label:"Parcelas",field:"parcela"},{name:"valor",label:"Valor",field:"valor",format:i=>this.$filters.numero(i,2)}],titulosCliente:[],titulosEmAberto:[],titulosHistorico:[],creditoCliente:{},saldo:0,documentos:{},modalFatura:{idFatura:"",idTitulo:"",titulos:[]},carregandoIdEmpresas:!0,idEmpresasPermissao:[],pagamentoMultiploVisivel:!1,valorPagMultiplo:0}},methods:{async calculaDadosGraficoPizza(){let i=[];const e=await $db.financeiroTitulo.le({idContato:this.contato.id});for(const u of e){const t=(u.dataPagamento||"").substr(0,10),l=(u.dataVencimentoOriginal||"").substr(0,10),c=$utils.dataAtual().substr(0,10);let n="Outros",s="tertiary";l&&(t?t<=l?(n="Em dia",s="positive"):t.substr(0,7)===l.substr(0,7)?(n="Dentro do m\xEAs",s="warning"):(n="Fora do m\xEAs",s="orange"):l<c&&(n="Inadimplente",s="negative")),i.push({eixo:n,cor:s,valor:u.valorRealizado||0,dataPagamento:t,data:t||(u.dataVencimento||"").substr(0,10),dataVencimentoOriginal:l})}let r={"Em dia":{q:0,v:0},"Dentro do m\xEAs":{q:0,v:0},"Fora do m\xEAs":{q:0,v:0},Inadimplente:{q:0,v:0},Outros:{q:0,v:0}};for(const u of i)r[u.eixo].q+=1,r[u.eixo].v+=u.valor;this.graficoMensal.datasets[0].data=[r["Em dia"].q,r["Dentro do m\xEAs"].q,r["Fora do m\xEAs"].q,r.Inadimplente.q,r.Outros.q],this.titulosCliente=i},executar(i){this.atualizar()},async receberTitulo(i,e=!1){let r=[],u=[],t=await $db.contato.le({id:i.idEmpresa}),l={},c=await $db.contato.le({id:i.idContato}),n={},s={};t.id||this.$q.notify("Erro ao recuperar informa\xE7\xF5es da Empresa."),r=await $db.contatoEndereco.leNew({idContato:t.id}),r.length&&(l=r[0]),c.id||this.$q.notify("Erro ao recuperar informa\xE7\xF5es do Contato."),r=await $db.contatoEndereco.leNew({idContato:c.id}),u=await $db.contatoTelefone.leNew({idContato:c.id}),r.length&&(n=r[0]),u.length&&(s=u[0]);let p=await $db.fatura.leV2({status:"Aberta",idContato:c.id,idEmpresa:t.id});for(const f of $lodash.orderBy(p,"dataHoraEmissao","desc")){if(e)return f.id;try{this.modalFatura={idTitulo:i.id},await this.$refs.faturaModal.mostrar({id:f.id}),e&&await this.$refs.faturaModal.fechar()}catch(x){this.$q.notifyError("N\xE3o foi poss\xEDvel adicionar este t\xEDtulo a uma fatura.",x)}await this.$forceUpdate();return}try{let f={id:$utils.uuid(),status:"Aberta",tipo:"Fatura",dataHoraEmissao:$utils.dataAtual(),calcularAutomatico:"Sim",idEmpresa:t.id,descricaoEmpresa:t.nome||"",numeroDocumentoEmpresa:t.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:t.numeroDocumentoMunicipal||"",idEmpresaEndereco:l.id||"",idContato:c.id,descricaoContato:c.nome||"",idContatoEndereco:n.id||"",numeroDocumentoContato:c.numeroDocumentoNacional||"",descricaoContatoEndereco:"".concat(n.logradouro||"",", ",n.numero||""," ",n.complemento||""," - ",n.bairro||""," - ",n.cep||""," - ",n.municipio||"","/",n.uf||""),telefoneContato:s.telefone||"",emailContato:c.email||"",regimeContato:c.regime||"",observacaoFaturamento:"",optanteSimplesNacional:t.regime==="SimplesNacional"?"1":"0",freteSeparado:!1,operacao:"Faturamento",tipoFrete:"CIF",totalDesconto:0,totalPercentualDesconto:0,subTotal:0,totalDocumento:0};if(await $db.documento.grava({atual:f}),e)return f.id;this.modalFatura={idTitulo:i.id},this.$refs.faturaModal.mostrar({id:f.id})}catch(f){this.$q.notifyError("N\xE3o foi poss\xEDvel adicionar este t\xEDtulo a uma fatura.",f)}await this.$forceUpdate()},async atualizar(){var c,n;if(this.contato=await $erp().contato.get((c=this.$route.params.id)!=null?c:""),!((n=this.contato)!=null&&n.id))return;this.titulosEmAberto=[],this.titulosHistorico=[];const i=await $db.financeiroTitulo.le({idContato:this.contato.id,emAberto:!0}),e=await $db.financeiroTitulo.le({idContato:this.contato.id,emAberto:!1});this.titulosEmAberto=$lodash.orderBy(i,"dataVencimento","asc"),this.titulosHistorico=$lodash.orderBy(e,"dataPagamento","desc"),this.carregandoIdEmpresas=!0,$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(s=>{this.idEmpresasPermissao=s.data.map(p=>p.id),this.carregandoIdEmpresas=!1});let r=await $db.contatoCreditoExtrato.le({idContato:this.contato.id});r=$lodash.orderBy(r,"dataEmissao","asc");let u=0,t={};r=r.filter(s=>s.tipo==="Cr\xE9dito Devolu\xE7\xE3o").reduce((s,p)=>{const f=this.$filters.data(p.dataEmissao);return s[f]||(s[f]=[]),p.documentoId&&!t[p.documentoId]&&(t[p.documentoId]=$db.hibrido.le({table:"documento",id:p.documentoId})),u+=p.creditoDevolucao,p.saldo=$utils.arredondar(u),s[f].push(p),s},{}),this.saldo=$utils.arredondar(u);let l={};for(const s in t)l[s]=await t[s];this.documentos=l,this.creditoCliente=r,await this.calculaDadosGraficoPizza()},async gerarPagamentoMultiplo(){if(this.valorPagMultiplo<=0){$q.notifyError("O valor informado deve ser maior que 0"),this.valorPagMultiplo=0;return}const i=[],e=await this.selecionarEmpresa(),r=this.titulosEmAberto.filter(l=>l.idEmpresa===e.id);if(!r.length){$q.notifyError("N\xE3o h\xE1 titulos pendentes para a empresa Selecionada."),this.valorPagMultiplo=0;return}let u=0;r.forEach(l=>{u<this.valorPagMultiplo&&!l.idFatura&&(i.push(l),u+=l.valorTotal)});const t=await this.receberTitulo(r[0],!0);this.modalFatura={idTitulo:i.map(l=>l.id)},await this.$refs.faturaModal.mostrar({id:t}),await this.$forceUpdate()},async selecionarEmpresa(){const i={ativo:!0,empresas:!0},e=await $g.promptContato.show({filtro:i,placeholder:"Selecione"});if(!e)throw new Error("Nenhum contato selecionado");return e},pagamentoMultiploModal(){this.pagamentoMultiploVisivel=!0,this.valorPagMultiplo=0}},watch:{"$route.params.id"(){this.atualizar()}},mounted(){this.atualizar()}},tt={class:"AtendimentoFinanceiro"},ot={class:"q-mt-md q-mb-md text-h6"},et={header:"",class:"text-weight-bold"},at={key:0,style:{margin:"0","text-align":"right",color:"red"},class:"text-weight-bold"},it={key:1,style:{margin:"0","text-align":"right",color:"#4caf50"},class:"text-weight-bold"},rt={key:2,style:{margin:"0","text-align":"right",color:"red"}},lt={key:3,style:{margin:"0","text-align":"right"}},st={class:"col-12 col-md-6"},nt={class:"col-12 col-md-6"},dt={key:0},ut={key:1};function mt(i,e,r,u,t,l){const c=v("g-label"),n=v("g-col"),s=v("g-row"),p=v("TituloCard"),f=v("badge"),x=v("grafico"),D=v("row"),N=v("FaturaModal"),S=v("campo");return m(),b("div",tt,[o(O,{modelValue:t.tab,"onUpdate:modelValue":e[0]||(e[0]=d=>t.tab=d),align:"left",class:"text-primary border-bottom q-px-sm"},{default:a(()=>[o(M,{label:"Em aberto",name:"tab-1"}),o(M,{label:"Cr\xE9dito do Cliente",name:"tab-2"}),o(M,{label:"Hist\xF3rico",name:"tab-3"})]),_:1},8,["modelValue"]),o(L,{modelValue:t.tab,"onUpdate:modelValue":e[2]||(e[2]=d=>t.tab=d),animated:""},{default:a(()=>[o(T,{name:"tab-1",class:"bg-light q-py-none q-px-sm"},{default:a(()=>[o(s,{gutter:"sm",items:"center",justify:"end",bg:"bg-white",style:{"margin-bottom":"8px"}},{default:a(()=>[o(n,{col:"grow"},{default:a(()=>[o(c,{text:"h5 bold",inline:""},{default:a(()=>[y(_(i.$filters.numero(t.titulosEmAberto.reduce((d,g)=>d+g.valorTotal,0),2))+" ",1),o(c,{text:"caption medium"},{default:a(()=>e[6]||(e[6]=[y("Total")])),_:1})]),_:1})]),_:1}),o(n,{col:"shrink"},{default:a(()=>[o(C,{onClick:e[1]||(e[1]=d=>l.pagamentoMultiploModal()),icon:"attach_money",label:"Receber v\xE1rios",color:"primary",class:"float-right"})]),_:1})]),_:1}),t.titulosEmAberto.length?(m(),E(s,{key:0},{default:a(()=>[(m(!0),b(q,null,P(t.titulosEmAberto,d=>(m(),E(n,{key:d.id,col:"12"},{default:a(()=>[o(p,{onExecutar:l.executar,dados:d,class:"q-my-sm"},{default:a(()=>[t.carregandoIdEmpresas?(m(),E(z,{key:0,dense:"",flat:"",class:"no-shadow q-ma-xs float-right"})):V("",!0),!t.carregandoIdEmpresas&&!d.cheque&&t.idEmpresasPermissao.includes(d.idEmpresa)?(m(),E(C,{key:1,onClick:g=>l.receberTitulo(d),icon:"save_alt",size:"md",color:"primary",dense:"",flat:"",rounded:""},{default:a(()=>[o(B,{anchor:"bottom middle",self:"center middle"},{default:a(()=>e[7]||(e[7]=[y("Receber")])),_:1})]),_:2},1032,["onClick"])):V("",!0)]),_:2},1032,["onExecutar","dados"])]),_:2},1024))),128))]),_:1})):(m(),E(s,{key:1},{default:a(()=>[o(n,{col:"12"},{default:a(()=>[o(c,{text:"sub1 medium center",class:"q-pa-md"},{default:a(()=>e[8]||(e[8]=[y(" N\xE3o h\xE1 titulos em aberto para este contato ")])),_:1})]),_:1})]),_:1}))]),_:1}),o(T,{class:"bg-white",name:"tab-2"},{default:a(()=>[h("div",ot," Saldo R$ "+_(i.$filters.numero(t.saldo,2)),1),o(k,{class:"no-shadow"},{default:a(()=>[(m(!0),b(q,null,P(Object.keys(t.creditoCliente),d=>(m(),b("div",{key:d,class:"q-pa-none text-left"},[h("label",et,_(d),1),o(R,{highlight:"",style:{width:"100%"}},{default:a(()=>[(m(!0),b(q,null,P(t.creditoCliente[d],g=>(m(),E(U,{key:g.id},{default:a(()=>[g.creditoDevolucao<0?(m(),E(w,{key:0,avatar:""},{default:a(()=>[o(F,{name:"trending_down",color:"red"})]),_:1})):(m(),E(w,{key:1,icon:"trending_up",avatar:""},{default:a(()=>[o(F,{name:"trending_up",color:"green-6"})]),_:1})),o(w,null,{default:a(()=>[o(A,null,{default:a(()=>[y(_(g.documentoTipo),1)]),_:2},1024),o(A,{caption:""},{default:a(()=>e[9]||(e[9]=[y(" Saldo ")])),_:1})]),_:2},1024),o(w,{avatar:""},{default:a(()=>[o(f,{class:"q-mx-sm",escuro:"",cor:"green-6",denso:"",round:""},{default:a(()=>[y(" #"+_(parseInt((t.documentos[g.documentoId]||{}).numero)||(g.documentoId||"").slice(-6)),1)]),_:2},1024)]),_:2},1024),o(w,{right:""},{default:a(()=>[g.creditoDevolucao<0?(m(),b("p",at,_(i.$filters.numero(g.creditoDevolucao,2)),1)):(m(),b("p",it,_(i.$filters.numero(g.creditoDevolucao,2)),1)),g.saldo<0?(m(),b("p",rt,[h("small",null,_(i.$filters.numero(g.saldo,2)),1)])):(m(),b("p",lt,[h("small",null,_(i.$filters.numero(g.saldo,2)),1)]))]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]))),128))]),_:1})]),_:1}),o(T,{class:"bg-white",name:"tab-3"},{default:a(()=>[o(D,null,{default:a(()=>[h("div",st,[$(h("div",null,[e[10]||(e[10]=h("div",{class:"text-h6 text-tertiary"}," Perfil ",-1)),o(D,{class:"q-mt-md"},{default:a(()=>[o(x,{type:"pie",data:t.graficoMensal,options:t.graficoOpcoesMensal,class:"col-12"},null,8,["data","options"])]),_:1})],512),[[j,t.titulosCliente.length]])]),h("div",nt,[e[11]||(e[11]=h("div",{class:"text-h6 text-tertiary"}," Hist\xF3rico ",-1)),t.titulosHistorico.length?(m(),b("div",dt,[o(G,{columns:t.historicoColunas,rows:t.titulosHistorico,"rows-per-page-options":[12],grid:""},null,8,["columns","rows"])])):(m(),b("div",ut," N\xE3o h\xE1 titulos pagos "))])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(N,{receberTitulo:{id:t.modalFatura.idTitulo},onExecutar:l.executar,ref:"faturaModal"},null,8,["receberTitulo","onExecutar"]),o(K,{ref:"pagamentoMultiplo",modelValue:t.pagamentoMultiploVisivel,"onUpdate:modelValue":e[5]||(e[5]=d=>t.pagamentoMultiploVisivel=d),persistent:""},{default:a(()=>[o(k,{style:{"min-width":"350px"}},{default:a(()=>[o(I,null,{default:a(()=>e[12]||(e[12]=[h("div",{class:"text-h6"},"Qual o valor a receber?",-1)])),_:1}),o(I,{class:"q-pt-none"},{default:a(()=>[o(S,{rotulo:"Valor a receber",modelValue:t.valorPagMultiplo,"onUpdate:modelValue":e[3]||(e[3]=d=>t.valorPagMultiplo=d),decimals:"4",value:"0",prefix:"R$",tipo:"decimal"},null,8,["modelValue"])]),_:1}),o(J,{align:"right",class:"text-primary"},{default:a(()=>[$(o(C,{flat:"",label:"Cancelar",color:"tertiary"},null,512),[[Q]]),$(o(C,{flat:"",label:"Receber",onClick:e[4]||(e[4]=d=>l.gerarPagamentoMultiplo()),class:"bg-primary",textColor:"white"},null,512),[[Q]])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var Mt=H(Z,[["render",mt]]);export{Mt as default};
