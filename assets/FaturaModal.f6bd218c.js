import{_ as Ma,r as J,o as v,p as z,f as t,w as n,C as E,h as sa,i as ma,k as M,t as P,d as q,cL as Za,e as x,j as A,m as ua,Q as L,B as Aa,bg as _a,H as ba,P as ga,F as j,u as K,S as U,T as k,U as Q,N as $a,l as Ba,z as Wa,O as Xa,E as Ya,bs as ka,D as Va,v as ao,a as oo,cQ as to,cR as eo,cS as io,cT as no,M as Sa,G as La,I as ja,J as Ha,K as ro,aW as so}from"./index.91387095.js";import{D as lo,C as co}from"./DocumentosFiscais.83e196b9.js";import{e as uo}from"./emitirNFe.35117289.js";import{V as mo}from"./VendaCard.5a0f65b0.js";import{E as fo}from"./EnvelopeCard.f6912f92.js";const po={computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{titulo:{},tituloOriginal:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,campos:{valorMulta:0},rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(e){this.$router.push({name:"AtendimentoFatura",params:{id:e}})},async migrarFatura(e){try{await new Promise((i,d)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{i()}).onCancel(()=>{d()})})}catch{return}if(!e&&this.titulo.idContato&&this.titulo.idEmpresa){const i=await $erp().contato.get(this.titulo.idContato)||{};let d=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),C=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();d=d.find(V=>(V.grupo||"").trim().toLowerCase()==="Principal")||d[0]||{},C=C.find(V=>(V.tipoTelefone||"").trim().toLowerCase()==="Principal")||C[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let c=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();c=c.find(V=>V.grupo.trim().toLowerCase()==="Principal")||c[0]||{},e=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:c.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:i.id,idContatoEndereco:d.id||"",numeroDocumentoContato:i.numeroDocumentoNacional||"",descricaoContato:i.nome||"",descricaoContatoEndereco:"".concat(d.logradouro||"",", ",d.numero||""," ",d.complemento||""," - ",d.bairro||""," - ",d.cep||""," - ",d.municipio||"","/",d.uf||""),telefoneContato:C.telefone||"",emailContato:i.email||"",regimeContato:i.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:e})}e.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:e.id},original:this.titulo}),localStorage.setItem("idFatura",e.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(this.titulo.valorDesconto===this.tituloOriginal.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){const e=Number(this.titulo.diasEmAtraso)||0;let i=0;e>0&&(i=Number(this.titulo.valorMulta)||0),this.modalEditar={visivel:!0,campos:{valorMulta:i},rules:[]}},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},cancelarDesconto(){this.titulo=$utils.clonar(this.tituloOriginal),this.modalEditar.visivel=!1},async desconto(){const e=this.titulo.valorDesconto;let i=0,d=0,C=0,a=Number(this.titulo.diasEmAtraso)||0;const c=Number(this.titulo.valor)||0;if(a<0&&(a=0),a>0&&(d=Number(this.titulo.valorMulta)||0,i=Number(this.titulo.valorJuros)||0,C=$utils.arredondar(d+i*a)),await $db.permissao.objeto("PadraoNovo_Financeiro")&&(C=$utils.arredondar(c+d+i*a)),e<0||e>C){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"];return}this.modalEditar.rules=[()=>!0];const o=$utils.arredondar(c-e+d+i*a),g=$utils.arredondar(e*100/(c||1));this.titulo.valorTotal=o,this.titulo.valorARealizar=o,this.titulo.percentualDesconto=g},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((e,i)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{i()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")}},props:{dados:{required:!0,type:Object}},async mounted(){const e=new Date(this.dados.dataVencimento).setHours(0,0,0,0),i=new Date().setHours(0,0,0,0);e<i?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,C=>C!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $db.hibrido.le({table:"documento",id:this.titulo.documentoId})),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(C=>this.visibilidade.botao.editar=C&&!this.tituloOriginal.valorRealizado),this.contatos={};const d={};if(this.titulo.idContato){const C=await $db.contato.le({id:this.titulo.idContato});C&&(d[this.titulo.idContato]=C)}if(this.titulo.idEmpresa){const C=await $db.contato.le({id:this.titulo.idEmpresa});C&&(d[this.titulo.idEmpresa]=C)}this.contatos=d,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leNew({id:this.titulo.idFatura}).then(C=>{this.fatura=C,C.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(V=>V.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},vo={class:"col-12 col-md-6 q-pl-none"},ho=E("br",null,null,-1),Co={class:"col-4 col-md"},go={key:0,class:"q-my-none"},bo={class:"q-my-none"},$o={class:"q-my-none"},Fo={class:"col-4 col-md text-right"},Eo={class:"col-4 col-md text-right"},Do={class:"col-12 col-md"},wo={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},_o={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},Po={class:"col-12 col-md-6"},qo={class:"text-body2"},yo={class:"col-12 col-md-6 text-right hideonmobile"},To={class:"col-12 text-right"},xo={class:"col-12 col-md-6"},Mo={class:"text-body2 q-my-none q-mb-md"},ko={class:"col-12 col-sm-4 col-md-2"},Vo={class:"text-left q-my-none"},Io={class:"col-6 col-md-1"},zo={class:"text-left q-my-none"},No={class:"col-6 col-md-1"},Oo={class:"text-left q-my-none"},Ro={class:"col-12 col-sm-4 col-md-2 text-right"},Ao=E("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1),Bo={class:"q-ma-none"},So={class:"q-mt-xs"},Lo=E("small",{class:"block text-caption"},"Multa",-1),jo={class:"q-mt-xs"},Ho=E("small",{class:"block text-caption"},"Juros",-1),Uo={class:"q-mt-lg text-right q-gutter-md"};function Qo(e,i,d,C,a,c){const V=J("avatar"),o=J("row"),g=J("campo");return v(),z("div",{class:ao([a.tema,"extratoItem bg-white q-pa-sm no-shadow"])},[t(o,{class:"items-center q-mx-none q-px-none q-mb-sm text-tertiary"},{default:n(()=>{var b;return[E("div",vo,[t(sa,{class:"q-pa-none"},{default:n(()=>[t(V,{imagem:(a.contatos[a.titulo.idContato]||{}).imagem,rotulo:(a.contatos[a.titulo.idContato]||{}).apelido,tamanho:"30"},null,8,["imagem","rotulo"]),t(ma,null,{default:n(()=>[M(P((a.contatos[a.titulo.idContato]||{}).apelido)+" ",1),ho]),_:1}),a.titulo.parcela?(v(),q(Za,{key:0,rounded:"",color:"tertiary",small:""},{default:n(()=>[M(P(a.titulo.parcela),1)]),_:1})):x("",!0)]),_:1})]),E("div",Co,[a.titulo.documentoCodigo?(v(),z("p",go,P(a.titulo.documentoTipo)+" #"+P((b=a.documento)==null?void 0:b.numero),1)):x("",!0),E("p",bo,P(a.titulo.formaDePagamento),1),E("p",$o,P(a.titulo.descricaoPlanoConta),1)]),E("div",Fo,[a.titulo.dataVencimentoOriginal?(v(),q(A,{key:0,name:"mdi-calendar-today"})):x("",!0),M(" "+P(e.$filters.data(a.titulo.dataVencimentoOriginal))+" ",1),t(ua,null,{default:n(()=>[M("Vencimento original")]),_:1})]),E("div",Eo,[a.titulo.dataVencimento?(v(),q(A,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+P(e.$filters.data(a.titulo.dataVencimento))+" ",1),t(ua,null,{default:n(()=>[M("Vencimento")]),_:1})]),E("div",Do,[E("p",wo,P(e.$filters.numero(a.titulo.valorTotal,2)),1),E("p",_o,P(e.$filters.numero(a.titulo.valor,2)),1)])]}),_:1}),t(o,{class:"items-center justify-end"},{default:n(()=>[E("div",Po,[E("div",qo,P(a.titulo.descricao),1)]),E("div",yo,[a.visibilidade.botao.remover?(v(),q(L,{key:0,onClick:c.remover,icon:"clear",color:"tertiary",round:"",dense:"",flat:""},{default:n(()=>[t(ua,null,{default:n(()=>[M(" Remover da Fatura #"+P(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):x("",!0),t(L,{onClick:c.alternarDetalhes,icon:`keyboard_arrow_${a.detalhes?"up":"down"}`,color:"tertiary",round:"",dense:"",flat:""},null,8,["onClick","icon"]),a.visibilidade.botao.editar?(v(),q(L,{key:1,onClick:c.editar,icon:"edit",color:"primary",round:"",dense:"",flat:""},null,8,["onClick"])):x("",!0),Aa(e.$slots,"default"),c.mostrarMenuTresPontos?(v(),q(L,{key:2,icon:"more_vert",color:"tertiary",rounded:"",dense:"",flat:""},{default:n(()=>[t(_a,null,{default:n(()=>[ba((v(),q(ga,{link:"",separator:""},{default:n(()=>[a.mostrarOpcaoMigrarFatura?(v(),z(j,{key:0},[(v(!0),z(j,null,K(a.faturasAbertas,b=>(v(),q(U,{clickable:"",key:b.id,onClick:y=>c.migrarFatura(b)},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"mdi-folder-move"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P("Migrar para fatura #"+(b.numero||b.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(U,{clickable:"",onClick:i[0]||(i[0]=b=>c.migrarFatura())},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"mdi-folder-move"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M("Migrar para nova fatura")]),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})),[[$a]])]),_:1})]),_:1})):x("",!0)])]),_:3}),t(Ba,{class:"hideondesktop q-mb-sm q-mt-xs"}),t(o,{class:"q-mx-none q-px-none hideondesktop"},{default:n(()=>[E("div",To,[a.visibilidade.botao.remover?(v(),q(L,{key:0,onClick:c.remover,icon:"clear",color:"tertiary",round:"",dense:"",flat:""},{default:n(()=>[t(ua,null,{default:n(()=>[M(" Remover da Fatura #"+P(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):x("",!0),t(L,{onClick:c.alternarDetalhes,round:"",dense:"",flat:"",color:"tertiary",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`},null,8,["onClick","icon"]),a.visibilidade.botao.editar?(v(),q(L,{key:1,onClick:c.editar,icon:"edit",color:"primary",round:"",dense:"",flat:""},null,8,["onClick"])):x("",!0),Aa(e.$slots,"default"),c.mostrarMenuTresPontos?(v(),q(L,{key:2,round:"",dense:"",flat:"",icon:"more_vert",color:"tertiary"},{default:n(()=>[t(_a,null,{default:n(()=>[ba((v(),q(ga,{link:"",separator:""},{default:n(()=>[a.mostrarOpcaoMigrarFatura?(v(),z(j,{key:0},[(v(!0),z(j,null,K(a.faturasAbertas,b=>(v(),q(U,{clickable:"",key:b.id,onClick:y=>c.migrarFatura(b)},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"mdi-folder-move"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P("Migrar para fatura #"+(b.numero||b.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(U,{clickable:"",onClick:i[1]||(i[1]=b=>c.migrarFatura())},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"mdi-folder-move"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M("Migrar para nova fatura")]),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})),[[$a]])]),_:1})]),_:1})):x("",!0)])]),_:3}),a.detalhes?(v(),q(Ba,{key:0,class:"hideondesktop q-my-sm"})):x("",!0),a.detalhes?(v(),q(o,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:n(()=>[E("div",xo,[t(sa,{class:"u-autoHeight q-pa-none",color:"none",dark:""},{default:n(()=>[t(A,{name:"business"}),t(ma,null,{default:n(()=>[M(P((a.contatos[a.titulo.idEmpresa]||{}).apelido),1)]),_:1})]),_:1}),E("p",Mo,P(a.titulo.observacao),1)]),E("div",ko,[E("p",Vo,P(a.titulo.descricaoCentroCusto),1)]),E("div",Io,[E("p",zo,[a.titulo.dataEmissao?(v(),q(A,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+P(e.$filters.data(a.titulo.dataEmissao))+" ",1),t(ua,null,{default:n(()=>[M("Emiss\xE3o")]),_:1})])]),E("div",No,[E("p",Oo,[a.titulo.dataCompetencia?(v(),q(A,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+P(e.$filters.data(a.titulo.dataCompetencia))+" ",1),t(ua,null,{default:n(()=>[M("Compet\xEAncia")]),_:1})])]),E("div",Ro,[Ao,E("p",Bo,P(e.$filters.numero(a.titulo.valorDesconto||0,2)),1),a.titulo.diasEmAtraso?(v(),z(j,{key:0},[E("div",So,[Lo,E("strong",null,P(e.$filters.numero(a.titulo.valorMulta||0,2))+" ("+P(e.$filters.numero(a.titulo.percentualMulta||0,2))+"%) ",1)]),E("div",jo,[Ho,E("strong",null,P(e.$filters.numero(a.titulo.valorTotalJuros||0,2))+" ("+P(e.$filters.numero(a.titulo.percentualJuros||0,2))+"% dia) ",1)])],64)):x("",!0)])]),_:1})):x("",!0),t(Va,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":i[8]||(i[8]=b=>a.modalEditar.visivel=b),onKeyup:ka(c.cancelarDesconto,["esc"]),persistent:""},{default:n(()=>[t(Wa,{style:{"min-width":"30vw"}},{default:n(()=>[t(sa,{class:"bg-primary text-white"},{default:n(()=>[t(ma,null,{default:n(()=>[M("Editar T\xEDtulo")]),_:1})]),_:1}),t(Xa,null,{default:n(()=>[t(Ya,{onSubmit:c.salvar,class:"q-pa-lg q-gutter-md"},{default:n(()=>[t(g,{modelValue:a.titulo.valor,"onUpdate:modelValue":i[2]||(i[2]=b=>a.titulo.valor=b),rotulo:"Valor",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),t(g,{modelValue:a.titulo.diasEmAtraso,"onUpdate:modelValue":i[3]||(i[3]=b=>a.titulo.diasEmAtraso=b),rotulo:"Dias em Atraso",tipo:"decimal",decimals:"0",zerosDireita:"0",zeros:"","somente-leitura":"",outlined:""},null,8,["modelValue"]),t(g,{modelValue:a.modalEditar.campos.valorMulta,"onUpdate:modelValue":i[4]||(i[4]=b=>a.modalEditar.campos.valorMulta=b),ajuda:`Multa de R$ ${e.$filters.numero(a.titulo.valorMulta,2)}`,rotulo:"Multa",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),t(g,{modelValue:a.titulo.valorTotalJuros,"onUpdate:modelValue":i[5]||(i[5]=b=>a.titulo.valorTotalJuros=b),ajuda:`Juros ao ${a.titulo.tipoJuros} de R$ ${e.$filters.numero(a.titulo.valorJuros,2)}`,rotulo:"Juros",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),t(g,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[i[6]||(i[6]=b=>a.titulo.valorDesconto=b),c.desconto],rotulo:"Desconto",tipo:"decimal",decimals:"2",rules:a.modalEditar.rules,outlined:""},null,8,["modelValue","onUpdate:modelValue","rules"]),t(g,{modelValue:a.titulo.valorTotal,"onUpdate:modelValue":i[7]||(i[7]=b=>a.titulo.valorTotal=b),rotulo:"Total",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),E("div",Uo,[t(L,{color:"tertiary",flat:"",unelevated:"",label:"Cancelar",onClick:c.cancelarDesconto},null,8,["onClick"]),t(L,{color:"primary",unelevated:"",label:"Salvar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],2)}var Jo=Ma(po,[["render",Qo]]),Go={async enviar(e,i){var d,C;try{const a=i.nome.replace("enviaemail.fatura.",""),c=(d=i.valor)!=null?d:"Impresso",V=(C=i.texto)!=null?C:`Voc\xEA est\xE1 recebendo o ${c} da empresa ${e.descricaoEmpresa}.`,o=await $db.contato.le({id:e.idContato}),g=await $utils.impressaoObterHtml(a,e),b={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:String(o==null?void 0:o.email).trim().toLowerCase(),assunto:`${c}`,mensagem:`${V}`},y=`${c} enviado para ${b.para}, com sucesso!.`,B=`Erro ao enviar e-mail. ${c} n\xE3o enviado.`;$q.loading.show({message:`Enviando ${c} por e-mail...`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const N=[{name:`${c}.pdf`,content:g,method:"html2pdf"}],H={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:b.de,to:b.para,subject:b.assunto,text:b.mensagem,attachments:N},u=await oo({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:H});$q.notifyPositive((u==null?void 0:u.status)===200&&y?y:u.data.message)}catch(a){$q.notifyError(errorMsg||"Erro ao enviar e-mail",a)}finally{$q.loading.hide()}}},Ko={async finalizar(e,i){var d,C,a,c,V;try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!e)try{await new Promise((s,l)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{s()}).onCancel(()=>{l()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const o=$utils.clonar(this.fatura),g=$utils.clonar(this.vendas),b=$utils.clonar(this.documentosEnvelope),y=$utils.clonar(this.carnes),B=[...g,...b].map(s=>s.id),N=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:B}}),H=$utils.clonar(N);if(y.length>0){const s=y.reduce((l,$)=>($.idFinanceiroBoleto&&$.codigoFinanceiroTitulo&&(l+=String($.codigoFinanceiroTitulo)+";"),l),"");if(s)try{$q.loading.show({message:"Baixando boletos..."});const l=`exec sp_Financeiro_BoletoBaixar '${s.slice(0,-1)}'`,$=await $utils.executarSql(l)}catch(l){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",l);return}finally{$q.loading.hide()}}const u=e?o.dataHoraFinalizado:$utils.dataAtual(),T=u,r=await $db.hibrido.le({table:"documento",id:this.$refs.faturamento.idDocumentoCaixa}),p=await $db.formaPagamento.le();this.documentoStatus=[],await this.$refs.faturamento.validar();let m=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(s=>s.valor),["idFormaPagamento","autorizacao","dataVencimento"]);$utils.verificarErro(g.some(s=>!s.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o.");const O=$utils.arredondar(this.carnes.reduce((s,l)=>s+(l.valorARealizar||0),0)),S=$utils.arredondar(m.reduce((s,l)=>s+(l.valor||0),0));let la=0;if(e&&(m=m.filter(s=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(l=>l.id===s.id))),o.totalDocumento>=0){if(this.carnes.length){if(S<O)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const l=m.reduce(($,D)=>{const w=`${D.autorizacao||""}${D.documento||""}${D.idFormaPagamento}`;return $[w]||($[w]={parcelas:0,formaPagamento:D.formaPagamento}),$[w].parcelas++,$},{});for(const $ in l)if(l[$].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${l[$].formaPagamento} acima do permitido.`),!1}}S<o.totalDocumento&&(la=1)}let na=la===1?"Aguardando Pagamento":"Finalizada";if(!e){this.documentoStatus.push({id:$utils.uuid(),idDocumento:o.id,operacao:"Fatura",statusOriginal:o.status,statusFinalizado:na,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:r.id||""}),o.status=na,o.dataHoraFinalizado=u,na="Faturado";const s=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",o.idEmpresa,0))||0;let l=0,$=b.filter(f=>f.status!=="Entregue").length,D=!1,w=!0;if(g.length>0&&s&&(this.$q.loading.hide(),await new Promise((f,F)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{w=!0,f()}).onCancel(()=>{w=!1,f()})}),this.$q.loading.show({message:"Processando..."})),$){let f="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";$>1&&(f=`Nesta Fatura h\xE1 ${$} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise((F,_)=>{this.$q.dialog({cancel:"N\xE3o",message:f,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{D=!0,F()}).onCancel(()=>{_()})})}catch{}this.$q.loading.show({message:"Processando..."})}let h=0;h=$utils.arredondar(H.reduce((f,F)=>(F.total>0&&(f+=F.total),f),h));for(const f of[...g,...b])f.tipo==="Envelope"&&D&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:f.id,operacao:f.operacao,statusOriginal:f.status,statusFinalizado:"Entregue",dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),f.status="Entregue"),f.tipo==="Venda"&&w&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:f.id,operacao:f.operacao,statusOriginal:f.status,statusFinalizado:na,dataHoraEmissao:u,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:r.id||""}),f.status="Faturado");for(const f of H){const F=[...g,...b].find(_=>_.id===f.idDocumento);if(f.status=F.status,f.total>0){f.quantidade=f.quantidade||1,f.valorItem=f.valorItem||0,f.descontoItem=f.descontoItem||0,f.descontoTotalRateado=f.descontoTotalRateado||0;let _=(f.valorItem-f.descontoItem)*f.quantidade-f.descontoTotalRateado;const I=$utils.arredondar((o.totalDesconto||0)*_/(h||1)||0);f.descontoFaturaRateado=$utils.arredondar(I),f.valorRealTotal=$utils.arredondar(_-I),f.valorReal=$utils.arredondar(f.valorRealTotal/f.quantidade),l+=I}}if(this.documentosItem=H,this.documentosItemOriginal=N,o.totalDesconto!==$utils.arredondar(l)){const f=$utils.arredondar((o.totalDesconto||0)-(l||0));let F,_=0;for(const I of H)I.total>_&&(_=I.total,F=I);if(F){const I=(F.descontoFaturaRateado||0)+(f||0),W=((F.valorItem||0)-(F.descontoItem||0))*(F.quantidade||1)-(F.descontoTotalRateado||0)-(I||0),da=(W||0)/(F.quantidade||1);F.descontoFaturaRateado=$utils.arredondar(I),F.valorReal=$utils.arredondar(da),F.valorRealTotal=$utils.arredondar(W)}}}const Pa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),ea=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Pa}),fa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let Y=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:fa});const Fa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Fa}),pa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),va=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:pa}),qa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),G=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:qa}),Ua=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Ia=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ua}),Qa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),za=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Qa}),Ja=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),Ea=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ja}),Ga=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),Ka=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ga}),ya=(d=this.contatos[o.idContato])==null?void 0:d.descontoCondicionadoPercentual;let ra=g.reduce((s,l)=>s+l.totalDocumento,0);ra=ra+b.reduce((s,l)=>s+l.totalDocumento,0),ra=$utils.arredondar(ra-o.totalDesconto);let ia=o.totalDocumento,X=[];const R=[],Na=[],Da=[],Oa=[];let ha=1,Ta="",wa=1,oa="";for(const s of m.filter(l=>!l.sinal)){s.sinal=s.sinal||la;const l=p.filter($=>$.id===s.idFormaPagamento)[0];if(ia<0)oa=$utils.uuid(),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idContato:o.idContato,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:G.id,dataEmissao:u,valorCredito:0,valorDebito:$utils.arredondar(ia*-1),descricao:G.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${o.id})`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idContato:o.idContato,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:Ka.id,dataEmissao:u,valorCredito:$utils.arredondar(ia*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${o.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id});else{if(Ta!==s.idFormaPagamento+s.autorizacao&&(Ta=s.idFormaPagamento+s.autorizacao,ha=1,wa=m.reduce(($,D)=>D.idFormaPagamento+D.autorizacao===Ta?$+1:$,0)),l.tipoFinanceiro==="T\xEDtulo Liquidado"&&(oa=$utils.uuid()),O>0){const $=$utils.uuid(),D=$utils.arredondar(s.valor*(O/ia));let w=0,h=0,f=0,F=0;if(l.tipo===5){let _=(await $erp().financeiroBanco.toArray()).find(I=>I.codigoBanco===122);_&&(h=_.percentualMulta||0,F=_.percentualJuros||0,w=$utils.arredondar(h/100*D),f=$utils.arredondar(F/100*D))}X.push({id:$,idFinanceiroPlanoConta:ea.id,idContato:o.idContato,dataEmissao:u,dataCompetencia:T,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:D,valorTotal:D,valorARealizar:D,valorMulta:w,percentualMulta:h,valorJuros:f,percentualJuros:F,documentoId:o.id,documentoTipo:"Fatura",parcela:ha+"/"+wa,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:o.idEmpresa,formaDePagamento:l.descricao,carne:l.tipo===5?1:0,dataEmissaoCarne:l.tipo===5?u:"",idDocumentoCaixa:r.id,idFinanceiroMovimentacaoAgrupamento:l.tipoFinanceiro==="T\xEDtulo Liquidado"?oa:""}),s.idFinanceiroTitulo=$,l.tipo===2&&Da.push({idTitulo:$,idDocumentoCondicaoPagamento:s.id,valor:D,dataVencimento:s.dataVencimento,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,formaPagamento:l}),Oa.push({idTitulo:$,valor:D,desconto:0})}if(ra>0){const $=$utils.uuid(),D=$utils.arredondar(s.valor*(ra/ia));let w=0,h=0,f=0,F=0;if(l.tipo===5){let _=(await $erp().financeiroBanco.toArray()).find(I=>I.codigoBanco===122);_&&(h=_.percentualMulta||0,F=_.percentualJuros||0,w=$utils.arredondar(h/100*D),f=$utils.arredondar(F/100*D))}X.push({id:$,idFinanceiroPlanoConta:G.id,idContato:o.idContato,dataEmissao:u,dataCompetencia:T,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:D,valorTotal:D,valorARealizar:D,valorMulta:w,percentualMulta:h,valorJuros:f,percentualJuros:F,documentoId:o.id,documentoTipo:"Fatura",parcela:ha+"/"+wa,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:o.idEmpresa,formaDePagamento:l.descricao,carne:l.tipo===5?1:0,dataEmissaoCarne:l.tipo===5?u:"",idDocumentoCaixa:r.id,idFinanceiroMovimentacaoAgrupamento:l.tipoFinanceiro==="T\xEDtulo Liquidado"?oa:"",descontoCondicionadoValor:ya>0?ya/100*D:0,descontoCondicionadoPercentual:ya}),s.idFinanceiroTitulo=$,l.tipo===2&&Da.push({idTitulo:$,idDocumentoCondicaoPagamento:s.id,valor:D,dataVencimento:s.dataVencimento,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,formaPagamento:l})}if(l.tipoFinanceiro==="T\xEDtulo Liquidado"&&ra>=0){R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:Y.id,idFinanceiroTitulo:s.idFinanceiroTitulo,dataEmissao:u,valorCredito:s.valor,valorDebito:0,descricao:Y.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id});let $=l.idFinanceiroPlanoConta;l.tipo===1&&(r||{}).idFinanceiroPlanoContaCaixa&&($=r.idFinanceiroPlanoContaCaixa);let D=await $db.financeiroPlanoConta.le({id:$});R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:oa,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:D.id,idFinanceiroTitulo:s.idFinanceiroTitulo,dataEmissao:u,valorCredito:0,valorDebito:s.valor,descricao:D.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id});for(const w of X)w.idFinanceiroMovimentacaoAgrupamento===oa&&(w.valorRealizado=w.valorARealizar,w.dataPagamento=s.dataVencimento,w.dataMovimento=s.dataVencimento,w.idDocumentoCaixaLiquidacao=r.id)}if(l.aliquota){const $=$utils.uuid(),D=$utils.arredondar(s.valor*(l.aliquota/100));if(X.push({id:$,idFinanceiroPlanoConta:l.idFinanceiroPlanoContaAliquota,idContato:l.idContatoOperadoraCartao,dataEmissao:u,dataCompetencia:T,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:D,valorTotal:D,valorARealizar:D,valorMulta:0,percentualJuros:0,documentoId:o.id,documentoTipo:"Fatura",parcela:ha+"/"+wa,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${l.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:o.idEmpresa,formaDePagamento:l.descricao,idDocumentoCaixa:r.id}),s.idFinanceiroTituloPagar=$,l.tipoFinanceiro==="T\xEDtulo Liquidado"){const w=$utils.uuid();R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:w,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:u,valorCredito:0,valorDebito:D,descricao:aa.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idFinanceiroTitulo:$,idContato:l.idContatoOperadoraCartao,idDocumentoCaixa:r.id});let h=l.idFinanceiroPlanoConta;l.tipo===1&&(r||{}).idFinanceiroPlanoContaCaixa&&(h=r.idFinanceiroPlanoContaCaixa);let f=await $db.financeiroPlanoConta.le({id:h});R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:w,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:u,valorCredito:D,valorDebito:0,descricao:f.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idFinanceiroTitulo:$,idContato:l.idContatoOperadoraCartao,idDocumentoCaixa:r.id});for(const F of X)F.id===$&&(F.idFinanceiroMovimentacaoAgrupamento=w,F.valorRealizado=D,F.dataPagamento=s.dataVencimento,F.dataMovimento=s.dataVencimento,F.idDocumentoCaixaLiquidacao=r.id)}}ha++}}const Ra=[];for(const s of Da){const l=$utils.uuid(),$=$utils.uuid();for(const w of X)w.id===s.idTitulo&&(w.idFinanceiroMovimentacaoAgrupamento=$,w.valorRealizado=w.valorARealizar,w.dataPagamento=u,w.dataMovimento=u,w.dataVencimento=u,w.dataVencimentoOriginal=u,w.idDocumentoCaixaLiquidacao=r.id);if(Ra.includes(s.idDocumentoCondicaoPagamento))continue;Ra.push(s.idDocumentoCondicaoPagamento);const D=$utils.arredondar(Da.reduce((w,h)=>h.idDocumentoCondicaoPagamento===s.idDocumentoCondicaoPagamento?w+(h.valor||0):w,0));X.push({id:l,idFinanceiroPlanoConta:va.id,idContato:o.idContato,dataEmissao:u,dataCompetencia:T,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:D,valorTotal:D,valorARealizar:D,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:o.id,documentoTipo:"Fatura",idEmpresa:o.idEmpresa,formaDePagamento:s.formaPagamento.descricao,idDocumentoCaixa:r.id,cheque:1,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${o.id} - C\xF3digoN #${$}`,descricao:"Cheque"}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:$,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:va.id,idFinanceiroTitulo:l,dataEmissao:u,valorCredito:0,valorDebito:D,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,idFinanceiroCheque:l,idDocumentoCaixa:r.id,documentoId:o.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:$,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:Y.id,idFinanceiroTitulo:l,dataEmissao:u,valorCredito:D,valorDebito:0,descricao:Y.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,idFinanceiroCheque:l,idDocumentoCaixa:r.id,documentoId:o.id})}if(O>0){const s=$utils.uuid();R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:Y.id,dataEmissao:u,valorCredito:O,valorDebito:0,descricao:Y.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idContato:o.idContato,idFinanceiroPlanoConta:ea.id,dataEmissao:u,valorCredito:0,valorDebito:O,descricao:ea.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:"Renegocia\xE7\xE3o",documentoId:s,idDocumentoCaixa:r.id});for(const l of Oa)Na.push({idFinanceiroMovimentacaoN:s,idFinanceiroTitulo:l.idTitulo,dataVencimento:u,valorOriginal:l.valor,valorDesconto:l.desconto,valorTotal:$utils.arredondar(l.valor-l.desconto)});for(const l of y){if(l.idFinanceiroMovimentacaoAgrupamento=s,l.idDocumentoCaixaLiquidacao=r.id,l.dataPagamento=u,l.dataMovimento=u,l.renegociado=1,l.cheque===1){l.valorRealizado=l.valor;continue}if(!l.valorARealizar){l.valorRealizado=l.valorTotal;continue}l.valorRealizado=l.valorARealizar}X=X.concat(y)}if(la===0){let s=$utils.uuid();const l=o.valorFrete||0;let $=0,D=0;const w=[];if(l>0&&(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:G.id,dataEmissao:u,valorCredito:0,valorDebito:l,descricao:G.descricao,observacao:`Lan\xE7amento frete da fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:za.id,dataEmissao:u,valorCredito:l,valorDebito:0,descricao:za.descricao,observacao:`Lan\xE7amento frete da fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id})),!e){s=$utils.uuid();for(const h of H){let f="",F={},_="",I={},W="",da={};const ca=await $db.item.leNew({id:h.idItem});if(f=h.idPlanoContaEstoque,!f){const Z=await $db.perfilContabilItem.le({idPerfilContabil:ca.idPerfilContabil,idCfop:h.idCfop,and:{idPerfilContabil:ca.idPerfilContabil,idCfop:h.idCfop}});Z.length&&Z[0].idPlanoContaEstoque&&(f=Z[0].idPlanoContaEstoque)}if(!f&&Ia.id&&(f=Ia.id),!f&&h.idCfop&&(f=(await $db.cfop.le({id:h.idCfop})).idPlanoContaEstoque),F=await $db.financeiroPlanoConta.le({id:f}),!F.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(_="",!_){const Z=await $db.perfilContabilItem.le({idPerfilContabil:ca.idPerfilContabil,idCfop:h.idCfop,and:{idPerfilContabil:ca.idPerfilContabil,idCfop:h.idCfop}});Z.length&&Z[0].idPlanoContaDespesa&&(_=Z[0].idPlanoContaDespesa)}if(!_&&Ea.id&&(_=Ea.id),!_&&h.idCfop&&(_=(await $db.cfop.le({id:h.idCfop})).idPlanoContaDestino),I=await $db.financeiroPlanoConta.le({id:_}),!I.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const xa=$utils.arredondar(h.total-(h.descontoTotalRateado||0)-(h.descontoFaturaRateado||0)),Ca=$utils.arredondar(h.valorCustoMedio*h.quantidade);if(Ca){if(h.operacaoFator<0?(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:F.id,dataEmissao:h.dataHoraFinalizado||u,valorCredito:Ca,valorDebito:0,descricao:F.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${o.id}) e item (${h.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:o.tipo,documentoId:o.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:I.id,dataEmissao:h.dataHoraFinalizado||u,valorCredito:0,valorDebito:Ca,descricao:I.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${o.id}) e item (${h.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:o.tipo,documentoId:o.id,idDocumentoCaixa:r.id})):(R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:F.id,dataEmissao:h.dataHoraFinalizado||u,valorCredito:0,valorDebito:Ca,descricao:F.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${o.id}) e item (${h.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:o.tipo,documentoId:o.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:I.id,dataEmissao:h.dataHoraFinalizado||u,valorCredito:Ca,valorDebito:0,descricao:I.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${o.id}) e item (${h.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:o.tipo,documentoId:o.id,idDocumentoCaixa:r.id})),W=h.idPlanoContaDestino,!W){const ta=await $db.perfilContabilItem.le({idPerfilContabil:ca.idPerfilContabil,idCfop:h.idCfop,and:{idPerfilContabil:ca.idPerfilContabil,idCfop:h.idCfop}});ta.length&&ta[0].idPlanoContaDespesa&&(W=ta[0].idPlanoContaDespesa)}if(!W&&Ea.id&&(W=Ea.id),!W&&h.idCfop&&(W=(await $db.cfop.le({id:h.idCfop})).idPlanoContaDestino),da=await $db.financeiroPlanoConta.le({id:W}),!da.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let Z=!0;for(const ta of w)if(ta.idPlanoContaDestino===da.id&&ta.idPlanoContaEstoque===F.id){ta.valor=$utils.arredondar(ta.valor+xa),Z=!1;break}Z&&w.push({idPlanoContaDestino:da.id,idPlanoContaEstoque:F.id,valor:xa}),$+=xa}}for(const h of w)h.valor<0&&(D+=h.valor);for(const h of w)if(h.valor>0){const f=await $db.financeiroPlanoConta.le({id:h.idPlanoContaDestino}),F=$utils.arredondar(D*(h.valor/($||1)));if(F>0){R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:G.id,dataEmissao:u,valorCredito:0,valorDebito:F,descricao:G.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:u,valorCredito:F,valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:u,dataMovimento:u,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id});for(const _ of m)R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:G.id,dataEmissao:u,valorCredito:0,valorDebito:$utils.arredondar((h.valor-F)*(_.valor/(ia||1))),descricao:G.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:_.dataVencimento,dataMovimento:_.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:u,valorCredito:$utils.arredondar((h.valor-F)*(_.valor/(ia||1))),valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:_.dataVencimento,dataMovimento:_.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id})}else for(const _ of m){const I=$utils.arredondar(h.valor*(_.valor/(ia||1)));R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:G.id,dataEmissao:u,valorCredito:0,valorDebito:I,descricao:G.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:_.dataVencimento,dataMovimento:_.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id}),R.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:o.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:u,valorCredito:I,valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${o.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:T,dataVencimento:_.dataVencimento,dataMovimento:_.dataVencimento,documentoTipo:"Fatura",documentoId:o.id,idDocumentoCaixa:r.id})}}}}if(this.financeiroTitulo=X,this.financeiroMovimentacao=R,this.financeiroRenegociacao=Na,this.fatura=o,this.vendas=g,this.documentosEnvelope=b,this.carnes=y,!e){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let l,$,D,w;if(l=await $db.configuracoes.porNome("integracao.bten.business"),$=(a=(C=l[0])==null?void 0:C.valor)!=null?a:!1,l=await $db.configuracoes.porNome("integracao.bten.authorization"),D=(V=(c=l[0])==null?void 0:c.valor)!=null?V:!1,w=$&&D,w){const h=[],f=this.contatos[o.idContato],F=await $api.bten.send(f,o);for(let _=0;_<F.length;_++){const I=F[_];I.status?h.push(I.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${I.telefone}!`)}h.length&&this.$q.notifyPositive(`NPS enviado para ${h.join(",")}!`)}}catch(l){l.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${l.message}`),l.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",l)}let s;if(r!=null&&r.idCaixa){const l=await $erp().caixa.get(r==null?void 0:r.idCaixa);l!=null&&l.id&&(s=$db.caixa.tiposCaixa[Number(l.tipo)])}if([...g,...b].length&&~["SAT","NFCe"].indexOf(s))try{await this.$refs.documentosFiscais.emitirCupom(this.fatura.id)}catch{}if(this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"){const l=await $db.configuracoes.le({prefixoNome:"enviaemail.fatura"});let $=l.find(D=>D.idEmpresa===this.fatura.idEmpresa);$||($=l.find(D=>!D.idEmpresa)),$&&await Go.enviar(this.fatura,$)}}return!0}catch(o){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",o)}finally{this.$q.loading.hide()}}};const Zo={components:{DocumentoCodigo:to,DocumentoMetas:eo,DocumentosFiscais:lo,Faturamento:io,TituloCard:Jo,VendaCard:mo,EnvelopeCard:fo},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let e=!1;return e=this.fatura.status==="Aberta",e||(e=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!e}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0},vendas:[],vendasOriginal:[],documentosEnvelope:[],documentosEnvelopeOriginal:[],documentosItem:[],documentosItemOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],erroCalculo:!1,erroCalculoMsg:"",sistemaPai:"",impressaoVisivel:!1,configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[uo],methods:{async calcularPesoTotal(){var c,V;const e=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),i=[],d={};let C=0,a=0;for(const o of e){const g=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:o.id}});for(const b of g)i.push(b)}for(const o of i)if(o.operacaoFator===-1){if(o.idItem&&!d[o.idItem]){const g=await $erp().item.get(o.idItem);g&&(d[o.idItem]=g)}C+=(((c=d[o.idItem])==null?void 0:c.peso)||0)*(o.quantidade||0),a+=(((V=d[o.idItem])==null?void 0:V.pesoBruto)||0)*(o.quantidade||0)}C=$utils.arredondar(C,4),a=$utils.arredondar(a,4),this.pesoTotal=C?$filters.numeroZerosDireita(C,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,c,V;const e=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),i=[],d={};let C=0;for(const o of e){const g=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:o.id}});for(const b of g)i.push(b)}for(const o of i){if(o.operacaoFator!==-1||o.tipoItem!=="Produto")continue;if(o.idItem&&!d[o.idItem]){const y=await $erp().item.get(o.idItem);y&&(d[o.idItem]=y)}const g=((a=d[o.idItem])==null?void 0:a.altura)*((c=d[o.idItem])==null?void 0:c.largura)*((V=d[o.idItem])==null?void 0:V.comprimento)||0,b=o.quantidade||0;C+=g>0?g*b:0}C=$utils.arredondar(C,4),this.metroCubicoTotal=C?$filters.numeroZerosDireita(C,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...Ko,async atualizar(){let e=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.vendas=[],this.documentosEnvelope=[],this.documentosEnvelopeOriginal=[],this.documentosItem=[],this.documentosItemOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.prop.id){const i=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(i.fatura),this.fatura=i.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(i.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=i.condicaoPagamento),this.vendasOriginal=$utils.clonar(i.vendas),this.vendas=i.vendas.sort((a,c)=>new Date(a.dataHoraFinalizado)<new Date(c.dataHoraFinalizado)?-1:1);const d=i.documentosEnvelope.sort((a,c)=>new Date(a.dataHoraFinalizado)<new Date(c.dataHoraFinalizado)?-1:1);this.documentosEnvelopeOriginal=$utils.clonar(d),this.documentosEnvelope=$utils.clonar(d),this.receberTitulo.id&&!i.carnes.find(a=>a.id===this.receberTitulo.id)&&(i.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),e=!0),this.carnesOriginal=$utils.clonar(i.carnes),this.carnes=i.carnes.sort((a,c)=>new Date(a.dataVencimento)<new Date(c.dataVencimento)?-1:1);const C={};if(i.fatura.idContato){const a=i.fatura.idContato;C[a]||(C[a]=await $db.contato.le({id:a}))}this.configuraImpressaoCarne(i.fatura.idEmpresa),this.configuraImpressaoConvenio(i.fatura.idEmpresa),this.configuraImpressaoEnvelope(i.fatura.idEmpresa),this.configuraImpressaoFatura(i.fatura.idEmpresa),this.contatos=C,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal(),e&&await this.salvarFatura()}},async executar(e){if(e==="recalcular"){if(this.prop.id){const i=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(i.carnes),this.carnes=i.carnes,await this.calculaTotais()}}else e==="salvarFatura"?(await this.salvarFatura(),await this.atualizar(),this.$emit("executar","atualizarSemFechar")):(await this.atualizar(),this.$emit("executar",e))},async calculaTotais(e){const i=$utils.arredondar(this.vendas.reduce((a,c)=>a+c.totalDocumento||0,0)),d=$utils.arredondar(this.documentosEnvelope.reduce((a,c)=>a+c.totalDocumento||0,0)),C=$utils.arredondar(this.carnes.reduce((a,c)=>a+c.valorARealizar||0,0));if(e||(this.fatura.subTotal=$utils.arredondar(i+d+C),e="desconto"),e==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),e==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.fatura.totalDesconto!==0){const a=i+d;a===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),a>0&&this.fatura.totalDesconto>a&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")}this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0);try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async configuraImpressaoConvenio(e){const i=await $db.configuracoes.porNome("impressao.convenio",e);this.configImpressaoConvenio=[...i.length?i.map(d=>({texto:"Imprimir Conv\xEAnio",...d})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(e){const i=await $db.configuracoes.porNome("impressao.carne",e);this.configImpressaoCarne=[...i.length?i.map(d=>({texto:"Imprimir Carn\xEA",...d})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(e){const i=await $db.configuracoes.porNome("impressao.envelope",e);this.configImpressaoEnvelope=[...i.length?i.map(d=>({texto:"Imprimir Envelope",...d})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(e){const i=await $db.configuracoes.porNome("impressao.fatura",e);this.configImpressaoFatura=[...i.length?i.map(d=>({texto:"Imprimir Fatura",...d})):[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"},this.sistemaPai==="optisoul"?{valor:"termoGarantia",texto:"Termo de Garantia"}:{}]]},async reabrir(e){var i;if(!((i=this.fatura)!=null&&i.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!e)try{$q.loading.show(),await no({idDocumento:this.fatura.id})}catch(d){this.$q.notifyError(d.message);return}finally{$q.loading.hide()}if(!e)try{await new Promise((d,C)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{d()}).onCancel(()=>{C()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const d=$utils.clonar(this.fatura),C=$utils.clonar(this.vendas),a=$utils.clonar(this.documentosEnvelope),c=$utils.clonar(this.documentosItem),V=this.$refs.faturamento.condicaoPagamento.filter(y=>y.valor);if(!e){const y=[];V.reduce((B,N)=>(N.idDocumentoCaixa&&!B[N.idDocumentoCaixa]&&(B[N.idDocumentoCaixa]=!0,y.push($db.hibrido.le({table:"documento",id:N.idDocumentoCaixa}))),B),{});for await(const B of y)if(B.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(y){$q.notifyError(y.message);return}let o=[],g=[],b=[];if(!e){o=await $db.financeiroTitulo.le({documentoId:d.id});for(const p of o)if(p.idFinanceiroBoleto){const m=await $erp().financeiroBoleto.get(p.idFinanceiroBoleto),O=await $db.financeiroBanco.le({id:m.idFinanceiroBanco}),S=await $db.banco.le({id:O.idBanco}),la=m.revisao,na=S.baixa,Pa=S.registro;if(m.remessaOperacao!==na){const ea=p.idFinanceiroBoleto,fa=$utils.uuid(),Y={id:fa,idFinanceiroBanco:m.idFinanceiroBanco,nossoNumero:m.nossoNumero,nossoNumeroDv:m.nossoNumeroDv,revisao:la+1,idEmpresa:m.idEmpresa,idContato:m.idContato,empresaNome:m.empresaNome,empresaNumeroDocumento:m.empresaNumeroDocumento,contatoNome:m.contatoNome,contatoNumeroDocumento:m.contatoNumeroDocumento,contatoLogradouro:m.contatoLogradouro,contatoCEP:m.contatoCEP,contatoBairro:m.contatoBairro,contatoCidade:m.contatoCidade,contatoUF:m.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:m.dataVencimento,dataImpressao:m.dataImpressao,valor:m.valor,valorJuros:m.valorJuros,tipoJuros:m.tipoJuros,valorMulta:m.valorMulta,valorDesconto:m.valorDesconto,valorTotal:m.valorTotal,codigoBarras:m.codigoBarras,linhaDigitavel:m.linhaDigitavel,mensagem1:m.mensagem1,mensagem2:m.mensagem2,mensagem3:m.mensagem3,mensagem4:m.mensagem4,mensagem5:m.mensagem5,gerarRemessa:1,remessaOperacao:na};await $db.financeiroBoleto.grava({atual:Y});let Fa=[];ea&&(Fa=await $db.financeiroTitulo.le({idFinanceiroBoleto:ea}));for(const aa of Fa){const pa=$utils.clonar(aa);aa.idFinanceiroBoleto=fa;let va=[];ea&&(va=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:ea}));for(const qa of va){const G={id:$utils.uuid(),idFinanceiroBoleto:fa,idFinanceiroTitulo:qa.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:G})}await $db.financeiroTitulo.grava({atual:aa,original:pa})}if(m.remessaOperacao===Pa&&m.gerarRemessa===1)for(const aa of[m,Y]){const pa={...aa,gerarRemessa:0};await $db.financeiroBoleto.grava({original:aa,atual:pa})}}}let y=[];this.$refs.faturamento.idDocumentoCaixa&&(y=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),o=await $db.financeiroTitulo.le({idFatura:d.id});let B=await $db.financeiroTitulo.le({idFatura:d.id});for(const p of $utils.clonar(o)){if(!p.idFinanceiroMovimentacaoAgrupamento)continue;const m=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:p.idFinanceiroMovimentacaoAgrupamento});for(const O of m){const S=await $db.financeiroTitulo.le({id:O.idFinanceiroTitulo});S.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(o=o.concat(S))}}let N=!1;for(const p of V){const m=await $db.financeiroTitulo.le({id:p.idFinanceiroTitulo});if(Object.keys(m).length){let O=[];O=y.filter(S=>S.idFinanceiroMovimentacaoN===m.idFinanceiroMovimentacaoAgrupamento),g=g.concat(O),O=y.filter(S=>S.idFinanceiroTitulo===m.id),g=g.concat(O),O=y.filter(S=>S.idFinanceiroCheque===m.id),g=g.concat(O),o=o.concat(m)}p.idFinanceiroTitulo="",p.sinal===1&&(N=!0)}B=await $db.financeiroTitulo.le({idFatura:d.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const p of B){if(!p.idFinanceiroMovimentacaoAgrupamento)continue;const m=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:p.idFinanceiroMovimentacaoAgrupamento});g=g.concat(m);const O=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:p.idFinanceiroMovimentacaoAgrupamento});b=b.concat(O)}if(B=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:d.id}),o=o.concat(B),d.id){let p=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:d.id});g=g.concat(p),p=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:d.id}),g=g.concat(p),p=await $db.financeiroMovimentacao.lerV2({documentoId:d.id});for(const m of p)(await $db.financeiroTitulo.le({id:m.idFinanceiroTitulo})).id||(g=g.concat(m))}const H=await $db.hibrido.lista({table:"documento",where:{idFatura:d.id}});for(const p of H){const m=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:p.id});g=g.concat(m)}let u=[];for(const p in o){const m=o[p].id;u.includes(m)?delete o[p]:u.push(m)}o=o.filter(p=>p),u=[];for(const p in g){const m=g[p].id;u.includes(m)?delete g[p]:u.push(m)}g=g.filter(p=>p),u=[];for(const p in b){const m=b[p].id;u.includes(m)?delete b[p]:u.push(m)}b=b.filter(p=>p);let T=$utils.dataAtual(),r=N?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:d.id,operacao:"Fatura",statusOriginal:d.status,statusFinalizado:r,dataHoraEmissao:T,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],d.status=r,r==="Aberta"&&(d.dataHoraFinalizado=""),r=N?"Aguardando Pagamento":"Aguardando Faturamento";for(const p of C)this.documentoStatus.push({id:$utils.uuid(),idDocumento:p.id,operacao:"Venda de Mercadoria",statusOriginal:p.status,statusFinalizado:r,dataHoraEmissao:T,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),p.status=r;for(const p of a)this.documentoStatus.push({id:$utils.uuid(),idDocumento:p.id,operacao:"Envelope",statusOriginal:p.status,statusFinalizado:p.status,dataHoraEmissao:T,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const p of c)p.status=r;this.fatura=d,this.vendas=C,this.documentosEnvelope=a,this.documentosItem=c}if(this.$q.loading.hide(),e&&await this.finalizar(e),this.$q.loading.show({message:"Processando..."}),e){let y=[],B=[],N=[],H=[],u=[],T=[];y=this.$refs.faturamento.condicaoPagamento.map(r=>r.id),B=this.$refs.faturamento.condicaoPagamentoOriginal.filter(r=>!y.includes(r.id));for(const r of B)if(r.idFinanceiroTitulo&&N.push(r.idFinanceiroTitulo),r.idFormaPagamento){let p;p=await $erp().formaPagamento.get(r.idFormaPagamento),(p||{}).aliquota&&(r.idFinanceiroTituloPagar?N.push(r.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const r of N){let p;if(p=await $erp().financeiroTitulo.get(r),p.id&&H.push(p),p.idFinanceiroMovimentacaoAgrupamento){let m,O;if(m=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:p.idFinanceiroMovimentacaoAgrupamento}}),O=(m.find(S=>S.idFinanceiroCheque)||{}).idFinanceiroCheque,O){let S=await $erp().financeiroTitulo.get(O);S.id&&H.push(S)}u.push(...m)}}for(let r of this.carnes){if(!r.id||(r=await $erp().financeiroTitulo.get(r.id),!(r||{}).idFinanceiroMovimentacaoAgrupamento))continue;let p,m;p=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento}}),m=await $db.hibrido.lista({table:"financeiroRenegociacao",where:{idFinanceiroMovimentacaoN:r.idFinanceiroMovimentacaoAgrupamento}}),u.push(...p),T.push(...m)}await $db.financeiroTitulo.remove(H),await $db.financeiroMovimentacao.remove(u),await $db.financeiroRenegociacao.remove(T)}else{await $db.financeiroTitulo.remove(o.filter(y=>!(y.carne&&y.idFatura===d.id))),await $db.financeiroMovimentacao.remove(g),await $db.financeiroRenegociacao.remove(b);for(const y of o.filter(B=>B.carne&&B.idFatura===d.id))await $db.financeiroTitulo.grava({original:y,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}return await this.salvarFatura(),await this.atualizar(),e?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let e,i,d,C;if(e=this.$refs.faturamento.condicaoPagamentoOriginal,i=this.$refs.faturamento.condicaoPagamento,C=$utils.arredondar(this.fatura.totalDocumento||0),d=$utils.arredondar(i.reduce((a,c)=>a+c.valor||0,0)),d!==C){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(e.length){let a=!1;i.length||(a=!0);for(const c of i)if(!e.find(V=>V.id===c.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,c)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{c()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){try{this.$q.loading.show({message:"Processando..."});let e=$utils.clonar(this.$refs.faturamento.condicaoPagamento.filter(d=>d.valor));for(let d in e)delete e[d].idDocumentoCondicaoPagamento,delete e[d].parcelas,delete e[d].formaPagamento,delete e[d].edicao,delete e[d].codigoDocumento,delete e[d].codigoDocumentoCaixa;const i=(this.carnesOriginal||[]).filter(d=>(this.financeiroTitulo||[]).find(C=>C.id===d.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,documentosEnvelope:this.documentosEnvelope,documentosEnvelopeOriginal:this.documentosEnvelopeOriginal,documentosItemOriginal:this.documentosItemOriginal,documentosItem:this.documentosItem,condicaoPagamentoOriginal:this.$refs.faturamento.condicaoPagamentoOriginal,condicaoPagamento:e,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:i,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id){let d=this.carnes.find(C=>C.id===this.receberTitulo.id);d.id&&await $db.financeiroTitulo.grava({original:d,atual:{idFatura:this.fatura.id}})}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async dialogImpressao(){if(this.carnes.length>0&&(this.fatura.status==="Finalizada"||this.fatura.status!=="Aguardando Pagamento"&&this.fatura.dataHoraFinalizado))return this.impressaoVisivel=!0,new Promise(e=>{this.resolveDialogImpressao=e})},fecharDialogImpressao(){this.impressaoVisivel=!1,this.resolveDialogImpressao()}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},Wo={class:"Fatura round-borders bg-grey-2 q-pb-sm"},Xo={class:"row items-center"},Yo={class:"col q-ma-sm q-title"},at={class:"bg-grey-2"},ot={class:"q-ma-sm"},tt={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},et={key:1,class:"q-item-label q-mt-md",style:{color:"#0c0c0c"}},it={class:"col-12 col-md-4 border-1 q-ma-md"},nt=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Subtotal",-1),rt={class:"col-8 text-right"},st=E("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"Desconto",-1),lt={class:"col-3"},dt={class:"col-5"},ct=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Total",-1),ut={class:"col-8 q-mt-sm text-right"},mt=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Total",-1),ft={class:"col-8 q-mt-sm text-right"},pt=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Bruto Total",-1),vt={class:"col-8 q-mt-sm text-right"},ht=E("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Metro C\xFAbico Total",-1),Ct={class:"col-8 q-mt-sm text-right"},gt={class:"Fatura-faturamento round-borders q-ma-sm q-pa-md"},bt={class:"round-borders q-ma-sm q-pa-md"};function $t(e,i,d,C,a,c){const V=J("avatar"),o=J("documento-codigo"),g=J("documento-metas"),b=J("VendaCard"),y=J("EnvelopeCard"),B=J("titulo-card"),N=J("row"),H=J("campo"),u=J("faturamento"),T=J("documentos-fiscais");return v(),z(j,null,[E("div",Wo,[t(sa,{class:"Fatura-barra bg-grey-2 q-py-md",color:"black",dark:""},{default:n(()=>[t(ma,null,{default:n(()=>[E("div",Xo,[t(V,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"60"},null,8,["imagem","rotulo"]),E("div",Yo,P(a.fatura.descricaoContato),1)])]),_:1}),a.fatura.id?(v(),q(o,{key:0,documento:a.fatura,class:"q-mx-sm"},null,8,["documento"])):x("",!0),a.fatura.status==="Finalizada"||a.fatura.status!=="Aguardando Pagamento"&&a.fatura.dataHoraFinalizado?(v(),q(L,{key:1,icon:"print",size:"md",color:"primary",round:"",flat:""},{default:n(()=>[t(_a,null,{default:n(()=>[ba((v(),q(ga,{link:"",separator:""},{default:n(()=>[(v(!0),z(j,null,K(a.configImpressaoFatura,r=>(v(),q(U,{clickable:"",key:r.valor,onClick:p=>e.$imprimir(r.valor,(a.fatura||{}).id||"0")},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"print"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P(r.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(v(!0),z(j,{key:0},K(a.configImpressaoEnvelope,r=>(v(),q(U,{clickable:"",key:r.valor,onClick:p=>e.$imprimir(r.valor,(a.fatura||{}).id||"0")},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"print"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P(r.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):x("",!0),(v(!0),z(j,null,K(a.configImpressaoCarne,r=>(v(),q(U,{clickable:"",key:r.valor,onClick:p=>e.$imprimir(r.valor,(a.fatura||{}).id||"0")},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"print"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P(r.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(v(!0),z(j,null,K(a.configImpressaoConvenio,r=>(v(),q(U,{clickable:"",key:r.valor,onClick:p=>e.$imprimir(r.valor,(a.fatura||{}).id||"0")},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"print"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P(r.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[$a]])]),_:1})]),_:1})):x("",!0),t(L,{icon:"more_vert",size:"md",color:"tertiary",flat:"",round:""},{default:n(()=>[t(_a,null,{default:n(()=>[t(ga,{link:"",separator:""},{default:n(()=>[a.fatura.id?(v(),q(U,{key:0,clickable:"",onClick:i[0]||(i[0]=r=>e.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"account_balance"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M("Emitir cupom")]),_:1})]),_:1})]),_:1})):x("",!0),a.fatura.id&&e.$utils.mapearStatus(a.fatura).permiteNota?(v(),z(j,{key:1},[t(U,{clickable:"",onClick:i[1]||(i[1]=r=>e.emitirNFeV2({idFatura:a.fatura.id},1,"Venda"))},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"account_balance"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M("NFe de Sa\xEDda/Venda")]),_:1})]),_:1})]),_:1}),t(U,{clickable:"",onClick:i[2]||(i[2]=r=>e.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o"))},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"account_balance"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M("NFe de Entrada/Devolu\xE7\xE3o")]),_:1})]),_:1})]),_:1}),t(U,{clickable:"",onClick:i[3]||(i[3]=r=>e.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa"))},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"account_balance"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M("NFe de Remessa")]),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),E("div",at,[t(g,{ref:"documentoMetas"},null,512)]),E("div",ot,[a.vendas.length>0?(v(),z("p",tt,[t(A,{name:"shopping_cart",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),M(" Vendas ")])):x("",!0),(v(!0),z(j,null,K(a.vendas,r=>(v(),z("div",{key:r.id,class:"bg-white q-mt-sm round-borders"},[t(b,{id:r.id,onAtualizar:c.atualizar,onExecutar:c.executar},null,8,["id","onAtualizar","onExecutar"])]))),128)),(v(!0),z(j,null,K(a.documentosEnvelope,r=>(v(),z("div",{key:r.id,class:"bg-white q-mt-sm round-borders"},[t(y,{id:r.id,onExecutar:c.executar},null,8,["id","onExecutar"])]))),128)),a.carnes.length>0?(v(),z("p",et,[t(A,{name:"attach_money",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),M(" Carn\xEAs ")])):x("",!0),(v(!0),z(j,null,K(a.carnes,r=>(v(),z("div",{key:r.id,class:"bg-white q-mt-sm round-borders"},[t(B,{dados:r,class:"q-mt-md",onExecutar:c.executar},null,8,["dados","onExecutar"])]))),128))]),t(N,{class:"justify-end"},{default:n(()=>[E("div",it,[t(N,{class:"q-col-gutter-md q-mb-sm"},{default:n(()=>[nt,E("strong",rt,P(e.$filters.numero(a.fatura.subTotal,2)),1)]),_:1}),a.permissaoDesconto?(v(),q(N,{key:0,class:"q-col-gutter-x-sm"},{default:n(()=>[st,E("div",lt,[t(H,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[i[4]||(i[4]=r=>a.fatura.totalPercentualDesconto=r),i[5]||(i[5]=r=>c.calculaTotais("descontoPercentual"))],tipo:"decimal",decimals:"2",suffix:"%","somente-leitura":c.descontoSomenteLeitura,error:a.erroCalculo},null,8,["modelValue","somente-leitura","error"])]),E("div",dt,[t(H,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[i[6]||(i[6]=r=>a.fatura.totalDesconto=r),i[7]||(i[7]=r=>c.calculaTotais("desconto"))],tipo:"decimal",decimals:"2","somente-leitura":c.descontoSomenteLeitura,error:a.erroCalculo,errorMessage:a.erroCalculoMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])])]),_:1})):x("",!0),t(N,{class:"q-col-gutter-x-sm q-mt-sm"},{default:n(()=>[ct,E("strong",ut,P(e.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1}),a.pesoTotal?(v(),q(N,{key:1,class:"q-col-gutter-x-sm q-mt-sm"},{default:n(()=>[mt,E("span",ft,P(a.pesoTotal),1)]),_:1})):x("",!0),a.pesoBrutoTotal?(v(),q(N,{key:2,class:"q-col-gutter-x-sm q-mt-sm"},{default:n(()=>[pt,E("span",vt,P(a.pesoBrutoTotal),1)]),_:1})):x("",!0),a.metroCubicoTotal?(v(),q(N,{key:3,class:"q-col-gutter-x-sm q-mt-sm"},{default:n(()=>[ht,E("span",Ct,P(a.metroCubicoTotal),1)]),_:1})):x("",!0)])]),_:1}),E("div",gt,[t(u,{documento:a.fatura,ref:"faturamento",onExecutar:c.executar,onSalvarFatura:c.salvarFatura},null,8,["documento","onExecutar","onSalvarFatura"])]),E("div",bt,[t(T,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])]),t(Va,{modelValue:a.impressaoVisivel,"onUpdate:modelValue":i[8]||(i[8]=r=>a.impressaoVisivel=r),onKeyup:ka(c.fecharDialogImpressao,["esc"]),persistent:""},{default:n(()=>[t(Sa,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"350px","max-width":"400px"}},{default:n(()=>[t(La,null,{default:n(()=>[t(sa,null,{default:n(()=>[t(L,{icon:"arrow_back",flat:"",round:"",dense:"",onClick:c.fecharDialogImpressao},null,8,["onClick"]),t(ma,null,{default:n(()=>[M("Imprimir")]),_:1})]),_:1})]),_:1}),t(ja,null,{default:n(()=>[t(Ha,null,{default:n(()=>[t(ga,{link:"",separator:""},{default:n(()=>[(v(!0),z(j,null,K(a.configImpressaoFatura,r=>(v(),q(U,{clickable:"",key:r.valor,onClick:p=>e.$imprimir(r.valor,(a.fatura||{}).id||"0")},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"print"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P(r.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(v(!0),z(j,{key:0},K(a.configImpressaoEnvelope,r=>(v(),q(U,{clickable:"",key:r.valor,onClick:p=>e.$imprimir(r.valor,(a.fatura||{}).id||"0")},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"print"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P(r.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):x("",!0),(v(!0),z(j,null,K(a.configImpressaoCarne,r=>(v(),q(U,{clickable:"",key:r.valor,onClick:p=>e.$imprimir(r.valor,(a.fatura||{}).id||"0")},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"print"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P(r.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(v(!0),z(j,null,K(a.configImpressaoConvenio,r=>(v(),q(U,{clickable:"",key:r.valor,onClick:p=>e.$imprimir(r.valor,(a.fatura||{}).id||"0")},{default:n(()=>[t(k,{avatar:""},{default:n(()=>[t(A,{name:"print"})]),_:1}),t(k,null,{default:n(()=>[t(Q,null,{default:n(()=>[M(P(r.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],64)}var Ft=Ma(Zo,[["render",$t]]);const Et={components:{CpfCnpjNoCupom:co,Fatura:Ft},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let e;try{e=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let i=await $db.hibrido.le({table:"documento",id:this.id});this.fatura=i,await this.verificarPermissoes(),this.desativarBotoes(),i.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),i.status==="Finalizada"||i.status!=="Aguardando Pagamento"&&i.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(i.idContato,$q.notify)}finally{clearTimeout(e),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(e){e.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizar(e){const d={cpfCnpjNoCupom:this.cpfCnpjNoCupom};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(!1,d)){this.lockEsc=!1;return}await this.$refs.fatura.atualizar(),await this.atualizar(),await this.$refs.fatura.dialogImpressao(),this.$emit("executar","finalizar"),this.fechar()},async executar(e){switch(e){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}if(e==="atualizarSemFechar"){await this.atualizar(),this.runOnHide.push(()=>this.$emit("executar","atualizar"));return}this.$emit("executar",e),this.fechar()},fechar(){this.visivel=!1},async mostrar(e={}){this.id=e.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(e=>e()),this.runOnHide=[]},async salvar(){try{await new Promise((e,i)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{i()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria")}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}};function Dt(e,i,d,C,a,c){const V=J("fatura"),o=J("CpfCnpjNoCupom");return v(),z("div",null,[t(Va,{modelValue:a.visivel,"onUpdate:modelValue":i[0]||(i[0]=g=>a.visivel=g),onKeyup:ka(c.voltar,["esc"]),onHide:c.onHide,maximized:"",persistent:""},{default:n(()=>[t(Sa,{view:"hHh LpR fFf",container:"",class:"bg-grey-4"},{default:n(()=>[t(La,null,{default:n(()=>[t(sa,null,{default:n(()=>[ba(t(L,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[$a]]),t(ma,null,{default:n(()=>[M("Fatura")]),_:1}),a.visibilidade.botao.salvar?(v(),q(L,{key:0,onClick:c.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):x("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(v(),q(L,{key:1,onClick:c.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):x("",!0)]),_:1})]),_:1}),t(ja,null,{default:n(()=>[t(Ha,{class:"u-container q-py-md"},{default:n(()=>[a.fatura.id?(v(),q(V,{key:0,onExecutar:c.executar,prop:{id:a.fatura.id},receberTitulo:d.receberTitulo,ref:"fatura"},null,8,["onExecutar","prop","receberTitulo"])):x("",!0)]),_:1})]),_:1}),t(ro,{class:"bg-light",bordered:""},{default:n(()=>[t(sa,{class:"q-pa-sm u-container"},{default:n(()=>[t(so),a.visibilidade.botao.reabrir?(v(),q(L,{key:0,onClick:c.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):x("",!0),a.visibilidade.botao.reabrir?ba((v(),q(L,{key:1,label:"Fechar",color:"tertiary",flat:"",class:"q-ml-sm"},null,512)),[[$a]]):x("",!0),a.visibilidade.botao.reabrir?x("",!0):(v(),q(L,{key:2,onClick:c.finalizar,disabled:!a.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),t(o,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":i[1]||(i[1]=g=>a.cpfCnpjNoCupom.visivel=g),onConfirmar:i[2]||(i[2]=g=>c.finalizar()),dados:a.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var Tt=Ma(Et,[["render",Dt]]);export{Tt as F,Jo as T};
