import{_ as F,Z as I,r as E,o as d,p,f as o,w as r,a$ as w,a_ as P,b5 as T,C as h,t as g,F as q,u as x,d as v,aP as A,e as D,Q as N,m as Q,k as C,z as V,P as z,S as H,T as y,j as $,U as k,H as M,b3 as S,b6 as B,b4 as O}from"./index.dc1c00d4.js";import{F as R,T as j}from"./FaturaModal.b6763995.js";import{_ as G}from"./Grafico.b587e626.js";import"./DocumentosFiscais.63841c8d.js";import"./Campo.cd26b183.js";import"./compactarValidarNFe.60382910.js";import"./obterItens.3a3cccaf.js";import"./codigosANP.a6c1a264.js";import"./emitirNFe.35117289.js";import"./VendaCard.189a04ef.js";import"./ModalHistoricoStatus.30067b57.js";import"./EnvelopeCard.1d081609.js";import"./Chart.7f1b92ad.js";const L={components:{Badge:I,FaturaModal:R,TituloCard:j,Grafico:G},data(){return{contato:{},tab:"tab-1",graficoMensal:{labels:["Em dia","Dentro do m\xEAs","Fora do m\xEAs","Inadimplente","Outros"],datasets:[{backgroundColor:["green","yellow","orange","red","gray"],data:[0,0,0,0,0]}]},graficoOpcoesMensal:{responsive:!0,maintainAspectRatio:!1},historicoColunas:[{name:"dataPagamento",label:"Data",field:"dataPagamento",sortable:!0,format:this.$filters.data},{name:"formaDePagamento",label:"Forma",field:"formaDePagamento",sortable:!0},{name:"parcela",label:"Parcelas",field:"parcela"},{name:"valor",label:"Valor",field:"valor",format:l=>this.$filters.numero(l,2)}],titulosCliente:[],titulosEmAberto:[],titulosHistorico:[],creditoCliente:{},saldo:0,documentos:{},modalFatura:{idFatura:"",idTitulo:""},carregandoIdEmpresas:!0,idEmpresasPermissao:[]}},methods:{async calculaDadosGraficoPizza(){let l=[];const e=await $db.financeiroTitulo.le({idContato:this.contato.id});for(const a of e){const t=(a.dataPagamento||"").substr(0,10),i=(a.dataVencimentoOriginal||"").substr(0,10),m=$utils.dataAtual().substr(0,10);let b="Outros",s="tertiary";i&&(t?t<=i?(b="Em dia",s="positive"):t.substr(0,7)===i.substr(0,7)?(b="Dentro do m\xEAs",s="warning"):(b="Fora do m\xEAs",s="orange"):i<m&&(b="Inadimplente",s="negative")),l.push({eixo:b,cor:s,valor:a.valorRealizado||0,dataPagamento:t,data:t||(a.dataVencimento||"").substr(0,10),dataVencimentoOriginal:i})}let c={"Em dia":{q:0,v:0},"Dentro do m\xEAs":{q:0,v:0},"Fora do m\xEAs":{q:0,v:0},Inadimplente:{q:0,v:0},Outros:{q:0,v:0}};for(const a of l)c[a.eixo].q+=1,c[a.eixo].v+=a.valor;this.graficoMensal.datasets[0].data=[c["Em dia"].q,c["Dentro do m\xEAs"].q,c["Fora do m\xEAs"].q,c.Inadimplente.q,c.Outros.q],this.titulosCliente=l},executar(l){this.atualizar()},async receberTitulo(l){let e=[],c=[],a=await $db.contato.le({id:l.idEmpresa}),t={},i=await $db.contato.le({id:l.idContato}),m={},b={};a.id||this.$q.notify("Erro ao recuperar informa\xE7\xF5es da Empresa."),e=await $db.contatoEndereco.leNew({idContato:a.id}),e.length&&(t=e[0]),i.id||this.$q.notify("Erro ao recuperar informa\xE7\xF5es do Contato."),e=await $db.contatoEndereco.leNew({idContato:i.id}),c=await $db.contatoTelefone.leNew({idContato:i.id}),e.length&&(m=e[0]),c.length&&(b=c[0]);let s=await $db.fatura.leNew({status:"Aberta",idContato:i.id,idEmpresa:a.id});for(const n of $lodash.orderBy(s,"dataHoraEmissao","desc")){try{this.modalFatura={idTitulo:l.id},this.$refs.faturaModal.mostrar({id:n.id})}catch(_){this.$q.notifyError("N\xE3o foi poss\xEDvel adicionar este t\xEDtulo a uma fatura.",_)}return}try{let n={id:$utils.uuid(),status:"Aberta",tipo:"Fatura",dataHoraEmissao:$utils.dataAtual(),calcularAutomatico:"Sim",idEmpresa:a.id,descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",idEmpresaEndereco:t.id||"",idContato:i.id,descricaoContato:i.nome||"",idContatoEndereco:m.id||"",numeroDocumentoContato:i.numeroDocumentoNacional||"",descricaoContatoEndereco:"".concat(m.logradouro||"",", ",m.numero||""," ",m.complemento||""," - ",m.bairro||""," - ",m.cep||""," - ",m.municipio||"","/",m.uf||""),telefoneContato:b.telefone||"",emailContato:i.email||"",regimeContato:i.regime||"",observacaoFaturamento:"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",freteSeparado:!1,operacao:"Faturamento",tipoFrete:"CIF",totalDesconto:0,totalPercentualDesconto:0,subTotal:0,totalDocumento:0};await $db.documento.grava({atual:n}),this.modalFatura={idTitulo:l.id},this.$refs.faturaModal.mostrar({id:n.id})}catch(n){this.$q.notifyError("N\xE3o foi poss\xEDvel adicionar este t\xEDtulo a uma fatura.",n)}},async atualizar(){var m,b;if(this.contato=await $erp().contato.get((m=this.$route.params.id)!=null?m:""),!((b=this.contato)!=null&&b.id))return;this.titulosEmAberto=[],this.titulosHistorico=[];const l=await $db.financeiroTitulo.le({idContato:this.contato.id,emAberto:!0}),e=await $db.financeiroTitulo.le({idContato:this.contato.id,emAberto:!1});this.titulosEmAberto=$lodash.orderBy(l,"dataVencimento","asc"),this.titulosHistorico=$lodash.orderBy(e,"dataPagamento","desc"),this.carregandoIdEmpresas=!0,$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(s=>{this.idEmpresasPermissao=s.data.map(n=>n.id),this.carregandoIdEmpresas=!1});let c=await $db.contatoCreditoExtrato.le({idContato:this.contato.id});c=$lodash.orderBy(c,"dataEmissao","asc");let a=0,t={};c=c.filter(s=>s.tipo==="Cr\xE9dito Devolu\xE7\xE3o").reduce((s,n)=>{const _=this.$filters.data(n.dataEmissao);return s[_]||(s[_]=[]),n.documentoId&&!t[n.documentoId]&&(t[n.documentoId]=$db.hibrido.le({table:"documento",id:n.documentoId})),a+=n.creditoDevolucao,n.saldo=$utils.arredondar(a),s[_].push(n),s},{}),this.saldo=$utils.arredondar(a);let i={};for(const s in t)i[s]=await t[s];this.documentos=i,this.creditoCliente=c,await this.calculaDadosGraficoPizza()}},watch:{"$route.params.id"(){this.atualizar()}},mounted(){this.atualizar()}},U={class:"AtendimentoFinanceiro"},Z={class:"q-mt-md q-mb-md text-h6"},J={key:0},K={key:1},W={class:"q-mt-md q-mb-md text-h6"},X={header:"",class:"text-weight-bold"},Y={key:0,style:{margin:"0","text-align":"right",color:"red"},class:"text-weight-bold"},tt={key:1,style:{margin:"0","text-align":"right",color:"#4caf50"},class:"text-weight-bold"},ot={key:2,style:{margin:"0","text-align":"right",color:"red"}},et={key:3,style:{margin:"0","text-align":"right"}},at={class:"col-12 col-md-6"},it={class:"col-12 col-md-6"},st={key:0},rt={key:1};function lt(l,e,c,a,t,i){const m=E("titulo-card"),b=E("badge"),s=E("grafico"),n=E("row"),_=E("fatura-modal");return d(),p("div",U,[o(P,{modelValue:t.tab,"onUpdate:modelValue":e[0]||(e[0]=u=>t.tab=u),class:"bg-transparent q-mt-lg text-primary",color:"transparent",align:"left"},{default:r(()=>[o(w,{label:"Em aberto",name:"tab-1"}),o(w,{label:"Cr\xE9dito do Cliente",name:"tab-2"}),o(w,{label:"Hist\xF3rico",name:"tab-3"})]),_:1},8,["modelValue"]),o(O,{modelValue:t.tab,"onUpdate:modelValue":e[1]||(e[1]=u=>t.tab=u),animated:"",class:"q-mb-md"},{default:r(()=>[o(T,{class:"bg-white",name:"tab-1"},{default:r(()=>[h("div",Z," Total R$ "+g(l.$filters.numero(t.titulosEmAberto.reduce((u,f)=>u+f.valorTotal,0),2)),1),t.titulosEmAberto.length?(d(),p("div",J,[(d(!0),p(q,null,x(t.titulosEmAberto,u=>(d(),p("div",{key:u.id},[o(m,{dados:u,class:"q-mb-md",onExecutar:i.executar},{default:r(()=>[t.carregandoIdEmpresas?(d(),v(A,{key:0,dense:"",flat:"",class:"no-shadow q-ma-xs",style:{float:"right"}})):D("",!0),!t.carregandoIdEmpresas&&!u.cheque&&t.idEmpresasPermissao.includes(u.idEmpresa)?(d(),v(N,{key:1,color:"primary",dense:"",flat:"",rounded:"",icon:"save_alt",size:"md",unelevated:"",onClick:f=>i.receberTitulo(u)},{default:r(()=>[o(Q,null,{default:r(()=>e[2]||(e[2]=[C("Receber")])),_:1})]),_:2},1032,["onClick"])):D("",!0)]),_:2},1032,["dados","onExecutar"])]))),128))])):(d(),p("div",K," N\xE3o h\xE1 titulos em aberto para este contato "))]),_:1}),o(T,{class:"bg-white",name:"tab-2"},{default:r(()=>[h("div",W," Saldo R$ "+g(l.$filters.numero(t.saldo,2)),1),o(V,{class:"no-shadow"},{default:r(()=>[(d(!0),p(q,null,x(Object.keys(t.creditoCliente),u=>(d(),p("div",{key:u,class:"q-pa-none text-left"},[h("label",X,g(u),1),o(z,{highlight:"",style:{width:"100%"}},{default:r(()=>[(d(!0),p(q,null,x(t.creditoCliente[u],f=>(d(),v(H,{key:f.id},{default:r(()=>[f.creditoDevolucao<0?(d(),v(y,{key:0,avatar:""},{default:r(()=>[o($,{name:"trending_down",color:"red"})]),_:1})):(d(),v(y,{key:1,icon:"trending_up",avatar:""},{default:r(()=>[o($,{name:"trending_up",color:"green-6"})]),_:1})),o(y,null,{default:r(()=>[o(k,null,{default:r(()=>[C(g(f.documentoTipo),1)]),_:2},1024),o(k,{caption:""},{default:r(()=>e[3]||(e[3]=[C(" Saldo ")])),_:1})]),_:2},1024),o(y,{avatar:""},{default:r(()=>[o(b,{class:"q-mx-sm",escuro:"",cor:"green-6",denso:"",round:""},{default:r(()=>[C(" #"+g(parseInt((t.documentos[f.documentoId]||{}).numero)||(f.documentoId||"").slice(-6)),1)]),_:2},1024)]),_:2},1024),o(y,{right:""},{default:r(()=>[f.creditoDevolucao<0?(d(),p("p",Y,g(l.$filters.numero(f.creditoDevolucao,2)),1)):(d(),p("p",tt,g(l.$filters.numero(f.creditoDevolucao,2)),1)),f.saldo<0?(d(),p("p",ot,[h("small",null,g(l.$filters.numero(f.saldo,2)),1)])):(d(),p("p",et,[h("small",null,g(l.$filters.numero(f.saldo,2)),1)]))]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]))),128))]),_:1})]),_:1}),o(T,{class:"bg-white",name:"tab-3"},{default:r(()=>[o(n,null,{default:r(()=>[h("div",at,[M(h("div",null,[e[4]||(e[4]=h("div",{class:"text-h6 text-tertiary"}," Perfil ",-1)),o(n,{class:"q-mt-md"},{default:r(()=>[o(s,{type:"pie",data:t.graficoMensal,options:t.graficoOpcoesMensal,class:"col-12"},null,8,["data","options"])]),_:1})],512),[[S,t.titulosCliente.length]])]),h("div",it,[e[5]||(e[5]=h("div",{class:"text-h6 text-tertiary"}," Hist\xF3rico ",-1)),t.titulosHistorico.length?(d(),p("div",st,[o(B,{columns:t.historicoColunas,rows:t.titulosHistorico,"rows-per-page-options":[12],grid:""},null,8,["columns","rows"])])):(d(),p("div",rt," N\xE3o h\xE1 titulos pagos "))])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o(_,{ref:"faturaModal",receberTitulo:{id:t.modalFatura.idTitulo},onExecutar:i.executar},null,8,["receberTitulo","onExecutar"])])}var yt=F(L,[["render",lt]]);export{yt as default};
