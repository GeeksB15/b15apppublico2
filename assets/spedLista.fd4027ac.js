import{_ as I,bu as Q,r as E,o as g,p as V,f as a,w as e,S as y,T as n,P as U,F as N,u as H,C as v,U as S,t as b,d as A,k as u,m as _,e as w,Q as x,be as G,H as O,j as L,N as B,l as T,M as Y,E as j,G as $,h as J,i as K,I as X,J as W,K as Z,D as R}from"./index.2cdadbf3.js";import{L as aa}from"./Lista.c179a646.js";const oa={components:{Lista:aa},data(){return{usuario:{},sped:{},lista:[],mostrar:{barraTopo:!0,toolbarTitulo:!0,icone:"description",titulo:"SPED",buscar:!0,filtroAvancado:!0,btnAjuda:!0,btnAtualizar:!0,btnNovo:!0,toolbarAcoes:!0,checkBox:!1,btnRemover:!1,btnRestaurar:!1,centralizaTabs:!1,btnDetalhes:!1,btnExportaXLS:!1,btnMenuMais:!1,toolbarAdicao:!1,bannerMsg:""},busca:"",tabSelecionada:{valor:""},tabs:[{valor:"retificadas",rotulo:"Retificadas"},{valor:"escrituracao",rotulo:"Escritura\xE7\xE3o"},{valor:"",rotulo:"Todas"}],filtrosOriginal:{},filtros:{codigoEmpresa:null,usuario:null,mes:null,ano:null,geracao:{ini:"",fim:""}},empresaOpcoes:[],contatoEmpresas:[],opcoesMeses:[{value:1,label:"Janeiro"},{value:2,label:"Fevereiro"},{value:3,label:"Mar\xE7o"},{value:4,label:"Abril"},{value:5,label:"Maio"},{value:6,label:"Junho"},{value:7,label:"Julho"},{value:8,label:"Agosto"},{value:9,label:"Setembro"},{value:10,label:"Outubro"},{value:11,label:"Novembro"},{value:12,label:"Dezembro"}],paginacao:{atual:1,maximo:1,total:1,limite:25}}},methods:{async atualizar(s){var d;const l=$utils.logarIni("spedLista");await $tryLoading(async()=>{var k,C,D,q,z,t,i,c,h,F,M,P;let{buscarDadosRecentes:p}=s!=null?s:{},o={},r={};p&&(o=await $utils.localIDB.getItem({objectStore:"dadosRecentes",id:"SpedLista_"+((k=this.usuario)==null?void 0:k.id)}),o!=null&&o._id&&(this.tabSelecionada.valor=o==null?void 0:o.tabSelecionada,this.busca=(o==null?void 0:o.busca)||"",this.filtros={codigoEmpresa:((C=o==null?void 0:o.filtros)==null?void 0:C.codigoEmpresa)||null,usuario:((D=o==null?void 0:o.filtros)==null?void 0:D.usuario)||null,mes:((q=o==null?void 0:o.filtros)==null?void 0:q.mes)||null,ano:((z=o==null?void 0:o.filtros)==null?void 0:z.ano)||null,geracao:{ini:((i=(t=o==null?void 0:o.filtros)==null?void 0:t.geracao)==null?void 0:i.ini)||"",fim:((h=(c=o==null?void 0:o.filtros)==null?void 0:c.geracao)==null?void 0:h.fim)||""}},this.compareObject(this.filtrosOriginal,this.filtros)&&(this.$refs.faturaLista.filtros=!0))),this.busca=((F=this.busca)==null?void 0:F.trim())||"",this.filtros.termoBusca=this.busca,this.filtros.usuario=(P=(M=this.filtros)==null?void 0:M.usuario)==null?void 0:P.trim(),this.filtros=$utils.eliminarVazios(this.filtros),r=$utils.clonarV2(this.filtros),r.status=this.tabSelecionada.valor,/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/.test(this.busca)&&(delete r.termoBusca,this.tabSelecionada.valor="",r.status="",r.id=this.busca);const m=await $db.sped.leListaCompleta({filtros:r,page:this.paginacao.atual,limit:this.paginacao.limite,sort:["dataHoraSolicitacao"],dir:["desc"]});this.lista=m==null?void 0:m.data,this.paginacao.total=m==null?void 0:m.total,this.paginacao.maximo=m==null?void 0:m.totalPages,o={_id:"SpedLista_"+this.usuario.id,tabSelecionada:this.tabSelecionada.valor,filtros:$utils.clonarV2(this.filtros),page:this.paginacao.atual,limit:this.paginacao.limite},await $utils.localIDB.setItem({objectStore:"dadosRecentes",data:o})}),$utils.logarFim(l,(d=this.lista)==null?void 0:d.length)},async atualizarPeriodico(){for(;this.ativaAtualizarPeriodico;){if(await $utils.dormir(3e4),!this.ativaAtualizarPeriodico)return;const s=this.lista.filter(({status:l})=>["Solicitado","Processando"].includes(l));for(const l of s)try{const d=await $db.sped.leListaCompleta({filtros:{id:l.id},page:1,limit:1,sort:["dataHoraSolicitacao"],dir:["desc"]});l.status=d.data[0].status,l.mensagemGeracao=d.data[0].mensagemGeracao}catch(d){console.error("Erro na consulta de status",d)}}},dialogSped(){var l;let s=new Date;s.setMonth(s.getMonth()-1),this.sped={visivel:!0,codigoEmpresa:this.sped.codigoEmpresa||((l=this.contatoEmpresas[0])==null?void 0:l.codigoContato),ano:this.sped.ano||s.getFullYear(),mes:this.sped.mes||s.getMonth()+1}},async gerarSped(){try{$q.loading.show({spinner:Q,spinnerColor:"amber",message:"Processando..."});const s=await $utils.geeksApi({gerarSped:{funcao:"CFA9862B-7CA9-4A4A-AC44-0424483B1C78",ano:this.sped.ano,mes:this.sped.mes,codigoEmpresa:this.sped.codigoEmpresa,usuario:$db.usuario.logado.nome,removerImpostoEntrada:0,retificadora:0}});this.sped.visivel=!1,$q.notifyPositive(s.data.gerarSped.mensagem||"Erro"),await $utils.dormir(100),await this.atualizar()}catch(s){$q.notifyError("Erro ao gerar SPED",s)}finally{$q.loading.hide()}},limparSped(){this.sped.visivel=!1},async limparFiltrosClick(){this.filtros=$utils.clonar(this.filtrosOriginal),await this.atualizar()},async empresaOpcoesCarregar(){this.contatoEmpresas=await $db.contatoEmpresa.listaCache(),this.empresaOpcoes=this.contatoEmpresas.map(s=>({label:s.nome,value:s.codigoContato}))},compareObject(s,l,d=[]){const p=Object.keys(s);for(const o of p)if(!d.includes(o)){if(typeof s[o]=="object"&&s[o]!==null){if(!this.compareObject(s[o],l[o],d))continue;return!0}else if(s[o]!==l[o])return!0}return!1},async retificar(s){var d;if(!s)return;const l=(d=this.contatoEmpresas)==null?void 0:d.find(p=>p.codigoContato===s.codigoEmpresa);if(!!await $q.dialogSimNao({title:"Retificar",message:`Deseja retificar o SPED de ${s.mes}/${s.ano} para ${l==null?void 0:l.nome} - ${l==null?void 0:l.numeroDocumentoNacional}?`}))try{$q.loading.show({spinner:Q,spinnerColor:"amber",message:"Processando..."});const p=await $utils.geeksApi({retificarSped:{funcao:"CFA9862B-7CA9-4A4A-AC44-0424483B1C78",ano:s.ano,mes:s.mes,codigoEmpresa:s.codigoEmpresa,usuario:$db.usuario.logado.nome,removerImpostoEntrada:0,retificadora:1}});$q.notifyPositive(p.data.retificarSped.mensagem||"Erro"),await $utils.dormir(100),await this.atualizar()}catch(p){$q.notifyError("Erro na gera\xE7\xE3o do SPED",p)}finally{$q.loading.hide()}},async download(s){!s.id||!await $q.dialogSimNao({title:"Download",message:"Deseja prosseguir com a opera\xE7\xE3o?"})||await $tryLoading(async()=>{var m;const d=(await $utils.geeksApi({downloadSped:{funcao:"34498589-8107-4A24-AC38-A4443D104D44",id:s.id}})).data.downloadSped;$utils.verificarErro(!d,"N\xE3o foi poss\xEDvel recuperar o arquivoSped");const p=(m=this.contatoEmpresas)==null?void 0:m.find(k=>k.codigoContato===s.codigoEmpresa),o=$utils.filtrarDigitos(p==null?void 0:p.numeroDocumentoNacional),r=document.createElement("a"),f=new Blob([d],{type:"text/plain"});r.setAttribute("href",window.URL.createObjectURL(f)),r.setAttribute("download",`${o}-${s.ano}-${String(s.mes).padStart(2,"0")}-sped.txt`),r.click()})}},beforeUnmount(){this.ativaAtualizarPeriodico=!1},async created(){this.usuario=JSON.parse(localStorage.getItem("usuario")),this.filtrosOriginal=$utils.clonar(this.filtros),this.empresaOpcoesCarregar(),await this.atualizar({buscarDadosRecentes:!0}),this.ativaAtualizarPeriodico=!0,this.atualizarPeriodico()}},ea={id:"SpedLista"},la={class:"mw80 text-center"},ta={class:"text-weight-bold"},sa={class:"q-mt-xs"},ia={class:"text-weight-medium"},ra={class:"q-ml-sm"},na={key:0,class:"text-weight-bold"},ua={key:1};function da(s,l,d,p,o,r){const f=E("campo"),m=E("BadgeCopiarUid"),k=E("avatar"),C=E("badge"),D=E("Lista"),q=E("g-col"),z=E("g-row");return g(),V("div",ea,[a(D,{ref:"spedLista",busca:o.busca,"onUpdate:busca":l[7]||(l[7]=t=>o.busca=t),onAtualizar:r.atualizar,onLimparFiltrosClick:r.limparFiltrosClick,onCriarClick:r.dialogSped,lista:o.lista,tabSelecionada:o.tabSelecionada,tabs:o.tabs,paginacao:o.paginacao,mostrar:o.mostrar},{filtroCampos:e(()=>[a(f,{modelValue:o.filtros.usuario,"onUpdate:modelValue":l[0]||(l[0]=t=>o.filtros.usuario=t),debounce:500,dense:"",rotulo:"Usu\xE1rio",class:"col-12 q-mt-md"},null,8,["modelValue"]),a(f,{modelValue:o.filtros.codigoEmpresa,"onUpdate:modelValue":l[1]||(l[1]=t=>o.filtros.codigoEmpresa=t),options:o.empresaOpcoes,clearable:"",dense:"",tipo:"seletor",rotulo:"Por empresa",class:"col-12 q-mt-lg"},null,8,["modelValue","options"]),a(f,{modelValue:o.filtros.mes,"onUpdate:modelValue":l[2]||(l[2]=t=>o.filtros.mes=t),options:o.opcoesMeses,clearable:"",dense:"",tipo:"seletor",rotulo:"M\xEAs",class:"col-12 q-mt-lg"},null,8,["modelValue","options"]),a(f,{modelValue:o.filtros.ano,"onUpdate:modelValue":l[3]||(l[3]=t=>o.filtros.ano=t),dense:"",tipo:"numero",rotulo:"Ano",class:"col-12 q-mt-lg"},null,8,["modelValue"]),a(y,{class:"q-pa-none q-mt-xl"},{default:e(()=>[a(n,null,{default:e(()=>[a(f,{modelValue:o.filtros.geracao.ini,"onUpdate:modelValue":l[4]||(l[4]=t=>o.filtros.geracao.ini=t),dense:"",tipo:"data",format:"DD/MM/YYYY",rotulo:"Gera\xE7\xE3o de"},null,8,["modelValue"])]),_:1})]),_:1}),a(y,{class:"q-pa-none q-mt-xs"},{default:e(()=>[a(n,null,{default:e(()=>[a(f,{modelValue:o.filtros.geracao.fim,"onUpdate:modelValue":l[5]||(l[5]=t=>o.filtros.geracao.fim=t),dense:"",tipo:"data",format:"DD/MM/YYYY",rotulo:"Gera\xE7\xE3o at\xE9"},null,8,["modelValue"])]),_:1})]),_:1}),a(f,{modelValue:o.paginacao.limite,"onUpdate:modelValue":l[6]||(l[6]=t=>o.paginacao.limite=t),tipo:"quantidade",dense:"",rotulo:"Quantidade por p\xE1gina",min:"1",class:"col-12 q-mt-xl"},null,8,["modelValue"])]),itemLista:e(()=>[a(U,{bordered:"",class:"bg-white q-mb-xs rounded-borders"},{default:e(()=>[(g(!0),V(N,null,H(o.lista,t=>(g(),V("div",{key:t.id,class:"itemHover"},[a(y,{"manual-focus":"",clickable:"",class:"q-py-sm q-px-xs items-center"},{default:e(()=>[a(n,{class:"hideonmobile col-auto q-pr-sm no-margin"},{default:e(()=>[a(y,{class:"q-pa-none"},{default:e(()=>[a(n,{side:"",class:"col-auto q-pa-none"},{default:e(()=>[v("div",la,[a(m,{id:t.id,escuro:"",cor:"positive"},null,8,["id"])])]),_:2},1024)]),_:2},1024)]),_:2},1024),a(n,{class:"col-md col-lg col-xl no-margin"},{default:e(()=>[a(y,{class:"q-pa-none"},{default:e(()=>[a(n,{class:"col-auto items-center"},{default:e(()=>{var i,c;return[a(k,{rotulo:(c=(i=o.empresaOpcoes)==null?void 0:i.filter(h=>h.value===t.codigoEmpresa))==null?void 0:c.label,tamanho:"40",style:{display:"flex","align-self":"center"}},null,8,["rotulo"])]}),_:2},1024),a(n,{class:"col"},{default:e(()=>[a(S,{lines:"2"},{default:e(()=>{var i,c;return[v("span",null,[v("span",ta,b((c=(i=o.empresaOpcoes)==null?void 0:i.find(h=>h.value===t.codigoEmpresa))==null?void 0:c.label),1)])]}),_:2},1024),a(S,{caption:"",lines:"2"},{default:e(()=>{var i,c;return[v("span",null,b((c=(i=o.contatoEmpresas)==null?void 0:i.find(h=>h.codigoContato===t.codigoEmpresa))==null?void 0:c.numeroDocumentoNacional),1)]}),_:2},1024),t.usuario?(g(),A(S,{key:0,caption:"",lines:"2"},{default:e(()=>[v("span",null,[u(b(t.usuario)+" ",1),a(_,{anchor:"bottom middle",self:"center middle"},{default:e(()=>l[12]||(l[12]=[u("Usu\xE1rio")])),_:1})])]),_:2},1024)):w("",!0),a(n,{class:"hideondesktop"},{default:e(()=>[v("div",sa,[a(m,{id:t.id,escuro:"",cor:"positive"},null,8,["id"]),a(C,{dica:"Status",class:"q-ml-xs",cor:t.idSpedAnterior?"tertiary":"light",rotulo:t.idSpedAnterior?"Retificadas":"Escritura\xE7\xE3o",escuro:!!t.idSpedAnterior},null,8,["cor","rotulo","escuro"]),t.dataHoraSolicitacao?(g(),A(S,{key:0,caption:"",class:"q-pt-xs"},{default:e(()=>[v("span",ia,b(s.$filters.data(t.dataHoraSolicitacao)),1),v("span",ra,b(s.$filters.hora(t.dataHoraSolicitacao)),1)]),_:2},1024)):w("",!0),t.mes&&t.ano?(g(),A(S,{key:1,caption:"",lines:"2"},{default:e(()=>{var i,c;return[t.mes?(g(),V("span",na,[u(b((c=(i=o.opcoesMeses)==null?void 0:i.find(h=>h.value===t.mes))==null?void 0:c.label)+" ",1),a(_,{anchor:"bottom middle",self:"center middle"},{default:e(()=>l[13]||(l[13]=[u("M\xEAs")])),_:1})])):w("",!0),t.ano?(g(),V("span",ua,[u(" / "+b(t.ano)+" ",1),a(_,{anchor:"bottom middle",self:"center middle"},{default:e(()=>l[14]||(l[14]=[u("Ano")])),_:1})])):w("",!0)]}),_:2},1024)):w("",!0)])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),o.tabSelecionada.valor===""?(g(),A(n,{key:0,class:"hideonmobile maxw100 no-margin text-center"},{default:e(()=>[a(S,{caption:"",lines:"2"},{default:e(()=>[a(C,{cor:t.idSpedAnterior?"tertiary":"light",rotulo:t.idSpedAnterior?"Retificadas":"Escritura\xE7\xE3o",escuro:!!t.idSpedAnterior,dica:"Status"},null,8,["cor","rotulo","escuro"])]),_:2},1024)]),_:2},1024)):w("",!0),a(n,{class:"maxw100 no-margin text-center"},{default:e(()=>[a(S,{caption:"",lines:"2"},{default:e(()=>[a(C,{cor:t.status==="Finalizado"?"positive":"tertiary",rotulo:t.status,escuro:""},null,8,["cor","rotulo"])]),_:2},1024),t.mensagemGeracao?(g(),A(_,{key:0,anchor:"bottom middle",self:"center middle"},{default:e(()=>[u(b(t.mensagemGeracao),1)]),_:2},1024)):w("",!0)]),_:2},1024),a(n,{class:"hideonmobile maxw90 no-margin"},{default:e(()=>[a(S,{caption:"",class:"text-weight-medium"},{default:e(()=>[u(b(s.$filters.data(t.dataHoraSolicitacao)),1)]),_:2},1024),a(S,{caption:""},{default:e(()=>[u(b(s.$filters.hora(t.dataHoraSolicitacao)),1)]),_:2},1024),a(_,{anchor:"bottom middle",self:"center middle"},{default:e(()=>l[15]||(l[15]=[u("Data da Gera\xE7\xE3o")])),_:1})]),_:2},1024),a(n,{class:"hideonmobile maxw80 no-margin"},{default:e(()=>[t.mes?(g(),A(S,{key:0,caption:"",lines:"2",class:"text-weight-bold"},{default:e(()=>{var i,c;return[v("span",null,[u(b((c=(i=o.opcoesMeses)==null?void 0:i.find(h=>h.value===t.mes))==null?void 0:c.label)+" ",1),a(_,{anchor:"bottom middle",self:"center middle"},{default:e(()=>l[16]||(l[16]=[u("M\xEAs")])),_:1})])]}),_:2},1024)):w("",!0),t.ano?(g(),A(S,{key:1,caption:"",lines:"2"},{default:e(()=>[v("span",null,[u(b(t.ano)+" ",1),a(_,{anchor:"bottom middle",self:"center middle"},{default:e(()=>l[17]||(l[17]=[u("Ano")])),_:1})])]),_:2},1024)):w("",!0)]),_:2},1024),a(n,{class:"col-auto q-pl-sm no-margin"},{default:e(()=>[a(y,{class:"q-pa-none"},{default:e(()=>[a(n,{class:"hideonmobile no-margin"},{default:e(()=>[v("span",null,[a(x,{onClick:i=>r.retificar(t),icon:"reply_all",size:"md",flat:"",dense:"",round:"",class:"hideonmobile"},null,8,["onClick"]),a(_,{anchor:"bottom middle",self:"center middle"},{default:e(()=>l[18]||(l[18]=[u("Retificar")])),_:1})])]),_:2},1024),a(n,{onClick:i=>r.download(t),class:"hideonmobile no-margin"},{default:e(()=>[v("span",null,[a(x,{icon:"download",size:"md",flat:"",dense:"",round:"",class:"hideonmobile",disabled:t.status!=="Finalizado"},null,8,["disabled"]),a(_,{anchor:"bottom middle",self:"center middle"},{default:e(()=>[u(b(t.status==="Finalizado"?"Exportar":"Aguarde finaliza\xE7\xE3o"),1)]),_:2},1024)])]),_:2},1032,["onClick"]),a(n,{class:"hideondesktop no-margin"},{default:e(()=>[a(x,{icon:"more_vert",size:"md",round:"",flat:"",dense:""},{default:e(()=>[a(G,null,{default:e(()=>[O((g(),A(U,{link:"","no-border":"",separator:""},{default:e(()=>[a(y,{onClick:i=>r.retificar(t),clickable:"",class:"hideondesktop"},{default:e(()=>[a(n,{avatar:""},{default:e(()=>[a(L,{name:"reply_all",size:"sm"})]),_:1}),a(n,null,{default:e(()=>l[19]||(l[19]=[u("Retificar")])),_:1})]),_:2},1032,["onClick"]),a(y,{onClick:i=>r.download(t),clickable:"",class:"hideondesktop"},{default:e(()=>[a(n,{avatar:""},{default:e(()=>[a(L,{name:"download",size:"sm"})]),_:1}),a(n,null,{default:e(()=>l[20]||(l[20]=[u("Exportar")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024)),[[B]])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),a(T)]))),128))]),_:1})]),_:1},8,["busca","onAtualizar","onLimparFiltrosClick","onCriarClick","lista","tabSelecionada","tabs","paginacao","mostrar"]),a(R,{modelValue:o.sped.visivel,"onUpdate:modelValue":l[11]||(l[11]=t=>o.sped.visivel=t),onHide:r.limparSped},{default:e(()=>[a(Y,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"350px"}},{default:e(()=>[a(j,{onSubmit:r.gerarSped,autocorrect:"off",autocapitalize:"off",autocomplete:"off",spellcheck:"false",novalidate:""},{default:e(()=>[a($,{class:"bg-white text-tertiary border-bottom"},{default:e(()=>[a(J,null,{default:e(()=>[a(K,null,{default:e(()=>[a(L,{name:"event",size:"sm",class:"q-mr-sm"}),l[21]||(l[21]=u(" Gerar SPED "))]),_:1})]),_:1})]),_:1}),a(X,null,{default:e(()=>[a(W,null,{default:e(()=>[a(z,{gutter:"md"},{default:e(()=>[a(q,{col:"12"},{default:e(()=>[a(f,{modelValue:o.sped.codigoEmpresa,"onUpdate:modelValue":l[8]||(l[8]=t=>o.sped.codigoEmpresa=t),options:o.empresaOpcoes,clearable:"",dense:"",tipo:"seletor",rotulo:"Por empresa",class:"col-12 q-mt-lg"},null,8,["modelValue","options"])]),_:1}),a(q,{col:"12 sm6"},{default:e(()=>[a(f,{modelValue:o.sped.mes,"onUpdate:modelValue":l[9]||(l[9]=t=>o.sped.mes=t),options:o.opcoesMeses,clearable:"",dense:"",tipo:"seletor",rotulo:"M\xEAs",class:"col-12 q-mt-lg"},null,8,["modelValue","options"])]),_:1}),a(q,{col:"12 sm6"},{default:e(()=>[a(f,{modelValue:o.sped.ano,"onUpdate:modelValue":l[10]||(l[10]=t=>o.sped.ano=t),dense:"",tipo:"numero",rotulo:"Ano",class:"col-12 q-mt-lg"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),a(Z,{class:"bg-white text-right border-top q-pa-sm"},{default:e(()=>[O(a(x,{label:"Cancelar",color:"tertiary",flat:"",class:"q-mr-sm"},null,512),[[B]]),a(x,{label:"Gerar",type:"submit",color:"primary",unelevated:"",dark:"",class:"q-ml-sm"})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue","onHide"])])}var fa=I(oa,[["render",da]]);export{fa as default};
