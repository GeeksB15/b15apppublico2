import{_ as Be,bh as $e,Y as Qe,Z as He,c$ as je,bf as Ge,bp as We,d0 as Je,bx as Ke,d1 as Ye,cX as Ze,cY as Xe,cZ as eo,d2 as oo,d3 as ao,d4 as to,c_ as io,a5 as ge,p as P,o as d,d as M,f as t,w as i,K as Ue,A as lo,B as N,C as A,D as y,L as I,E as T,e as m,a7 as _e,l as g,G as ro,x as c,t as v,i as f,az as oe,N as Y,F as x,r as Z,P as C,R as u,j as _,S as E,s as X,a6 as Se,k as ee,cr as ve,I as so,bb as no,y as te,M as ze,a4 as ie,h as co,cT as uo,bw as be,bs as Re}from"./index.15b86ac9.js";import{e as mo}from"./emitirNFe.35117289.js";import{D as po}from"./DocumentosFiscais.91448d6f.js";import{M as ho}from"./ModalHistoricoStatus.2ef4c951.js";const fo={components:{Arquivo:$e,Avatar:Qe,Badge:He,CodigoBarras:je,ContatoCriar:Ge,PromptItemV2:We,Receita:Je,Tutorial:Ke,Pupilometro:Ye,DocumentoCodigo:Ze,DocumentoMetas:Xe,Faturamento:eo,PromptItemTabelaPrecoNovo:oo,PromptDocumentoOperacao:ao,TitulosPendentesEmAtraso:to},computed:{carrinhoSemArmacaoVazia(){return this.carrinho.filter(a=>!(a.tipoItem==="Arma\xE7\xE3o"&&!a.descricaoItem.trim()&&a.total===0&&a.valorItem===0))},erroDataHoraPrevisto(){if(this.campos.dataHoraPrevisto){const a=new Date().setHours(0,0,0,0);if(new Date(this.campos.dataHoraPrevisto)<new Date(a))return"Previs\xE3o de entrega n\xE3o pode ser menor do que a data de hoje"}return""},descricaoClassificacaoDestinatario(){return this.classificacaoDestinatario===0?"PF N\xE3o Contribuinte":this.classificacaoDestinatario===1?"PJ Contribuinte":this.classificacaoDestinatario===2?"PJ N\xE3o Contribuinte":"Sem classifica\xE7\xE3o de destinat\xE1rio"},ehOrcamento(){var a,o,l,n;return["AGUARDANDO LIBERA\xC7\xC3O","AGUARDANDO ESTOQUE","AGUARDANDO FINANCEIRO","OR\xC7AMENTO"].includes((((o=(a=this.envelope)==null?void 0:a.documento)==null?void 0:o.status)||"").toUpperCase())&&(((n=(l=this.envelope)==null?void 0:l.documento)==null?void 0:n.tipo)||"").toUpperCase()==="ENVELOPE"}},data(){return{armacao:{alturaMontagemOD:null,alturaMontagemOE:null,diagonal:null,ponte:null,altura:null,tamanho:"",armacaoMaterial:"",tipoMontagem:""},armacaoMaterialModal:!1,armacaoMaterialDescricao:"",envelope:{},mostrarTitulosPendentesEmAtraso:{},modalCreditoDisponivel:{},modalItensSemEstoque:{data:[],resolve:null,reject:null,visivel:!1},visivel:!1,opcoesArmacaoMaterial:[],tipoMontagemModal:!1,tipoMontagemDescricao:"",opcoesTipoMontagem:[],campos:{totalDesconto:0,totalPercentualDesconto:0,subTotal:0,totalDocumento:0,idContato:"",descricaoContato:"",idDocumentoAdicional:"",dataHoraPrevisto:""},tipo:"Envelope",tipoEnvelope:"Oculos",tipoLente:"",tipoOculos:"Vista",carrinho:[],documentoContato:[],duplicarReceita:!1,descricaoReceitaSelecionada:"",modalItem:{visivel:!1,filtros:{}},modalPupilometro:{},tipoPupilometro:"",permissaoPupilometro:!1,descricaoLaboratorio:"",itensTipo:[],itens:{},tipoDescontoPercentagem:!0,tipoDescontoTotal:!0,pacientes:[{label:"",value:""}],tipoLentes:[],tipoLentesOculos:["","Monofocal (Longe)","Monofocal (M\xE9dio)","Monofocal (Perto)","Bifocal (Longe e Perto)","Multifocal (Longe e Perto)","Intermedi\xE1rio (M\xE9dio e Perto)","Intermedi\xE1rio (Longe e M\xE9dio)"],tipoLentesContato:["","Monofocal (Longe)","Bifocal (Longe e Perto)","Multifocal (Longe e Perto)"],receita:{},receitasDescricao:[],modalReceita:{visivel:!1,id:"",idEmpresa:"",duplicar:!1},arquivo:[],opcoesPacientes:[],filtroAvancado:void 0,dataPrevisaoEntrega:null,horaPrevisaoEntrega:null,classificacaoDestinatario:null,menuVenda:!1,contatoResponsavel:null,contato:{imagem:null},exibirCarregando:!1}},emits:["atualizar","fechou"],methods:{async abrirReceitaAoAbrirEnvelope(){const a=localStorage.getItem("idReceita");a&&(localStorage.removeItem("idReceita"),this.receitas.some(o=>o.id===a)&&await this.abrirModalReceita(a,!1))},async reprovarOrcamento(){try{const a=await new Promise((o,l)=>$q.dialog({message:"Especifique o motivo:",noRefocus:!0,preventClose:!0,prompt:{model:"",type:"text",class:"bg-light"},title:"Reprovar or\xE7amento?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(n=>{o(n.trim())}).onCancel(()=>{l()}));if(a)try{$q.loading.show({message:"Reprovando..."});const o=$utils.dataAtual(),l="N\xE3o Aprovado",e=((await $db.contato.le({numeroDocumentoNacional:$db.usuario.logado.numeroDocumentoNacional}))[0]||{}).id||"";this.envelope.documentoStatus.push({id:$utils.uuid(),idDocumento:this.campos.id,dataHoraEmissao:o,operacao:this.campos.operacao,statusOriginal:this.campos.status,statusFinalizado:l,observacao:a,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional}),this.campos.motivoCancelamento=a,this.campos.status=l,this.campos.dataHoraFinalizado=o;for(const r of this.carrinho)r.status=l,r.dataHoraFinalizado=o;this.$refs.faturamento.condicaoPagamento=[],await this.corrigirValores(),await this.salvar(),$q.notifyPositive("Or\xE7amento reprovado")}catch(o){$q.notifyError("Ocorreu um erro ao reprovar o or\xE7amento.",o)}finally{$q.loading.hide()}else $q.notifyError("Especifique o motivo")}catch(a){console.error(a)}},async retornarOrcamento(){try{$q.loading.show(),await io({idDocumento:this.campos.id})}catch(a){this.$q.notifyError(a.message);return}finally{$q.loading.hide()}this.$q.dialog({message:"Retornar para or\xE7amento?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(async()=>{try{$q.loading.show({message:"Retornando..."});try{await $db.venda.checarConflitoStatus({id:this.campos.id,status:this.envelopeOriginal.documento.status})}catch(e){return $q.notifyError(e.message),!1}let a=await $db.documentoStatus.le({idDocumento:this.campos.id});if(a=$lodash.orderBy(a,"dataHoraEmissao","desc")[0],["Faturado","Aguardando Pagamento"].includes(this.campos.status))return $q.notifyError("N\xE3o \xE9 poss\xEDvel reabrir envelopes de faturas j\xE1 pagas! Por favor, reabra a fatura."),!1;if(!await $db.permissao.objeto("Diretiva_Vendas_Reabertura")){const e=new Date,r=new Date(this.campos.dataHoraFinalizado);if(r.getFullYear()<e.getFullYear()||r.getMonth()<e.getMonth())return $q.notifyError("N\xE3o \xE9 poss\xEDvel reabrir envelopes de meses passados!"),!1}this.documentoStatus=[];const o=$utils.dataAtual(),n=((await $db.contato.le({numeroDocumentoNacional:$db.usuario.logado.numeroDocumentoNacional}))[0]||{}).id||"";for(const e of this.carrinho)e.status="Or\xE7amento",e.dataHoraFinalizado="";this.campos.idFatura="",this.campos.idContatoFinalizado="",this.campos.status="Or\xE7amento",this.campos.dataHoraFinalizado="",this.campos.dataHoraRealizado="",this.campos.motivoCancelamento="",this.envelope.documentoStatus.push({id:$utils.uuid(),idDocumento:this.campos.id,dataHoraEmissao:o,operacao:this.campos.operacao,statusOriginal:a==null?void 0:a.statusFinalizado,statusFinalizado:"Or\xE7amento",cpfUsuario:$db.usuario.logado.numeroDocumentoNacional}),await this.corrigirValores(),await this.salvar(),$q.notifyPositive("Envelope retornado para or\xE7amento")}catch(a){return $q.notifyError("N\xE3o foi poss\xEDvel retornar para or\xE7amento.",a),!1}finally{$q.loading.hide()}})},async finalizar(){try{await new Promise((a,o)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar este or\xE7amento",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{a()}).onCancel(()=>{o()})})}catch{return}this.erroEncontrado()||(this.modalCreditoDisponivel={permiteFinalizar:!1,resolve:void 0,reject:void 0,visivel:!1},await this.corrigirValores(),await $db.envelope.finalizar({tela:this,dados:this.envelope,dadosOriginal:this.envelopeOriginal}))},ajustarDataHoraPrevisaoEntrega(){let a;a=new Date(this.dataPrevisaoEntrega),a.setHours(this.horaPrevisaoEntrega.slice(0,2)),a.setMinutes(this.horaPrevisaoEntrega.slice(3,5)),this.campos.dataHoraPrevisto=ge.formatDate(a)},async criarOpcoesPacientes(){try{const a=await $db.hibrido.le({table:"contato",id:this.envelope.documento.idContatoResponsavel}),o=await $db.contato.leFilhos(this.envelope.documento.idContatoResponsavel);o.push(a);const l=o.map(n=>({label:n.nome,value:n.id}));return l.sort((n,e)=>n.label<e.label?1:-1),l}catch(a){this.$q.notifyError("N\xE3o foi poss\xEDvel carregar os dados de pacientes",a)}},filtrarPacientes(a,o){o(async()=>{const l=await this.criarOpcoesPacientes();if(a==="")this.opcoesPacientes=l;else{const n=a.toLowerCase();this.opcoesPacientes=l.filter(e=>e.label.toLowerCase().indexOf(n)>-1)}})},async fecharModalPupilometro(){if(this.modalPupilometro.visivel=!1,$db.pupilometro.fotoOriginal==="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAQAAAAkGDomAAAATklEQVR42u3OMQEAAAgDINc/9Czh4QEJSDuvRVBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUPDSAovln7Gzmi7KAAAAAElFTkSuQmCC")return;let a={id:(this.modalPupilometro.pupilometroAtual||{}).id||$utils.uuid(),descricao:"Pupil\xF4metro",referencia:"idEnvelope:"+this.campos.id,json:JSON.stringify({medidas:$db.pupilometro.medidas})};this.modalPupilometro.pupilometroAtual=a,this.modalPupilometro.fotoAtual=$db.pupilometro.foto,this.modalPupilometro.fotoOriginalAtual=$db.pupilometro.fotoOriginal,this.armacao.largura=$db.pupilometro.medidas.tamanhoArmacao,this.armacao.ponte=$db.pupilometro.medidas.ponte,this.armacao.altura=$db.pupilometro.medidas.alturaArmacao,this.armacao.diagonal=$db.pupilometro.medidas.diagonal.distancia,$db.pupilometro.medidas.bifocal?(this.armacao.alturaMontagemOD=$db.pupilometro.medidas.bifocalOlhoDireito,this.armacao.alturaMontagemOE=$db.pupilometro.medidas.bifocalOlhoEsquerdo):(this.armacao.alturaMontagemOD=$db.pupilometro.medidas.dip.od.altura,this.armacao.alturaMontagemOE=$db.pupilometro.medidas.dip.oe.altura),await this.salvarDnp()},async abrirModalPupilometro(a){if(this.modalPupilometro={...this.modalPupilometro,visivel:!1,avancar:this.envelope.somenteLeitura?"Medidas":""},$db.pupilometro.limpar(),$db.pupilometro.medidas.tipo="Presencial",this.armacao.largura&&($db.pupilometro.medidas.tamanhoArmacao=this.armacao.largura),this.armacao.ponte&&($db.pupilometro.medidas.ponte=this.armacao.ponte),this.armacao.diagonal&&($db.pupilometro.medidas.diagonal.distancia=this.armacao.diagonal),this.armacao.altura&&($db.pupilometro.medidas.alturaArmacao=this.armacao.altura),(this.modalPupilometro.pupilometroAtual||{}).json){const o=JSON.parse(this.modalPupilometro.pupilometroAtual.json),l=async n=>{$db.pupilometro[n]=await $db.pupilometro.leFoto({id:this.modalPupilometro.pupilometroAtual.id,tipoFoto:n})};await Promise.all([l("foto"),l("fotoOriginal")]),$db.pupilometro.medidas=o.medidas,this.armacao.largura&&($db.pupilometro.medidas.tamanhoArmacao=this.armacao.largura),this.armacao.ponte&&($db.pupilometro.medidas.ponte=this.armacao.ponte),this.armacao.diagonal&&($db.pupilometro.medidas.diagonal.distancia=this.armacao.diagonal),this.envelope.somenteLeitura||$db.pupilometro.foto!=="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAQAAAAkGDomAAAATklEQVR42u3OMQEAAAgDINc/9Czh4QEJSDuvRVBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUPDSAovln7Gzmi7KAAAAAElFTkSuQmCC"?this.modalPupilometro.avancar="Medidas":this.modalPupilometro.avancar="TirarFoto"}if(a==="Cart\xE3o"){$db.pupilometro.medidas.tipo=a,$db.pupilometro.medidas.olhoDireito.centroOlho.top=345,$db.pupilometro.medidas.olhoDireito.centroOlho.left=255,$db.pupilometro.medidas.olhoEsquerdo.centroOlho.top=345,$db.pupilometro.medidas.olhoEsquerdo.centroOlho.left=450,$db.pupilometro.medidas.nariz.top=0,$db.pupilometro.medidas.nariz.left=0,$db.pupilometro.medidas.ponte=23,this.envelope.somenteLeitura||$db.pupilometro.foto!=="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAQAAAAkGDomAAAATklEQVR42u3OMQEAAAgDINc/9Czh4QEJSDuvRVBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUPDSAovln7Gzmi7KAAAAAElFTkSuQmCC"?this.modalPupilometro.avancar="CartaoMedidas":this.modalPupilometro.avancar="CartaoFoto",this.modalPupilometro={...this.modalPupilometro,visivel:!0},this.$nextTick(()=>{this.modalPupilometro.avancar==="CartaoFoto"&&this.$refs.pupilometro.cartaoNovo()});return}this.$nextTick(()=>{this.modalPupilometro.visivel=!0})},abrirArmacaoMaterialModal(){this.envelope.somenteLeitura||(this.armacaoMaterialModal=!0)},abrirTipoMontagemModal(){this.envelope.somenteLeitura||(this.tipoMontagemModal=!0)},async atualizarArmacaoMaterial(){let a=[];await $db.item.carregarMemoria();for(const l of $db.item.itens)l.armacaoMaterial&&!~a.indexOf(l.armacaoMaterial)&&a.push(l.armacaoMaterial);await $tryLoading(async()=>{var l,n;if($db.hibrido.isOnline()){const e=await $utils.geeksApi({consultaArmacaoMaterial:{funcao:"6FF4BA1C-F269-4F94-B567-0FA84041B371"}});if((l=e==null?void 0:e.data)!=null&&l.consultaArmacaoMaterial){let r=(n=e.data)==null?void 0:n.consultaArmacaoMaterial;r=r.map(p=>p.ArmacaoMaterial),a=a.concat(r)}}else{let e=(await $erp().documentoItem.toArray()).map(r=>r.armacaoMaterial);e=e.filter(r=>r),e=e.filter((r,p,k)=>k.indexOf(r)===p),a=a.concat(e)}}),a=a.map(l=>({armacaoMaterial:l,sort:l.toLowerCase()})),a=$lodash.orderBy(a,"sort","asc");const o=[];for(const l of a)o.push({rotulo:l.armacaoMaterial,valor:l.armacaoMaterial});this.opcoesArmacaoMaterial=o},async atualizarTipoMontagem(){let a=[];await $db.item.carregarMemoria();for(const l of $db.item.itens)l.tipoMontagem&&!~a.indexOf(l.tipoMontagem)&&a.push(l.tipoMontagem);a=a.map(l=>({tipoMontagem:l,sort:l.toLowerCase()})),a=$lodash.orderBy(a,"sort","asc");const o=[];for(const l of a)o.push({rotulo:l.tipoMontagem,valor:l.tipoMontagem});this.opcoesTipoMontagem=o},async criarArmacaoMaterial(){this.opcoesArmacaoMaterial=$lodash.orderBy([...this.opcoesArmacaoMaterial,{rotulo:this.armacaoMaterialDescricao,valor:this.armacaoMaterialDescricao,sort:this.armacaoMaterialDescricao.toLowerCase()}],"sort","asc"),this.armacao.armacaoMaterial=this.armacaoMaterialDescricao,this.armacaoMaterialModal=!1},async criarTipoMontagem(){this.opcoesTipoMontagem=$lodash.orderBy([...this.opcoesTipoMontagem,{rotulo:this.tipoMontagemDescricao,valor:this.tipoMontagemDescricao,sort:this.tipoMontagemDescricao.toLowerCase()}],"sort","asc"),this.armacao.tipoMontagem=this.tipoMontagemDescricao,this.tipoMontagemModal=!1},async selecionarEmpresa(){const a=await $erp().empresa.toArray();let o;if(!a.filter(n=>n.ativo).length)throw new Error("Empresa n\xE3o encontrada");if(a.filter(n=>n.ativo).length===1)return a.find(n=>n.ativo);const l=await $g.promptContato.show({filtro:{ativo:!0,empresas:!0},placeholder:"Selecione a empresa"});if((l||{}).id&&(o=(await $db.empresa.le({idContato:l.id})).find(e=>e.id)),!o)throw new Error("Empresa n\xE3o selecionada");return o},async obterContatoVendedor(a){const l=((await $db.configuracoes.le({nome:"vendas.usaCarteira"}))[0]||{}).valor==="1",n=(a||{}).idContatoVendedor;if(n&&l){const p=await $erp().contato.get(n)||{};if(p.id)return p}const e=JSON.parse(localStorage.getItem("usuario"))||{};let r=(await $db.contato.ler({filtros:{ativo:!0,vendedores:!0}})).data;if(r.length===1)return r[0];for(const p of r){if(!(p||{}).numeroDocumentoNacional)continue;const k=(p.numeroDocumentoNacional||"").replace(/\D/g,""),D=(e.numeroDocumentoNacional||"").replace(/\D/g,"");if(k===D)return p}return this.selecionarContato({placeholder:"Selecione o respons\xE1vel",filtro:{ativo:!0,vendedores:!0}})},async mostrar(a){var o;try{$q.loading.show();const{idEnvelope:l,idContato:n}=a!=null?a:{};let e;if(n&&(e=await $db.hibrido.le({table:"contato",id:n})),((e==null?void 0:e.condutaRestricao)||"").trim()){this.$emit("fechar"),$q.notify({message:e.condutaRestricao,timeout:0,type:"negative",closeBtn:!0});return}if(l){const r=await $db.hibrido.le({table:"documento",id:l});r.documentoContato=await $db.hibrido.lista({table:"documentoContato",where:{idDocumento:r.id}}),this.arquivo=[],this.arquivoOriginal=await $db.arquivo.lista({tipoArquivo:"-",idTabelaMaster:r.id}),this.arquivo=$utils.clonarV2(this.arquivoOriginal),r.arquivoOriginal=this.arquivoOriginal,r.arquivo=this.arquivo,this.itensEnvelopeOriginal=[],this.itensEnvelopeOriginal=[...this.itensEnvelopeOriginal,...await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:r.id}})],this.itensEnvelope=$utils.clonarV2(this.itensEnvelopeOriginal);const p=this.itensEnvelope.filter(k=>k.idDocumento===r.id);this.envelope={documento:r,documentoStatus:[],documentoContato:r.documentoContato,documentoItens:p,somenteLeitura:!0,arquivo:r.arquivo,arquivoOriginal:r.arquivoOriginal},this.envelope.somenteLeitura=!this.ehOrcamento,delete this.envelope.documento.arquivo,delete this.envelope.documento.arquivoOriginal,delete this.envelope.documento.documentoContato,this.envelopeOriginal=$utils.clonarV2(this.envelope)}else{this.tipoLente="",this.receita={},this.carrinho=[];const r=await this.selecionarEmpresa();let p;n&&(p=await $db.hibrido.le({table:"contato",id:n})),(!p||await $db.contato.ehContatoConsumidor(p))&&(p=await this.selecionarContato({placeholder:"Selecione o cliente",filtro:{ativo:!0},habilitarBotaoNovoContato:!0}));const k=await this.obterContatoVendedor(p),D=await this.obterContatoUsuario();let O="";if(p.idItemTabelaPreco){const h=await $db.itemTabelaPreco.le({id:p.idItemTabelaPreco});(h==null?void 0:h.id)&&(!h.idEmpresa||h.idEmpresa===r.idContato)&&(O=p.idItemTabelaPreco)}if(!O){const h=await $db.configuracoes.le({nome:"vendas.tabelapadrao"});let b,L;b=h.find(F=>F.idEmpresa===r.idContato),L=Number(b==null?void 0:b.valor),L||(b=h.find(F=>!F.idEmpresa),L=Number(b==null?void 0:b.valor)),L&&(O=(o=(await $erp().itemTabelaPreco.filter(ae=>Number(ae.codigoItemTabelaPreco)===L).toArray())[0])==null?void 0:o.id)}if(!O){const h=await $erp().itemTabelaPreco.filter(b=>b.tabelaMaster===1&&!b.idEmpresa===r.idContato).toArray();if(h.length===1)O=h[0].id;else if(h.lenght>1)try{O=(await this.selecionarItemTabelaPreco(null,r.idContato)).id}catch(b){$q.notifyError(b)}}let w={id:$utils.uuid(),tipo:"Envelope",documentoId:null,documentoTipo:"Venda",status:"Or\xE7amento",dataHoraEmissao:$utils.dataAtual(),idEmpresa:r.idContato,idItemTabelaPreco:O,descricaoEmpresa:r.nome,numeroDocumentoEmpresa:r.numeroDocumentoNacional,idContato:p.id,descricaoContato:p.nome,numeroDocumentoContato:p.numeroDocumentoNacional,idContatoVendedor:k.id,idContatoDigitador:D.id,idContatoResponsavel:p.id,idContatoIndicacao:null,operacao:"Normal",codigoDocumentoOperacao:1,totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0,observacao:"",observacaoInterna:"",numeroOrdemCompra:""};this.envelope={documento:w,documentoStatus:[],documentoContato:[],documentoItens:[],somenteLeitura:!1,arquivo:[],arquivoOriginal:[]},this.envelopeOriginal={documento:{},documentoStatus:[],documentoContato:[],documentoItens:[],somenteLeitura:!1,arquivo:[],arquivoOriginal:[]}}this.envelope=$utils.clonarV2(this.envelope),this.envelopeOriginal=$utils.clonarV2(this.envelopeOriginal),await this.atualizar()}catch(l){$q.notifyError("Erro ao carregar envelope",l)}finally{$q.loading.hide()}},alterarTipoLente(){for(const a of this.carrinho)a.oculos=this.tipoLente},async selecionarPaciente(a){const o=$utils.clonar(this.envelope.documento);a.value!==o.idDocumentoAdicional&&(o.idDocumentoAdicional=""),o.idContato=a.value,o.descricaoContato=a.label,this.envelope.documento=$utils.clonar(o),this.campos=$utils.clonar(o),await this.filtrarReceitas(),await this.atualizarReceita(),await this.atualizarDocumentoMetas()},async atualizarReceita(a){var o;if(await this.filtrarReceitas(),this.receita={},a||this.receitasDescricao.length&&(a=this.receitasDescricao[0].value),a){this.receita=await $db.receita.le({id:a||this.receita.id}),await this.pacientesAtualizar();const l=$utils.clonar(this.envelope.documento);l.idContato=this.receita.paciente.id,l.descricaoContato=(o=this.pacientes.filter(n=>n.value===this.campos.idContato)[0])==null?void 0:o.label,this.envelope.documento=$utils.clonar(l),this.campos=$utils.clonar(l)}},async atualizarReceitaV2(a){var o;if(this.receita=await $db.receita.le({id:a}),await this.filtrarReceitas(),this.receita.id){const l=$utils.clonar(this.envelope.documento);l.idContato=this.receita.paciente.id,l.descricaoContato=(o=this.pacientes.filter(n=>n.value===this.campos.idContato)[0])==null?void 0:o.label,this.envelope.documento=$utils.clonar(l),this.campos=$utils.clonar(l)}},async calculaTotal(a){await $db.envelope.calculaTotal({envelope:$utils.clonar(this.campos),itensEnvelope:$utils.clonar(this.carrinho),campoAlterado:a}).then(o=>{this.envelope.documento=$utils.clonar(o.envelope),this.campos=$utils.clonar(o.envelope)})},async calculaTotalItem(a,o){const n=(await $db.envelope.calculaTotalItem({envelope:$utils.clonar(this.campos),itemEnvelope:$utils.clonar(this.carrinho[a]),campoAlterado:o})).itemEnvelope;if(o==="valorItem"){const e=$utils.clonarV2(this.carrinho);e[a]={...n,valorItem:0},this.carrinho=e,this.$nextTick(async()=>{const r=$utils.clonarV2(this.carrinho);r[a]=n,this.carrinho=r,await this.calculaTotal()})}else{const e=$utils.clonarV2(this.carrinho);e[a]=n,this.carrinho=e}await this.calculaTotal()},async abrirModalDependente(){const a=await this.$refs.modalDependente.mostrar();(a||{}).id&&(await this.criarDependencia(a),await this.filtrarReceitas())},async abrirModalReceita(a,o){try{this.$refs.modalReceita.mostrar({id:a||$utils.uuid(),idEmpresa:$lodash.get(this.envelope,"documento.idEmpresa",""),duplicar:o,idContato:this.campos.idContato,descricaoContato:this.campos.descricaoContato})}catch(l){this.$q.notifyError("Ocorreu um erro ao carregar a receita.",l)}},limparFiltroAvancado(){this.filtroAvancado={...this.filtroAvancado,cilindrico:{lte:0},esfericoInicial:{lte:0},esfericoFinal:{gte:0},tipo:"Lente"}},abrirModalItem(a,o){var h,b,L,F,ae,ce,de,ue,me,pe,he,fe,s,q,V,U,S,z,R,B,Q,$,H,j,G,W,J,K,le,re,se,ne,Ce,ye,we,ke,Oe,Ee,De,Ve,Ae,Me,Ie,qe,Pe,Le,Fe,xe,Ne,Te;let l,n,e,r,p,k,D,O,w;switch(a){case"Lentes":this.modalItem.filtros={tipo:"Lente",ativo:!0,bloquearVenda:!1},this.tipoLente&&(~this.tipoLente.indexOf("Monofocal")&&(w="Monofocal"),~this.tipoLente.indexOf("Bifocal")&&(w="Bifocal"),(~this.tipoLente.indexOf("Multifocal")||~this.tipoLente.indexOf("Intermedi\xE1rio"))&&(w="Multifocal")),n=(ae=(F=(L=(b=(h=this.receita)==null?void 0:h.prescricao)==null?void 0:b.dioptria)==null?void 0:L.od)==null?void 0:F.longe)==null?void 0:ae.cilindrico,e=(pe=(me=(ue=(de=(ce=this.receita)==null?void 0:ce.prescricao)==null?void 0:de.dioptria)==null?void 0:ue.oe)==null?void 0:me.longe)==null?void 0:pe.cilindrico,r=(V=(q=(s=(fe=(he=this.receita)==null?void 0:he.prescricao)==null?void 0:fe.dioptria)==null?void 0:s.od)==null?void 0:q.longe)==null?void 0:V.esferico,p=(B=(R=(z=(S=(U=this.receita)==null?void 0:U.prescricao)==null?void 0:S.dioptria)==null?void 0:z.oe)==null?void 0:R.longe)==null?void 0:B.esferico,l=(G=(j=(H=($=(Q=this.receita)==null?void 0:Q.prescricao)==null?void 0:$.dioptria)==null?void 0:H.od)==null?void 0:j.medio)==null?void 0:G.esferico,(!r||l&&l>r)&&(r=l),l=(re=(le=(K=(J=(W=this.receita)==null?void 0:W.prescricao)==null?void 0:J.dioptria)==null?void 0:K.oe)==null?void 0:le.medio)==null?void 0:re.esferico,(!p||l&&l>p)&&(p=l),l=(we=(ye=(Ce=(ne=(se=this.receita)==null?void 0:se.prescricao)==null?void 0:ne.dioptria)==null?void 0:Ce.od)==null?void 0:ye.perto)==null?void 0:we.cilindrico,(!n||l&&l>n)&&(n=l),l=(Ve=(De=(Ee=(Oe=(ke=this.receita)==null?void 0:ke.prescricao)==null?void 0:Oe.dioptria)==null?void 0:Ee.oe)==null?void 0:De.perto)==null?void 0:Ve.cilindrico,(!e||l&&l>e)&&(e=l),l=(Pe=(qe=(Ie=(Me=(Ae=this.receita)==null?void 0:Ae.prescricao)==null?void 0:Me.dioptria)==null?void 0:Ie.od)==null?void 0:qe.perto)==null?void 0:Pe.esferico,(!r||l&&l>r)&&(r=l),l=(Te=(Ne=(xe=(Fe=(Le=this.receita)==null?void 0:Le.prescricao)==null?void 0:Fe.dioptria)==null?void 0:xe.oe)==null?void 0:Ne.perto)==null?void 0:Te.esferico,(!p||l&&l>p)&&(p=l),n=Number(n||void 0),e=Number(e||void 0),r=Number(r||void 0),p=Number(p||void 0),Number.isNaN(n)&&Number.isNaN(e)||(k=n>e?n:e),(Number.isNaN(n)||Number.isNaN(e))&&(k=n||e),Number.isNaN(r)&&Number.isNaN(p)||(D=r<p?r:p,O=r>p?r:p),(Number.isNaN(r)||Number.isNaN(p))&&(D=O=r||p),this.filtroAvancado={cilindrico:{lte:k||0},esfericoInicial:{lte:D||0},esfericoFinal:{gte:O||0},lenteTipo:w,opcoesTiposLente:["","Monofocal","Bifocal","Multifocal"]};break;case"LentesContato":this.modalItem.filtros={tipo:"Lente Contato",ativo:!0,bloquearVenda:!1},this.filtroAvancado=void 0;break;case"Armacao":this.modalItem.filtros={tipo:["Arma\xE7\xE3o","\xD3culos Sol"],ativo:!0,bloquearVenda:!1},this.filtroAvancado=void 0;break;case"Tratamento LOD":this.modalItem.filtros={tipo:"Tratamento",ativo:!0,bloquearVenda:!1},this.filtroAvancado=void 0,this.tipoTratamento="TLOD",this.idDocumentoItemPai=o;break;case"Tratamento LOE":this.modalItem.filtros={tipo:"Tratamento",ativo:!0,bloquearVenda:!1},this.filtroAvancado=void 0,this.tipoTratamento="TLOE",this.idDocumentoItemPai=o;break}this.modalItem.filtros.idEmpresa=this.campos.idEmpresa,this.modalItem.filtros.idTabelaPreco=this.campos.idItemTabelaPreco,this.modalItem.visivel=!0},async alterarTipoEnvelope(){const a=async()=>{this.tipoOculos=this.tipoEnvelope==="Oculos"?"Vista":"",this.carrinho=[],this.tipoEnvelope==="Oculos"?(this.tipoOculos="Vista",this.tipoLentes=this.tipoLentesOculos):(this.tipoOculos="",this.tipoLentes=this.tipoLentesContato)};if(!this.carrinho.length){a();return}$q.dialog({cancel:"Cancelar",message:"Esta a\xE7\xE3o ir\xE1 remover os itens do carrinho.",ok:"Continuar",title:"Tem certeza?"}).onOk(()=>{a()}).onCancel(()=>{this.tipoEnvelope=this.tipoEnvelope==="Oculos"?"Lentes":"Oculos"})},async criarDependencia(a){try{await $db.contato.criarDependenciaContatos({contatoPai:{id:this.campos.idContatoResponsavel},contatoFilho:{id:a.id}}),await $db.contato.criarDependenciaContatos({contatoPai:{id:a.id},contatoFilho:{id:this.campos.idContatoResponsavel}});const o=$utils.clonar(this.envelope.documento);o.idContato=a.id,o.descricaoContato=a.nome,this.receita={},this.envelope.documento=$utils.clonar(o),this.campos=$utils.clonar(o)}catch(o){this.$q.notifyError("Ocorreu um erro ao criar a depend\xEAncia.",o)}},async filtrarReceitas(){var D;let a=[];this.receitas=await $db.hibrido.lista({table:"documento",where:{tipo:"Prescri\xE7\xE3o",idContato:this.campos.idContato}}),this.receitas=$lodash.orderBy(this.receitas,["dataHoraEmissao","numero"],["desc","desc"]);const o=this.receitas.map(({id:O})=>O),l=await $db.hibrido.lista({table:"documentoContato",whereIn:{idDocumento:o},whereFilter:{descricao:"Medico"}}),n=$utils.unicos(l,"idContato").filter(Boolean),e=await $db.hibrido.lista({table:"contato",whereIn:{id:n}}),r={};for(const O of e)r[O.id]=O;const p={};for(const O of l)O.nome=((D=r[O.idContato])==null?void 0:D.nome)||"",p[O.idDocumento]=O;const k=new Date().setHours(0,0,0,0);for(let O of this.receitas){let h=`De ${(p[O.id]||{}).nome}, `;h+=`${this.$filters.data(O.dataHoraEmissao)} `,h+=`v\xE1lido at\xE9 ${this.$filters.data(O.dataHoraFinalizado)}`;let b={};new Date(O.dataHoraFinalizado).setHours(0,0,0,0)<k?b={icon:"alarm_off",color:"negative",stamp:"Vencida"}:b={icon:"alarm",stamp:"\xC0 vencer"};const L={label:h,value:O.id,...b};a.push(L)}this.receitasDescricao=a,!this.receita.id&&this.receitas.length&&(this.receita=await $db.receita.le({id:this.receitas[0].id}))},async fechar(a){a.stopPropagation(),this.visivel=!1},ordenarCarrinho(){const a={LOE:1,TLOE:2,LOD:3,TLOD:4,Arma\u00E7\u00E3o:5};this.carrinho=(this.carrinho||[]).sort((o,l)=>a[o.tipoItem]-a[l.tipoItem])},async removerItem(a){const o=(this.carrinho[a]||{}).id;this.carrinho=this.carrinho.filter(l=>l.id!==o&&l.idDocumentoItemPai!==o),this.envelope.documentoItens=$utils.clonar(this.carrinho),await this.calculaTotal()},async salvarDnp(){var n,e,r,p;const a=JSON.parse((r=(e=(n=this.modalPupilometro)==null?void 0:n.pupilometroAtual)==null?void 0:e.json)!=null?r:null),o=this.receita.id,l=(p=a==null?void 0:a.medidas)==null?void 0:p.dnp;l&&await $db.receita.salvarDnp({idReceita:o,dnp:l}),await this.atualizarReceita(this.receita.id)},async salvar_click(){this.erroEncontrado()||(await this.corrigirValores(),await this.salvar())},async salvar(){try{$q.loading.show({message:"Salvando..."});const a=$utils.clonar(this.envelope),o=$utils.clonar(this.envelopeOriginal);if(await $db.documento.grava({atual:a.documento,original:o.documento}),await $utils.processarFilho("documentoItem",o.documentoItens,a.documentoItens),await $utils.processarFilho("documentoContato",o.documentoContato,a.documentoContato),await $utils.processarFilho("documentoStatus",o.documentoStatus,a.documentoStatus),Object.keys(a.pupilometro.atual).length){const l=a.pupilometro.atual.id;await $db.hibrido.grava("json",{atual:a.pupilometro.atual,original:a.pupilometro.original});try{await Promise.all([$db.pupilometro.gravaFoto({base64:a.pupilometro.fotoAtual,idPupilometro:l,tipoFoto:"foto"}),$db.pupilometro.gravaFoto({base64:a.pupilometro.fotoOriginalAtual,idPupilometro:l,tipoFoto:"fotoOriginal"})])}catch(n){this.$q.notifyError("N\xE3o foi poss\xEDvel salvar a foto",n)}}Object.keys(a.arquivoOriginal).length&&await $db.arquivo.remove(a.arquivoOriginal.filter(l=>!a.arquivo.find(n=>n.id===l.id)));for(const l of a.arquivo){let n={};Object.keys(a.arquivoOriginal).length?n={original:a.arquivoOriginal.find(e=>e.id===l.id)||[{}],atual:l}:n={atual:l},(l==null?void 0:l.name)&&(l==null?void 0:l.editado)&&await $db.arquivo.edita(n),l!=null&&l.name||await $db.arquivo.grava(n)}this.$route.name==="AtendimentoVenda"&&a.documento.idContatoResponsavel!==this.$route.params.id&&$router.push({name:"AtendimentoVenda",params:{id:a.documento.idContatoResponsavel}}),this.$emit("atualizar"),this.visivel=!1}catch(a){$q.notifyError("Erro ao salvar: ",a)}finally{$q.loading.hide()}},erroEncontrado(){return this.tipoLente?this.receita.id?this.carrinho.length?this.erroDataHoraPrevisto?(this.$q.notifyError("Erro no preenchimento do formul\xE1rio"),!0):!1:(this.$q.notifyError("N\xE3o h\xE1 itens no carrinho"),!0):(this.$q.notifyError("Selecione uma receita"),!0):(this.$q.notifyError("Selecione o tipo da lente"),!0)},async corrigirValores(){let a={};if(this.tipoEnvelope==="Oculos"){let o=!1;for(const l in this.carrinho)if(this.carrinho[l].tipoItem==="Arma\xE7\xE3o"){this.carrinho[l].alturaMontagemOD=$utils.numberOrNull(this.armacao.alturaMontagemOD),this.carrinho[l].alturaMontagemOE=$utils.numberOrNull(this.armacao.alturaMontagemOE),this.carrinho[l].diagonal=$utils.numberOrNull(this.armacao.diagonal),this.carrinho[l].ponte=$utils.numberOrNull(this.armacao.ponte),this.carrinho[l].altura=$utils.numberOrNull(this.armacao.altura),this.carrinho[l].largura=$utils.numberOrNull(this.armacao.largura),this.carrinho[l].armacaoMaterial=this.armacao.armacaoMaterial,this.carrinho[l].tipoMontagem=this.armacao.tipoMontagem,this.carrinho[l].oculos=this.tipoLente,this.carrinho[l].tipoOculos=this.tipoOculos,this.carrinho[l].idItem&&(a.id=this.carrinho[l].idItem,a.armacaoMaterial=this.armacao.armacaoMaterial,a.tipoMontagem=this.armacao.tipoMontagem,a.diagonal=$utils.numberOrNull(this.armacao.diagonal),a.ponte=$utils.numberOrNull(this.armacao.ponte),a.altura=$utils.numberOrNull(this.armacao.altura),a.largura=$utils.numberOrNull(this.armacao.largura)),o=!0;break}o||this.carrinho.push({id:$utils.uuid(),idDocumento:this.campos.id,dataHoraEmissao:$utils.dataAtual(),descontoItem:0,descontoPercentualItem:0,descontoSubTotal:0,descricaoItem:"",operacaoFator:0,oculos:this.tipoLente,tipoOculos:this.tipoOculos,quantidade:0,status:this.campos.status,subTotal:0,tipoItem:"Arma\xE7\xE3o",total:0,valorCusto:0,valorCustoMedio:0,valorCustoReposicao:0,valorCustoUltimo:0,valorItem:0,valorItemUltimo:0,valorOriginal:0,valorReal:0,alturaMontagemOD:$utils.numberOrNull(this.armacao.alturaMontagemOD),alturaMontagemOE:$utils.numberOrNull(this.armacao.alturaMontagemOE),diagonal:$utils.numberOrNull(this.armacao.diagonal),ponte:$utils.numberOrNull(this.armacao.ponte),altura:$utils.numberOrNull(this.armacao.altura),largura:$utils.numberOrNull(this.armacao.largura),armacaoMaterial:this.armacao.armacaoMaterial,tipoMontagem:this.armacao.tipoMontagem})}this.campos.idDocumentoAdicional=this.receita.id,this.envelope={...this.envelope,documento:$utils.clonar(this.campos),documentoItens:$utils.clonar(this.carrinho),armacao:a,arquivo:this.$refs.arquivo.arquivo.map(o=>({...o,idTabelaMaster:this.campos.id,tabelaMaster:"envelope"})),arquivoOriginal:this.envelope.arquivoOriginal,pupilometro:{original:$utils.clonarV2(this.modalPupilometro.pupilometroOriginal),atual:$utils.clonarV2(this.modalPupilometro.pupilometroAtual),fotoAtual:this.modalPupilometro.fotoAtual,fotoOriginalAtual:this.modalPupilometro.fotoOriginalAtual}},await this.salvarDnp()},adicionarItem(a){const o=this.carrinho.find(e=>e.idItem===a.id);let l=1;a.novoValorVenda=a.valorVenda,o&&(a.novoValorVenda=o.valorReal,l=o.quantidade);const n={};n[a.id]={item:a,quantidade:l},this.selecionarItens(n)},async selecionarItens(a){for(const o in a){const l=a[o].item||{};await this.selecionarItem(o,l)}},async selecionarItem(a,o){var e;let l=[];if(["Arma\xE7\xE3o","\xD3culos Sol"].includes(o.tipo))l=["Arma\xE7\xE3o"];else if(o.tipo==="Tratamento")l=[this.tipoTratamento];else if(["Lente","Lente Contato"].includes(o.tipo))try{l=["LOD","LOE"];for(const r of this.carrinho){const p=l.indexOf(r.tipoItem);p!==-1&&l.splice(p,1)}l.length===0&&(l=["LOD","LOE"])}catch{return}this.modalItem.visivel=!1;const n=await $utils.selecionarCfop({ncm:o.ncm,idItem:o.id,itemTipo:o.tipo,codigoDocumentoOperacao:this.campos.codigoDocumentoOperacao,idContatoDestinatario:this.campos.idContato,idContatoEmitente:this.campos.idEmpresa,operacaoFator:-1});if(!n){this.$q.notify("N\xE3o foi poss\xEDvel localizar o CFOP.");return}for(const r of l){if(!["TLOD","TLOE"].includes(r))for(const D in this.carrinho)((e=this.carrinho[D])==null?void 0:e.tipoItem)===r&&await this.removerItem(D);const p=(await $db.estoqueSaldoProdutoEmpresa.le({idItem:o.id,idEmpresa:$lodash.get(this.envelope,"documento.idEmpresa",""),tipoEstoque:"Dispon\xEDvel"})).find(D=>D.idItem),k={id:$utils.uuid(),idItem:o.id,idDocumento:this.campos.id,codigoPlanoContaDestino:139,codigoPlanoContaEstoque:146,dataHoraEmissao:$utils.dataAtual(),descontoItem:0,descontoPercentualItem:0,descontoSubTotal:0,descricaoItem:o.descricaoConcatenada,operacao:n==null?void 0:n.operacao,operacaoFator:n==null?void 0:n.fator,idCfop:n==null?void 0:n.id,oculos:this.tipoLente,tipoOculos:r==="Arma\xE7\xE3o"?this.tipoOculos:"",lenteTipo:r!=="Arma\xE7\xE3o"?this.tipoOculos:"",quantidade:1,status:this.campos.status,subTotal:o.valorVenda,tipoItem:r,total:o.valorVenda,valorCusto:0,valorCustoMedio:$lodash.get(p,"valorCustoMedio",0),valorCustoReposicao:o.valorCustoReposicao||0,valorCustoUltimo:$lodash.get(p,"valorCusto",0),valorItem:o.valorVenda,valorItemUltimo:0,valorOriginal:o.valorVenda,valorReal:o.valorVenda,valorRealTotal:o.valorVenda,alturaMontagemOD:null,alturaMontagemOE:null,diagonal:$utils.numberOrNull(o.diagonal),ponte:$utils.numberOrNull(o.ponte),altura:$utils.numberOrNull(o.altura),largura:$utils.numberOrNull(o.largura),armacaoMaterial:o.armacaoMaterial||"",tipoMontagem:o.tipoMontagem||""};["TLOD","TLOE"].includes(r)&&this.idDocumentoItemPai&&(k.idDocumentoItemPai=this.idDocumentoItemPai),r==="Arma\xE7\xE3o"&&(this.armacao.diagonal=$utils.numberOrNull(k.diagonal),this.armacao.ponte=$utils.numberOrNull(k.ponte),this.armacao.altura=$utils.numberOrNull(k.altura),this.armacao.largura=$utils.numberOrNull(k.largura),this.armacao.armacaoMaterial=k.armacaoMaterial,this.armacao.tipoMontagem=k.tipoMontagem),this.carrinho.push(k),this.ordenarCarrinho(),await this.carregarItens(),await this.calculaTotal(),this.carrinho.sort((D,O)=>D.tipoItem==="Arma\xE7\xE3o"||O.tipoItem==="Arma\xE7\xE3o"?D.tipoItem==="Arma\xE7\xE3o"?1:-1:D.tipoItem.localeCompare(O.tipoItem))}},async pacientesAtualizar(){const a=await $db.contato.leFilhos(this.contatoResponsavel.id);a.push({nome:this.contatoResponsavel.nome,id:this.contatoResponsavel.id});const o=[];for(const l of a)o.push({label:l.nome,value:l.id});this.pacientes=$lodash.orderBy(o,"label")},async atualizar(){this.campos=$utils.clonar({...$db.envelope.vazio,...this.envelope.documento}),this.contatoResponsavel=await $db.hibrido.le({table:"contato",id:this.campos.idContatoResponsavel}),this.tipoLente="",this.tipoLentes=this.tipoLentesOculos,this.carrinho=$utils.clonar(this.envelope.documentoItens||[]),this.armacao.alturaMontagemOD=null,this.armacao.alturaMontagemOE=null,this.armacao.diagonal=null,this.armacao.ponte=null,this.armacao.altura=null,this.armacao.largura=null,this.armacao.armacaoMaterial="",this.armacao.tipoMontagem="";const a=[];for(const e in this.carrinho){if(this.carrinho[e].idItem){const r=await $erp().item.get(this.carrinho[e].idItem);a.push(r.tipo||"")}if(this.carrinho[e].tipoItem==="Arma\xE7\xE3o"){this.armacao.alturaMontagemOD=$utils.numberOrNull(this.carrinho[e].alturaMontagemOD),this.armacao.alturaMontagemOE=$utils.numberOrNull(this.carrinho[e].alturaMontagemOE),this.armacao.diagonal=$utils.numberOrNull(this.carrinho[e].diagonal),this.armacao.ponte=$utils.numberOrNull(this.carrinho[e].ponte),this.armacao.altura=$utils.numberOrNull(this.carrinho[e].altura),this.armacao.largura=$utils.numberOrNull(this.carrinho[e].largura),this.armacao.armacaoMaterial=this.carrinho[e].armacaoMaterial,this.armacao.tipoMontagem=this.carrinho[e].tipoMontagem,this.tipoLente=this.carrinho[e].oculos;break}}this.tipoEnvelope="Oculos";const o=new RegExp(/contato/i);for(const e of a)if(o.test(e)){this.tipoEnvelope="Lentes";break}const l=this.envelope.documentoContato.find(e=>e.descricao==="Laborat\xF3rio");if(this.descricaoLaboratorio="",l!=null&&l.idContato){const e=await $db.hibrido.le({table:"contato",id:l.idContato});this.descricaoLaboratorio=e.apelido}if(!this.campos.dataHoraPrevisto){let e="",r=await $db.configuracoes.le({nome:"venda.envelope.previsaoentrega"});r.length&&(r=parseInt(r[0].valor)),Number.isInteger(r)||(r=15);let p=new Date;const k=p.getDate();p.setDate(k+r),e=new Date(p.setHours(0,0,0,0)),this.campos.dataHoraPrevisto=ge.formatDate(e),this.envelope.documento.dataHoraPrevisto=ge.formatDate(e)}let n;n=String(new Date(this.campos.dataHoraPrevisto).getHours()).padStart(2,"0"),n+=":",n+=String(new Date(this.campos.dataHoraPrevisto).getMinutes()).padStart(2,"0"),this.dataPrevisaoEntrega=new Date(new Date(this.campos.dataHoraPrevisto).toDateString()),this.horaPrevisaoEntrega=n,await Promise.all([this.pacientesAtualizar(),this.atualizarArmacaoMaterial(),this.atualizarTipoMontagem(),this.atualizarReceitaV2(this.campos.idDocumentoAdicional),this.ordenarCarrinho(),this.carregarItens(),this.carregarPupilometro()]),this.visivel=!0,await this.$nextTick(),this.$refs.arquivo.somenteLeitura=this.envelope.somenteLeitura,await this.obterClassificacaoDestinatario(this.campos.idContato),await this.atualizarDocumentoMetas(),this.$refs.faturamento.atualizar(),await this.abrirReceitaAoAbrirEnvelope(),await this.configuraImpressosWhatsapp(this.envelope.documento)},async carregarItens(){for(const a of this.carrinho)if(!!a.idItem&&!(a.idItem in this.itens)){let o=await $erp().item.get(a.idItem);o={...o,marca:o.marca||"",referencia:o.referencia||"",observacao:o.observacao||"",aplicacao:o.aplicacao||"",imagem:o.imagem||""};const l=$utils.clonarV2(this.itens);l[o.id]=o,this.itens=l}},async carregarPupilometro(){var l,n;$db.permissao.objeto("pupilometro").then(e=>{this.permissaoPupilometro=e});const o=(await $db.hibrido.lista({table:"json",where:{descricao:"Pupil\xF4metro",referencia:"idEnvelope:"+this.campos.id}})).find(e=>e.id);this.modalPupilometro.pupilometroOriginal={},this.modalPupilometro.pupilometroAtual={},o&&(this.modalPupilometro.pupilometroOriginal=$utils.clonarV2(o),this.modalPupilometro.pupilometroAtual=$utils.clonarV2(o)),this.tipoPupilometro="";try{const e=JSON.parse(this.modalPupilometro.pupilometroAtual.json);this.tipoPupilometro=(n=(l=e==null?void 0:e.medidas)==null?void 0:l.tipo)!=null?n:"Presencial"}catch{}},async selecionarContato(a){const{placeholder:o,filtro:l,habilitarBotaoNovoContato:n}={placeholder:"Selecione o contato",filtro:{ativo:!0},...a},e=await $g.promptContato.show({filtro:l,placeholder:o,habilitarBotaoNovoContato:n});if(!e)throw new Error("Contato n\xE3o selecionado");return e},async obterClassificacaoDestinatario(a){if(this.classificacaoDestinatario=null,!a)return;const o=await $erp().contato.get(a);if(!o)return;const l=(o.numeroDocumentoNacional||"").trim().replace(/\D/g,""),n=(o.numeroDocumentoEstadual||"").trim().replace(/\D/g,"");if(l.length===14){this.classificacaoDestinatario=2,n&&(n||"").toLowerCase()!=="isento"&&(this.classificacaoDestinatario=1);return}this.classificacaoDestinatario=0},async obterContatoUsuario(){const a=JSON.parse(localStorage.getItem("usuario"))||{};let o={};return a.codigoUsuario&&(o=(await $erp().contato.where({codigoUsuario:a.codigoUsuario}).toArray()).find(l=>l.id)||{}),o},async atualizarDocumentoMetas(){if(!this.$refs.documentoMetas)return;const a=await $db.contato.leCompleto(this.envelope.documento.idContato);this.contato.imagem=a.imagem;const o=a.endereco.find(r=>r.grupo==="Principal")||a.endereco[0]||"",l=a.telefone.find(r=>r.grupo==="Principal")||a.telefone[0]||"";let n="";n="".concat((o==null?void 0:o.logradouro)||"",", ",(o==null?void 0:o.numero)||""," ",(o==null?void 0:o.complemento)||""," - ",(o==null?void 0:o.bairro)||""," - ",(o==null?void 0:o.cep)||""," - ",(o==null?void 0:o.municipio)||"","/",(o==null?void 0:o.uf)||""),n===",   -  -  - /"&&(n="");const e=await $db.contato.le({id:this.envelope.documento.idEmpresa});this.envelope.documento.numeroDocumentoEmpresa=e.numeroDocumentoNacional,this.envelope.documento.telefoneContato=l.telefone,this.envelope.documento.descricaoContatoEndereco=n,this.envelope.documento.idContatoIndicacao=this.campos.idContatoIndicacao,this.$refs.documentoMetas.documento=$utils.clonar(this.envelope.documento),this.$refs.documentoMetas.documentoContato=$utils.clonar(this.envelope.documentoContato)},async alterarCliente(){var o;const a=await this.selecionarContato({placeholder:"Selecione o cliente",filtro:{ativo:!0,somenteCarteira:!0}});if(a.id){if((await $db.venda.titulosPendentesAtraso({idContato:a.id})).length&&$q.notify({message:"O Cliente possui t\xEDtulo(s) pendente(s) em atraso!",timeout:0,type:"warning",closeBtn:!0}),(a.condutaRestricao||"").trim()){$q.notify({message:a.condutaRestricao,timeout:0,type:"negative",closeBtn:!0});return}this.envelope.documento.idContato===this.envelope.documento.idContatoResponsavel&&(this.envelope.documento.idContato=a.id,this.envelope.documento.descricaoContato=(o=a.nome)!=null?o:""),this.envelope.documento.idContatoResponsavel=a.id,this.contatoResponsavel=$utils.clonar(a),this.campos=$utils.clonar(this.envelope.documento),await this.atualizarDocumentoMetas(),await this.filtrarReceitas()}},async alterarVendedor(){const a=await this.selecionarContato({placeholder:"Selecione o vendedor",filtro:{ativo:!0,vendedores:!0}});a.id&&(this.envelope.documento.idContatoVendedor=a.id,this.campos=$utils.clonar(this.envelope.documento),await this.atualizarDocumentoMetas())},async alterarTabelaPreco(){const a=await this.selecionarItemTabelaPreco(null,this.envelope.documento.idEmpresa);a.id&&(this.envelope.documento.idItemTabelaPreco=a.id,this.campos=$utils.clonar(this.envelope.documento),await this.atualizarDocumentoMetas())},async selecionarItemTabelaPreco(a,o){if(!a)return this.$refs.promptItemTabelaPreco.placeholder="Selecione a tabela de pre\xE7o",this.$refs.promptItemTabelaPreco.filtro={tabelaMaster:!0,idContatoEmpresa:o},this.$refs.promptItemTabelaPreco.mostrar(),new Promise((l,n)=>{this.resolve=l,this.reject=n});a.id||this.reject("Tabela de pre\xE7o n\xE3o selecionada"),this.resolve(a)},async alterarDocumentoOperacao(){try{const a=await this.selecionarDocumentoOperacaoViaPrompt();a.id&&(this.envelope.documento.operacao=a.descricao,this.envelope.documento.codigoDocumentoOperacao=a.codigoDocumentoOperacao,this.finalidadeDestinatario=a.finalidade,this.campos=$utils.clonar(this.envelope.documento),await this.atualizarDocumentoMetas())}catch(a){console.error("alterarDocumentoOperacao: ",a)}},async selecionarDocumentoOperacaoViaPrompt(a){if(!a)return this.$refs.promptDocumentoOperacao.placeholder="Selecione a opera\xE7\xE3o",this.$refs.promptDocumentoOperacao.mostrar({classificacaoDestinatario:this.classificacaoDestinatario}),new Promise((o,l)=>{this.resolve=o,this.reject=l});if(!a.id){this.reject("Opera\xE7\xE3o n\xE3o selecionada");return}this.resolve(a)},async selecionarContatoIndicacao(){const a=await this.selecionarContato({placeholder:"Selecione a indica\xE7\xE3o",filtro:{ativo:!0}});a.id&&(this.envelope.documento.idContatoIndicacao=a.id,this.campos=$utils.clonar(this.envelope.documento),await this.atualizarDocumentoMetas())},async removerIndicacao(){this.envelope.documento.idContatoIndicacao="",this.campos=$utils.clonar(this.envelope.documento),await this.atualizarDocumentoMetas()},async selecionarLaboratorio(){const a=await this.selecionarContato({placeholder:"Selecione o laborat\xF3rio",filtro:{ativo:!0,segmento:"Laborat\xF3rio"}});if(!(a!=null&&a.id))return;let o=$utils.clonar(this.envelope.documentoContato);o.some(l=>l.descricao==="Laborat\xF3rio"&&l.idContato===a.id)||(o=o.filter(l=>l.descricao!=="Laborat\xF3rio"),o.push({id:$utils.uuid(),idContato:a.id,idDocumento:this.envelope.documento.id,descricao:"Laborat\xF3rio"}),this.envelope.documentoContato=$utils.clonar(o),this.descricaoLaboratorio=a.apelido,await this.atualizarDocumentoMetas())},async removerLaboratorio(){let a=$utils.clonar(this.envelope.documentoContato);a=a.filter(o=>o.descricao!=="Laborat\xF3rio"),this.envelope.documentoContato=$utils.clonar(a),this.descricaoLaboratorio="",await this.atualizarDocumentoMetas()},async alocarConvenio(){const a=await this.selecionarContato({placeholder:"Selecione o conv\xEAnio",filtro:{convenios:!0,idContato:this.envelope.documento.idContatoResponsavel}});if(!(a!=null&&a.id))return;let o=$utils.clonar(this.envelope.documentoContato);o.some(l=>l.descricao==="Conv\xEAnio"&&l.idContato===a.id)||(o=o.filter(l=>l.descricao!=="Conv\xEAnio"),o.push({id:$utils.uuid(),idContato:a.id,idDocumento:this.envelope.documento.id,descricao:"Conv\xEAnio"}),this.envelope.documentoContato=$utils.clonar(o),await this.atualizarDocumentoMetas())},async removerConvenio(){let a=$utils.clonar(this.envelope.documentoContato);a=a.filter(o=>o.descricao!=="Conv\xEAnio"),this.envelope.documentoContato=$utils.clonar(a),await this.atualizarDocumentoMetas()},async configuraImpressosWhatsapp(a){const o=await $db.configuracoes.le({prefixoNome:"venda.whatsapp.enviar.",idEmpresa:a.idEmpresa});this.configImpressosWhatsapp=o.map(l=>({...l,idVenda:a.id}))},async dialogEnviar(a){var o,l;try{const n=await $db.hibrido.le({table:"documento",id:a.idVenda});$utils.verificarErro(!(n!=null&&n.id),"Erro ao obter dados");const e=await $db.contato.leCompleto(n.idContato),r=(((o=e==null?void 0:e.telefone)==null?void 0:o.find(p=>p.tipoTelefone==="WhatsApp"))||((l=e==null?void 0:e.telefone)==null?void 0:l.find(p=>p.tipoTelefone==="Principal"))||(e==null?void 0:e.telefone[0])||{}).telefone.trim()||"";$q.dialog({title:"Enviar impresso pelo Whatsapp?",preventClose:!0,prompt:{label:"Enviar para este n\xFAmero:",model:r,hint:"Ou adicione um novo n\xFAmero, ex: 19988776655",isValid:p=>p.length>0,type:"text"},cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(async p=>{var D;n.telefoneContato=p.replace(/\D/g,"");const k=await $db.venda.enviaImpressaoPdfwhatsapp({documento:n,nomeImpresso:a.nome.replace("venda.whatsapp.enviar.",""),mensagem:(D=a.texto)!=null?D:`Voc\xEA est\xE1 recebendo o ${a.valor} da empresa ${n.descricaoEmpresa} (${n.numeroDocumentoEmpresa}).`})})}catch{$q.notifyError("Erro ao enviar.",erro)}}}},vo={class:"layout-padding q-pa-none q-pb-md q-mt-md"},bo={class:"u-container"},go={class:"bg-white round-borders q-py-md q-my-md"},_o={key:0,class:"text-caption q-mb-sm"},Co={class:"text-right"},yo=c("br",null,null,-1),wo={class:"q-pa-md"},ko={class:"col-12 col-md"},Oo={class:"col-12 col-md-auto"},Eo={class:"col-12 col-md"},Do={class:"col-12 col-md-auto"},Vo={class:"q-pa-md"},Ao={key:0,class:"q-pa-lg text-center"},Mo=c("p",{class:"text-caption"},"Para incluir, utilize os bot\xF5es acima ou insira via QR Code.",-1),Io={class:"col-12 col-lg-4"},qo=c("span",{class:"text-body2"},"Paciente: ",-1),Po={class:"col-12 col-lg-4"},Lo=c("span",{class:"text-body2"},"M\xE9dico: ",-1),Fo={class:"col-12 col-lg-2"},xo=c("span",{class:"text-body2"},"Data: ",-1),No={class:"col-12 col-lg-2"},To=c("span",{class:"text-body2"},"Validade: ",-1),Uo={key:0,class:"col-12"},So=c("strong",{class:"text-body2"},"Observa\xE7\xE3o:",-1),zo=c("div",{class:"col"},"Esf\xE9rico",-1),Ro=c("div",{class:"col"},"Cilindrico",-1),Bo=c("div",{class:"col"},"Eixo",-1),Qo=c("div",{class:"col"},"DNP",-1),$o={class:"col"},Ho={class:"col"},jo={class:"col"},Go={class:"col"},Wo={class:"col"},Jo={class:"col"},Ko={class:"col"},Yo={class:"col"},Zo=c("div",{class:"col"},"M\xE9dio",-1),Xo=c("div",{class:"col"},"Perto",-1),ea=c("div",{class:"col"},"Esf\xE9rico",-1),oa=c("div",{class:"col"},"DNP",-1),aa=c("div",{class:"col"},"Esf\xE9rico",-1),ta=c("div",{class:"col"},"DNP",-1),ia={class:"col"},la={class:"col"},ra={class:"col"},sa={class:"col"},na={class:"col"},ca={class:"col"},da={class:"col"},ua={class:"col"},ma={class:"q-pa-md"},pa={class:"bg-white round-borders q-mt-md"},ha={class:"q-pa-md q-pt-none"},fa={class:"col-12 col-sm-4"},va={class:"col-12 col-sm-4"},ba={class:"col-12 col-sm-4"},ga={class:"q-pa-md"},_a={key:0,class:"text-center"},Ca=c("p",null,"N\xE3o h\xE1 itens no carrinho",-1),ya=c("p",{class:"text-caption"},"Para adicionar, utilize os bot\xF5es acima ou insira o c\xF3digo de barras",-1),wa=[Ca,ya],ka={class:"col-12 col-md-auto"},Oa={class:"col-12 col-md"},Ea={class:"col-4 col-md"},Da={class:"col-4 col-md"},Va={class:"col-4 col-md"},Aa={class:"col-4 col-md"},Ma={class:"q-col-gutter-sm row justify-end q-mt-sm"},Ia={class:"col-12 col-md-4 offset-md-8"},qa=c("div",{class:"col-4"},"Subtotal",-1),Pa={class:"col-8 text-right"},La=c("div",{class:"col-4",style:{"padding-top":"16px"}},"Desconto",-1),Fa=c("div",{class:"col-4 q-mt-sm",style:{"padding-top":"8px"}},"Total",-1),xa={class:"col-8 q-mt-sm text-right",style:{"padding-top":"8px"}},Na={class:"q-pa-md"},Ta={class:"col-12 col-md"},Ua={class:"col-xs-6 col-md"},Sa={class:"col-xs-6 col-md"},za={class:"col-12 col-lg-3"},Ra={class:"col-xs-6 col-md"},Ba={class:"col-xs-6 col-md"},Qa={class:"q-pa-md"},$a={class:"col-6 col-md"},Ha={class:"col-6 col-md"},ja={class:"col-6 col-md"},Ga={class:"col-6 col-md"},Wa={class:"col-12 col-lg-3"},Ja={class:"col-12 col-lg-3"},Ka={class:"Fatura-faturamento round-borders q-pa-md"},Ya={class:"u-container"},Za={class:"row justify-end"},Xa={class:"row justify-end"},et={class:"layout-padding"},ot={class:"q-pa-sm"},at={class:"q-mt-lg text-right"},tt={class:"layout-padding"},it={class:"q-pa-sm"},lt={key:0},rt={class:"q-mt-lg text-right"};function st(a,o,l,n,e,r){const p=P("avatar"),k=P("badge"),D=P("documento-codigo"),O=P("documento-metas"),w=P("campo"),h=P("row"),b=P("Arquivo"),L=P("CodigoBarras"),F=P("Tutorial"),ae=P("faturamento"),ce=P("pupilometro"),de=P("ContatoCriar"),ue=P("PromptItemV2"),me=P("receita"),pe=P("prompt-item-tabela-preco-novo"),he=P("prompt-documento-operacao"),fe=P("TitulosPendentesEmAtraso");return d(),M("div",null,[t(te,{modelValue:e.visivel,"onUpdate:modelValue":o[39]||(o[39]=s=>e.visivel=s),persistent:"",maximized:"",onKeyup:no(r.fechar,["esc"]),onHide:o[40]||(o[40]=s=>a.$emit("fechou"))},{default:i(()=>[t(Ue,{view:"hHh LpR fFf",container:"",class:"bg-light"},{default:i(()=>[t(lo,null,{default:i(()=>[t(N,null,{default:i(()=>[A(t(y,{flat:"",round:"",dense:"",icon:"arrow_back"},null,512),[[I]]),t(T,null,{default:i(()=>[m("Envelope")]),_:1}),r.ehOrcamento?(d(),M("form",{key:0,onSubmit:o[0]||(o[0]=_e((...s)=>r.salvar_click&&r.salvar_click(...s),["prevent"]))},[t(y,{class:"q-ml-sm no-shadow",color:"white","text-color":"primary",unelevated:"",label:"Salvar",type:"submit"})],32)):g("",!0)]),_:1})]),_:1}),t(ro,null,{default:i(()=>[c("div",vo,[c("div",bo,[c("div",go,[t(N,{class:"Venda-barra bg-transparent q-px-md",color:"black",dark:""},{default:i(()=>[t(p,{imagem:(e.contato||{}).imagem,rotulo:e.campos.descricaoContato,tamanho:"50"},null,8,["imagem","rotulo"]),t(T,{class:"text-tertiary"},{default:i(()=>{var s;return[c("div",null,v(e.campos.descricaoContato),1),((s=e.contatoResponsavel)==null?void 0:s.id)&&e.contatoResponsavel.id!==e.campos.idContato?(d(),M("div",_o,v(e.contatoResponsavel.nome),1)):g("",!0),c("div",null,[t(k,{denso:""},{default:i(()=>[m(v(r.descricaoClassificacaoDestinatario),1)]),_:1})])]}),_:1}),c("div",Co,[t(D,{documento:e.envelope.documento},null,8,["documento"]),yo,r.ehOrcamento?(d(),f(y,{key:0,color:"tertiary",flat:"",icon:"more_vert",round:""},{default:i(()=>[t(oe,{modelValue:e.menuVenda,"onUpdate:modelValue":o[2]||(o[2]=s=>e.menuVenda=s)},{default:i(()=>[A((d(),f(Y,{link:"",separator:""},{default:i(()=>[(d(!0),M(x,null,Z(a.configImpressosWhatsapp.filter(s=>s.valor),s=>(d(),f(C,{clickable:"",key:s.valor,onClick:q=>r.dialogEnviar(s)},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"mdi-whatsapp"})]),_:1}),t(u,null,{default:i(()=>[m(v(s.valor),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(C,{clickable:"",onClick:r.alterarCliente},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"how_to_reg"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Alterar cliente")]),_:1})]),_:1})]),_:1},8,["onClick"]),t(C,{clickable:"",onClick:r.alterarVendedor},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"how_to_reg"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Alterar vendedor")]),_:1})]),_:1})]),_:1},8,["onClick"]),e.envelope.documentoItens.filter(s=>s.idItem).length?g("",!0):(d(),f(C,{key:0,clickable:"",onClick:r.alterarTabelaPreco},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"attach_money"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Alterar tabela de pre\xE7o")]),_:1})]),_:1})]),_:1},8,["onClick"])),e.envelope.documentoItens.filter(s=>s.idItem).length?g("",!0):(d(),f(C,{key:1,clickable:"",onClick:r.alterarDocumentoOperacao},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"attach_money"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Alterar Opera\xE7\xE3o")]),_:1})]),_:1})]),_:1},8,["onClick"])),e.envelope.documento.idContatoIndicacao?(d(),f(C,{key:2,clickable:"",onClick:o[1]||(o[1]=s=>r.removerIndicacao())},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"how_to_reg"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Remover indica\xE7\xE3o")]),_:1})]),_:1})]),_:1})):(d(),f(C,{key:3,clickable:"",onClick:r.selecionarContatoIndicacao},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"how_to_reg"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Selecionar indica\xE7\xE3o")]),_:1})]),_:1})]),_:1},8,["onClick"])),e.envelope.documentoContato.some(s=>s.descricao==="Conv\xEAnio")?(d(),f(C,{key:4,clickable:"",onClick:r.removerConvenio},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"input"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Remover conv\xEAnio")]),_:1})]),_:1})]),_:1},8,["onClick"])):(d(),f(C,{key:5,clickable:"",onClick:r.alocarConvenio},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"input"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Alocar conv\xEAnio")]),_:1})]),_:1})]),_:1},8,["onClick"]))]),_:1})),[[I]])]),_:1},8,["modelValue"])]),_:1})):g("",!0),!r.ehOrcamento&&!e.campos.idFatura&&!~["Cancelado","N\xE3o Aprovado"].indexOf(e.campos.status)?(d(),f(y,{key:1,icon:"undo",color:"primary",label:"Retornar para or\xE7amento",class:"hideonmobile",onClick:r.retornarOrcamento},null,8,["onClick"])):g("",!0)])]),_:1}),!r.ehOrcamento&&!e.campos.idFatura&&!~["Cancelado","N\xE3o Aprovado"].indexOf(e.campos.status)?(d(),f(y,{key:0,icon:"undo",color:"primary",label:"Retornar para or\xE7amento",class:"hideondesktop q-ma-md",onClick:r.retornarOrcamento},null,8,["onClick"])):g("",!0),t(O,{ref:"documentoMetas"},null,512)]),t(X,{class:"q-mb-md bg-white no-shadow"},{default:i(()=>[t(N,{class:"text-tertiary"},{default:i(()=>[t(T,null,{default:i(()=>[m("Dados Principais")]),_:1})]),_:1}),c("div",wo,[t(h,{class:"items-center q-col-gutter-md"},{default:i(()=>[c("div",ko,[t(Se,{modelValue:e.campos.descricaoContato,"onUpdate:modelValue":[o[3]||(o[3]=s=>e.campos.descricaoContato=s),r.selecionarPaciente],"use-input":"","hide-selected":"","fill-input":"","input-debounce":"500","stack-label":"",label:"Paciente",options:e.opcoesPacientes,onFilter:r.filtrarPacientes},{prepend:i(()=>[t(y,{color:"tertiary",size:"md",icon:"person_add",dense:"",flat:"",round:"",onClick:r.abrirModalDependente},{default:i(()=>[t(ee,null,{default:i(()=>[m("Incluir paciente")]),_:1})]),_:1},8,["onClick"])]),"no-option":i(()=>[t(C,null,{default:i(()=>[t(u,{class:"text-grey"},{default:i(()=>[m(" Resultado n\xE3o encontrado ")]),_:1})]),_:1})]),_:1},8,["modelValue","options","onFilter","onUpdate:modelValue"])]),c("div",Oo,[t(ve,{readonly:e.envelope.somenteLeitura,modelValue:e.tipoEnvelope,"onUpdate:modelValue":[o[4]||(o[4]=s=>e.tipoEnvelope=s),r.alterarTipoEnvelope],class:"q-mr-sm",label:"\xD3culos",val:"Oculos"},null,8,["readonly","modelValue","onUpdate:modelValue"]),t(ve,{readonly:e.envelope.somenteLeitura,modelValue:e.tipoEnvelope,"onUpdate:modelValue":[o[5]||(o[5]=s=>e.tipoEnvelope=s),r.alterarTipoEnvelope],label:"LDC",val:"Lentes"},{default:i(()=>[t(ee,null,{default:i(()=>[m("Lentes de Contato")]),_:1})]),_:1},8,["readonly","modelValue","onUpdate:modelValue"])]),c("div",Eo,[t(w,{modelValue:e.tipoLente,"onUpdate:modelValue":[o[6]||(o[6]=s=>e.tipoLente=s),r.alterarTipoLente],class:"col-12 col-lg-4",maxlength:"60",rotulo:"Tipo",tipo:"seletor",opcoes:e.tipoLentes,somenteLeitura:e.envelope.somenteLeitura},null,8,["modelValue","opcoes","somenteLeitura","onUpdate:modelValue"])]),c("div",Do,[t(ve,{modelValue:e.tipoOculos,"onUpdate:modelValue":o[7]||(o[7]=s=>e.tipoOculos=s),class:"q-mr-sm",disable:e.envelope.somenteLeitura||e.tipoEnvelope!=="Oculos",label:"Vista",val:"Vista"},null,8,["modelValue","disable"]),t(ve,{modelValue:e.tipoOculos,"onUpdate:modelValue":o[8]||(o[8]=s=>e.tipoOculos=s),disable:e.envelope.somenteLeitura||e.tipoEnvelope!=="Oculos",label:"Solar",val:"Solar"},null,8,["modelValue","disable"])])]),_:1})])]),_:1}),t(X,{class:"q-mb-md no-shadow"},{default:i(()=>[t(N,null,{default:i(()=>[t(_,{name:"mdi-file-eye",size:"24px",class:"text-tertiary"}),t(T,{class:"text-tertiary"},{default:i(()=>[m(" Receita ")]),_:1}),e.envelope.somenteLeitura?g("",!0):(d(),f(y,{key:0,color:"primary",dense:"",flat:"",icon:"search",round:"",onClick:r.filtrarReceitas},{default:i(()=>[t(oe,null,{default:i(()=>[t(Y,{separator:"",link:""},{default:i(()=>[(d(!0),M(x,null,Z(e.receitasDescricao,s=>A((d(),f(C,{clickable:"",key:s.value,onClick:q=>r.atualizarReceita(s.value)},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:s.icon,color:s.color},null,8,["name","color"])]),_:2},1024),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m(v(s.label),1)]),_:2},1024),t(E,{caption:""},{default:i(()=>[c("small",null,v(s.stamp),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),[[I]])),128))]),_:1})]),_:1}),t(ee,null,{default:i(()=>[m("Selecionar receita")]),_:1})]),_:1},8,["onClick"])),e.envelope.somenteLeitura?g("",!0):(d(),f(y,{key:1,color:"primary",dense:"",flat:"",icon:"add",onClick:o[9]||(o[9]=s=>r.abrirModalReceita("",!1)),round:""},{default:i(()=>[t(ee,null,{default:i(()=>[m("Adicionar")]),_:1})]),_:1})),e.envelope.somenteLeitura?g("",!0):(d(),f(y,{key:2,color:"tertiary",dense:"",flat:"",icon:"more_vert",round:""},{default:i(()=>[t(oe,null,{default:i(()=>[t(Y,{link:"",separator:""},{default:i(()=>[e.receitasDescricao.length?A((d(),f(C,{key:0,clickable:"",onClick:o[10]||(o[10]=s=>r.abrirModalReceita(e.receita.id,!1))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"edit"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Editar")]),_:1})]),_:1})]),_:1})),[[I]]):g("",!0),e.receitasDescricao.length?A((d(),f(C,{key:1,clickable:"",onClick:o[11]||(o[11]=s=>r.abrirModalReceita(e.receita.id,!0))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"file_copy"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Duplicar")]),_:1})]),_:1})]),_:1})),[[I]]):g("",!0)]),_:1})]),_:1})]),_:1}))]),_:1}),c("div",Vo,[e.receitasDescricao.length?g("",!0):(d(),M("div",Ao,[c("p",null,"N\xE3o h\xE1 receitas para o paciente "+v(e.campos.descricaoContato)+".",1),Mo])),e.receitasDescricao.length?(d(),f(h,{key:1,class:"q-col-gutter-md"},{default:i(()=>[c("div",Io,[qo,c("strong",null,v((e.receita.paciente||{}).nome),1)]),c("div",Po,[Lo,c("strong",null,v((e.receita.medico||{}).nome),1)]),c("div",Fo,[xo,c("strong",null,v(a.$filters.data(e.receita.data)),1)]),c("div",No,[To,c("strong",null,v(a.$filters.data(e.receita.validade)),1)]),e.receita.observacoes?(d(),M("div",Uo,[So,c("p",null,v(e.receita.observacoes),1)])):g("",!0)]),_:1})):g("",!0),e.receitasDescricao.length?(d(),f(h,{key:2,class:"q-col-gutter-md"},{default:i(()=>[t(Y,{class:"col-12 col-lg-6",highlight:"","no-border":""},{default:i(()=>[t(C,{class:"q-px-none"},{default:i(()=>[t(u,{avatar:"",class:"mw100"}),t(u,{class:"text-subtitle1 text-weight-bold"},{default:i(()=>[m("Longe")]),_:1})]),_:1}),t(C,{class:"q-px-none"},{default:i(()=>[t(u,{avatar:"",class:"mw100"}),t(u,{class:"text-body2 text-weight-bold"},{default:i(()=>[t(h,null,{default:i(()=>[zo,Ro,Bo,Qo]),_:1})]),_:1})]),_:1}),t(C,{class:"q-px-none"},{default:i(()=>[t(u,{avatar:"",class:"mw100"},{default:i(()=>[t(u,null,{default:i(()=>[m("OD")]),_:1})]),_:1}),t(u,null,{default:i(()=>[t(h,null,{default:i(()=>{var s,q,V,U,S,z,R,B,Q,$,H,j,G,W,J,K,le,re,se,ne;return[c("div",$o,v(a.$filters.numeroSinal((S=(U=(V=(q=(s=e.receita)==null?void 0:s.prescricao)==null?void 0:q.dioptria)==null?void 0:V.od)==null?void 0:U.longe)==null?void 0:S.esferico,2)),1),c("div",Ho,v(a.$filters.numeroSinal(($=(Q=(B=(R=(z=e.receita)==null?void 0:z.prescricao)==null?void 0:R.dioptria)==null?void 0:B.od)==null?void 0:Q.longe)==null?void 0:$.cilindrico,2)),1),c("div",jo,v(a.$filters.numeroOuBranco((J=(W=(G=(j=(H=e.receita)==null?void 0:H.prescricao)==null?void 0:j.dioptria)==null?void 0:G.od)==null?void 0:W.longe)==null?void 0:J.eixo)),1),c("div",Go,v(a.$filters.numeroOuBranco((ne=(se=(re=(le=(K=e.receita)==null?void 0:K.prescricao)==null?void 0:le.dioptria)==null?void 0:re.od)==null?void 0:se.longe)==null?void 0:ne.dnp,2)),1)]}),_:1})]),_:1})]),_:1}),t(C,{class:"q-px-none"},{default:i(()=>[t(u,{avatar:"",class:"mw100"},{default:i(()=>[t(u,null,{default:i(()=>[m("OE")]),_:1})]),_:1}),t(u,null,{default:i(()=>[t(h,null,{default:i(()=>{var s,q,V,U,S,z,R,B,Q,$,H,j,G,W,J,K;return[c("div",Wo,v(a.$filters.numeroSinal((U=(V=(q=(s=e.receita.prescricao)==null?void 0:s.dioptria)==null?void 0:q.oe)==null?void 0:V.longe)==null?void 0:U.esferico,2)),1),c("div",Jo,v(a.$filters.numeroSinal((B=(R=(z=(S=e.receita.prescricao)==null?void 0:S.dioptria)==null?void 0:z.oe)==null?void 0:R.longe)==null?void 0:B.cilindrico,2)),1),c("div",Ko,v(a.$filters.numeroOuBranco((j=(H=($=(Q=e.receita.prescricao)==null?void 0:Q.dioptria)==null?void 0:$.oe)==null?void 0:H.longe)==null?void 0:j.eixo)),1),c("div",Yo,v(a.$filters.numeroOuBranco((K=(J=(W=(G=e.receita.prescricao)==null?void 0:G.dioptria)==null?void 0:W.oe)==null?void 0:J.longe)==null?void 0:K.dnp,2)),1)]}),_:1})]),_:1})]),_:1})]),_:1}),t(Y,{class:"col-12 col-lg-6",highlight:"","no-border":""},{default:i(()=>[t(C,{class:"q-px-none"},{default:i(()=>[t(u,{avatar:"",class:"mw100"},{default:i(()=>[m("\xA0\xA0")]),_:1}),t(u,{class:"text-subtitle1 text-weight-bold"},{default:i(()=>[t(h,null,{default:i(()=>[Zo,Xo]),_:1})]),_:1})]),_:1}),t(C,{class:"q-px-none"},{default:i(()=>[t(u,{avatar:"",class:"mw100"},{default:i(()=>[m("\xA0\xA0")]),_:1}),t(u,{class:"text-body2 text-weight-bold"},{default:i(()=>[t(h,null,{default:i(()=>[ea,oa,aa,ta]),_:1})]),_:1})]),_:1}),t(C,null,{default:i(()=>[t(u,{avatar:"",class:"mw100"},{default:i(()=>[t(u,null,{default:i(()=>[m("OD")]),_:1})]),_:1}),t(u,null,{default:i(()=>[t(h,null,{default:i(()=>{var s,q,V,U,S,z,R,B,Q,$,H,j,G,W,J,K;return[c("div",ia,v(a.$filters.numeroSinal((U=(V=(q=(s=e.receita.prescricao)==null?void 0:s.dioptria)==null?void 0:q.od)==null?void 0:V.medio)==null?void 0:U.esferico,2)),1),c("div",la,v(a.$filters.numeroOuBranco((B=(R=(z=(S=e.receita.prescricao)==null?void 0:S.dioptria)==null?void 0:z.od)==null?void 0:R.medio)==null?void 0:B.dnp,2)),1),c("div",ra,v(a.$filters.numeroSinal((j=(H=($=(Q=e.receita.prescricao)==null?void 0:Q.dioptria)==null?void 0:$.od)==null?void 0:H.perto)==null?void 0:j.esferico,2)),1),c("div",sa,v(a.$filters.numeroOuBranco((K=(J=(W=(G=e.receita.prescricao)==null?void 0:G.dioptria)==null?void 0:W.od)==null?void 0:J.perto)==null?void 0:K.dnp,2)),1)]}),_:1})]),_:1})]),_:1}),t(C,null,{default:i(()=>[t(u,{avatar:"",class:"mw100"},{default:i(()=>[t(u,null,{default:i(()=>[m("OE")]),_:1})]),_:1}),t(u,null,{default:i(()=>[t(h,null,{default:i(()=>{var s,q,V,U,S,z,R,B,Q,$,H,j,G,W,J,K;return[c("div",na,v(a.$filters.numeroSinal((U=(V=(q=(s=e.receita.prescricao)==null?void 0:s.dioptria)==null?void 0:q.oe)==null?void 0:V.medio)==null?void 0:U.esferico,2)),1),c("div",ca,v(a.$filters.numeroOuBranco((B=(R=(z=(S=e.receita.prescricao)==null?void 0:S.dioptria)==null?void 0:z.oe)==null?void 0:R.medio)==null?void 0:B.dnp,2)),1),c("div",da,v(a.$filters.numeroSinal((j=(H=($=(Q=e.receita.prescricao)==null?void 0:Q.dioptria)==null?void 0:$.oe)==null?void 0:H.perto)==null?void 0:j.esferico,2)),1),c("div",ua,v(a.$filters.numeroOuBranco((K=(J=(W=(G=e.receita.prescricao)==null?void 0:G.dioptria)==null?void 0:W.oe)==null?void 0:J.perto)==null?void 0:K.dnp,2)),1)]}),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):g("",!0)])]),_:1}),t(X,{class:"bg-white q-mb-md no-shadow"},{default:i(()=>[t(N,{class:"text-tertiary"},{default:i(()=>[t(_,{name:"image",size:"24px"}),t(T,null,{default:i(()=>[m("Arquivos")]),_:1})]),_:1}),c("div",ma,[t(b,{ref:"arquivo",enableChanges:!e.envelope.somenteLeitura,arquivo:e.envelope.arquivo,idTabelaMaster:e.envelope.documento.id},null,8,["enableChanges","arquivo","idTabelaMaster"])])]),_:1}),t(X,{class:"bg-white q-mb-md no-shadow"},{default:i(()=>[c("div",pa,[t(N,{class:"text-tertiary"},{default:i(()=>[t(_,{name:"description",size:"24px"}),t(T,null,{default:i(()=>[m("Observa\xE7\xF5es")]),_:1})]),_:1}),c("div",ha,[t(h,{class:"q-col-gutter-md"},{default:i(()=>[c("div",fa,[t(w,{modelValue:e.campos.observacao,"onUpdate:modelValue":o[12]||(o[12]=s=>e.campos.observacao=s),tipo:"textoArea",rotulo:"Observa\xE7\xE3o","somente-leitura":e.envelope.somenteLeitura},null,8,["modelValue","somente-leitura"])]),c("div",va,[t(w,{modelValue:e.campos.observacaoInterna,"onUpdate:modelValue":o[13]||(o[13]=s=>e.campos.observacaoInterna=s),tipo:"textoArea",rotulo:"Observa\xE7\xE3o interna","somente-leitura":e.envelope.somenteLeitura},null,8,["modelValue","somente-leitura"])]),c("div",ba,[t(w,{modelValue:e.campos.numeroOrdemCompra,"onUpdate:modelValue":o[14]||(o[14]=s=>e.campos.numeroOrdemCompra=s),autogrow:"",rotulo:"Ordem de Compra","somente-leitura":e.envelope.somenteLeitura,maxlength:"50"},null,8,["modelValue","somente-leitura"])])]),_:1})])])]),_:1}),t(X,{class:"q-mb-md bg-white no-shadow"},{default:i(()=>[t(N,null,{default:i(()=>[t(_,{name:"mdi-glasses",size:"24px",class:"text-tertiary"}),t(T,{class:"text-tertiary"},{default:i(()=>[m(" Carrinho ")]),_:1}),t(y,{class:"hideondesktop",color:"primary",dense:"",flat:"",icon:"add",round:""},{default:i(()=>[t(oe,null,{default:i(()=>[t(Y,{link:"",separator:""},{default:i(()=>[!e.envelope.somenteLeitura&&e.tipoEnvelope==="Lentes"?A((d(),f(C,{key:0,clickable:"",onClick:o[15]||(o[15]=s=>r.abrirModalItem("LentesContato"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"add"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Lentes de Contato")]),_:1})]),_:1})]),_:1})),[[I]]):g("",!0),!e.envelope.somenteLeitura&&e.tipoEnvelope==="Oculos"&&["Vista","Solar"].includes(e.tipoOculos)?A((d(),f(C,{key:1,clickable:"",onClick:o[16]||(o[16]=s=>r.abrirModalItem("Lentes"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"add"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Lentes")]),_:1})]),_:1})]),_:1})),[[I]]):g("",!0),!e.envelope.somenteLeitura&&e.tipoEnvelope==="Oculos"&&["Vista","Solar"].includes(e.tipoOculos)?A((d(),f(C,{key:2,clickable:"",onClick:o[17]||(o[17]=s=>r.abrirModalItem("Armacao"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"add"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Arma\xE7\xE3o")]),_:1})]),_:1})]),_:1})),[[I]]):g("",!0)]),_:1})]),_:1})]),_:1}),!e.envelope.somenteLeitura&&e.tipoEnvelope==="Lentes"?(d(),f(y,{key:0,color:"primary",flat:"",icon:"add",class:"hideonmobile",label:"Lentes de Contato",onClick:o[18]||(o[18]=s=>r.abrirModalItem("LentesContato"))})):g("",!0),!e.envelope.somenteLeitura&&e.tipoEnvelope==="Oculos"&&["Vista","Solar"].includes(e.tipoOculos)?(d(),f(y,{key:1,class:"hideonmobile",color:"primary",flat:"",icon:"add",label:"Lentes",onClick:o[19]||(o[19]=s=>r.abrirModalItem("Lentes"))})):g("",!0),!e.envelope.somenteLeitura&&e.tipoEnvelope==="Oculos"&&["Vista","Solar"].includes(e.tipoOculos)?(d(),f(y,{key:2,class:"hideonmobile",color:"primary",flat:"",icon:"add",label:"Arma\xE7\xE3o",onClick:o[20]||(o[20]=s=>r.abrirModalItem("Armacao"))})):g("",!0),!e.envelope.somenteLeitura&&(e.tipoEnvelope==="Lentes"||e.tipoEnvelope==="Oculos"&&["Vista","Solar"].includes(e.tipoOculos))?(d(),f(L,{key:3,itemFiltros:{ativo:!0,bloquearVenda:!1,idEmpresa:e.campos.idEmpresa,idItemTabelaPreco:e.campos.idItemTabelaPreco},documentoItens:e.carrinho,onAdicionar:r.adicionarItem,onAtualizar:r.selecionarItens},null,8,["itemFiltros","documentoItens","onAdicionar","onAtualizar"])):g("",!0)]),_:1}),c("div",ga,[e.carrinho.length?(d(!0),M(x,{key:1},Z(r.carrinhoSemArmacaoVazia,(s,q)=>(d(),f(h,{class:"items-start q-col-gutter-md",key:q},{default:i(()=>[c("div",ka,[t(p,{imagem:(e.itens[s.idItem]||{}).imagem||"",rotulo:s.descricaoItem,tamanho:"120"},null,8,["imagem","rotulo"])]),c("div",Oa,[t(N,{class:"Venda-itemBarra bg-transparent q-pa-none",color:"black",dark:""},{default:i(()=>[t(T,{class:"q-pl-none"},{default:i(()=>[m(v(s.descricaoItem),1),c("span",null,v((e.itens[s.idItem]||{}).marca||""),1)]),_:2},1024),t(k,{class:"q-mr-sm"},{default:i(()=>[m(v(s.tipoItem)+" "+v((e.itens[s.idItem]||{}).referencia||""),1)]),_:2},1024),e.envelope.somenteLeitura?g("",!0):(d(),f(y,{key:0,color:"tertiary",dense:"",flat:"",icon:"delete",round:"",onClick:V=>r.removerItem(q)},null,8,["onClick"]))]),_:2},1024),t(h,{class:"q-col-gutter-sm"},{default:i(()=>[c("div",Ea,[t(w,{somenteLeitura:e.envelope.somenteLeitura,modelValue:s.valorItem,"onUpdate:modelValue":V=>s.valorItem=V,dense:"",outlined:"","rotulo-fixo":"Valor",onBlur:V=>r.calculaTotalItem(q,"valorItem"),tipo:"decimal",decimals:"2"},null,8,["somenteLeitura","modelValue","onUpdate:modelValue","onBlur"])]),c("div",Da,[t(h,{class:"items-center"},{default:i(()=>[t(_,{name:"mdi-minus",color:"primary"}),t(w,{somenteLeitura:e.envelope.somenteLeitura,modelValue:s.descontoPercentualItem,"onUpdate:modelValue":V=>s.descontoPercentualItem=V,dense:"",outlined:"",opcoes:{maximumValue:100},"rotulo-fixo":"Desconto",tipo:"decimal",decimals:"2",suffix:"%",onBlur:V=>r.calculaTotalItem(q,"descontoPercentualItem")},null,8,["somenteLeitura","modelValue","onUpdate:modelValue","onBlur"])]),_:2},1024)]),c("div",Va,[t(w,{somenteLeitura:e.envelope.somenteLeitura,modelValue:s.descontoItem,"onUpdate:modelValue":V=>s.descontoItem=V,dense:"",outlined:"",opcoes:{minimumValue:0},"rotulo-fixo":"Desconto",onBlur:V=>r.calculaTotalItem(q,"descontoItem"),tipo:"decimal",decimals:"2"},null,8,["somenteLeitura","modelValue","onUpdate:modelValue","onBlur"])]),c("div",Aa,[t(h,{class:"items-center"},{default:i(()=>[t(_,{name:"mdi-equal",color:"primary",class:"hideonmobile"}),t(w,{modelValue:s.total,"onUpdate:modelValue":V=>s.total=V,dense:"",outlined:"","somente-leitura":"","rotulo-fixo":"Total",tipo:"decimal",decimals:"2"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)])]),_:2},1024),c("div",Ma,[!e.envelope.somenteLeitura&&s.tipoItem==="LOE"?(d(),f(y,{key:0,color:"primary",flat:"",icon:"add",label:"Tratamento LOE",onClick:V=>r.abrirModalItem("Tratamento LOE",s.id)},null,8,["onClick"])):g("",!0),!e.envelope.somenteLeitura&&s.tipoItem==="LOD"?(d(),f(y,{key:1,color:"primary",flat:"",icon:"add",label:"Tratamento LOD",onClick:V=>r.abrirModalItem("Tratamento LOD",s.id)},null,8,["onClick"])):g("",!0)])])]),_:2},1024))),128)):(d(),M("div",_a,wa)),e.carrinho.length?(d(),f(h,{key:2,class:"q-col-gutter-md q-mt-md"},{default:i(()=>[c("div",Ia,[t(h,{class:"q-col-gutter-md"},{default:i(()=>[qa,c("strong",Pa,v(a.$filters.numero(e.campos.subTotal,2)),1),La,t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.campos.totalPercentualDesconto,"onUpdate:modelValue":o[21]||(o[21]=s=>e.campos.totalPercentualDesconto=s),class:"col-3",opcoes:{maximumValue:100},tipo:"decimal",decimals:"2",suffix:"%",onBlur:o[22]||(o[22]=s=>r.calculaTotal("descontoPercentual"))},null,8,["somente-leitura","modelValue"]),t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.campos.totalDesconto,"onUpdate:modelValue":o[23]||(o[23]=s=>e.campos.totalDesconto=s),class:"col-5",opcoes:{minimumValue:0},onBlur:o[24]||(o[24]=s=>r.calculaTotal("desconto")),tipo:"decimal",decimals:"2"},null,8,["somente-leitura","modelValue"]),Fa,c("strong",xa,v(a.$filters.numero(e.campos.totalDocumento,2)),1)]),_:1})])]),_:1})):g("",!0)])]),_:1}),(d(),f(X,{key:0,class:"q-mb-md bg-white no-shadow"},{default:i(()=>[c("div",Na,[t(h,{class:"q-col-gutter-md"},{default:i(()=>[c("div",Ta,[t(h,{class:"q-px-none q-mx-none"},{default:i(()=>[e.permissaoPupilometro&&this.tipoPupilometro?(d(),f(y,{key:0,label:"Pupil\xF4metro",icon:"mdi-eye-settings-outline",unelevated:"",color:"primary",onClick:o[25]||(o[25]=s=>r.abrirModalPupilometro(this.tipoPupilometro))})):g("",!0),e.permissaoPupilometro&&!this.tipoPupilometro?(d(),f(y,{key:1,label:"Pupil\xF4metro",icon:"mdi-eye-settings-outline",unelevated:"",color:"primary"},{default:i(()=>[t(oe,null,{default:i(()=>[t(Y,{link:"","no-border":"",separator:""},{default:i(()=>[A((d(),f(C,{clickable:"",onClick:o[26]||(o[26]=s=>r.abrirModalPupilometro("Presencial"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"add"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Pupil\xF4metro (Arma\xE7\xE3o)")]),_:1})]),_:1})]),_:1})),[[I]]),A((d(),f(C,{clickable:"",onClick:o[27]||(o[27]=s=>r.abrirModalPupilometro("Cart\xE3o"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"add"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m("Pupil\xF4metro (Cart\xE3o)")]),_:1})]),_:1})]),_:1})),[[I]])]),_:1})]),_:1})]),_:1})):g("",!0),t(F,{componente:"Envelope"})]),_:1})]),c("div",Ua,[t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.armacao.alturaMontagemOD,"onUpdate:modelValue":o[28]||(o[28]=s=>e.armacao.alturaMontagemOD=s),rotulo:"Alt. Mont. OD",tipo:"decimal",decimals:"2",permiteNull:""},null,8,["somente-leitura","modelValue"])]),c("div",Sa,[t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.armacao.alturaMontagemOE,"onUpdate:modelValue":o[29]||(o[29]=s=>e.armacao.alturaMontagemOE=s),rotulo:"Alt. Mont. OE",tipo:"decimal",decimals:"2",permiteNull:""},null,8,["somente-leitura","modelValue"])]),c("div",za,[t(Se,{dense:"",rounded:"",modelValue:e.descricaoLaboratorio,"onUpdate:modelValue":o[30]||(o[30]=s=>e.descricaoLaboratorio=s),label:"Laborat\xF3rio",options:["a","b"],onFilter:r.selecionarLaboratorio,class:"col-12 col-sm-4"},{append:i(()=>[e.descricaoLaboratorio!==""?(d(),f(_,{key:0,name:"close",onClick:_e(r.removerLaboratorio,["stop"]),class:"cursor-pointer"},null,8,["onClick"])):g("",!0),t(_,{name:"search",onClick:_e(r.selecionarLaboratorio,["stop"]),class:"cursor-pointer"},null,8,["onClick"])]),_:1},8,["modelValue","onFilter"])]),c("div",Ra,[t(w,{modelValue:e.dataPrevisaoEntrega,"onUpdate:modelValue":[o[31]||(o[31]=s=>e.dataPrevisaoEntrega=s),r.ajustarDataHoraPrevisaoEntrega],rotulo:"Data Previs\xE3o de Entrega",maxlength:"10",tipo:"data",error:!!r.erroDataHoraPrevisto,errorMessage:r.erroDataHoraPrevisto},null,8,["modelValue","error","errorMessage","onUpdate:modelValue"])]),c("div",Ba,[t(w,{modelValue:e.horaPrevisaoEntrega,"onUpdate:modelValue":[o[32]||(o[32]=s=>e.horaPrevisaoEntrega=s),r.ajustarDataHoraPrevisaoEntrega],rotulo:"Hora Previs\xE3o de Entrega",maxlength:"4",tipo:"hora"},null,8,["modelValue","onUpdate:modelValue"])])]),_:1})])]),_:1})),(d(),f(X,{key:1,class:"q-mb-md bg-white no-shadow"},{default:i(()=>[c("div",Qa,[t(h,{class:"q-col-gutter-md"},{default:i(()=>[c("div",$a,[t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.armacao.diagonal,"onUpdate:modelValue":o[33]||(o[33]=s=>e.armacao.diagonal=s),tipo:"decimal",decimals:"2",rotulo:"Diagonal",permiteNull:""},null,8,["somente-leitura","modelValue"])]),c("div",Ha,[t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.armacao.ponte,"onUpdate:modelValue":o[34]||(o[34]=s=>e.armacao.ponte=s),tipo:"decimal",decimals:"2",rotulo:"Ponte",permiteNull:""},null,8,["somente-leitura","modelValue"])]),c("div",ja,[t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.armacao.altura,"onUpdate:modelValue":o[35]||(o[35]=s=>e.armacao.altura=s),tipo:"decimal",decimals:"2",rotulo:"Altura Vertical",permiteNull:""},null,8,["somente-leitura","modelValue"])]),c("div",Ga,[t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.armacao.largura,"onUpdate:modelValue":o[36]||(o[36]=s=>e.armacao.largura=s),rotulo:"Largura",tipo:"decimal",decimals:"2",permiteNull:""},null,8,["somente-leitura","modelValue"])]),c("div",Wa,[t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.armacao.armacaoMaterial,"onUpdate:modelValue":o[37]||(o[37]=s=>e.armacao.armacaoMaterial=s),after:[{icon:"add_circle",handler(){r.abrirArmacaoMaterialModal()}}],opcoes:e.opcoesArmacaoMaterial,"rotulo-fixo":"Material",tipo:"seletor"},null,8,["somente-leitura","modelValue","after","opcoes"])]),c("div",Ja,[t(w,{"somente-leitura":e.envelope.somenteLeitura,modelValue:e.armacao.tipoMontagem,"onUpdate:modelValue":o[38]||(o[38]=s=>e.armacao.tipoMontagem=s),after:[{icon:"add_circle",handler(){r.abrirTipoMontagemModal()}}],opcoes:e.opcoesTipoMontagem,"rotulo-fixo":"Tipo Montagem",tipo:"seletor"},null,8,["somente-leitura","modelValue","after","opcoes"])])]),_:1})])]),_:1})),c("div",Ka,[t(ae,{documento:e.campos,ref:"faturamento"},null,8,["documento"])])])])]),_:1}),e.envelope.somenteLeitura?g("",!0):(d(),f(so,{key:0,bordered:"",class:"bg-light"},{default:i(()=>[c("div",Ya,[t(N,{class:"bg-light"},{default:i(()=>[t(T,{class:"text-right"},{default:i(()=>[t(y,{class:"q-mx-md",color:"negative",flat:"",label:"N\xE3o aprovado",onClick:r.reprovarOrcamento},null,8,["onClick"]),t(y,{color:"primary",label:"Finalizar",unelevated:"",onClick:r.finalizar},null,8,["onClick"])]),_:1})]),_:1})])]),_:1}))]),_:1})]),_:1},8,["modelValue","onKeyup"]),t(te,{modelValue:e.armacaoMaterialModal,"onUpdate:modelValue":o[43]||(o[43]=s=>e.armacaoMaterialModal=s)},{default:i(()=>[t(X,null,{default:i(()=>[t(N,null,{default:i(()=>[t(T,null,{default:i(()=>[m("Cadastrar Material")]),_:1})]),_:1}),t(ze,null,{default:i(()=>[t(w,{modelValue:e.armacaoMaterialDescricao,"onUpdate:modelValue":o[41]||(o[41]=s=>e.armacaoMaterialDescricao=s),modelModifiers:{trim:!0},class:"row",maxlength:"60",rotulo:"Material"},null,8,["modelValue"])]),_:1}),t(N,null,{default:i(()=>[t(T,null,{default:i(()=>[c("div",Za,[t(y,{flat:"",color:"tertiary",onClick:o[42]||(o[42]=s=>e.armacaoMaterialModal=!1),label:"Cancelar"}),t(y,{unelevated:"",color:"primary",onClick:r.criarArmacaoMaterial,label:"Criar"},null,8,["onClick"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(te,{modelValue:e.tipoMontagemModal,"onUpdate:modelValue":o[46]||(o[46]=s=>e.tipoMontagemModal=s)},{default:i(()=>[t(X,null,{default:i(()=>[t(N,null,{default:i(()=>[t(T,null,{default:i(()=>[m("Cadastrar Tipo Montagem")]),_:1})]),_:1}),t(ze,null,{default:i(()=>[t(w,{modelValue:e.tipoMontagemDescricao,"onUpdate:modelValue":o[44]||(o[44]=s=>e.tipoMontagemDescricao=s),modelModifiers:{trim:!0},class:"row",maxlength:"60",rotulo:"Tipo Montagem"},null,8,["modelValue"])]),_:1}),t(N,null,{default:i(()=>[t(T,null,{default:i(()=>[c("div",Xa,[t(y,{flat:"",color:"tertiary",onClick:o[45]||(o[45]=s=>e.tipoMontagemModal=!1),label:"Cancelar"}),t(y,{unelevated:"",color:"primary",onClick:r.criarTipoMontagem,label:"Criar"},null,8,["onClick"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(te,{modelValue:e.modalPupilometro.visivel,"onUpdate:modelValue":o[48]||(o[48]=s=>e.modalPupilometro.visivel=s),maximized:"",onHide:o[49]||(o[49]=s=>r.fecharModalPupilometro())},{default:i(()=>[t(Ue,{class:"bg-light"},{default:i(()=>[t(ce,{ref:"pupilometro",avancar:e.modalPupilometro.avancar,somenteLeitura:e.envelope.somenteLeitura,onFecharModal:o[47]||(o[47]=s=>r.fecharModalPupilometro())},null,8,["avancar","somenteLeitura"])]),_:1})]),_:1},8,["modelValue"]),t(te,{modelValue:e.modalCreditoDisponivel.visivel,"onUpdate:modelValue":o[52]||(o[52]=s=>e.modalCreditoDisponivel.visivel=s),minimized:"",onHide:o[53]||(o[53]=s=>e.modalCreditoDisponivel.reject())},{default:i(()=>[t(X,{class:"q-dialog-plugin"},{default:i(()=>[t(N,{class:"bg-primary text-white"},{default:i(()=>[t(T,null,{default:i(()=>[m(v(e.modalCreditoDisponivel.title),1)]),_:1}),A(t(y,{dense:"",flat:"",icon:"close",round:""},null,512),[[I]])]),_:1}),c("div",et,[c("form",ot,[t(Y,{"no-border":"",dense:""},{default:i(()=>[t(C,null,{default:i(()=>[t(E,null,{default:i(()=>[t(E,{header:""},{default:i(()=>[m(v(e.modalCreditoDisponivel.body),1)]),_:1})]),_:1})]),_:1})]),_:1}),c("div",at,[A(t(y,{color:"tertiary",flat:"",label:"Cancelar"},null,512),[[I]]),t(y,{color:"primary",class:"q-ml-sm no-shadow",label:"Continuar",unelevated:"",onClick:o[50]||(o[50]=s=>e.modalCreditoDisponivel.resolve("continuar"))}),e.modalCreditoDisponivel.permiteFinalizar?(d(),f(y,{key:0,color:"primary",class:"q-ml-sm no-shadow",unelevated:"",label:"Aprovar",onClick:o[51]||(o[51]=s=>e.modalCreditoDisponivel.resolve("aprovar"))})):g("",!0)])])])]),_:1})]),_:1},8,["modelValue"]),t(te,{modelValue:e.modalItensSemEstoque.visivel,"onUpdate:modelValue":o[55]||(o[55]=s=>e.modalItensSemEstoque.visivel=s),minimized:"",onShow:o[56]||(o[56]=s=>a.$q.loading.hide()),onHide:o[57]||(o[57]=s=>e.modalItensSemEstoque.reject())},{default:i(()=>[t(X,{class:"q-dialog-plugin"},{default:i(()=>[t(N,{class:"bg-primary text-white"},{default:i(()=>[t(T,null,{default:i(()=>[m(v(e.modalItensSemEstoque.data.length>1?"Itens":"Item")+" sem estoque ",1)]),_:1}),A(t(y,{dense:"",flat:"",icon:"close",round:""},null,512),[[I]])]),_:1}),c("div",tt,[c("form",it,[t(Y,{"no-border":"",dense:""},{default:i(()=>[(d(!0),M(x,null,Z(e.modalItensSemEstoque.data,(s,q)=>(d(),M(x,{key:q},[q?(d(),f(ie,{key:0})):g("",!0),t(C,null,{default:i(()=>[t(E,null,{default:i(()=>[t(E,{header:""},{default:i(()=>[m(v(s.itemDescricao),1)]),_:2},1024),t(E,{caption:""},{default:i(()=>[m(" Estoque: "+v(s.saldo)+" ",1),s.offline?(d(),M("span",lt,"(Offline)")):g("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)],64))),128))]),_:1}),c("div",rt,[A(t(y,{color:"tertiary",flat:"",label:"Cancelar"},null,512),[[I]]),t(y,{color:"primary",class:"q-ml-sm no-shadow",label:"Finalizar",unelevated:"",onClick:o[54]||(o[54]=s=>e.modalItensSemEstoque.resolve())})])])])]),_:1})]),_:1},8,["modelValue"]),t(de,{ref:"modalDependente","cpf-cnpj":"","data-nascimento":"","msg-erro":"Ocorreu um erro ao incluir o paciente.","msg-sucesso":"Paciente inclu\xEDdo com sucesso.",titulo:"Incluir Paciente",observacao:""},null,512),t(ue,{modelValue:e.modalItem.visivel,"onUpdate:modelValue":o[62]||(o[62]=s=>e.modalItem.visivel=s),filtro:e.modalItem.filtros,filtroAvancado:e.filtroAvancado,onSelecionarItens:r.selecionarItens,onLimparFiltroAvancado:r.limparFiltroAvancado},co({_:2},[e.filtroAvancado?{name:"camposFiltroAvancado",fn:i(()=>[t(w,{modelValue:e.filtroAvancado.lenteTipo,"onUpdate:modelValue":o[58]||(o[58]=s=>e.filtroAvancado.lenteTipo=s),class:"col-12 col-lg-4",maxlength:"60",rotulo:"Tipo",tipo:"seletor",opcoes:e.filtroAvancado.opcoesTiposLente},null,8,["modelValue","opcoes"]),t(w,{modelValue:e.filtroAvancado.esfericoInicial.lte,"onUpdate:modelValue":o[59]||(o[59]=s=>e.filtroAvancado.esfericoInicial.lte=s),prefix:"<=",rotulo:"Esf\xE9rico Inicial",tipo:"decimal",decimals:"2",dense:""},null,8,["modelValue"]),t(w,{modelValue:e.filtroAvancado.esfericoFinal.gte,"onUpdate:modelValue":o[60]||(o[60]=s=>e.filtroAvancado.esfericoFinal.gte=s),prefix:">=",rotulo:"Esf\xE9rico Final",tipo:"decimal",decimals:"2",dense:""},null,8,["modelValue"]),t(w,{modelValue:e.filtroAvancado.cilindrico.lte,"onUpdate:modelValue":o[61]||(o[61]=s=>e.filtroAvancado.cilindrico.lte=s),prefix:"<=",rotulo:"Cil\xEDndrico",tipo:"decimal",decimals:"2",dense:""},null,8,["modelValue"])]),key:"0"}:void 0]),1032,["modelValue","filtro","filtroAvancado","onSelecionarItens","onLimparFiltroAvancado"]),t(me,{ref:"modalReceita",onAtualizar:r.atualizarReceita},null,8,["onAtualizar"]),t(pe,{ref:"promptItemTabelaPreco",onSelecionar:r.selecionarItemTabelaPreco},null,8,["onSelecionar"]),t(he,{ref:"promptDocumentoOperacao",onSelecionar:r.selecionarDocumentoOperacaoViaPrompt},null,8,["onSelecionar"]),t(uo,{color:"primary",size:"50px",visible:e.exibirCarregando},null,8,["visible"]),t(fe,{model:e.mostrarTitulosPendentesEmAtraso},null,8,["model"])])}var nt=Be(fo,[["render",st]]);const ct={visibilidade:{botao:{editar:!1,remover:!1,visualizar:!1}}},dt={components:{Avatar:Qe,Envelope:nt,ModalHistoricoStatus:ho,DocumentosFiscais:po},computed:{podeMigrarFatura(){return!~["Finalizada","Aguardando Pagamento"].indexOf(this.fatura.status)&&!~["Cancelado","N\xE3o Aprovado","Or\xE7amento"].indexOf(this.documento.status)}},data(){return{contato:{},documento:{},documentosItem:[],fatura:{},faturasAbertas:[],visibilidade:{},detalhesVisivel:!1,configImpressaoOrcamento:[],configImpressaoEnvelope:[],sistemaPai:""}},methods:{irParaAtendimentoFatura(a){this.$router.push({name:"AtendimentoFatura",params:{id:a}})},async migrarFatura({documento:a,idFatura:o}){try{await new Promise((l,n)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar este envelope para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{l()}).onCancel(()=>{n()})})}catch{return}try{let l;if(o&&(l=await $db.hibrido.le({table:"documento",id:o})),!l){const n=await $db.envelope.obterDadosContatoResponsavel(a.idContatoResponsavel);l=$db.fatura.criar({...a,idContato:n.idContato,idContatoEndereco:n.idContatoEndereco,numeroDocumentoContato:n.numeroDocumentoContato,descricaoContato:n.descricaoContato,descricaoContatoEndereco:n.descricaoContatoEndereco,telefoneContato:n.telefoneContato}),await $db.fatura.grava({fatura:l})}await $db.documento.grava({atual:{id:a.id,idFatura:l.id},original:a}),localStorage.setItem("idFatura",l.id),this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(a.idContatoResponsavel)}catch(l){let n="Erro ao migrar para fatura.";/^GError:.+/.test(l.message)&&(n=l.message.slice(7)),$q.notify({type:"negative",message:n}),console.error(l);return}},alternarDetalhes(){this.detalhesVisivel=!this.detalhesVisivel},async carregarContatos({ids:a}){const o={};for(const l of a)o[l]||(o[l]=await $db.hibrido.le({table:"contato",id:l}));this.contato=o},async configurarVisibilidade({documento:a,faturasAbertas:o}){const l=$utils.clonar(ct.visibilidade);o.some(n=>n.id===a.idFatura)&&(l.botao.remover=await $db.permissao.objeto("Diretiva_Vendas_RemoverVendaFatura")),!~["Cancelado","N\xE3o Aprovado"].indexOf(a.status)&&!a.idFatura&&(l.botao.editar=!0),l.botao.editar||(l.botao.visualizar=!0),this.visibilidade=l},async carregarFaturasAbertas({documento:a}){let o=[];return a.idContatoResponsavel&&a.idEmpresa&&(o=await $db.hibrido.lista({table:"documento",where:{idContato:a.idContatoResponsavel,idEmpresa:a.idEmpresa,tipo:"Fatura",status:"Aberta"}}),o=o.sort((l,n)=>!l.numero||l.numero<n.numero?-1:1)),o},async mostrar({documento:a}){await this.$refs.modalEnvelope.mostrar({idEnvelope:a.id})},async atualizar(){this.sistemaPai=$utils.sistemaPai();const a=await $db.hibrido.le({table:"documento",id:this.id}),o=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:this.id}}),l=await this.carregarFaturasAbertas({documento:a});a.idFatura&&(this.fatura=await $db.hibrido.le({table:"documento",id:a.idFatura})),await this.carregarContatos({ids:[a.idContato,a.idContatoVendedor,a.idContatoResponsavel]}),await this.configurarVisibilidade({documento:a,faturasAbertas:l}),await this.configuraImpressaoEnvelope({documento:a}),await this.configuraImpressaoOrcamento({documento:a}),await this.configuraImpressosWhatsapp({documento:a}),this.faturasAbertas=l,this.documentosItem=o.filter(n=>n.idItem),this.documento=a},async configuraImpressaoEnvelope({documento:a}){const o=await $db.configuracoes.porNome("impressao.envelope",a.idEmpresa);this.configImpressaoEnvelope=[...o.length?o.map(l=>({texto:"Imprimir Envelope",...l})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoOrcamento({documento:a}){const o=await $db.configuracoes.porNome("impressao.venda",a.idEmpresa);this.configImpressaoOrcamento=[...o.length?o.map(l=>({texto:"Imprimir Or\xE7amento",...l})):[{valor:"invoice",texto:"Or\xE7amento/Venda (Invoice)"},this.sistemaPai==="optisoul"?{valor:"orcamento",texto:"Or\xE7amento (Antigo)"}:{},this.sistemaPai==="optisoul"?{valor:"termoGarantia",texto:"Termo de Garantia"}:{}]]},async configuraImpressosWhatsapp({documento:a}){const o=await $db.configuracoes.le({prefixoNome:"venda.whatsapp.enviar.",idEmpresa:a.idEmpresa});this.configImpressosWhatsapp=o.map(l=>({...l,idVenda:a.id}))},async dialogEnviar(a){var o,l;try{const n=await $db.hibrido.le({table:"documento",id:a.idVenda});$utils.verificarErro(!(n!=null&&n.id),"Erro ao obter dados");const e=await $db.contato.leCompleto(n.idContato),r=(((o=e==null?void 0:e.telefone)==null?void 0:o.find(p=>p.tipoTelefone==="WhatsApp"))||((l=e==null?void 0:e.telefone)==null?void 0:l.find(p=>p.tipoTelefone==="Principal"))||(e==null?void 0:e.telefone[0])||{}).telefone.trim()||"";$q.dialog({title:"Enviar impresso pelo Whatsapp?",preventClose:!0,prompt:{label:"Enviar para este n\xFAmero:",model:r||"",hint:"Ou adicione um novo n\xFAmero, ex: 19988776655",isValid:p=>p.length>0,type:"text"},cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(async p=>{var D;n.telefoneContato=p.replace(/\D/g,"");const k=await $db.venda.enviaImpressaoPdfwhatsapp({documento:n,nomeImpresso:a.nome.replace("venda.whatsapp.enviar.",""),mensagem:(D=a.texto)!=null?D:`Voc\xEA est\xE1 recebendo o ${a.valor} da empresa ${n.descricaoEmpresa} (${n.numeroDocumentoEmpresa}).`})})}catch{$q.notifyError("Erro ao enviar.",erro)}},copiarUid(){const a=this.$refs.uid;a.type="text";try{a.select(),document.execCommand("copy"),this.$q.notify({message:"UID copiado para a \xE1rea de transfer\xEAncia.",type:"info"})}catch{this.$q.notify("Erro ao copiar.")}a.type="hidden",window.getSelection().removeAllRanges()},descricaoEnvelope(a){if(a.itens)return a.itens.map(l=>l.descricaoItem).filter(Boolean).join(" | ");let o="";for(const l of this.dados.itensEnvelopes)l.idDocumentoAdicional===a.id&&l.descricaoItem.trim()&&(o+=l.descricaoItem.trim()+" | ");return o.slice(0,-3)},executar(a){switch(a){case"atualizar":this.atualizar();break;case"cancelar":case"finalizar":case"reprovar":this.$emit("executar","atualizar");break;case"retornarOrcamento":this.$emit("executar",a);break}},async remover({documento:a}){this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este envelope da fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(async()=>{try{await $db.venda.checarConflitoStatus({id:a.id,status:a.status})}catch(o){return $q.notifyError(o.message),!1}await $db.documento.grava({atual:{id:a.id,idFatura:""},original:a}),this.$emit("executar","remover")})}},mixins:[mo],props:{id:{required:!0,type:String}},async mounted(){await this.atualizar()}},ut={class:"col-12 col-md-6 q-pl-none"},mt={class:"q-item-section"},pt={class:"col-6 col-md hideonmobile"},ht={class:"text-left q-my-none"},ft={class:"col-4 col-md hideonmobile"},vt={class:"text-left q-my-none"},bt={class:"col-4 col-md hideonmobile"},gt={class:"text-left q-my-none"},_t={class:"col-6 col-md hideonmobile"},Ct={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},yt={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},wt={class:"col-12 hideondesktop"},kt={class:"text-left q-my-none"},Ot={class:"col-12 col-md-6"},Et={class:"col-12 col-md-6 full-height items-end hideonmobile"},Dt={class:"col-6"},Vt={class:"text-left q-my-none"},At={class:"text-left q-my-none"},Mt={class:"col-6"},It={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},qt={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},Pt={class:"col-12 full-height items-end"},Lt={class:"col-12 col-md-6"},Ft={class:"text-subtitle1 text-weight-bold q-ma-none items-center"},xt={class:"q-ma-none"},Nt={key:0},Tt={class:"col-6 col-md-4"},Ut=c("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Faturamento ",-1),St={class:"q-ma-none"},zt={class:"col-6 col-md-2 text-right"},Rt=c("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1),Bt={class:"q-ma-none"};function Qt(a,o,l,n,e,r){const p=P("avatar"),k=P("row"),D=P("DocumentosFiscais"),O=P("Envelope"),w=P("ModalHistoricoStatus");return e.documento.id?(d(),f(X,{key:0,id:"VendaCard",class:"extratoItem bg-white q-pa-sm no-shadow"},{default:i(()=>[t(k,{class:"items-center justify-between q-mx-none q-px-none q-mb-sm"},{default:i(()=>{var h;return[c("div",ut,[t(N,{class:"q-pa-none"},{default:i(()=>{var b;return[t(p,{imagem:(b=e.contato[e.documento.idContato])==null?void 0:b.imagem,rotulo:e.documento.descricaoContato,tamanho:"40",style:{float:"left"}},null,8,["imagem","rotulo"]),t(T,null,{default:i(()=>{var L;return[c("div",mt,[t(E,null,{default:i(()=>{var F;return[m(v((F=e.contato[e.documento.idContato])==null?void 0:F.apelido),1)]}),_:1}),e.documento.idContatoResponsavel!==e.documento.idContato&&((L=e.contato[e.documento.idContatoResponsavel])==null?void 0:L.nome)?(d(),f(E,{key:0,caption:""},{default:i(()=>{var F;return[m(v((F=e.contato[e.documento.idContatoResponsavel])==null?void 0:F.nome),1)]}),_:1})):(d(),f(E,{key:1,caption:""},{default:i(()=>{var F;return[m(v((F=e.contato[e.documento.idContato])==null?void 0:F.nome),1)]}),_:1}))])]}),_:1}),t(be,{rounded:"",color:"tertiary",small:""},{default:i(()=>[m(v(e.documento.status),1)]),_:1}),t(be,{class:"q-ml-sm",color:"positive",escuro:"",onClick:r.copiarUid},{default:i(()=>[m(" #"+v(parseInt(e.documento.numero)||(e.documento.id||"").slice(-6))+" ",1),t(_,{class:"q-ml-sm",name:"mdi-glasses"}),A(c("input",{type:"hidden","onUpdate:modelValue":o[0]||(o[0]=L=>e.documento.id=L),ref:"uid"},null,512),[[Re,e.documento.id]])]),_:1},8,["onClick"])]}),_:1})]),c("div",pt,[c("p",ht,[e.contato[e.documento.idContatoVendedor]?(d(),f(_,{key:0,name:"mdi-account-tie"})):g("",!0),m(" "+v((h=e.contato[e.documento.idContatoVendedor])==null?void 0:h.apelido)+" ",1),t(ee,null,{default:i(()=>[m(" Vendedor(a) ")]),_:1})])]),c("div",ft,[c("p",vt,[e.documento.dataHoraEmissao?(d(),f(_,{key:0,name:"mdi-calendar-today "})):g("",!0),m(" "+v(a.$filters.data(e.documento.dataHoraEmissao))+" ",1),t(ee,null,{default:i(()=>[m(" Emiss\xE3o ")]),_:1})])]),c("div",bt,[c("p",gt,[e.documento.dataHoraFinalizado?(d(),f(_,{key:0,name:"mdi-calendar-check"})):g("",!0),m(" "+v(a.$filters.data(e.documento.dataHoraFinalizado))+" ",1),e.documento.dataHoraFinalizado?(d(),f(ee,{key:1},{default:i(()=>[m(" Finalizado ")]),_:1})):g("",!0)])]),c("div",_t,[c("p",Ct,v(a.$filters.numero(e.documento.totalDocumento,2)),1),c("p",yt,v(a.$filters.numero(e.documento.subTotal,2)),1)])]}),_:1}),t(ie,{class:"hideondesktop q-mb-sm"}),t(k,{class:"q-mx-none q-px-none items-center"},{default:i(()=>{var h;return[c("div",wt,[c("p",kt,[e.contato[e.documento.idContatoVendedor]?(d(),f(_,{key:0,name:"mdi-account-tie"})):g("",!0),m(" "+v((h=e.contato[e.documento.idContatoVendedor])==null?void 0:h.apelido)+" ",1),t(ee,null,{default:i(()=>[m(" Vendedor(a) ")]),_:1})])]),c("div",Ot,[t(Y,{class:"no-border text-tertiary"},{default:i(()=>[(d(!0),M(x,null,Z(e.documentosItem,b=>(d(),f(C,{key:b.id,class:"q-pa-none q-mb-xs",style:{"min-height":"auto"}},{default:i(()=>[t(u,{avatar:"",class:"mw80"},{default:i(()=>[t(E,null,{default:i(()=>[m(v(b.quantidade)+"x",1)]),_:2},1024)]),_:2},1024),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m(v(b.descricaoItem),1)]),_:2},1024)]),_:2},1024),t(u,{side:"",top:""},{default:i(()=>[t(E,null,{default:i(()=>[m(v(a.$filters.numero(b.total,2)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),c("div",Et,[t(ie,{class:"hideondesktop q-mb-sm q-mt-xs"}),t(y,{rounded:"",dense:"",flat:"",icon:"more_vert",color:"tertiary",class:"no-shadow q-mx-xs",size:"md",style:{float:"right"}},{default:i(()=>[t(oe,null,{default:i(()=>[A((d(),f(Y,{link:"",separator:""},{default:i(()=>[a.$utils.mapearStatus(e.documento).permiteNota?(d(),M(x,{key:0},[A((d(),f(C,{clickable:"",onClick:o[1]||(o[1]=b=>a.emitirNFeV2({idVenda:e.documento.id},1,"Venda"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"account_balance"})]),_:1}),t(u,null,{default:i(()=>[m("NFe de Sa\xEDda/Venda")]),_:1})]),_:1})),[[I]]),A((d(),f(C,{clickable:"",onClick:o[2]||(o[2]=b=>a.emitirNFeV2({idVenda:e.documento.id},0,"Devolu\xE7\xE3o"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"account_balance"})]),_:1}),t(u,null,{default:i(()=>[m("NFe de Entrada/Devolu\xE7\xE3o")]),_:1})]),_:1})),[[I]]),A((d(),f(C,{clickable:"",onClick:o[3]||(o[3]=b=>a.emitirNFeV2({idVenda:e.documento.id},1,"Remessa"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"account_balance"})]),_:1}),t(u,null,{default:i(()=>[m("NFe de Remessa")]),_:1})]),_:1})),[[I]])],64)):g("",!0),r.podeMigrarFatura?(d(),M(x,{key:1},[(d(!0),M(x,null,Z(e.faturasAbertas.filter(b=>b.id!==e.documento.idFatura),b=>A((d(),f(C,{clickable:"",key:b.id,onClick:L=>r.migrarFatura({documento:e.documento,idFatura:b.id})},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"mdi-folder-move"})]),_:1}),t(u,null,{default:i(()=>[m(v("Migrar para fatura #"+(b.numero||b.id.slice(-6))),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[I]])),128)),A((d(),f(C,{clickable:"",onClick:o[4]||(o[4]=b=>r.migrarFatura({documento:e.documento}))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"mdi-folder-move"})]),_:1}),t(u,null,{default:i(()=>[m("Migrar para nova fatura")]),_:1})]),_:1})),[[I]])],64)):g("",!0),t(C,{clickable:"",onClick:o[5]||(o[5]=b=>a.$refs.modalHistoricoStatus.mostrar({idDocumento:e.documento.id}))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"history"})]),_:1}),t(u,null,{default:i(()=>[m("Hist\xF3rico do Status")]),_:1})]),_:1}),(d(!0),M(x,null,Z(a.configImpressosWhatsapp.filter(b=>b.valor),b=>(d(),f(C,{clickable:"",key:b.valor,onClick:L=>r.dialogEnviar(b)},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"mdi-whatsapp"})]),_:1}),t(u,null,{default:i(()=>[m(v(b.valor),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[I]])]),_:1})]),_:1}),e.visibilidade.botao.remover?(d(),f(y,{key:0,rounded:"",dense:"",flat:"",icon:"clear",color:"tertiary",class:"no-shadow q-mx-xs",size:"md",onClick:o[6]||(o[6]=b=>r.remover({documento:e.documento})),style:{float:"right"}})):g("",!0),e.visibilidade.botao.editar?(d(),f(y,{key:1,rounded:"",dense:"",flat:"",icon:"edit",color:"primary",class:"no-shadow q-mx-xs",size:"md",onClick:o[7]||(o[7]=b=>r.mostrar({documento:e.documento})),style:{float:"right"}})):g("",!0),e.visibilidade.botao.visualizar?(d(),f(y,{key:2,rounded:"",dense:"",flat:"",icon:"remove_red_eye",color:"primary",class:"no-shadow q-mx-xs",size:"md",onClick:o[8]||(o[8]=b=>r.mostrar({documento:e.documento})),style:{float:"right"}})):g("",!0),t(y,{rounded:"",dense:"",flat:"",icon:"print",color:"primary",class:"no-shadow q-mx-xs",size:"md",style:{float:"right"}},{default:i(()=>[t(oe,null,{default:i(()=>[t(Y,{link:"",separator:""},{default:i(()=>[(d(!0),M(x,null,Z(e.configImpressaoOrcamento.filter(b=>b.valor),b=>(d(),f(C,{clickable:"",key:b.valor,onClick:L=>a.$imprimir(b.valor,{id:e.documento.id,Oculto:"0"})},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"print"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m(v(b.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),e.sistemaPai==="optisoul"?(d(!0),M(x,{key:0},Z(e.configImpressaoEnvelope,b=>(d(),f(C,{clickable:"",key:b.valor,onClick:L=>a.$imprimir(b.valor,e.documento.id)},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"print"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m(v(b.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):g("",!0)]),_:1})]),_:1})]),_:1}),t(y,{rounded:"",dense:"",flat:"",icon:e.detalhesVisivel?"keyboard_arrow_up":"keyboard_arrow_down",size:"md",class:"no-shadow q-mx-xs",color:"tertiary",style:{float:"right"},onClick:r.alternarDetalhes},null,8,["icon","onClick"])])]}),_:1}),t(ie,{class:"hideondesktop q-mb-sm q-mt-xs"}),t(k,{class:"q-mx-none q-px-none hideondesktop"},{default:i(()=>[c("div",Dt,[c("p",Vt,[e.documento.dataHoraEmissao?(d(),f(_,{key:0,name:"mdi-calendar-today"})):g("",!0),m(" "+v(a.$filters.data(e.documento.dataHoraEmissao))+" ",1),t(ee,null,{default:i(()=>[m(" Emiss\xE3o ")]),_:1})]),c("p",At,[e.documento.dataHoraFinalizado?(d(),f(_,{key:0,name:"mdi-calendar-check"})):g("",!0),m(" "+v(a.$filters.data(e.documento.dataHoraFinalizado))+" ",1),e.documento.dataHoraFinalizado?(d(),f(ee,{key:1},{default:i(()=>[m(" Finalizado ")]),_:1})):g("",!0)])]),c("div",Mt,[c("p",It,v(a.$filters.numero(e.documento.subTotal,2)),1),c("p",qt,v(a.$filters.numero(e.documento.totalDocumento,2)),1)]),c("div",Pt,[t(ie,{class:"hideondesktop q-mb-sm q-mt-xs"}),t(y,{rounded:"",dense:"",flat:"",icon:"more_vert",color:"tertiary",class:"no-shadow q-mx-xs",size:"md",style:{float:"right"}},{default:i(()=>[t(oe,null,{default:i(()=>[A((d(),f(Y,{link:"",separator:""},{default:i(()=>[a.$utils.mapearStatus(e.documento).permiteNota?(d(),M(x,{key:0},[A((d(),f(C,{clickable:"",onClick:o[9]||(o[9]=h=>a.emitirNFeV2({idVenda:e.documento.id},1,"Venda"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"account_balance"})]),_:1}),t(u,null,{default:i(()=>[m("NFe de Sa\xEDda/Venda")]),_:1})]),_:1})),[[I]]),A((d(),f(C,{clickable:"",onClick:o[10]||(o[10]=h=>a.emitirNFeV2({idVenda:e.documento.id},0,"Devolu\xE7\xE3o"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"account_balance"})]),_:1}),t(u,null,{default:i(()=>[m("NFe de Entrada/Devolu\xE7\xE3o")]),_:1})]),_:1})),[[I]]),A((d(),f(C,{clickable:"",onClick:o[11]||(o[11]=h=>a.emitirNFeV2({idVenda:e.documento.id},1,"Remessa"))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"account_balance"})]),_:1}),t(u,null,{default:i(()=>[m("NFe de Remessa")]),_:1})]),_:1})),[[I]])],64)):g("",!0),r.podeMigrarFatura?(d(),M(x,{key:1},[(d(!0),M(x,null,Z(e.faturasAbertas.filter(h=>h.id!==e.documento.idFatura),h=>A((d(),f(C,{key:h.id,onClick:b=>r.migrarFatura({documento:e.documento,idFatura:h.id})},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"mdi-folder-move"})]),_:1}),t(u,null,{default:i(()=>[m(v("Migrar para fatura #"+(h.numero||h.id.slice(-6))),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[I]])),128)),A((d(),f(C,{onClick:o[12]||(o[12]=h=>r.migrarFatura({documento:e.documento}))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"mdi-folder-move"})]),_:1}),t(u,null,{default:i(()=>[m("Migrar para nova fatura")]),_:1})]),_:1})),[[I]])],64)):g("",!0),t(C,{clickable:"",onClick:o[13]||(o[13]=h=>a.$refs.modalHistoricoStatus.mostrar({idDocumento:e.documento.id}))},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"history"})]),_:1}),t(u,null,{default:i(()=>[m("Hist\xF3rico do Status")]),_:1})]),_:1}),(d(!0),M(x,null,Z(a.configImpressosWhatsapp.filter(h=>h.valor),h=>(d(),f(C,{clickable:"",key:h.valor,onClick:b=>r.dialogEnviar(h)},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"mdi-whatsapp"})]),_:1}),t(u,null,{default:i(()=>[m(v(h.valor),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[I]])]),_:1})]),_:1}),e.visibilidade.botao.remover?(d(),f(y,{key:0,rounded:"",dense:"",flat:"",icon:"clear",color:"tertiary",class:"no-shadow q-mx-xs",size:"md",onClick:o[14]||(o[14]=h=>r.remover({documento:e.documento})),style:{float:"right"}})):g("",!0),e.visibilidade.botao.editar?(d(),f(y,{key:1,rounded:"",dense:"",flat:"",icon:"edit",color:"primary",class:"no-shadow q-mx-xs",size:"md",onClick:o[15]||(o[15]=h=>r.mostrar({documento:e.documento})),style:{float:"right"}})):g("",!0),e.visibilidade.botao.visualizar?(d(),f(y,{key:2,rounded:"",dense:"",flat:"",icon:"remove_red_eye",color:"primary",class:"no-shadow q-mx-xs",size:"md",onClick:o[16]||(o[16]=h=>r.mostrar({documento:e.documento})),style:{float:"right"}})):g("",!0),t(y,{rounded:"",dense:"",flat:"",icon:"print",color:"primary",class:"no-shadow q-mx-xs",size:"md",style:{float:"right"}},{default:i(()=>[t(oe,null,{default:i(()=>[t(Y,{link:"",separator:""},{default:i(()=>[(d(!0),M(x,null,Z(e.configImpressaoOrcamento.filter(h=>h.valor),h=>(d(),f(C,{clickable:"",key:h.valor,onClick:b=>a.$imprimir(h.valor,{id:e.documento.id,Oculto:"0"})},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"print"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m(v(h.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),e.sistemaPai==="optisoul"?(d(!0),M(x,{key:0},Z(e.configImpressaoEnvelope,h=>(d(),f(C,{clickable:"",key:h.valor,onClick:b=>a.$imprimir(h.valor,e.documento.id)},{default:i(()=>[t(u,{avatar:""},{default:i(()=>[t(_,{name:"print"})]),_:1}),t(u,null,{default:i(()=>[t(E,null,{default:i(()=>[m(v(h.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):g("",!0)]),_:1})]),_:1})]),_:1}),t(y,{rounded:"",dense:"",flat:"",icon:e.detalhesVisivel?"keyboard_arrow_up":"keyboard_arrow_down",size:"md",class:"no-shadow q-mx-xs",color:"tertiary",style:{float:"right"},onClick:r.alternarDetalhes},null,8,["icon","onClick"])])]),_:1}),e.detalhesVisivel?(d(),f(ie,{key:0,class:"hideondesktop q-my-sm"})):g("",!0),e.detalhesVisivel?(d(),f(k,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:i(()=>[c("div",Lt,[c("p",Ft,[t(_,{name:"business"}),m(" "+v(e.documento.descricaoEmpresa),1)]),c("div",xt,[e.fatura.id?(d(),M("div",Nt,[m(" Fatura "),t(be,{color:"positive",escuro:"",onClick:r.copiarUid},{default:i(()=>[m(" #"+v(parseInt(e.fatura.numero)||(e.fatura.id||"").slice(-6))+" ",1),t(_,{class:"q-ml-sm",name:"mdi-glasses"}),A(c("input",{type:"hidden","onUpdate:modelValue":o[17]||(o[17]=h=>e.fatura.id=h),ref:"uid"},null,512),[[Re,e.fatura.id]])]),_:1},8,["onClick"]),t(be,{class:"q-ml-sm",rounded:"",color:"tertiary",small:""},{default:i(()=>[m(v(e.fatura.status),1)]),_:1})])):g("",!0),c("div",null,v(e.documento.observacao),1),c("div",null,v(e.documento.observacaoInterna),1),c("div",null,v(e.documento.motivoCancelamento),1),c("div",null,v(e.documento.observacaoCancelamento),1)]),t(D,{idVenda:e.documento.id},null,8,["idVenda"])]),c("div",Tt,[Ut,c("div",St,v(e.documento.observacaoFaturamento),1)]),c("div",zt,[Rt,c("p",Bt,v(a.$filters.numero(e.documento.totalDesconto,2)),1)])]),_:1})):g("",!0),t(O,{ref:"modalEnvelope"},null,512),t(w,{ref:"modalHistoricoStatus"},null,512)]),_:1})):g("",!0)}var Wt=Be(dt,[["render",Qt]]);export{Wt as E,nt as a};
