import{_ as ka,r as Q,o as v,p as N,f as t,w as r,C as D,h as da,i as pa,k as M,t as y,d as T,cL as Ya,e as x,j as R,m as fa,Q as B,B as Sa,be as ya,H as ga,P as Ca,F as L,u as J,S as H,T as _,U,N as ba,l as La,z as ao,O as oo,E as to,bq as Va,D as Ia,v as eo,a as io,cN as no,cO as ro,cP as so,cQ as lo,M as ja,G as Ha,I as Ua,J as Qa,K as co,aU as uo}from"./index.0a2643b1.js";import{D as mo,C as fo}from"./DocumentosFiscais.94c68375.js";import{e as po}from"./emitirNFe.35117289.js";import{V as vo}from"./VendaCard.49b59de9.js";import{E as ho}from"./EnvelopeCard.ae9f18be.js";const Co={computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{titulo:{},tituloOriginal:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,campos:{valorMulta:0},rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(e){this.$router.push({name:"AtendimentoFatura",params:{id:e}})},async migrarFatura(e){try{await new Promise((o,d)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{o()}).onCancel(()=>{d()})})}catch{return}if(!e&&this.titulo.idContato&&this.titulo.idEmpresa){const o=await $erp().contato.get(this.titulo.idContato)||{};let d=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),h=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();d=d.find(k=>(k.grupo||"").trim().toLowerCase()==="Principal")||d[0]||{},h=h.find(k=>(k.tipoTelefone||"").trim().toLowerCase()==="Principal")||h[0]||{};const a=await $erp().contato.get(this.titulo.idEmpresa)||{};let m=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();m=m.find(k=>k.grupo.trim().toLowerCase()==="Principal")||m[0]||{},e=$db.fatura.criar({idEmpresa:a.id,idEmpresaEndereco:m.id||"",descricaoEmpresa:a.nome||"",numeroDocumentoEmpresa:a.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:a.numeroDocumentoMunicipal||"",optanteSimplesNacional:a.regime==="SimplesNacional"?"1":"0",idContato:o.id,idContatoEndereco:d.id||"",numeroDocumentoContato:o.numeroDocumentoNacional||"",descricaoContato:o.nome||"",descricaoContatoEndereco:"".concat(d.logradouro||"",", ",d.numero||""," ",d.complemento||""," - ",d.bairro||""," - ",d.cep||""," - ",d.municipio||"","/",d.uf||""),telefoneContato:h.telefone||"",emailContato:o.email||"",regimeContato:o.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:e})}e.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:e.id},original:this.titulo}),localStorage.setItem("idFatura",e.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(this.titulo.valorDesconto===this.tituloOriginal.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){const e=Number(this.titulo.diasEmAtraso)||0;let o=0;e>0&&(o=Number(this.titulo.valorMulta)||0),this.modalEditar={visivel:!0,campos:{valorMulta:o},rules:[]}},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},cancelarDesconto(){this.titulo=$utils.clonar(this.tituloOriginal),this.modalEditar.visivel=!1},async desconto(){const e=this.titulo.valorDesconto;let o=0,d=0,h=0,a=Number(this.titulo.diasEmAtraso)||0;const m=Number(this.titulo.valor)||0;if(a<0&&(a=0),a>0&&(d=Number(this.titulo.valorMulta)||0,o=Number(this.titulo.valorJuros)||0,h=$utils.arredondar(d+o*a)),await $db.permissao.objeto("PadraoNovo_Financeiro")&&(h=$utils.arredondar(m+d+o*a)),e<0||e>h){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"];return}this.modalEditar.rules=[()=>!0];const C=$utils.arredondar(m-e+d+o*a),F=$utils.arredondar(e*100/(m||1));this.titulo.valorTotal=C,this.titulo.valorARealizar=C,this.titulo.percentualDesconto=F},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((e,o)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{o()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")}},props:{dados:{required:!0,type:Object}},async mounted(){const e=new Date(this.dados.dataVencimento).setHours(0,0,0,0),o=new Date().setHours(0,0,0,0);e<o?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,h=>h!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $db.hibrido.le({table:"documento",id:this.titulo.documentoId})),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(h=>this.visibilidade.botao.editar=h&&!this.tituloOriginal.valorRealizado),this.contatos={};const d={};if(this.titulo.idContato){const h=await $db.contato.le({id:this.titulo.idContato});h&&(d[this.titulo.idContato]=h)}if(this.titulo.idEmpresa){const h=await $db.contato.le({id:this.titulo.idEmpresa});h&&(d[this.titulo.idEmpresa]=h)}this.contatos=d,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leNew({id:this.titulo.idFatura}).then(h=>{this.fatura=h,h.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(a=>{a.data.find(k=>k.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},go={class:"col-12 col-md-6 q-pl-none"},bo={class:"col-4 col-md"},$o={key:0,class:"q-my-none"},Fo={class:"q-my-none"},Eo={class:"q-my-none"},Do={class:"col-4 col-md text-right"},wo={class:"col-4 col-md text-right"},Po={class:"col-12 col-md"},qo={class:"text-right text-h5 text-positive text-weight-bold q-my-none"},yo={class:"text-right text-weight-normal text-tertiary text-body2 q-my-none"},To={class:"col-12 col-md-6"},xo={class:"text-body2"},Mo={class:"col-12 col-md-6 text-right hideonmobile"},_o={class:"col-12 text-right"},ko={class:"col-12 col-md-6"},Vo={class:"text-body2 q-my-none q-mb-md"},Io={class:"col-12 col-sm-4 col-md-2"},zo={class:"text-left q-my-none"},No={class:"col-6 col-md-1"},Oo={class:"text-left q-my-none"},Ro={class:"col-6 col-md-1"},Ao={class:"text-left q-my-none"},Bo={class:"col-12 col-sm-4 col-md-2 text-right"},So={class:"q-ma-none"},Lo={class:"q-mt-xs"},jo={class:"q-mt-xs"},Ho={class:"q-mt-lg text-right q-gutter-md"};function Uo(e,o,d,h,a,m){const k=Q("avatar"),C=Q("row"),F=Q("campo");return v(),N("div",{class:eo([a.tema,"extratoItem bg-white q-pa-sm no-shadow"])},[t(C,{class:"items-center q-mx-none q-px-none q-mb-sm text-tertiary"},{default:r(()=>{var $;return[D("div",go,[t(da,{class:"q-pa-none"},{default:r(()=>[t(k,{imagem:(a.contatos[a.titulo.idContato]||{}).imagem,rotulo:(a.contatos[a.titulo.idContato]||{}).apelido,tamanho:"30"},null,8,["imagem","rotulo"]),t(pa,null,{default:r(()=>[M(y((a.contatos[a.titulo.idContato]||{}).apelido)+" ",1),o[9]||(o[9]=D("br",null,null,-1))]),_:1}),a.titulo.parcela?(v(),T(Ya,{key:0,rounded:"",color:"tertiary",small:""},{default:r(()=>[M(y(a.titulo.parcela),1)]),_:1})):x("",!0)]),_:1})]),D("div",bo,[a.titulo.documentoCodigo?(v(),N("p",$o,y(a.titulo.documentoTipo)+" #"+y(($=a.documento)==null?void 0:$.numero),1)):x("",!0),D("p",Fo,y(a.titulo.formaDePagamento),1),D("p",Eo,y(a.titulo.descricaoPlanoConta),1)]),D("div",Do,[a.titulo.dataVencimentoOriginal?(v(),T(R,{key:0,name:"mdi-calendar-today"})):x("",!0),M(" "+y(e.$filters.data(a.titulo.dataVencimentoOriginal))+" ",1),t(fa,null,{default:r(()=>o[10]||(o[10]=[M("Vencimento original")])),_:1})]),D("div",wo,[a.titulo.dataVencimento?(v(),T(R,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+y(e.$filters.data(a.titulo.dataVencimento))+" ",1),t(fa,null,{default:r(()=>o[11]||(o[11]=[M("Vencimento")])),_:1})]),D("div",Po,[D("p",qo,y(e.$filters.numero(a.titulo.valorTotal,2)),1),D("p",yo,y(e.$filters.numero(a.titulo.valor,2)),1)])]}),_:1}),t(C,{class:"items-center justify-end"},{default:r(()=>[D("div",To,[D("div",xo,y(a.titulo.descricao),1)]),D("div",Mo,[a.visibilidade.botao.remover?(v(),T(B,{key:0,onClick:m.remover,icon:"clear",color:"tertiary",round:"",dense:"",flat:""},{default:r(()=>[t(fa,null,{default:r(()=>[M(" Remover da Fatura #"+y(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):x("",!0),t(B,{onClick:m.alternarDetalhes,icon:`keyboard_arrow_${a.detalhes?"up":"down"}`,color:"tertiary",round:"",dense:"",flat:""},null,8,["onClick","icon"]),a.visibilidade.botao.editar?(v(),T(B,{key:1,onClick:m.editar,icon:"edit",color:"primary",round:"",dense:"",flat:""},null,8,["onClick"])):x("",!0),Sa(e.$slots,"default"),m.mostrarMenuTresPontos?(v(),T(B,{key:2,icon:"more_vert",color:"tertiary",rounded:"",dense:"",flat:""},{default:r(()=>[t(ya,null,{default:r(()=>[ga((v(),T(Ca,{link:"",separator:""},{default:r(()=>[a.mostrarOpcaoMigrarFatura?(v(),N(L,{key:0},[(v(!0),N(L,null,J(a.faturasAbertas,$=>(v(),T(H,{clickable:"",key:$.id,onClick:i=>m.migrarFatura($)},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y("Migrar para fatura #"+($.numero||$.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(H,{clickable:"",onClick:o[0]||(o[0]=$=>m.migrarFatura())},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>o[12]||(o[12]=[M("Migrar para nova fatura")])),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})),[[ba]])]),_:1})]),_:1})):x("",!0)])]),_:3}),t(La,{class:"hideondesktop q-mb-sm q-mt-xs"}),t(C,{class:"q-mx-none q-px-none hideondesktop"},{default:r(()=>[D("div",_o,[a.visibilidade.botao.remover?(v(),T(B,{key:0,onClick:m.remover,icon:"clear",color:"tertiary",round:"",dense:"",flat:""},{default:r(()=>[t(fa,null,{default:r(()=>[M(" Remover da Fatura #"+y(parseInt(a.fatura.numero)||(a.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):x("",!0),t(B,{onClick:m.alternarDetalhes,round:"",dense:"",flat:"",color:"tertiary",icon:`keyboard_arrow_${a.detalhes?"up":"down"}`},null,8,["onClick","icon"]),a.visibilidade.botao.editar?(v(),T(B,{key:1,onClick:m.editar,icon:"edit",color:"primary",round:"",dense:"",flat:""},null,8,["onClick"])):x("",!0),Sa(e.$slots,"default"),m.mostrarMenuTresPontos?(v(),T(B,{key:2,round:"",dense:"",flat:"",icon:"more_vert",color:"tertiary"},{default:r(()=>[t(ya,null,{default:r(()=>[ga((v(),T(Ca,{link:"",separator:""},{default:r(()=>[a.mostrarOpcaoMigrarFatura?(v(),N(L,{key:0},[(v(!0),N(L,null,J(a.faturasAbertas,$=>(v(),T(H,{clickable:"",key:$.id,onClick:i=>m.migrarFatura($)},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y("Migrar para fatura #"+($.numero||$.id.slice(-6))),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),t(H,{clickable:"",onClick:o[1]||(o[1]=$=>m.migrarFatura())},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"mdi-folder-move"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>o[13]||(o[13]=[M("Migrar para nova fatura")])),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})),[[ba]])]),_:1})]),_:1})):x("",!0)])]),_:3}),a.detalhes?(v(),T(La,{key:0,class:"hideondesktop q-my-sm"})):x("",!0),a.detalhes?(v(),T(C,{key:1,class:"items-start q-mx-none q-px-none q-mt-md"},{default:r(()=>[D("div",ko,[t(da,{class:"u-autoHeight q-pa-none",color:"none",dark:""},{default:r(()=>[t(R,{name:"business"}),t(pa,null,{default:r(()=>[M(y((a.contatos[a.titulo.idEmpresa]||{}).apelido),1)]),_:1})]),_:1}),D("p",Vo,y(a.titulo.observacao),1)]),D("div",Io,[D("p",zo,y(a.titulo.descricaoCentroCusto),1)]),D("div",No,[D("p",Oo,[a.titulo.dataEmissao?(v(),T(R,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+y(e.$filters.data(a.titulo.dataEmissao))+" ",1),t(fa,null,{default:r(()=>o[14]||(o[14]=[M("Emiss\xE3o")])),_:1})])]),D("div",Ro,[D("p",Ao,[a.titulo.dataCompetencia?(v(),T(R,{key:0,name:"mdi-calendar-check"})):x("",!0),M(" "+y(e.$filters.data(a.titulo.dataCompetencia))+" ",1),t(fa,null,{default:r(()=>o[15]||(o[15]=[M("Compet\xEAncia")])),_:1})])]),D("div",Bo,[o[18]||(o[18]=D("p",{class:"text-subtitle1 text-weight-bold q-ma-none"}," Desconto ",-1)),D("p",So,y(e.$filters.numero(a.titulo.valorDesconto||0,2)),1),a.titulo.diasEmAtraso?(v(),N(L,{key:0},[D("div",Lo,[o[16]||(o[16]=D("small",{class:"block text-caption"},"Multa",-1)),D("strong",null,y(e.$filters.numero(a.titulo.valorMulta||0,2))+" ("+y(e.$filters.numero(a.titulo.percentualMulta||0,2))+"%) ",1)]),D("div",jo,[o[17]||(o[17]=D("small",{class:"block text-caption"},"Juros",-1)),D("strong",null,y(e.$filters.numero(a.titulo.valorTotalJuros||0,2))+" ("+y(e.$filters.numero(a.titulo.percentualJuros||0,2))+"% dia) ",1)])],64)):x("",!0)])]),_:1})):x("",!0),t(Ia,{modelValue:a.modalEditar.visivel,"onUpdate:modelValue":o[8]||(o[8]=$=>a.modalEditar.visivel=$),onKeyup:Va(m.cancelarDesconto,["esc"]),persistent:""},{default:r(()=>[t(ao,{style:{"min-width":"30vw"}},{default:r(()=>[t(da,{class:"bg-primary text-white"},{default:r(()=>[t(pa,null,{default:r(()=>o[19]||(o[19]=[M("Editar T\xEDtulo")])),_:1})]),_:1}),t(oo,null,{default:r(()=>[t(to,{onSubmit:m.salvar,class:"q-pa-lg q-gutter-md"},{default:r(()=>[t(F,{modelValue:a.titulo.valor,"onUpdate:modelValue":o[2]||(o[2]=$=>a.titulo.valor=$),rotulo:"Valor",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),t(F,{modelValue:a.titulo.diasEmAtraso,"onUpdate:modelValue":o[3]||(o[3]=$=>a.titulo.diasEmAtraso=$),rotulo:"Dias em Atraso",tipo:"decimal",decimals:"0",zerosDireita:"0",zeros:"","somente-leitura":"",outlined:""},null,8,["modelValue"]),t(F,{modelValue:a.modalEditar.campos.valorMulta,"onUpdate:modelValue":o[4]||(o[4]=$=>a.modalEditar.campos.valorMulta=$),ajuda:`Multa de R$ ${e.$filters.numero(a.titulo.valorMulta,2)}`,rotulo:"Multa",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),t(F,{modelValue:a.titulo.valorTotalJuros,"onUpdate:modelValue":o[5]||(o[5]=$=>a.titulo.valorTotalJuros=$),ajuda:`Juros ao ${a.titulo.tipoJuros} de R$ ${e.$filters.numero(a.titulo.valorJuros,2)}`,rotulo:"Juros",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue","ajuda"]),t(F,{modelValue:a.titulo.valorDesconto,"onUpdate:modelValue":[o[6]||(o[6]=$=>a.titulo.valorDesconto=$),m.desconto],rotulo:"Desconto",tipo:"decimal",decimals:"2",rules:a.modalEditar.rules,outlined:""},null,8,["modelValue","onUpdate:modelValue","rules"]),t(F,{modelValue:a.titulo.valorTotal,"onUpdate:modelValue":o[7]||(o[7]=$=>a.titulo.valorTotal=$),rotulo:"Total",tipo:"decimal",decimals:"2","somente-leitura":"",outlined:""},null,8,["modelValue"]),D("div",Ho,[t(B,{color:"tertiary",flat:"",unelevated:"",label:"Cancelar",onClick:m.cancelarDesconto},null,8,["onClick"]),t(B,{color:"primary",unelevated:"",label:"Salvar",type:"submit"})])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],2)}var Qo=ka(Co,[["render",Uo]]),Jo={async enviar(e,o){var d,h;try{const a=o.nome.replace("enviaemail.fatura.",""),m=(d=o.valor)!=null?d:"Impresso",k=(h=o.texto)!=null?h:`Voc\xEA est\xE1 recebendo o ${m} da empresa ${e.descricaoEmpresa}.`,C=await $db.contato.le({id:e.idContato}),F=await $utils.impressaoObterHtml(a,e),$={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:String(C==null?void 0:C.email).trim().toLowerCase(),assunto:`${m}`,mensagem:`${k}`},i=`${m} enviado para ${$.para}, com sucesso!.`,I=`Erro ao enviar e-mail. ${m} n\xE3o enviado.`;$q.loading.show({message:`Enviando ${m} por e-mail...`,html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const V=[{name:`${m}.pdf`,content:F,method:"html2pdf"}],j={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"xpto@9@9"},from:$.de,to:$.para,subject:$.assunto,text:$.mensagem,attachments:V},A=await io({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:j});$q.notifyPositive((A==null?void 0:A.status)===200&&i?i:A.data.message)}catch(a){$q.notifyError(errorMsg||"Erro ao enviar e-mail",a)}finally{$q.loading.hide()}}},Go={async finalizar(e,o){var d,h,a,m,k,C,F,$;try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!e)try{await new Promise((s,l)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{s()}).onCancel(()=>{l()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const i=$utils.clonar(this.fatura),I=$utils.clonar(this.vendas),V=$utils.clonar(this.documentosEnvelope),j=$utils.clonar(this.carnes),A=[...I,...V].map(s=>s.id),K=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:A}}),u=$utils.clonar(K);if(j.length>0){const s=j.reduce((l,b)=>(b.idFinanceiroBoleto&&b.codigoFinanceiroTitulo&&(l+=String(b.codigoFinanceiroTitulo)+";"),l),"");if(s)try{$q.loading.show({message:"Baixando boletos..."});const l=`exec sp_Financeiro_BoletoBaixar '${s.slice(0,-1)}'`,b=await $utils.executarSql(l)}catch(l){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",l);return}finally{$q.loading.hide()}}const n=e?i.dataHoraFinalizado:$utils.dataAtual(),c=n,g=await $db.hibrido.le({table:"documento",id:this.$refs.faturamento.idDocumentoCaixa}),S=await $db.formaPagamento.le();this.documentoStatus=[],await this.$refs.faturamento.validar();let Y=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(s=>s.valor),["idFormaPagamento","autorizacao","dataVencimento"]);$utils.verificarErro(I.some(s=>!s.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o.");const oa=$utils.arredondar(this.carnes.reduce((s,l)=>s+(l.valorARealizar||0),0)),$a=$utils.arredondar(Y.reduce((s,l)=>s+(l.valor||0),0));let ta=0;if(e&&(Y=Y.filter(s=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(l=>l.id===s.id))),i.totalDocumento>=0){if(this.carnes.length){if($a<oa)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const l=Y.reduce((b,w)=>{const P=`${w.autorizacao||""}${w.documento||""}${w.idFormaPagamento}`;return b[P]||(b[P]={parcelas:0,formaPagamento:w.formaPagamento}),b[P].parcelas++,b},{});for(const b in l)if(l[b].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${l[b].formaPagamento} acima do permitido.`),!1}}$a<i.totalDocumento&&(ta=1)}let na=ta===1?"Aguardando Pagamento":"Finalizada";if(!e){this.documentoStatus.push({id:$utils.uuid(),idDocumento:i.id,operacao:"Fatura",statusOriginal:i.status,statusFinalizado:na,dataHoraEmissao:n,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:g.id||""}),i.status=na,i.dataHoraFinalizado=n,na="Faturado";const s=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",i.idEmpresa,0))||0;let l=0,b=V.filter(f=>f.status!=="Entregue").length,w=!1,P=!0;if(I.length>0&&s&&(this.$q.loading.hide(),await new Promise((f,E)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{P=!0,f()}).onCancel(()=>{P=!1,f()})}),this.$q.loading.show({message:"Processando..."})),b){let f="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";b>1&&(f=`Nesta Fatura h\xE1 ${b} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise((E,q)=>{this.$q.dialog({cancel:"N\xE3o",message:f,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{w=!0,E()}).onCancel(()=>{q()})})}catch{}this.$q.loading.show({message:"Processando..."})}let p=0;p=$utils.arredondar(u.reduce((f,E)=>(E.total>0&&(f+=E.total),f),p));for(const f of[...I,...V])f.tipo==="Envelope"&&w&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:f.id,operacao:f.operacao,statusOriginal:f.status,statusFinalizado:"Entregue",dataHoraEmissao:n,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),f.status="Entregue"),f.tipo==="Venda"&&P&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:f.id,operacao:f.operacao,statusOriginal:f.status,statusFinalizado:na,dataHoraEmissao:n,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:g.id||""}),f.status="Faturado");for(const f of u){const E=[...I,...V].find(q=>q.id===f.idDocumento);if(f.status=E.status,f.total>0){f.quantidade=f.quantidade||1,f.valorItem=f.valorItem||0,f.descontoItem=f.descontoItem||0,f.descontoTotalRateado=f.descontoTotalRateado||0;let q=(f.valorItem-f.descontoItem)*f.quantidade-f.descontoTotalRateado;const z=$utils.arredondar((i.totalDesconto||0)*q/(p||1)||0);f.descontoFaturaRateado=$utils.arredondar(z),f.valorRealTotal=$utils.arredondar(q-z),f.valorReal=$utils.arredondar(f.valorRealTotal/f.quantidade),l+=z}}if(this.documentosItem=u,this.documentosItemOriginal=K,i.totalDesconto!==$utils.arredondar(l)){const f=$utils.arredondar((i.totalDesconto||0)-(l||0));let E,q=0;for(const z of u)z.total>q&&(q=z.total,E=z);if(E){const z=(E.descontoFaturaRateado||0)+(f||0),X=((E.valorItem||0)-(E.descontoItem||0))*(E.quantidade||1)-(E.descontoTotalRateado||0)-(z||0),ua=(X||0)/(E.quantidade||1);E.descontoFaturaRateado=$utils.arredondar(z),E.valorReal=$utils.arredondar(ua),E.valorRealTotal=$utils.arredondar(X)}}}const Fa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),ca=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Fa}),ra=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ra});const Ea=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),Da=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ea}),Ta=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),za=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ta}),Ja=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),Z=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ja}),Ga=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Na=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ga}),Ka=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),Oa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ka}),Za=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),wa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Za}),Wa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),Xa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Wa}),xa=(d=this.contatos[i.idContato])==null?void 0:d.descontoCondicionadoPercentual;let la=I.reduce((s,l)=>s+l.totalDocumento,0);la=la+V.reduce((s,l)=>s+l.totalDocumento,0),la=$utils.arredondar(la-i.totalDesconto);let sa=i.totalDocumento,W=[];const O=[],Ra=[],Pa=[],Aa=[];let va=1,Ma="",qa=1,ea="";for(const s of Y.filter(l=>!l.sinal)){s.sinal=s.sinal||ta;const l=S.filter(b=>b.id===s.idFormaPagamento)[0];if(sa<0)ea=$utils.uuid(),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:ea,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:$utils.arredondar(sa*-1),descricao:Z.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${i.id})`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:ea,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Xa.id,dataEmissao:n,valorCredito:$utils.arredondar(sa*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${i.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id});else{if(Ma!==s.idFormaPagamento+s.autorizacao&&(Ma=s.idFormaPagamento+s.autorizacao,va=1,qa=Y.reduce((b,w)=>w.idFormaPagamento+w.autorizacao===Ma?b+1:b,0)),l.tipoFinanceiro==="T\xEDtulo Liquidado"&&(ea=$utils.uuid()),oa>0){const b=$utils.uuid(),w=$utils.arredondar(s.valor*(oa/sa));let P=0,p=0,f=0,E=0;if(l.tipo===5){let q=(await $erp().financeiroBanco.toArray()).find(z=>z.codigoBanco===122);q&&(p=q.percentualMulta||0,E=q.percentualJuros||0,P=$utils.arredondar(p/100*w),f=$utils.arredondar(E/100*w))}W.push({id:b,idFinanceiroPlanoConta:ca.id,idContato:i.idContato,dataEmissao:n,dataCompetencia:c,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:w,valorTotal:w,valorARealizar:w,valorMulta:P,percentualMulta:p,valorJuros:f,percentualJuros:E,documentoId:i.id,documentoTipo:"Fatura",parcela:va+"/"+qa,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:l.descricao,carne:l.tipo===5?1:0,dataEmissaoCarne:l.tipo===5?n:"",idDocumentoCaixa:g.id,idFinanceiroMovimentacaoAgrupamento:l.tipoFinanceiro==="T\xEDtulo Liquidado"?ea:""}),s.idFinanceiroTitulo=b,l.tipo===2&&Pa.push({idTitulo:b,idDocumentoCondicaoPagamento:s.id,valor:w,dataVencimento:s.dataVencimento,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,formaPagamento:l}),Aa.push({idTitulo:b,valor:w,desconto:0})}if(la>0){const b=$utils.uuid(),w=$utils.arredondar(s.valor*(la/sa));let P=0,p=0,f=0,E=0;if(l.tipo===5){let q=(await $erp().financeiroBanco.toArray()).find(z=>z.codigoBanco===122);q&&(p=q.percentualMulta||0,E=q.percentualJuros||0,P=$utils.arredondar(p/100*w),f=$utils.arredondar(E/100*w))}W.push({id:b,idFinanceiroPlanoConta:Z.id,idContato:i.idContato,dataEmissao:n,dataCompetencia:c,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:w,valorTotal:w,valorARealizar:w,valorMulta:P,percentualMulta:p,valorJuros:f,percentualJuros:E,documentoId:i.id,documentoTipo:"Fatura",parcela:va+"/"+qa,descricao:"Fatura de Venda Mercadoria",observacao:`${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:l.descricao,carne:l.tipo===5?1:0,dataEmissaoCarne:l.tipo===5?n:"",idDocumentoCaixa:g.id,idFinanceiroMovimentacaoAgrupamento:l.tipoFinanceiro==="T\xEDtulo Liquidado"?ea:"",descontoCondicionadoValor:xa>0?xa/100*w:0,descontoCondicionadoPercentual:xa}),s.idFinanceiroTitulo=b,l.tipo===2&&Pa.push({idTitulo:b,idDocumentoCondicaoPagamento:s.id,valor:w,dataVencimento:s.dataVencimento,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,formaPagamento:l})}if(l.tipoFinanceiro==="T\xEDtulo Liquidado"&&la>=0){O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:ea,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:aa.id,idFinanceiroTitulo:s.idFinanceiroTitulo,dataEmissao:n,valorCredito:s.valor,valorDebito:0,descricao:aa.descricao,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id});let b=l.idFinanceiroPlanoConta;l.tipo===1&&(g||{}).idFinanceiroPlanoContaCaixa&&(b=g.idFinanceiroPlanoContaCaixa);let w=await $db.financeiroPlanoConta.le({id:b}),P="";[3,4].includes(l.tipo)&&(P=(m=(a=(h=W[0])==null?void 0:h.observacao)==null?void 0:a.match(/Autorização\s(\d+)/))==null?void 0:m[1],P&&(P=` (Autoriza\xE7\xE3o ${P})`)),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:ea,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:w.id,idFinanceiroTitulo:s.idFinanceiroTitulo,dataEmissao:n,valorCredito:0,valorDebito:s.valor,descricao:w.descricao+P,observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id});for(const p of W)p.idFinanceiroMovimentacaoAgrupamento===ea&&(p.valorRealizado=p.valorARealizar,p.dataPagamento=s.dataVencimento,p.dataMovimento=s.dataVencimento,p.idDocumentoCaixaLiquidacao=g.id)}if(l.aliquota){const b=$utils.uuid(),w=$utils.arredondar(s.valor*(l.aliquota/100));if(W.push({id:b,idFinanceiroPlanoConta:l.idFinanceiroPlanoContaAliquota,idContato:l.idContatoOperadoraCartao,dataEmissao:n,dataCompetencia:c,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:w,valorTotal:w,valorARealizar:w,valorMulta:0,percentualJuros:0,documentoId:i.id,documentoTipo:"Fatura",parcela:va+"/"+qa,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${l.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${this.$refs.faturamento.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:l.descricao,idDocumentoCaixa:g.id}),s.idFinanceiroTituloPagar=b,l.tipoFinanceiro==="T\xEDtulo Liquidado"){const P=$utils.uuid();O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Da.id,dataEmissao:n,valorCredito:0,valorDebito:w,descricao:Da.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:b,idContato:l.idContatoOperadoraCartao,idDocumentoCaixa:g.id});let p=l.idFinanceiroPlanoConta;l.tipo===1&&(g||{}).idFinanceiroPlanoContaCaixa&&(p=g.idFinanceiroPlanoContaCaixa);let f=await $db.financeiroPlanoConta.le({id:p});O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:P,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:n,valorCredito:w,valorDebito:0,descricao:f.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:b,idContato:l.idContatoOperadoraCartao,idDocumentoCaixa:g.id});for(const E of W)E.id===b&&(E.idFinanceiroMovimentacaoAgrupamento=P,E.valorRealizado=w,E.dataPagamento=s.dataVencimento,E.dataMovimento=s.dataVencimento,E.idDocumentoCaixaLiquidacao=g.id)}}va++}}const Ba=[];for(const s of Pa){const l=$utils.uuid(),b=$utils.uuid();for(const P of W)P.id===s.idTitulo&&(P.idFinanceiroMovimentacaoAgrupamento=b,P.valorRealizado=P.valorARealizar,P.dataPagamento=n,P.dataMovimento=n,P.dataVencimento=n,P.dataVencimentoOriginal=n,P.idDocumentoCaixaLiquidacao=g.id);if(Ba.includes(s.idDocumentoCondicaoPagamento))continue;Ba.push(s.idDocumentoCondicaoPagamento);const w=$utils.arredondar(Pa.reduce((P,p)=>p.idDocumentoCondicaoPagamento===s.idDocumentoCondicaoPagamento?P+(p.valor||0):P,0));W.push({id:l,idFinanceiroPlanoConta:za.id,idContato:i.idContato,dataEmissao:n,dataCompetencia:c,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:w,valorTotal:w,valorARealizar:w,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:i.id,documentoTipo:"Fatura",idEmpresa:i.idEmpresa,formaDePagamento:s.formaPagamento.descricao,idDocumentoCaixa:g.id,cheque:1,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${i.id} - C\xF3digoN #${b}`,descricao:"Cheque"}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:b,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:za.id,idFinanceiroTitulo:l,dataEmissao:n,valorCredito:0,valorDebito:w,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,idFinanceiroCheque:l,idDocumentoCaixa:g.id,documentoId:i.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:b,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:aa.id,idFinanceiroTitulo:l,dataEmissao:n,valorCredito:w,valorDebito:0,descricao:aa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,idFinanceiroCheque:l,idDocumentoCaixa:g.id,documentoId:i.id})}if(oa>0){const s=$utils.uuid();O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:aa.id,dataEmissao:n,valorCredito:oa,valorDebito:0,descricao:aa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,idDocumentoCaixa:g.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:ca.id,dataEmissao:n,valorCredito:0,valorDebito:oa,descricao:ca.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Renegocia\xE7\xE3o",documentoId:s,idDocumentoCaixa:g.id});for(const l of Aa)Ra.push({idFinanceiroMovimentacaoN:s,idFinanceiroTitulo:l.idTitulo,dataVencimento:n,valorOriginal:l.valor,valorDesconto:l.desconto,valorTotal:$utils.arredondar(l.valor-l.desconto)});for(const l of j){if(l.idFinanceiroMovimentacaoAgrupamento=s,l.idDocumentoCaixaLiquidacao=g.id,l.dataPagamento=n,l.dataMovimento=n,l.renegociado=1,l.cheque===1){l.valorRealizado=l.valor;continue}if(!l.valorARealizar){l.valorRealizado=l.valorTotal;continue}l.valorRealizado=l.valorARealizar}W=W.concat(j)}if(ta===0){let s=$utils.uuid();const l=i.valorFrete||0;let b=0,w=0;const P=[];if(l>0&&(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:l,descricao:Z.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Oa.id,dataEmissao:n,valorCredito:l,valorDebito:0,descricao:Oa.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id})),!e){s=$utils.uuid();for(const p of u){let f="",E={},q="",z={},X="",ua={};const ma=await $db.item.leNew({id:p.idItem});if(f=p.idPlanoContaEstoque,!f){const G=await $db.perfilContabilItem.le({idPerfilContabil:ma.idPerfilContabil,idCfop:p.idCfop,and:{idPerfilContabil:ma.idPerfilContabil,idCfop:p.idCfop}});G.length&&G[0].idPlanoContaEstoque&&(f=G[0].idPlanoContaEstoque)}if(!f&&Na.id&&(f=Na.id),!f&&p.idCfop&&(f=(await $db.cfop.le({id:p.idCfop})).idPlanoContaEstoque),E=await $db.financeiroPlanoConta.le({id:f}),!E.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(q="",!q){const G=await $db.perfilContabilItem.le({idPerfilContabil:ma.idPerfilContabil,idCfop:p.idCfop,and:{idPerfilContabil:ma.idPerfilContabil,idCfop:p.idCfop}});G.length&&G[0].idPlanoContaDespesa&&(q=G[0].idPlanoContaDespesa)}if(!q&&wa.id&&(q=wa.id),!q&&p.idCfop&&(q=(await $db.cfop.le({id:p.idCfop})).idPlanoContaDestino),z=await $db.financeiroPlanoConta.le({id:q}),!z.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const _a=$utils.arredondar(p.total-(p.descontoTotalRateado||0)-(p.descontoFaturaRateado||0)),ha=$utils.arredondar(p.valorCustoMedio*p.quantidade);if(ha){if(p.operacaoFator<0?(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:E.id,dataEmissao:p.dataHoraFinalizado||n,valorCredito:ha,valorDebito:0,descricao:E.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${p.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:g.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:z.id,dataEmissao:p.dataHoraFinalizado||n,valorCredito:0,valorDebito:ha,descricao:z.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${p.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:g.id})):(O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:E.id,dataEmissao:p.dataHoraFinalizado||n,valorCredito:0,valorDebito:ha,descricao:E.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${p.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:g.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:z.id,dataEmissao:p.dataHoraFinalizado||n,valorCredito:ha,valorDebito:0,descricao:z.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${p.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:g.id})),X=p.idPlanoContaDestino,!X){const ia=await $db.perfilContabilItem.le({idPerfilContabil:ma.idPerfilContabil,idCfop:p.idCfop,and:{idPerfilContabil:ma.idPerfilContabil,idCfop:p.idCfop}});ia.length&&ia[0].idPlanoContaDespesa&&(X=ia[0].idPlanoContaDespesa)}if(!X&&wa.id&&(X=wa.id),!X&&p.idCfop&&(X=(await $db.cfop.le({id:p.idCfop})).idPlanoContaDestino),ua=await $db.financeiroPlanoConta.le({id:X}),!ua.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let G=!0;for(const ia of P)if(ia.idPlanoContaDestino===ua.id&&ia.idPlanoContaEstoque===E.id){ia.valor=$utils.arredondar(ia.valor+_a),G=!1;break}G&&P.push({idPlanoContaDestino:ua.id,idPlanoContaEstoque:E.id,valor:_a}),b+=_a}}for(const p of P)p.valor<0&&(w+=p.valor);for(const p of P)if(p.valor>0){const f=await $db.financeiroPlanoConta.le({id:p.idPlanoContaDestino}),E=$utils.arredondar(w*(p.valor/(b||1)));if(E>0){O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:E,descricao:Z.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:n,valorCredito:E,valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:n,dataMovimento:n,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id});for(const q of Y)O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:$utils.arredondar((p.valor-E)*(q.valor/(sa||1))),descricao:Z.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:n,valorCredito:$utils.arredondar((p.valor-E)*(q.valor/(sa||1))),valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id})}else for(const q of Y){const z=$utils.arredondar(p.valor*(q.valor/(sa||1)));O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Z.id,dataEmissao:n,valorCredito:0,valorDebito:z,descricao:Z.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id}),O.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:f.id,dataEmissao:n,valorCredito:z,valorDebito:0,descricao:f.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:c,dataVencimento:q.dataVencimento,dataMovimento:q.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:g.id})}}}}if(this.financeiroTitulo=W,this.financeiroMovimentacao=O,this.financeiroRenegociacao=Ra,this.fatura=i,this.vendas=I,this.documentosEnvelope=V,this.carnes=j,!e){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let l,b,w,P;if(l=await $db.configuracoes.porNome("integracao.bten.business"),b=(C=(k=l[0])==null?void 0:k.valor)!=null?C:!1,l=await $db.configuracoes.porNome("integracao.bten.authorization"),w=($=(F=l[0])==null?void 0:F.valor)!=null?$:!1,P=b&&w,P){const p=[],f=this.contatos[i.idContato],E=await $api.bten.send(f,i);for(let q=0;q<E.length;q++){const z=E[q];z.status?p.push(z.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${z.telefone}!`)}p.length&&this.$q.notifyPositive(`NPS enviado para ${p.join(",")}!`)}}catch(l){l.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${l.message}`),l.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",l)}let s;if(g!=null&&g.idCaixa){const l=await $erp().caixa.get(g==null?void 0:g.idCaixa);l!=null&&l.id&&(s=$db.caixa.tiposCaixa[Number(l.tipo)])}if([...I,...V].length&&~["SAT","NFCe"].indexOf(s))try{await this.$refs.documentosFiscais.emitirCupom(this.fatura.id)}catch{}if(this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"){const l=await $db.configuracoes.le({prefixoNome:"enviaemail.fatura"});let b=l.find(w=>w.idEmpresa===this.fatura.idEmpresa);b||(b=l.find(w=>!w.idEmpresa)),b&&await Jo.enviar(this.fatura,b)}}return!0}catch(i){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",i)}finally{this.$q.loading.hide()}}};const Ko={components:{DocumentoCodigo:no,DocumentoMetas:ro,DocumentosFiscais:mo,Faturamento:so,TituloCard:Qo,VendaCard:vo,EnvelopeCard:ho},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let e=!1;return e=this.fatura.status==="Aberta",e||(e=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!e}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0},vendas:[],vendasOriginal:[],documentosEnvelope:[],documentosEnvelopeOriginal:[],documentosItem:[],documentosItemOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],erroCalculo:!1,erroCalculoMsg:"",sistemaPai:"",impressaoVisivel:!1,configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[po],methods:{async calcularPesoTotal(){var m,k;const e=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),o=[],d={};let h=0,a=0;for(const C of e){const F=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:C.id}});for(const $ of F)o.push($)}for(const C of o)if(C.operacaoFator===-1){if(C.idItem&&!d[C.idItem]){const F=await $erp().item.get(C.idItem);F&&(d[C.idItem]=F)}h+=(((m=d[C.idItem])==null?void 0:m.peso)||0)*(C.quantidade||0),a+=(((k=d[C.idItem])==null?void 0:k.pesoBruto)||0)*(C.quantidade||0)}h=$utils.arredondar(h,4),a=$utils.arredondar(a,4),this.pesoTotal=h?$filters.numeroZerosDireita(h,4,2):null,this.pesoBrutoTotal=a?$filters.numeroZerosDireita(a,4,2):null},async calcularMetroCubicoTotal(){var a,m,k;const e=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),o=[],d={};let h=0;for(const C of e){const F=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:C.id}});for(const $ of F)o.push($)}for(const C of o){if(C.operacaoFator!==-1||C.tipoItem!=="Produto")continue;if(C.idItem&&!d[C.idItem]){const i=await $erp().item.get(C.idItem);i&&(d[C.idItem]=i)}const F=((a=d[C.idItem])==null?void 0:a.altura)*((m=d[C.idItem])==null?void 0:m.largura)*((k=d[C.idItem])==null?void 0:k.comprimento)||0,$=C.quantidade||0;h+=F>0?F*$:0}h=$utils.arredondar(h,4),this.metroCubicoTotal=h?$filters.numeroZerosDireita(h,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...Go,async atualizar(){let e=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.vendas=[],this.documentosEnvelope=[],this.documentosEnvelopeOriginal=[],this.documentosItem=[],this.documentosItemOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.prop.id){const o=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(o.fatura),this.fatura=o.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(o.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=o.condicaoPagamento),this.vendasOriginal=$utils.clonar(o.vendas),this.vendas=o.vendas.sort((a,m)=>new Date(a.dataHoraFinalizado)<new Date(m.dataHoraFinalizado)?-1:1);const d=o.documentosEnvelope.sort((a,m)=>new Date(a.dataHoraFinalizado)<new Date(m.dataHoraFinalizado)?-1:1);this.documentosEnvelopeOriginal=$utils.clonar(d),this.documentosEnvelope=$utils.clonar(d),this.receberTitulo.id&&!o.carnes.find(a=>a.id===this.receberTitulo.id)&&(o.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),e=!0),this.carnesOriginal=$utils.clonar(o.carnes),this.carnes=o.carnes.sort((a,m)=>new Date(a.dataVencimento)<new Date(m.dataVencimento)?-1:1);const h={};if(o.fatura.idContato){const a=o.fatura.idContato;h[a]||(h[a]=await $db.contato.le({id:a}))}this.configuraImpressaoCarne(o.fatura.idEmpresa),this.configuraImpressaoConvenio(o.fatura.idEmpresa),this.configuraImpressaoEnvelope(o.fatura.idEmpresa),this.configuraImpressaoFatura(o.fatura.idEmpresa),this.contatos=h,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal(),e&&await this.salvarFatura()}},async executar(e){if(e==="recalcular"){if(this.prop.id){const o=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(o.carnes),this.carnes=o.carnes,await this.calculaTotais()}}else e==="salvarFatura"?(await this.salvarFatura(),await this.atualizar(),this.$emit("executar","atualizarSemFechar")):(await this.atualizar(),this.$emit("executar",e))},async calculaTotais(e){const o=$utils.arredondar(this.vendas.reduce((a,m)=>a+m.totalDocumento||0,0)),d=$utils.arredondar(this.documentosEnvelope.reduce((a,m)=>a+m.totalDocumento||0,0)),h=$utils.arredondar(this.carnes.reduce((a,m)=>a+m.valorARealizar||0,0));if(e||(this.fatura.subTotal=$utils.arredondar(o+d+h),e="desconto"),e==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),e==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.fatura.totalDesconto!==0){const a=o+d;a===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),a>0&&this.fatura.totalDesconto>a&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")}this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0);try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async configuraImpressaoConvenio(e){const o=await $db.configuracoes.porNome("impressao.convenio",e);this.configImpressaoConvenio=[...o.length?o.map(d=>({texto:"Imprimir Conv\xEAnio",...d})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(e){const o=await $db.configuracoes.porNome("impressao.carne",e);this.configImpressaoCarne=[...o.length?o.map(d=>({texto:"Imprimir Carn\xEA",...d})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(e){const o=await $db.configuracoes.porNome("impressao.envelope",e);this.configImpressaoEnvelope=[...o.length?o.map(d=>({texto:"Imprimir Envelope",...d})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(e){const o=await $db.configuracoes.porNome("impressao.fatura",e),d=[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"}];this.sistemaPai==="optisoul"&&d.push({valor:"termoGarantia",texto:"Termo de Garantia"}),this.configImpressaoFatura=[...o.length?o.map(h=>({texto:"Imprimir Fatura",...h})):d]},async reabrir(e){var o;if(!((o=this.fatura)!=null&&o.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!e)try{$q.loading.show(),await lo({idDocumento:this.fatura.id})}catch(d){this.$q.notifyError(d.message);return}finally{$q.loading.hide()}if(!e)try{await new Promise((d,h)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{d()}).onCancel(()=>{h()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const d=$utils.clonar(this.fatura),h=$utils.clonar(this.vendas),a=$utils.clonar(this.documentosEnvelope),m=$utils.clonar(this.documentosItem),k=this.$refs.faturamento.condicaoPagamento.filter(i=>i.valor);if(!e){const i=[];k.reduce((I,V)=>(V.idDocumentoCaixa&&!I[V.idDocumentoCaixa]&&(I[V.idDocumentoCaixa]=!0,i.push($db.hibrido.le({table:"documento",id:V.idDocumentoCaixa}))),I),{});for await(const I of i)if(I.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(i){$q.notifyError(i.message);return}let C=[],F=[],$=[];if(!e){C=await $db.financeiroTitulo.le({documentoId:d.id});for(const n of C)if(n.idFinanceiroBoleto){const c=await $erp().financeiroBoleto.get(n.idFinanceiroBoleto),g=await $db.financeiroBanco.le({id:c.idFinanceiroBanco}),S=await $db.banco.le({id:g.idBanco}),Y=c.revisao,oa=S.baixa,$a=S.registro;if(c.remessaOperacao!==oa){const ta=n.idFinanceiroBoleto,na=$utils.uuid(),Fa={id:na,idFinanceiroBanco:c.idFinanceiroBanco,nossoNumero:c.nossoNumero,nossoNumeroDv:c.nossoNumeroDv,revisao:Y+1,idEmpresa:c.idEmpresa,idContato:c.idContato,empresaNome:c.empresaNome,empresaNumeroDocumento:c.empresaNumeroDocumento,contatoNome:c.contatoNome,contatoNumeroDocumento:c.contatoNumeroDocumento,contatoLogradouro:c.contatoLogradouro,contatoCEP:c.contatoCEP,contatoBairro:c.contatoBairro,contatoCidade:c.contatoCidade,contatoUF:c.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:c.dataVencimento,dataImpressao:c.dataImpressao,valor:c.valor,valorJuros:c.valorJuros,tipoJuros:c.tipoJuros,valorMulta:c.valorMulta,valorDesconto:c.valorDesconto,valorTotal:c.valorTotal,codigoBarras:c.codigoBarras,linhaDigitavel:c.linhaDigitavel,mensagem1:c.mensagem1,mensagem2:c.mensagem2,mensagem3:c.mensagem3,mensagem4:c.mensagem4,mensagem5:c.mensagem5,gerarRemessa:1,remessaOperacao:oa};await $db.financeiroBoleto.grava({atual:Fa});let ca=[];ta&&(ca=await $db.financeiroTitulo.le({idFinanceiroBoleto:ta}));for(const ra of ca){const aa=$utils.clonar(ra);ra.idFinanceiroBoleto=na;let Ea=[];ta&&(Ea=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:ta}));for(const Da of Ea){const Ta={id:$utils.uuid(),idFinanceiroBoleto:na,idFinanceiroTitulo:Da.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:Ta})}await $db.financeiroTitulo.grava({atual:ra,original:aa})}if(c.remessaOperacao===$a&&c.gerarRemessa===1)for(const ra of[c,Fa]){const aa={...ra,gerarRemessa:0};await $db.financeiroBoleto.grava({original:ra,atual:aa})}}}let i=[];this.$refs.faturamento.idDocumentoCaixa&&(i=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),C=await $db.financeiroTitulo.le({idFatura:d.id});let I=await $db.financeiroTitulo.le({idFatura:d.id});for(const n of $utils.clonar(C)){if(!n.idFinanceiroMovimentacaoAgrupamento)continue;const c=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:n.idFinanceiroMovimentacaoAgrupamento});for(const g of c){const S=await $db.financeiroTitulo.le({id:g.idFinanceiroTitulo});S.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(C=C.concat(S))}}let V=!1;for(const n of k){const c=await $db.financeiroTitulo.le({id:n.idFinanceiroTitulo});if(Object.keys(c).length){let g=[];g=i.filter(S=>S.idFinanceiroMovimentacaoN===c.idFinanceiroMovimentacaoAgrupamento),F=F.concat(g),g=i.filter(S=>S.idFinanceiroTitulo===c.id),F=F.concat(g),g=i.filter(S=>S.idFinanceiroCheque===c.id),F=F.concat(g),C=C.concat(c)}n.idFinanceiroTitulo="",n.sinal===1&&(V=!0)}I=await $db.financeiroTitulo.le({idFatura:d.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const n of I){if(!n.idFinanceiroMovimentacaoAgrupamento)continue;const c=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:n.idFinanceiroMovimentacaoAgrupamento});F=F.concat(c);const g=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:n.idFinanceiroMovimentacaoAgrupamento});$=$.concat(g)}if(I=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:d.id}),C=C.concat(I),d.id){let n=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:d.id});F=F.concat(n),n=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:d.id}),F=F.concat(n),n=await $db.financeiroMovimentacao.lerV2({documentoId:d.id});for(const c of n)(await $db.financeiroTitulo.le({id:c.idFinanceiroTitulo})).id||(F=F.concat(c))}const j=await $db.hibrido.lista({table:"documento",where:{idFatura:d.id}});for(const n of j){const c=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:n.id});F=F.concat(c)}let A=[];for(const n in C){const c=C[n].id;A.includes(c)?delete C[n]:A.push(c)}C=C.filter(n=>n),A=[];for(const n in F){const c=F[n].id;A.includes(c)?delete F[n]:A.push(c)}F=F.filter(n=>n),A=[];for(const n in $){const c=$[n].id;A.includes(c)?delete $[n]:A.push(c)}$=$.filter(n=>n);let K=$utils.dataAtual(),u=V?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:d.id,operacao:"Fatura",statusOriginal:d.status,statusFinalizado:u,dataHoraEmissao:K,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],d.status=u,u==="Aberta"&&(d.dataHoraFinalizado=""),u=V?"Aguardando Pagamento":"Aguardando Faturamento";for(const n of h)this.documentoStatus.push({id:$utils.uuid(),idDocumento:n.id,operacao:"Venda de Mercadoria",statusOriginal:n.status,statusFinalizado:u,dataHoraEmissao:K,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),n.status=u;for(const n of a)this.documentoStatus.push({id:$utils.uuid(),idDocumento:n.id,operacao:"Envelope",statusOriginal:n.status,statusFinalizado:n.status,dataHoraEmissao:K,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const n of m)n.status=u;this.fatura=d,this.vendas=h,this.documentosEnvelope=a,this.documentosItem=m}if(this.$q.loading.hide(),e&&await this.finalizar(e),this.$q.loading.show({message:"Processando..."}),e){let i=[],I=[],V=[],j=[],A=[],K=[];i=this.$refs.faturamento.condicaoPagamento.map(u=>u.id),I=this.$refs.faturamento.condicaoPagamentoOriginal.filter(u=>!i.includes(u.id));for(const u of I)if(u.idFinanceiroTitulo&&V.push(u.idFinanceiroTitulo),u.idFormaPagamento){let n;n=await $erp().formaPagamento.get(u.idFormaPagamento),(n||{}).aliquota&&(u.idFinanceiroTituloPagar?V.push(u.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const u of V){let n;if(n=await $erp().financeiroTitulo.get(u),n.id&&j.push(n),n.idFinanceiroMovimentacaoAgrupamento){let c,g;if(c=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:n.idFinanceiroMovimentacaoAgrupamento}}),g=(c.find(S=>S.idFinanceiroCheque)||{}).idFinanceiroCheque,g){let S=await $erp().financeiroTitulo.get(g);S.id&&j.push(S)}A.push(...c)}}for(let u of this.carnes){if(!u.id||(u=await $erp().financeiroTitulo.get(u.id),!(u||{}).idFinanceiroMovimentacaoAgrupamento))continue;let n,c;n=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:u.idFinanceiroMovimentacaoAgrupamento}}),c=await $db.hibrido.lista({table:"financeiroRenegociacao",where:{idFinanceiroMovimentacaoN:u.idFinanceiroMovimentacaoAgrupamento}}),A.push(...n),K.push(...c)}await $db.financeiroTitulo.remove(j),await $db.financeiroMovimentacao.remove(A),await $db.financeiroRenegociacao.remove(K)}else{await $db.financeiroTitulo.remove(C.filter(i=>!(i.carne&&i.idFatura===d.id))),await $db.financeiroMovimentacao.remove(F),await $db.financeiroRenegociacao.remove($);for(const i of C.filter(I=>I.carne&&I.idFatura===d.id))await $db.financeiroTitulo.grava({original:i,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}return await this.salvarFatura(),await this.atualizar(),e?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let e,o,d,h;if(e=this.$refs.faturamento.condicaoPagamentoOriginal,o=this.$refs.faturamento.condicaoPagamento,h=$utils.arredondar(this.fatura.totalDocumento||0),d=$utils.arredondar(o.reduce((a,m)=>a+m.valor||0,0)),d!==h){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(e.length){let a=!1;o.length||(a=!0);for(const m of o)if(!e.find(k=>k.id===m.id)){a=!0;break}if(!a){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((a,m)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{a()}).onCancel(()=>{m()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){try{this.$q.loading.show({message:"Processando..."});let e=$utils.clonar(this.$refs.faturamento.condicaoPagamento.filter(d=>d.valor));for(let d in e)delete e[d].idDocumentoCondicaoPagamento,delete e[d].parcelas,delete e[d].formaPagamento,delete e[d].edicao,delete e[d].codigoDocumento,delete e[d].codigoDocumentoCaixa;const o=(this.carnesOriginal||[]).filter(d=>(this.financeiroTitulo||[]).find(h=>h.id===d.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,documentosEnvelope:this.documentosEnvelope,documentosEnvelopeOriginal:this.documentosEnvelopeOriginal,documentosItemOriginal:this.documentosItemOriginal,documentosItem:this.documentosItem,condicaoPagamentoOriginal:this.$refs.faturamento.condicaoPagamentoOriginal,condicaoPagamento:e,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:o,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id){let d=this.carnes.find(h=>h.id===this.receberTitulo.id);d.id&&await $db.financeiroTitulo.grava({original:d,atual:{idFatura:this.fatura.id}})}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async dialogImpressao(){if(this.carnes.length>0&&(this.fatura.status==="Finalizada"||this.fatura.status!=="Aguardando Pagamento"&&this.fatura.dataHoraFinalizado))return this.impressaoVisivel=!0,new Promise(e=>{this.resolveDialogImpressao=e})},fecharDialogImpressao(){this.impressaoVisivel=!1,this.resolveDialogImpressao()}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},Zo={class:"Fatura round-borders bg-grey-2 q-pb-sm"},Wo={class:"row items-center"},Xo={class:"col q-ma-sm q-title"},Yo={class:"bg-grey-2"},at={class:"q-ma-sm"},ot={key:0,class:"q-item-label",style:{color:"#0c0c0c"}},tt={key:1,class:"q-item-label q-mt-md",style:{color:"#0c0c0c"}},et={class:"col-12 col-md-4 border-1 q-ma-md"},it={class:"col-8 text-right"},nt={class:"col-3"},rt={class:"col-5"},st={class:"col-8 q-mt-sm text-right"},lt={class:"col-8 q-mt-sm text-right"},dt={class:"col-8 q-mt-sm text-right"},ct={class:"col-8 q-mt-sm text-right"},ut={class:"Fatura-faturamento round-borders q-ma-sm q-pa-md"},mt={class:"round-borders q-ma-sm q-pa-md"};function ft(e,o,d,h,a,m){const k=Q("avatar"),C=Q("documento-codigo"),F=Q("documento-metas"),$=Q("VendaCard"),i=Q("EnvelopeCard"),I=Q("titulo-card"),V=Q("row"),j=Q("campo"),A=Q("faturamento"),K=Q("documentos-fiscais");return v(),N(L,null,[D("div",Zo,[t(da,{class:"Fatura-barra bg-grey-2 q-py-md",color:"black",dark:""},{default:r(()=>[t(pa,null,{default:r(()=>[D("div",Wo,[t(k,{imagem:(a.contatos[a.fatura.idContato]||{}).imagem,rotulo:a.fatura.descricaoContato,tamanho:"60"},null,8,["imagem","rotulo"]),D("div",Xo,y(a.fatura.descricaoContato),1)])]),_:1}),a.fatura.id?(v(),T(C,{key:0,documento:a.fatura,class:"q-mx-sm"},null,8,["documento"])):x("",!0),a.fatura.status==="Finalizada"||a.fatura.status!=="Aguardando Pagamento"&&a.fatura.dataHoraFinalizado?(v(),T(B,{key:1,icon:"print",size:"md",color:"primary",round:"",flat:""},{default:r(()=>[t(ya,null,{default:r(()=>[ga((v(),T(Ca,{link:"",separator:""},{default:r(()=>[(v(!0),N(L,null,J(a.configImpressaoFatura,u=>(v(),T(H,{clickable:"",key:u.valor,onClick:n=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(v(!0),N(L,{key:0},J(a.configImpressaoEnvelope,u=>(v(),T(H,{clickable:"",key:u.valor,onClick:n=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):x("",!0),(v(!0),N(L,null,J(a.configImpressaoCarne,u=>(v(),T(H,{clickable:"",key:u.valor,onClick:n=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(v(!0),N(L,null,J(a.configImpressaoConvenio,u=>(v(),T(H,{clickable:"",key:u.valor,onClick:n=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[ba]])]),_:1})]),_:1})):x("",!0),t(B,{icon:"more_vert",size:"md",color:"tertiary",flat:"",round:""},{default:r(()=>[t(ya,null,{default:r(()=>[t(Ca,{link:"",separator:""},{default:r(()=>[a.fatura.id?(v(),T(H,{key:0,clickable:"",onClick:o[0]||(o[0]=u=>e.$refs.documentosFiscais.emitirCupom(a.fatura.id))},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"account_balance"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>o[9]||(o[9]=[M("Emitir cupom")])),_:1})]),_:1})]),_:1})):x("",!0),a.fatura.id&&e.$utils.mapearStatus(a.fatura).permiteNota?(v(),N(L,{key:1},[t(H,{clickable:"",onClick:o[1]||(o[1]=u=>e.emitirNFeV2({idFatura:a.fatura.id},1,"Venda"))},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"account_balance"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>o[10]||(o[10]=[M("NFe de Sa\xEDda/Venda")])),_:1})]),_:1})]),_:1}),t(H,{clickable:"",onClick:o[2]||(o[2]=u=>e.emitirNFeV2({idFatura:a.fatura.id},0,"Devolu\xE7\xE3o"))},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"account_balance"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>o[11]||(o[11]=[M("NFe de Entrada/Devolu\xE7\xE3o")])),_:1})]),_:1})]),_:1}),t(H,{clickable:"",onClick:o[3]||(o[3]=u=>e.emitirNFeV2({idFatura:a.fatura.id},1,"Remessa"))},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"account_balance"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>o[12]||(o[12]=[M("NFe de Remessa")])),_:1})]),_:1})]),_:1})],64)):x("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),D("div",Yo,[t(F,{ref:"documentoMetas"},null,512)]),D("div",at,[a.vendas.length>0?(v(),N("p",ot,[t(R,{name:"shopping_cart",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),o[13]||(o[13]=M(" Vendas "))])):x("",!0),(v(!0),N(L,null,J(a.vendas,u=>(v(),N("div",{key:u.id,class:"bg-white q-mt-sm round-borders"},[t($,{id:u.id,onAtualizar:m.atualizar,onExecutar:m.executar},null,8,["id","onAtualizar","onExecutar"])]))),128)),(v(!0),N(L,null,J(a.documentosEnvelope,u=>(v(),N("div",{key:u.id,class:"bg-white q-mt-sm round-borders"},[t(i,{id:u.id,onExecutar:m.executar},null,8,["id","onExecutar"])]))),128)),a.carnes.length>0?(v(),N("p",tt,[t(R,{name:"attach_money",class:"q-mr-md",size:"24px",style:{color:"#737373"}}),o[14]||(o[14]=M(" Carn\xEAs "))])):x("",!0),(v(!0),N(L,null,J(a.carnes,u=>(v(),N("div",{key:u.id,class:"bg-white q-mt-sm round-borders"},[t(I,{dados:u,class:"q-mt-md",onExecutar:m.executar},null,8,["dados","onExecutar"])]))),128))]),t(V,{class:"justify-end"},{default:r(()=>[D("div",et,[t(V,{class:"q-col-gutter-md q-mb-sm"},{default:r(()=>[o[15]||(o[15]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Subtotal",-1)),D("strong",it,y(e.$filters.numero(a.fatura.subTotal,2)),1)]),_:1}),a.permissaoDesconto?(v(),T(V,{key:0,class:"q-col-gutter-x-sm"},{default:r(()=>[o[16]||(o[16]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"50px"}},"Desconto",-1)),D("div",nt,[t(j,{modelValue:a.fatura.totalPercentualDesconto,"onUpdate:modelValue":[o[4]||(o[4]=u=>a.fatura.totalPercentualDesconto=u),o[5]||(o[5]=u=>m.calculaTotais("descontoPercentual"))],tipo:"decimal",decimals:"2",suffix:"%","somente-leitura":m.descontoSomenteLeitura,error:a.erroCalculo},null,8,["modelValue","somente-leitura","error"])]),D("div",rt,[t(j,{modelValue:a.fatura.totalDesconto,"onUpdate:modelValue":[o[6]||(o[6]=u=>a.fatura.totalDesconto=u),o[7]||(o[7]=u=>m.calculaTotais("desconto"))],tipo:"decimal",decimals:"2","somente-leitura":m.descontoSomenteLeitura,error:a.erroCalculo,errorMessage:a.erroCalculoMsg},null,8,["modelValue","somente-leitura","error","errorMessage"])])]),_:1})):x("",!0),t(V,{class:"q-col-gutter-x-sm q-mt-sm"},{default:r(()=>[o[17]||(o[17]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Total",-1)),D("strong",st,y(e.$filters.numero(a.fatura.totalDocumento,2)),1)]),_:1}),a.pesoTotal?(v(),T(V,{key:1,class:"q-col-gutter-x-sm q-mt-sm"},{default:r(()=>[o[18]||(o[18]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Total",-1)),D("span",lt,y(a.pesoTotal),1)]),_:1})):x("",!0),a.pesoBrutoTotal?(v(),T(V,{key:2,class:"q-col-gutter-x-sm q-mt-sm"},{default:r(()=>[o[19]||(o[19]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Peso Bruto Total",-1)),D("span",dt,y(a.pesoBrutoTotal),1)]),_:1})):x("",!0),a.metroCubicoTotal?(v(),T(V,{key:3,class:"q-col-gutter-x-sm q-mt-sm"},{default:r(()=>[o[20]||(o[20]=D("div",{class:"col-4 col-lg-3",style:{"line-height":"35px"}},"Metro C\xFAbico Total",-1)),D("span",ct,y(a.metroCubicoTotal),1)]),_:1})):x("",!0)])]),_:1}),D("div",ut,[t(A,{documento:a.fatura,ref:"faturamento",onExecutar:m.executar,onSalvarFatura:m.salvarFatura},null,8,["documento","onExecutar","onSalvarFatura"])]),D("div",mt,[t(K,{ref:"documentosFiscais",idFatura:a.fatura.id},null,8,["idFatura"])])]),t(Ia,{modelValue:a.impressaoVisivel,"onUpdate:modelValue":o[8]||(o[8]=u=>a.impressaoVisivel=u),onKeyup:Va(m.fecharDialogImpressao,["esc"]),persistent:""},{default:r(()=>[t(ja,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"350px","max-width":"400px"}},{default:r(()=>[t(Ha,null,{default:r(()=>[t(da,null,{default:r(()=>[t(B,{icon:"arrow_back",flat:"",round:"",dense:"",onClick:m.fecharDialogImpressao},null,8,["onClick"]),t(pa,null,{default:r(()=>o[21]||(o[21]=[M("Imprimir")])),_:1})]),_:1})]),_:1}),t(Ua,null,{default:r(()=>[t(Qa,null,{default:r(()=>[t(Ca,{link:"",separator:""},{default:r(()=>[(v(!0),N(L,null,J(a.configImpressaoFatura,u=>(v(),T(H,{clickable:"",key:u.valor,onClick:n=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a.sistemaPai==="optisoul"?(v(!0),N(L,{key:0},J(a.configImpressaoEnvelope,u=>(v(),T(H,{clickable:"",key:u.valor,onClick:n=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):x("",!0),(v(!0),N(L,null,J(a.configImpressaoCarne,u=>(v(),T(H,{clickable:"",key:u.valor,onClick:n=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(v(!0),N(L,null,J(a.configImpressaoConvenio,u=>(v(),T(H,{clickable:"",key:u.valor,onClick:n=>e.$imprimir(u.valor,(a.fatura||{}).id||"0")},{default:r(()=>[t(_,{avatar:""},{default:r(()=>[t(R,{name:"print"})]),_:1}),t(_,null,{default:r(()=>[t(U,null,{default:r(()=>[M(y(u.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])],64)}var pt=ka(Ko,[["render",ft]]);const vt={components:{CpfCnpjNoCupom:fo,Fatura:pt},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let e;try{e=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let o=await $db.hibrido.le({table:"documento",id:this.id});this.fatura=o,await this.verificarPermissoes(),this.desativarBotoes(),o.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),o.status==="Finalizada"||o.status!=="Aguardando Pagamento"&&o.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(o.idContato,$q.notify)}finally{clearTimeout(e),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(e){e.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizar(e){const d={cpfCnpjNoCupom:this.cpfCnpjNoCupom};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(!1,d)){this.lockEsc=!1;return}await this.$refs.fatura.atualizar(),await this.atualizar(),await this.$refs.fatura.dialogImpressao(),this.$emit("executar","finalizar"),this.fechar()},async executar(e){switch(e){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}if(e==="atualizarSemFechar"){await this.atualizar(),this.runOnHide.push(()=>this.$emit("executar","atualizar"));return}this.$emit("executar",e),this.fechar()},fechar(){this.visivel=!1},async mostrar(e={}){this.id=e.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(e=>e()),this.runOnHide=[]},async salvar(){try{await new Promise((e,o)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{o()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria")}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}};function ht(e,o,d,h,a,m){const k=Q("fatura"),C=Q("CpfCnpjNoCupom");return v(),N("div",null,[t(Ia,{modelValue:a.visivel,"onUpdate:modelValue":o[0]||(o[0]=F=>a.visivel=F),onKeyup:Va(m.voltar,["esc"]),onHide:m.onHide,maximized:"",persistent:""},{default:r(()=>[t(ja,{view:"hHh LpR fFf",container:"",class:"bg-grey-4"},{default:r(()=>[t(Ha,null,{default:r(()=>[t(da,null,{default:r(()=>[ga(t(B,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[ba]]),t(pa,null,{default:r(()=>o[3]||(o[3]=[M("Fatura")])),_:1}),a.visibilidade.botao.salvar?(v(),T(B,{key:0,onClick:m.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):x("",!0),a.visibilidade.botao.reabrir&&a.temPermissaoCorrigir?(v(),T(B,{key:1,onClick:m.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):x("",!0)]),_:1})]),_:1}),t(Ua,null,{default:r(()=>[t(Qa,{class:"u-container q-py-md"},{default:r(()=>[a.fatura.id?(v(),T(k,{key:0,onExecutar:m.executar,prop:{id:a.fatura.id},receberTitulo:d.receberTitulo,ref:"fatura"},null,8,["onExecutar","prop","receberTitulo"])):x("",!0)]),_:1})]),_:1}),t(co,{class:"bg-light",bordered:""},{default:r(()=>[t(da,{class:"q-pa-sm u-container"},{default:r(()=>[t(uo),a.visibilidade.botao.reabrir?(v(),T(B,{key:0,onClick:m.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):x("",!0),a.visibilidade.botao.reabrir?ga((v(),T(B,{key:1,label:"Fechar",color:"tertiary",flat:"",class:"q-ml-sm"},null,512)),[[ba]]):x("",!0),a.visibilidade.botao.reabrir?x("",!0):(v(),T(B,{key:2,onClick:m.finalizar,disabled:!a.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),t(C,{modelValue:a.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":o[1]||(o[1]=F=>a.cpfCnpjNoCupom.visivel=F),onConfirmar:o[2]||(o[2]=F=>m.finalizar()),dados:a.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var Et=ka(vt,[["render",ht]]);export{Et as F,Qo as T};
