import{_ as Ia,r as J,o as c,p as O,f as a,bJ as ro,w as t,d as b,e as P,k as C,t as z,l as ya,Q as Z,m as no,s as lo,bf as Ma,H as ea,P as fa,F as L,x as H,S as G,T as I,j as Q,N as ia,q as so,A as uo,M as za,E as co,G as Ba,h as Ta,i as Na,I as Aa,J as Oa,K as Wa,br as Ra,D as Sa,cN as mo,cO as fo,cP as po,cQ as vo,U as K,C as wa,B as Va,aU as ho}from"./index.79e95fd1.js";import{D as go,C as bo}from"./DocumentosFiscais.ab7ff4cd.js";import{V as Co}from"./VendaCard.bd66a145.js";import{E as Fo}from"./EnvelopeCard.58fef056.js";import{e as Do}from"./emitirNFe.35117289.js";const $o={computed:{mostrarMenuTresPontos(){return this.mostrarOpcaoMigrarFatura}},data(){return{width:0,tituloOriginal:{},titulo:{},detalhes:!1,contatos:{},documento:{},fatura:{},faturasAbertas:[],mostrarOpcaoMigrarFatura:!1,visibilidade:{botao:{remover:!1,editar:!1}},modalEditar:{visivel:!1,campos:{valorMulta:0},rules:[]},tema:["TituloCard","bg-white","rounded-borders"]}},emits:["executar"],methods:{irParaAtendimentoFatura(r){this.$router.push({name:"AtendimentoFatura",params:{id:r}})},async migrarFatura(r){try{await new Promise((e,d)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 migrar esta venda para outra fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{e()}).onCancel(()=>{d()})})}catch{return}if(!r&&this.titulo.idContato&&this.titulo.idEmpresa){const e=await $erp().contato.get(this.titulo.idContato)||{};let d=await $erp().contatoEndereco.where({idContato:this.titulo.idContato}).toArray(),F=await $erp().contatoTelefone.where({idContato:this.titulo.idContato}).toArray();d=d.find(B=>(B.grupo||"").trim().toLowerCase()==="Principal")||d[0]||{},F=F.find(B=>(B.tipoTelefone||"").trim().toLowerCase()==="Principal")||F[0]||{};const o=await $erp().contato.get(this.titulo.idEmpresa)||{};let m=await $erp().contatoEndereco.where({idContato:this.titulo.idEmpresa}).toArray();m=m.find(B=>B.grupo.trim().toLowerCase()==="Principal")||m[0]||{},r=$db.fatura.criar({idEmpresa:o.id,idEmpresaEndereco:m.id||"",descricaoEmpresa:o.nome||"",numeroDocumentoEmpresa:o.numeroDocumentoNacional||"",inscricaoMunicipalEmpresa:o.numeroDocumentoMunicipal||"",optanteSimplesNacional:o.regime==="SimplesNacional"?"1":"0",idContato:e.id,idContatoEndereco:d.id||"",numeroDocumentoContato:e.numeroDocumentoNacional||"",descricaoContato:e.nome||"",descricaoContatoEndereco:"".concat(d.logradouro||"",", ",d.numero||""," ",d.complemento||""," - ",d.bairro||""," - ",d.cep||""," - ",d.municipio||"","/",d.uf||""),telefoneContato:F.telefone||"",emailContato:e.email||"",regimeContato:e.regime||"",observacaoFaturamento:""}),await $db.fatura.grava({fatura:r})}r.id?(await $db.financeiroTitulo.grava({atual:{id:this.titulo.id,idFatura:r.id},original:this.titulo}),localStorage.setItem("idFatura",r.id),this.titulo.idContato&&(this.$emit("executar","atualizar"),this.irParaAtendimentoFatura(this.titulo.idContato))):this.$q.notify("N\xE3o foi poss\xEDvel realizar a opera\xE7\xE3o")},async salvar(){if(this.titulo.valorDesconto===this.tituloOriginal.valorDesconto){this.modalEditar.visivel=!1;return}try{await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.tituloOriginal=$utils.clonar(this.titulo),this.modalEditar.visivel=!1,this.$q.notifyPositive("T\xEDtulo salvo."),this.$emit("executar","recalcular")}catch{this.$q.notifyPositive("N\xE3o foi poss\xEDvel salvar o t\xEDtulo. Por favor, tente novamente.")}},editar(){const r=Number(this.titulo.diasEmAtraso)||0;let e=0;r>0&&(e=Number(this.titulo.valorMulta)||0),this.modalEditar={visivel:!0,campos:{valorMulta:e},rules:[]}},async permissaoEditar(){return await $db.permissao.objeto("Diretiva_Caixa_DescontoTitulo")},cancelarDesconto(){this.titulo=$utils.clonar(this.tituloOriginal),this.modalEditar.visivel=!1},async desconto(){const r=this.titulo.valorDesconto;let e=0,d=0,F=0,o=Number(this.titulo.diasEmAtraso)||0;const m=Number(this.titulo.valor)||0;if(o<0&&(o=0),o>0&&(d=Number(this.titulo.valorMulta)||0,e=Number(this.titulo.valorJuros)||0,F=$utils.arredondar(d+e*o)),await $db.permissao.objeto("PadraoNovo_Financeiro")&&(F=$utils.arredondar(m+d+e*o)),r<0||r>F){this.modalEditar.rules=[()=>"Desconto n\xE3o permitido"];return}this.modalEditar.rules=[()=>!0];const l=$utils.arredondar(m-r+d+e*o),f=$utils.arredondar(r*100/(m||1));this.titulo.valorTotal=l,this.titulo.valorARealizar=l,this.titulo.percentualDesconto=f},alternarDetalhes(){this.detalhes=!this.detalhes},async remover(){try{await new Promise((r,e)=>{this.$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 remover este t\xEDtulo da fatura.",noRefocus:!0,preventClose:!0,title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-negative",textColor:"white",flat:!0}}).onOk(()=>{r()}).onCancel(()=>{e()})})}catch{return}this.titulo.idFatura="",await $db.financeiroTitulo.grava({atual:this.titulo,original:this.tituloOriginal}),this.visibilidade.botao.remover=!1,this.$q.notifyPositive("T\xEDtulo removido da fatura."),this.$emit("executar","remover")},onResize(){this.width=window.innerWidth}},props:{dados:{required:!0,type:Object}},async mounted(){const r=new Date(this.dados.dataVencimento).setHours(0,0,0,0),e=new Date().setHours(0,0,0,0);r<e?this.tema.push("vencido"):this.tema=$lodash.remove(this.tema,F=>F!=="vencido"),this.tituloOriginal=$utils.clonar(this.dados),this.titulo=$utils.clonar(this.dados),this.titulo.documentoId&&(this.documento=await $db.hibrido.le({table:"documento",id:this.titulo.documentoId})),this.visibilidade.botao.remover=!1,this.permissaoEditar().then(F=>this.visibilidade.botao.editar=F&&!this.tituloOriginal.valorRealizado),this.contatos={};const d={};if(this.titulo.idContato){const F=await $db.contato.le({id:this.titulo.idContato});F&&(d[this.titulo.idContato]=F)}if(this.titulo.idEmpresa){const F=await $db.contato.le({id:this.titulo.idEmpresa});F&&(d[this.titulo.idEmpresa]=F)}this.contatos=d,this.mostrarOpcaoMigrarFatura=!0,this.titulo.idFatura&&$db.fatura.leV2({id:this.titulo.idFatura}).then(F=>{this.fatura=F,F.status==="Aberta"&&$db.contato.ler({filtros:{ativo:!0,empresas:!0}}).then(o=>{o.data.find(B=>B.id===this.titulo.idEmpresa)&&(this.visibilidade.botao.remover=!0)})})}},Eo={id:"TituloCard"};function wo(r,e,d,F,o,m){const B=J("BadgeCopiarUid"),l=J("badge"),f=J("g-col"),j=J("avatar"),v=J("g-label"),N=J("g-row"),R=J("campo");return c(),O("div",Eo,[a(ro,{onResize:m.onResize},null,8,["onResize"]),a(uo,{class:so(["extratoItem bg-white no-shadow",o.tema])},{default:t(()=>[a(N,{gutter:"sm",items:"center",justify:"between"},{default:t(()=>[a(f,{col:"12",text:"right",class:"hideondesktop"},{default:t(()=>{var y,i,w,T,h,p;return[a(B,{numero:(y=o.titulo)==null?void 0:y.documentoCodigo,id:(i=o.titulo)==null?void 0:i.id,escuro:"",icone:"mdi-file-document",cor:"positive",class:"q-mr-xs"},null,8,["numero","id"]),o.titulo.parcela?(c(),b(l,{key:0,rotulo:o.titulo.parcela,escuro:"",cor:"tertiary",class:"q-mr-xs"},null,8,["rotulo"])):P("",!0),(w=o.titulo)!=null&&w.documentoCodigo?(c(),b(B,{key:1,numero:(T=o.documento)==null?void 0:T.numero,escuro:"",id:(h=o.documento)==null?void 0:h.id,dica:(p=o.titulo)==null?void 0:p.documentoTipo,cor:"tertiary",class:"q-mr-xs"},null,8,["numero","id","dica"])):P("",!0)]}),_:1}),a(f,{col:"12 sm5"},{default:t(()=>[a(N,{items:"center"},{default:t(()=>[a(f,{col:"shrink",self:o.width<=992?"top":"center"},{default:t(()=>{var y,i;return[a(j,{imagem:(y=o.contatos[o.titulo.idContato])==null?void 0:y.imagem,rotulo:(i=o.contatos[o.titulo.idContato])==null?void 0:i.apelido,tamanho:"40"},null,8,["imagem","rotulo"])]}),_:1},8,["self"]),a(f,null,{default:t(()=>[a(v,{text:"body1 medium"},{default:t(()=>{var y;return[C(z((y=o.contatos[o.titulo.idContato])==null?void 0:y.apelido)+" ",1),a(v,{caption:""},{default:t(()=>{var i;return[C(z((i=o.contatos[o.titulo.idContato])==null?void 0:i.nome),1)]}),_:1})]}),_:1})]),_:1})]),_:1})]),_:1}),a(f,{col:"sm3",class:"hideonmobile"},{default:t(()=>{var y,i,w,T,h,p,n,$;return[a(B,{numero:(y=o.titulo)==null?void 0:y.documentoCodigo,id:(i=o.titulo)==null?void 0:i.id,escuro:"",icone:"mdi-file-document",cor:"positive",class:"q-mr-xs"},null,8,["numero","id"]),o.titulo.parcela?(c(),b(l,{key:0,rotulo:o.titulo.parcela,escuro:"",cor:"tertiary",class:"q-mr-xs"},null,8,["rotulo"])):P("",!0),(w=o.titulo)!=null&&w.documentoCodigo?(c(),b(B,{key:1,numero:(T=o.documento)==null?void 0:T.numero,escuro:"",id:(h=o.documento)==null?void 0:h.id,dica:(p=o.titulo)==null?void 0:p.documentoTipo,cor:"tertiary",class:"q-mr-xs"},null,8,["numero","id","dica"])):P("",!0),((n=o.titulo)==null?void 0:n.formaDePagamento)||(($=o.titulo)==null?void 0:$.descricaoPlanoConta)?(c(),b(v,{key:2,text:"sub2 regular"},{default:t(()=>{var W,D;return[C(z((W=o.titulo)==null?void 0:W.formaDePagamento)+" ",1),(D=o.titulo)!=null&&D.descricaoPlanoConta?(c(),b(v,{key:0,caption:""},{default:t(()=>{var A;return[C(" Descri\xE7\xE3o do plano de conta"+z((A=o.titulo)==null?void 0:A.descricaoPlanoConta),1)]}),_:1})):P("",!0)]}),_:1})):P("",!0)]}),_:1}),a(f,{col:"5 sm-shrink md2"},{default:t(()=>{var y,i;return[(y=o.titulo)!=null&&y.dataVencimentoOriginal?(c(),b(v,{key:0,icon:"mdi-calendar-today",tip:"Vencimento original"},{default:t(()=>{var w;return[C(z(r.$filters.data((w=o.titulo)==null?void 0:w.dataVencimentoOriginal)),1)]}),_:1})):P("",!0),(i=o.titulo)!=null&&i.dataVencimento?(c(),b(v,{key:1,icon:"mdi-calendar-check",tip:"Vencimento"},{default:t(()=>{var w;return[C(z(r.$filters.data((w=o.titulo)==null?void 0:w.dataVencimento)),1)]}),_:1})):P("",!0)]}),_:1}),a(f,{col:"7 sm md2"},{default:t(()=>[a(v,{text:"h5 right bold",color:o.titulo.valorTotal>0?"text-positive":"text-negative"},{default:t(()=>[C(z(r.$filters.numero(o.titulo.valorTotal,2)),1)]),_:1},8,["color"]),a(v,{text:"body right medium"},{default:t(()=>[C(z(r.$filters.numero(o.titulo.valor,2)),1)]),_:1})]),_:1})]),_:1}),a(ya,{class:"q-mx-sm q-mb-xs"}),a(N,{gutter:"sm",items:"center"},{default:t(()=>[a(f,{col:"12 md"},{default:t(()=>[a(v,{text:"body2 regular"},{default:t(()=>[C(z(o.titulo.descricao),1)]),_:1})]),_:1}),a(f,{col:"12 md3",text:"right",self:"end"},{default:t(()=>[a(Z,{onClick:m.alternarDetalhes,round:"",dense:"",flat:"",color:"tertiary",icon:`keyboard_arrow_${o.detalhes?"up":"down"}`},null,8,["onClick","icon"]),o.visibilidade.botao.remover?(c(),b(Z,{key:0,onClick:m.remover,round:"",dense:"",flat:"",icon:"clear",color:"tertiary"},{default:t(()=>[a(no,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[C(" Remover da Fatura #"+z(parseInt(o.fatura.numero)||(o.fatura.id||"").slice(-6)),1)]),_:1})]),_:1},8,["onClick"])):P("",!0),o.visibilidade.botao.editar?(c(),b(Z,{key:1,onClick:m.editar,round:"",dense:"",flat:"",icon:"edit",color:"primary"},null,8,["onClick"])):P("",!0),lo(r.$slots,"default",{},void 0,!0),m.mostrarMenuTresPontos?(c(),b(Z,{key:2,icon:"more_vert",color:"tertiary",rounded:"",dense:"",flat:""},{default:t(()=>[a(Ma,null,{default:t(()=>[ea((c(),b(fa,{link:"",separator:""},{default:t(()=>[o.mostrarOpcaoMigrarFatura?(c(),O(L,{key:0},[(c(!0),O(L,null,H(o.faturasAbertas,y=>(c(),b(G,{key:y.id,onClick:i=>m.migrarFatura(y),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"mdi-folder-move"})]),_:1}),a(I,null,{default:t(()=>[C(z("Migrar para fatura #"+(y.numero||y.id.slice(-6))),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),a(G,{clickable:"",onClick:e[0]||(e[0]=y=>m.migrarFatura())},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"mdi-folder-move"})]),_:1}),a(I,null,{default:t(()=>e[8]||(e[8]=[C("Migrar para nova fatura")])),_:1})]),_:1})],64)):P("",!0)]),_:1})),[[ia]])]),_:1})]),_:1})):P("",!0)]),_:3})]),_:3}),o.detalhes?(c(),b(N,{key:0,gutter:"sm",items:"stretch"},{default:t(()=>[a(f,{col:"12 sm12 md-grow",bordered:"","rounded-borders":""},{default:t(()=>{var y,i;return[a(N,{gutter:"none"},{default:t(()=>[a(f,{col:"12 sm6"},{default:t(()=>{var w;return[(w=o.contatos[o.titulo.idEmpresa])!=null&&w.apelido?(c(),b(v,{key:0,text:"sub2 medium",icon:`business ${o.width<=992?"15px":"xs"} tertiary left`},{default:t(()=>{var T;return[C(z((T=o.contatos[o.titulo.idEmpresa])==null?void 0:T.apelido),1)]}),_:1},8,["icon"])):P("",!0)]}),_:1}),a(f,{col:"12 sm6"},{default:t(()=>{var w;return[(w=o.titulo)!=null&&w.documentoCodigo?(c(),b(v,{key:0,text:"sub2 medium",inline:"",icon:`request_quote ${o.width<=992?"15px":"xs"} tertiary left`},{default:t(()=>{var T,h,p;return[C(z((T=o.titulo)==null?void 0:T.documentoTipo)+" ",1),a(B,{id:(h=o.documento)==null?void 0:h.id,escuro:"",cor:"positive",numero:(p=o.documento)==null?void 0:p.numero,class:"q-mx-sm"},null,8,["id","numero"])]}),_:1},8,["icon"])):P("",!0)]}),_:1})]),_:1}),(y=o.titulo)!=null&&y.observacao?(c(),b(v,{key:0,text:"sub2",class:"q-mt-sm"},{default:t(()=>[e[9]||(e[9]=C(" Obs.: ")),a(v,{inline:"",text:"regular"},{default:t(()=>{var w;return[C(z((w=o.titulo)==null?void 0:w.observacao),1)]}),_:1})]),_:1})):P("",!0),(i=o.titulo)!=null&&i.descricaoCentroCusto?(c(),b(v,{key:1,text:"sub2",class:"q-mt-sm"},{default:t(()=>[e[10]||(e[10]=C(" Desc.: ")),a(v,{inline:"",text:"regular"},{default:t(()=>{var w;return[C(z((w=o.titulo)==null?void 0:w.descricaoCentroCusto),1)]}),_:1})]),_:1})):P("",!0)]}),_:1}),a(f,{col:"12 sm6 md2",bordered:"","rounded-borders":""},{default:t(()=>[a(N,null,{default:t(()=>[a(f,{col:"6 md12"},{default:t(()=>{var y;return[(y=o.titulo)!=null&&y.dataEmissao?(c(),b(v,{key:0,text:"sub2",icon:"mdi-calendar-today",tip:"Emiss\xE3o"},{default:t(()=>{var i;return[C(z(r.$filters.data((i=o.titulo)==null?void 0:i.dataEmissao))+" ",1),a(v,{caption:""},{default:t(()=>e[11]||(e[11]=[C("Emiss\xE3o")])),_:1})]}),_:1})):P("",!0)]}),_:1}),a(f,{col:"6 md12"},{default:t(()=>{var y;return[(y=o.titulo)!=null&&y.dataCompetencia?(c(),b(v,{key:0,icon:"mdi-calendar-check",tip:"Compet\xEAncia",text:"sub2"},{default:t(()=>{var i;return[C(z(r.$filters.data((i=o.titulo)==null?void 0:i.dataCompetencia))+" ",1),a(v,{caption:""},{default:t(()=>e[12]||(e[12]=[C("Compet\xEAncia")])),_:1})]}),_:1})):P("",!0)]}),_:1})]),_:1})]),_:1}),a(f,{col:"12 sm6 md3",bordered:"","rounded-borders":""},{default:t(()=>{var y,i;return[a(v,{text:"sub2",bordered:"bottom"},{default:t(()=>[e[13]||(e[13]=C(" Desconto ")),a(v,{text:"bold right",class:"float-right",inline:""},{default:t(()=>{var w;return[C(z(r.$filters.numero(((w=o.titulo)==null?void 0:w.valorDesconto)||0,2)),1)]}),_:1})]),_:1}),(y=o.titulo)!=null&&y.diasEmAtraso?(c(),b(v,{key:0,text:"sub2 medium",bordered:"bottom",class:"q-mt-sm"},{default:t(()=>[e[14]||(e[14]=C(" Multa ")),a(v,{text:"bold right",class:"float-right",inline:""},{default:t(()=>{var w,T;return[C(z(r.$filters.numero(((w=o.titulo)==null?void 0:w.valorMulta)||0,2))+" ("+z(r.$filters.numero(((T=o.titulo)==null?void 0:T.percentualMulta)||0,2))+"%) ",1)]}),_:1})]),_:1})):P("",!0),(i=o.titulo)!=null&&i.diasEmAtraso?(c(),b(v,{key:1,text:"sub2 medium",bordered:"bottom",class:"q-mt-sm"},{default:t(()=>[e[15]||(e[15]=C(" Juros ")),a(v,{text:"bold right",class:"float-right",inline:""},{default:t(()=>{var w,T;return[C(z(r.$filters.numero(((w=o.titulo)==null?void 0:w.valorTotalJuros)||0,2))+" ("+z(r.$filters.numero(((T=o.titulo)==null?void 0:T.percentualJuros)||0,2))+"% dia) ",1)]}),_:1})]),_:1})):P("",!0)]}),_:1})]),_:1})):P("",!0)]),_:3},8,["class"]),a(Sa,{modelValue:o.modalEditar.visivel,"onUpdate:modelValue":e[7]||(e[7]=y=>o.modalEditar.visivel=y),onKeyup:Ra(m.cancelarDesconto,["esc"]),persistent:""},{default:t(()=>[a(za,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"500px"}},{default:t(()=>[a(co,{onSubmit:m.salvar},{default:t(()=>[a(Ba,{class:"bg-white text-tertiary border-bottom"},{default:t(()=>[a(Ta,{class:"bg-primary text-white"},{default:t(()=>[a(Na,null,{default:t(()=>e[16]||(e[16]=[C("Editar T\xEDtulo")])),_:1}),ea(a(Z,{icon:"close",round:"",flat:""},null,512),[[ia]])]),_:1})]),_:1}),a(Aa,null,{default:t(()=>[a(Oa,null,{default:t(()=>[a(N,{gutter:"md",bg:"bg-white"},{default:t(()=>[a(f,{col:"12"},{default:t(()=>[a(R,{modelValue:o.titulo.valor,"onUpdate:modelValue":e[1]||(e[1]=y=>o.titulo.valor=y),"somente-leitura":"",filled:"",tipo:"decimal",rotulo:"Valor",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue"]),a(R,{modelValue:o.titulo.diasEmAtraso,"onUpdate:modelValue":e[2]||(e[2]=y=>o.titulo.diasEmAtraso=y),zeros:"","somente-leitura":"",filled:"",tipo:"decimal",rotulo:"Dias em Atraso",decimals:"0",zerosDireita:"0",class:"q-field--with-bottom"},null,8,["modelValue"]),a(R,{modelValue:o.modalEditar.campos.valorMulta,"onUpdate:modelValue":e[3]||(e[3]=y=>o.modalEditar.campos.valorMulta=y),"somente-leitura":"",filled:"",ajuda:`Multa de R$ ${r.$filters.numero(o.titulo.valorMulta,2)}`,rotulo:"Multa",tipo:"decimal",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue","ajuda"]),a(R,{modelValue:o.titulo.valorTotalJuros,"onUpdate:modelValue":e[4]||(e[4]=y=>o.titulo.valorTotalJuros=y),"somente-leitura":"",filled:"",ajuda:`Juros ao ${o.titulo.tipoJuros} de R$ ${r.$filters.numero(o.titulo.valorJuros,2)}`,rotulo:"Juros",tipo:"decimal",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue","ajuda"]),a(R,{modelValue:o.titulo.valorDesconto,"onUpdate:modelValue":[e[5]||(e[5]=y=>o.titulo.valorDesconto=y),m.desconto],rules:o.modalEditar.rules,filled:"",rotulo:"Desconto",tipo:"decimal",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue","onUpdate:modelValue","rules"]),a(R,{modelValue:o.titulo.valorTotal,"onUpdate:modelValue":e[6]||(e[6]=y=>o.titulo.valorTotal=y),filled:"",tipo:"decimal",rotulo:"Total",decimals:"2",class:"q-field--with-bottom"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),a(Wa,{class:"bg-white text-right border-top q-pa-sm"},{default:t(()=>[a(Z,{onClick:m.cancelarDesconto,flat:"",unelevated:"",label:"Cancelar",color:"tertiary"},null,8,["onClick"]),a(Z,{type:"submit",unelevated:"",label:"Salvar",color:"primary"})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue","onKeyup"])])}var yo=Ia($o,[["render",wo],["__scopeId","data-v-53008a31"]]),To={async finalizar(r,e){var d,F,o,m,B,l,f,j,v,N,R,y;try{if($utils.verificarErro(this.erroCalculo,"Erro de c\xE1lculo encontrado."),!r)try{await new Promise((s,u)=>{$q.dialog({cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},message:"Esta a\xE7\xE3o ir\xE1 finalizar esta fatura",ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0},title:"Tem certeza?"}).onOk(()=>{s()}).onCancel(()=>{u()})})}catch{return!1}this.$q.loading.show({message:"Processando..."});const i=$utils.clonar(this.fatura),w=$utils.clonar(this.vendas),T=$utils.clonar(this.documentosEnvelope),h=$utils.clonar(this.carnes),p=[...w,...T].map(s=>s.id),n=await $db.hibrido.lista({table:"documentoItem",whereIn:{idDocumento:p}}),$=$utils.clonar(n),W=$utils.arredondar((i.totalDesconto||0)+(i.totalBonus||0));if(h.length>0){const s=h.reduce((u,x)=>(x.idFinanceiroBoleto&&x.codigoFinanceiroTitulo&&(u+=String(x.codigoFinanceiroTitulo)+";"),u),"");if(s)try{$q.loading.show({message:"Baixando boletos..."});const u=`exec sp_Financeiro_BoletoBaixar '${s.slice(0,-1)}'`,x=await $utils.executarSql(u)}catch(u){$q.notifyError("N\xE3o foi poss\xEDvel baixar boletos",u);return}finally{$q.loading.hide()}}const D=r?i.dataHoraFinalizado:$utils.dataAtual(),A=D,q=await $db.hibrido.le({table:"documento",id:this.$refs.faturamento.idDocumentoCaixa}),ga=await $db.formaPagamento.le();this.documentoStatus=[],await this.$refs.faturamento.validar();let Y=$lodash.orderBy(this.$refs.faturamento.condicaoPagamento.filter(s=>s.valor),["idFormaPagamento","autorizacao","dataVencimento"]);if($utils.verificarErro(w.some(s=>!s.dataHoraFinalizado),"Existe pedido de venda sem data de finaliza\xE7\xE3o."),i.tokenBonusUtilizado){const s=await $utils.geeksApi({utilizaBonus:{funcao:"1A130FC6-C9BA-4121-B9CF-069CEAEC36CB",tokenBonus:i.tokenBonusUtilizado,valorVenda:(i.subTotal||0)-(i.totalDesconto||0),cnpjEmissor:i.numeroDocumentoEmpresa,cpfCliente:i.numeroDocumentoContato,idDocumentoDestino:i.id,utiliza:!0}});$utils.verificarErro(((F=(d=s.data)==null?void 0:d.utilizaBonus)==null?void 0:F.status)!=="Utilizado","B\xF4nus inv\xE1lido"),$utils.verificarErro(!((m=(o=s.data)==null?void 0:o.utilizaBonus)!=null&&m.valor),"Valor do B\xF4nus inv\xE1lido")}const ra=$utils.arredondar(this.carnes.reduce((s,u)=>s+(u.valorARealizar||0),0)),na=$utils.arredondar(Y.reduce((s,u)=>s+(u.valor||0),0));let da=0;if(r&&(Y=Y.filter(s=>!this.$refs.faturamento.condicaoPagamentoOriginal.find(u=>u.id===s.id))),i.totalDocumento>=0){if(this.carnes.length){if(na<ra)return this.$q.notify("Valor pago menor que a soma dos t\xEDtulos \xE0 faturar!"),!1;if(!await $db.permissao.objeto("Diretiva_Caixa_PagarCarneCartao")){const u=Y.reduce((x,k)=>{const V=`${k.autorizacao||""}${k.documento||""}${k.idFormaPagamento}`;return x[V]||(x[V]={parcelas:0,formaPagamento:k.formaPagamento}),x[V].parcelas++,x},{});for(const x in u)if(u[x].parcelas>this.carnes.length)return this.$q.notify(`Quantidade de parcelas da forma de pagamento ${u[x].formaPagamento} acima do permitido.`),!1}}na<i.totalDocumento&&(da=1)}let ca=da===1?"Aguardando Pagamento":"Finalizada";if(!r){this.documentoStatus.push({id:$utils.uuid(),idDocumento:i.id,operacao:"Fatura",statusOriginal:i.status,statusFinalizado:ca,dataHoraEmissao:D,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:q.id||""}),i.status=ca,i.dataHoraFinalizado=D,ca="Faturado";const s=parseInt(await $db.configuracoes.leValorComFiltroEmpresa("vendas.usaExpedicao",i.idEmpresa,0))||0;let u=0,x=T.filter(g=>g.status!=="Entregue").length,k=!1,V=!0;if(w.length>0&&s&&(this.$q.loading.hide(),await new Promise((g,_)=>{this.$q.dialog({cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},message:"Gostaria de dar baixa na(s) venda(s), removendo-a(s) do processo de expedi\xE7\xE3o?",noRefocus:!0,preventClose:!0,persistent:!0,title:"Confirma?"}).onOk(()=>{V=!0,g()}).onCancel(()=>{V=!1,g()})}),this.$q.loading.show({message:"Processando..."})),x){let g="Nesta Fatura h\xE1 1 envelope aguardando entrega, deseja mudar o status deste para Entregue?";x>1&&(g=`Nesta Fatura h\xE1 ${x} envelopes aguardando entrega, deseja mudar o status destes para Entregue?`),this.$q.loading.hide();try{await new Promise((_,M)=>{this.$q.dialog({cancel:"N\xE3o",message:g,noRefocus:!0,ok:"Sim",preventClose:!0,title:"Confirma?"}).onOk(()=>{k=!0,_()}).onCancel(()=>{M()})})}catch{}this.$q.loading.show({message:"Processando..."})}let E=0;for(const g of $)g.total>0&&(E+=(g.valorItem-g.descontoItem)*g.quantidade-g.descontoTotalRateado);for(const g of[...w,...T])g.tipo==="Envelope"&&k&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:g.id,operacao:g.operacao,statusOriginal:g.status,statusFinalizado:"Entregue",dataHoraEmissao:D,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),g.status="Entregue"),g.tipo==="Venda"&&V&&(this.documentoStatus.push({id:$utils.uuid(),idDocumento:g.id,operacao:g.operacao,statusOriginal:g.status,statusFinalizado:ca,dataHoraEmissao:D,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:q.id||""}),g.status="Faturado");for(const g of $){const _=[...w,...T].find(M=>M.id===g.idDocumento);if(g.status=_.status,g.total>0){g.quantidade=g.quantidade||1,g.valorItem=g.valorItem||0,g.descontoItem=g.descontoItem||0,g.descontoTotalRateado=g.descontoTotalRateado||0;let M=(g.valorItem-g.descontoItem)*g.quantidade-g.descontoTotalRateado;const S=$utils.arredondar(W*M/(E||1)||0);g.descontoFaturaRateado=$utils.arredondar(S),g.valorRealTotal=$utils.arredondar(M-S),g.valorReal=$utils.arredondar(g.valorRealTotal/g.quantidade),u+=S}}if(this.documentosItem=$,this.documentosItemOriginal=n,W!==$utils.arredondar(u)){const g=$utils.arredondar(W-(u||0));let _,M=0;for(const S of $)S.total>M&&(M=S.total,_=S);if(_){const S=(_.descontoFaturaRateado||0)+(g||0),ta=((_.valorItem||0)-(_.descontoItem||0))*(_.quantidade||1)-(_.descontoTotalRateado||0)-(S||0),va=(ta||0)/(_.quantidade||1);_.descontoFaturaRateado=$utils.arredondar(S),_.valorReal=$utils.arredondar(va),_.valorRealTotal=$utils.arredondar(ta)}}}const Pa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.renegociacao"}))[0].valor),ba=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Pa}),Ka=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatareceber"}))[0].valor);let pa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ka});const Za=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.duplicatapagar"}))[0].valor),ja=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Za}),Xa=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cheque"}))[0].valor),La=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Xa}),Ya=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.faturamentogeral"}))[0].valor),aa=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:Ya}),ao=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0].valor),Ua=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:ao}),oo=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.frete"}))[0].valor),Ha=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:oo}),to=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.cmv"}))[0].valor),Da=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:to}),eo=parseInt((await $db.configuracoes.le({nome:"financeiro.planocontas.creditoclientes"}))[0].valor),io=await $db.financeiroPlanoConta.le({codigoFinanceiroPlanoConta:eo}),xa=(B=this.contatos[i.idContato])==null?void 0:B.descontoCondicionadoPercentual,_a=await $db.configuracoes.leValorNumerico("contabilidade.versao")!==2;let ma=w.reduce((s,u)=>s+u.totalDocumento,0);ma=ma+T.reduce((s,u)=>s+u.totalDocumento,0),ma=$utils.arredondar(ma-W);let ua=i.totalDocumento,oa=[];const U=[],Ja=[],$a=[],Qa=[];let Ca=1,ka="",Ea=1,la="";for(const s of Y.filter(u=>!u.sinal)){s.sinal=s.sinal||da;const u=ga.filter(x=>x.id===s.idFormaPagamento)[0];if(ua<0)la=$utils.uuid(),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:la,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:D,valorCredito:0,valorDebito:$utils.arredondar(ua*-1),descricao:aa.descricao,observacao:`Movimenta\xE7\xE3o de d\xE9bito da devolu\xE7\xE3o de clientes no(s) pedido(s) da fatura c\xF3digo (${i.id})`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:la,idContato:i.idContato,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:io.id,dataEmissao:D,valorCredito:$utils.arredondar(ua*-1),valorDebito:0,descricao:`Cr\xE9dito proveniente de produtos devolvidos no(s) pedido(s) da fatura c\xF3digo (${i.id})`,observacao:"Movimenta\xE7\xE3o de cr\xE9dito na conta de clientes",automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id});else{if(ka!==s.idFormaPagamento+s.autorizacao&&(ka=s.idFormaPagamento+s.autorizacao,Ca=1,Ea=Y.reduce((x,k)=>k.idFormaPagamento+k.autorizacao===ka?x+1:x,0)),u.tipoFinanceiro==="T\xEDtulo Liquidado"&&(la=$utils.uuid()),ra>0){const x=$utils.uuid(),k=$utils.arredondar(s.valor*(ra/ua));let V=0,E=0,g=0,_=0;if(u.tipo===5){let M=(await $erp().financeiroBanco.toArray()).find(S=>S.codigoBanco===122);M&&(E=M.percentualMulta||0,_=M.percentualJuros||0,V=$utils.arredondar(E/100*k),g=$utils.arredondar(_/100*k))}oa.push({id:x,idFinanceiroPlanoConta:ba.id,idContato:i.idContato,dataEmissao:D,dataCompetencia:A,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:k,valorTotal:k,valorARealizar:k,valorMulta:V,percentualMulta:E,valorJuros:g,percentualJuros:_,documentoId:i.id,documentoTipo:"Fatura",parcela:Ca+"/"+Ea,descricao:"Fatura de Venda Mercadoria",observacao:`${i.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:u.descricao,carne:u.tipo===5?1:0,dataEmissaoCarne:u.tipo===5?D:"",idDocumentoCaixa:q.id,idFinanceiroMovimentacaoAgrupamento:u.tipoFinanceiro==="T\xEDtulo Liquidado"?la:""}),s.idFinanceiroTitulo=x,u.tipo===2&&$a.push({idTitulo:x,idDocumentoCondicaoPagamento:s.id,valor:k,dataVencimento:s.dataVencimento,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,formaPagamento:u}),Qa.push({idTitulo:x,valor:k,desconto:0})}if(ma>0){const x=$utils.uuid(),k=$utils.arredondar(s.valor*(ma/ua));let V=0,E=0,g=0,_=0;if(u.tipo===5){let M=(await $erp().financeiroBanco.toArray()).find(S=>S.codigoBanco===122);M&&(E=M.percentualMulta||0,_=M.percentualJuros||0,V=$utils.arredondar(E/100*k),g=$utils.arredondar(_/100*k))}oa.push({id:x,idFinanceiroPlanoConta:aa.id,idContato:i.idContato,dataEmissao:D,dataCompetencia:A,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:k,valorTotal:k,valorARealizar:k,valorMulta:V,percentualMulta:E,valorJuros:g,percentualJuros:_,documentoId:i.id,documentoTipo:"Fatura",parcela:Ca+"/"+Ea,descricao:"Fatura de Venda Mercadoria",observacao:`${i.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:1,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:u.descricao,carne:u.tipo===5?1:0,dataEmissaoCarne:u.tipo===5?D:"",idDocumentoCaixa:q.id,idFinanceiroMovimentacaoAgrupamento:u.tipoFinanceiro==="T\xEDtulo Liquidado"?la:"",descontoCondicionadoValor:xa>0?xa/100*k:0,descontoCondicionadoPercentual:xa}),s.idFinanceiroTitulo=x,u.tipo===2&&$a.push({idTitulo:x,idDocumentoCondicaoPagamento:s.id,valor:k,dataVencimento:s.dataVencimento,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,formaPagamento:u})}if(u.tipoFinanceiro==="T\xEDtulo Liquidado"&&ma>=0){U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:la,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:pa.id,idFinanceiroTitulo:s.idFinanceiroTitulo,dataEmissao:D,valorCredito:s.valor,valorDebito:0,descricao:String(pa.descricao).trim(),observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id});let x=u.idFinanceiroPlanoConta;u.tipo===1&&(q||{}).idFinanceiroPlanoContaCaixa&&(x=q.idFinanceiroPlanoContaCaixa);let k=await $db.financeiroPlanoConta.le({id:x}),V="";[3,4].includes(u.tipo)&&(V=(j=(f=(l=oa[0])==null?void 0:l.observacao)==null?void 0:f.match(/Autorização\s(\d+)/))==null?void 0:j[1],V&&(V=` (Autoriza\xE7\xE3o ${V})`)),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:la,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:k.id,idFinanceiroTitulo:s.idFinanceiroTitulo,dataEmissao:D,valorCredito:0,valorDebito:s.valor,descricao:String(k.descricao+V).trim(),observacao:`Liquida\xE7\xE3o referente t\xEDtulo fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id});for(const E of oa)E.idFinanceiroMovimentacaoAgrupamento===la&&(E.valorRealizado=E.valorARealizar,E.dataPagamento=s.dataVencimento,E.dataMovimento=s.dataVencimento,E.idDocumentoCaixaLiquidacao=q.id)}if(u.aliquota){const x=$utils.uuid(),k=$utils.arredondar(s.valor*(u.aliquota/100));if(oa.push({id:x,idFinanceiroPlanoConta:u.idFinanceiroPlanoContaAliquota,idContato:u.idContatoOperadoraCartao,dataEmissao:D,dataCompetencia:A,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:k,valorTotal:k,valorARealizar:k,valorMulta:0,percentualJuros:0,documentoId:i.id,documentoTipo:"Fatura",parcela:Ca+"/"+Ea,descricao:`T\xEDtulo referente a al\xEDquota da forma de pagamento: ${u.descricao}`,observacao:`T\xEDtulo referente a al\xEDquota. ${i.observacaoFaturamento||""} ${s.observacao||""}`.trim(),documentoVinculado:1,receberPagar:0,valorDesconto:0,percentualDesconto:0,idEmpresa:i.idEmpresa,formaDePagamento:u.descricao,idDocumentoCaixa:q.id}),s.idFinanceiroTituloPagar=x,u.tipoFinanceiro==="T\xEDtulo Liquidado"){const V=$utils.uuid();U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:V,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:ja.id,dataEmissao:D,valorCredito:0,valorDebito:k,descricao:ja.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:x,idContato:u.idContatoOperadoraCartao,idDocumentoCaixa:q.id});let E=u.idFinanceiroPlanoConta;u.tipo===1&&(q||{}).idFinanceiroPlanoContaCaixa&&(E=q.idFinanceiroPlanoContaCaixa);let g=await $db.financeiroPlanoConta.le({id:E});U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:V,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:D,valorCredito:k,valorDebito:0,descricao:g.descricao,observacao:`Liquida\xE7\xE3o al\xEDquota cart\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:s.dataVencimento,dataMovimento:s.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idFinanceiroTitulo:x,idContato:u.idContatoOperadoraCartao,idDocumentoCaixa:q.id});for(const _ of oa)_.id===x&&(_.idFinanceiroMovimentacaoAgrupamento=V,_.valorRealizado=k,_.dataPagamento=s.dataVencimento,_.dataMovimento=s.dataVencimento,_.idDocumentoCaixaLiquidacao=q.id)}}Ca++}}const Ga=[];for(const s of $a){const u=$utils.uuid(),x=$utils.uuid();for(const V of oa)V.id===s.idTitulo&&(V.idFinanceiroMovimentacaoAgrupamento=x,V.valorRealizado=V.valorARealizar,V.dataPagamento=D,V.dataMovimento=D,V.dataVencimento=D,V.dataVencimentoOriginal=D,V.idDocumentoCaixaLiquidacao=q.id);if(Ga.includes(s.idDocumentoCondicaoPagamento))continue;Ga.push(s.idDocumentoCondicaoPagamento);const k=$utils.arredondar($a.reduce((V,E)=>E.idDocumentoCondicaoPagamento===s.idDocumentoCondicaoPagamento?V+(E.valor||0):V,0));oa.push({id:u,idFinanceiroPlanoConta:La.id,idContato:i.idContato,dataEmissao:D,dataCompetencia:A,dataVencimento:s.dataVencimento,dataVencimentoOriginal:s.dataVencimento,valor:k,valorTotal:k,valorARealizar:k,valorMulta:0,percentualJuros:0,receberPagar:1,valorDesconto:0,percentualDesconto:0,documentoId:i.id,documentoTipo:"Fatura",idEmpresa:i.idEmpresa,formaDePagamento:s.formaPagamento.descricao,idDocumentoCaixa:q.id,cheque:1,idBanco:s.idBanco,agencia:s.agencia,conta:s.conta,numeroCheque:s.numeroCheque,observacao:`Liquida\xE7\xE3o de Cheques da Fatura #${i.id} - C\xF3digoN #${x}`,descricao:"Cheque"}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:x,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:La.id,idFinanceiroTitulo:u,dataEmissao:D,valorCredito:0,valorDebito:k,descricao:"Cheque - Cr\xE9dito de t\xEDtulos a receber",observacao:"Cr\xE9dito de t\xEDtulos a receber",automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,idFinanceiroCheque:u,idDocumentoCaixa:q.id,documentoId:i.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:x,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:pa.id,idFinanceiroTitulo:u,dataEmissao:D,valorCredito:k,valorDebito:0,descricao:pa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,idFinanceiroCheque:u,idDocumentoCaixa:q.id,documentoId:i.id})}if(ra>0){const s=$utils.uuid();U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:pa.id,dataEmissao:D,valorCredito:ra,valorDebito:0,descricao:pa.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica",automatico:1,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,idDocumentoCaixa:q.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idContato:i.idContato,idFinanceiroPlanoConta:ba.id,dataEmissao:D,valorCredito:0,valorDebito:ra,descricao:ba.descricao,observacao:"Contabiliza\xE7\xE3o autom\xE1tica - Complemento",automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:"Renegocia\xE7\xE3o",documentoId:s,idDocumentoCaixa:q.id});for(const u of Qa)Ja.push({idFinanceiroMovimentacaoN:s,idFinanceiroTitulo:u.idTitulo,dataVencimento:D,valorOriginal:u.valor,valorDesconto:u.desconto,valorTotal:$utils.arredondar(u.valor-u.desconto)});for(const u of h){if(u.idFinanceiroMovimentacaoAgrupamento=s,u.idDocumentoCaixaLiquidacao=q.id,u.dataPagamento=D,u.dataMovimento=D,u.renegociado=1,u.cheque===1){u.valorRealizado=u.valor;continue}if(!u.valorARealizar){u.valorRealizado=u.valorTotal;continue}u.valorRealizado=u.valorARealizar}oa=oa.concat(h)}if(da===0){let s=$utils.uuid();const u=i.valorFrete||0;let x=0,k=0;const V=[];if(u>0&&(U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:D,valorCredito:0,valorDebito:u,descricao:aa.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:Ha.id,dataEmissao:D,valorCredito:u,valorDebito:0,descricao:Ha.descricao,observacao:`Lan\xE7amento frete da fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id})),!r){s=$utils.uuid();for(const E of $){let g="",_={},M="",S={},ta="",va={};const ha=await $db.item.leNew({id:E.idItem});if(g=E.idPlanoContaEstoque,!g){const X=await $db.perfilContabilItem.le({idPerfilContabil:ha.idPerfilContabil,idCfop:E.idCfop,and:{idPerfilContabil:ha.idPerfilContabil,idCfop:E.idCfop}});X.length&&X[0].idPlanoContaEstoque&&(g=X[0].idPlanoContaEstoque)}if(!g&&Ua.id&&(g=Ua.id),!g&&E.idCfop&&(g=(await $db.cfop.le({id:E.idCfop})).idPlanoContaEstoque),_=await $db.financeiroPlanoConta.le({id:g}),!_.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Estoque.");return}if(M="",!M){const X=await $db.perfilContabilItem.le({idPerfilContabil:ha.idPerfilContabil,idCfop:E.idCfop,and:{idPerfilContabil:ha.idPerfilContabil,idCfop:E.idCfop}});X.length&&X[0].idPlanoContaDespesa&&(M=X[0].idPlanoContaDespesa)}if(!M&&Da.id&&(M=Da.id),!M&&E.idCfop&&(M=(await $db.cfop.le({id:E.idCfop})).idPlanoContaDestino),S=await $db.financeiroPlanoConta.le({id:M}),!S.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Despesa.");return}const qa=$utils.arredondar(E.total-(E.descontoTotalRateado||0)-(E.descontoFaturaRateado||0)),Fa=$utils.arredondar(E.valorCustoMedio*E.quantidade);if(Fa){if(_a&&(E.operacaoFator<0?(U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:_.id,dataEmissao:E.dataHoraFinalizado||D,valorCredito:Fa,valorDebito:0,descricao:_.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${E.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:q.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:S.id,dataEmissao:E.dataHoraFinalizado||D,valorCredito:0,valorDebito:Fa,descricao:S.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${E.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:q.id})):(U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:_.id,dataEmissao:E.dataHoraFinalizado||D,valorCredito:0,valorDebito:Fa,descricao:_.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${E.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:q.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:S.id,dataEmissao:E.dataHoraFinalizado||D,valorCredito:Fa,valorDebito:0,descricao:S.descricao,observacao:`Movimenta\xE7\xF5es de CMV referente fatura (${i.id}) e item (${E.idItem}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:i.tipo,documentoId:i.id,idDocumentoCaixa:q.id}))),ta=E.idPlanoContaDestino,!ta){const sa=await $db.perfilContabilItem.le({idPerfilContabil:ha.idPerfilContabil,idCfop:E.idCfop,and:{idPerfilContabil:ha.idPerfilContabil,idCfop:E.idCfop}});sa.length&&sa[0].idPlanoContaDespesa&&(ta=sa[0].idPlanoContaDespesa)}if(!ta&&Da.id&&(ta=Da.id),!ta&&E.idCfop&&(ta=(await $db.cfop.le({id:E.idCfop})).idPlanoContaDestino),va=await $db.financeiroPlanoConta.le({id:ta}),!va.id){this.$q.notify("N\xE3o foi poss\xEDvel localizar Conta de Receita.");return}let X=!0;for(const sa of V)if(sa.idPlanoContaDestino===va.id&&sa.idPlanoContaEstoque===_.id){sa.valor=$utils.arredondar(sa.valor+qa),X=!1;break}X&&V.push({idPlanoContaDestino:va.id,idPlanoContaEstoque:_.id,valor:qa}),x+=qa}}for(const E of V)E.valor<0&&(k+=E.valor);for(const E of V)if(E.valor>0){const g=await $db.financeiroPlanoConta.le({id:E.idPlanoContaDestino}),_=$utils.arredondar(k*(E.valor/(x||1)));if(_>0){if(U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:D,valorCredito:0,valorDebito:_,descricao:aa.descricao,observacao:`Lan\xE7amento entrada faturamento geral da devolu\xE7\xE3o referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:D,valorCredito:_,valorDebito:0,descricao:g.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de destino referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:D,dataMovimento:D,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id}),_a)for(const M of Y)U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:D,valorCredito:0,valorDebito:$utils.arredondar((E.valor-_)*(M.valor/(ua||1))),descricao:aa.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:M.dataVencimento,dataMovimento:M.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:D,valorCredito:$utils.arredondar((E.valor-_)*(M.valor/(ua||1))),valorDebito:0,descricao:g.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:M.dataVencimento,dataMovimento:M.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id})}else if(_a)for(const M of Y){const S=$utils.arredondar(E.valor*(M.valor/(ua||1)));U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:aa.id,dataEmissao:D,valorCredito:0,valorDebito:S,descricao:aa.descricao,observacao:`Lan\xE7amento sa\xEDda na conta de faturamento geral referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:M.dataVencimento,dataMovimento:M.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id}),U.push({id:$utils.uuid(),idFinanceiroMovimentacaoN:s,idEmpresa:i.idEmpresa,idFinanceiroPlanoConta:g.id,dataEmissao:D,valorCredito:S,valorDebito:0,descricao:g.descricao,observacao:`Lan\xE7amento entrada na conta de venda do produto referente fatura (${i.id}) - contabiliza\xE7\xE3o autom\xE1tica`,automatico:0,liquidando:0,dataCompetencia:A,dataVencimento:M.dataVencimento,dataMovimento:M.dataVencimento,documentoTipo:"Fatura",documentoId:i.id,idDocumentoCaixa:q.id})}}}}if(this.financeiroTitulo=oa,this.financeiroMovimentacao=U,this.financeiroRenegociacao=Ja,this.fatura=i,this.vendas=w,this.documentosEnvelope=T,this.carnes=h,!r){await this.salvarFatura(),$utils.emitter.emit("desativarBotoesFaturaModal");try{let u,x,k,V;if(u=await $db.configuracoes.porNome("integracao.bten.business"),x=(N=(v=u[0])==null?void 0:v.valor)!=null?N:!1,u=await $db.configuracoes.porNome("integracao.bten.authorization"),k=(y=(R=u[0])==null?void 0:R.valor)!=null?y:!1,V=x&&k,V){const E=[],g=this.contatos[i.idContato],_=await $api.bten.send(g,i);for(let M=0;M<_.length;M++){const S=_[M];S.status?E.push(S.telefone):this.$q.notifyError(`Falha ao enviar NPS para ${S.telefone}!`)}E.length&&this.$q.notifyPositive(`NPS enviado para ${E.join(",")}!`)}}catch(u){u.name==="GeeksException"&&this.$q.notifyAlert(`N\xE3o foi poss\xEDvel enviar NPS: ${u.message}`),u.name!=="GeeksException"&&this.$q.notifyError("N\xE3o foi possivel enviar NPS para o contato.",u)}let s;if(q!=null&&q.idCaixa){const u=await $erp().caixa.get(q==null?void 0:q.idCaixa);u!=null&&u.id&&(s=$db.caixa.tiposCaixa[Number(u.tipo)])}if([...w,...T].length&&~["SAT","NFCe"].indexOf(s))try{await this.$refs.documentosFiscais.emitirCupom(this.fatura.id)}catch{}this.$q.notifyPositive("Fatura finalizada"),this.fatura.status==="Finalizada"&&($db.bonus.gera(i).then(u=>{u&&u!==!0&&$q.notifyPositive("B\xF4nus gerado com sucesso!")}),$utils.enviarWhatsapp({configuracao:"fatura",documento:$utils.clonar(this.fatura),loading:!0}),$utils.enviarEmail({configuracao:"fatura",documento:$utils.clonar(this.fatura),loading:!0}))}return!0}catch(i){this.$q.notifyError("N\xE3o foi poss\xEDvel finalizar a fatura",i)}finally{this.$q.loading.hide()}}};const Po={components:{DocumentoCodigo:mo,DocumentoMetas:fo,DocumentosFiscais:go,VendaCard:Co,EnvelopeCard:Fo,TituloCard:yo,Faturamento:po},computed:{config(){return $db.configuracoes.valores},descontoSomenteLeitura(){let r=!1;return r=this.fatura.status==="Aberta",r||(r=this.fatura.status==="Aguardando Pagamento"&&this.permissaoDescontoFaturaSinal),!r},bonusSomenteLeitura(){return this.fatura.status!=="Aberta"}},data(){return{contatos:{},faturaOriginal:{},fatura:{totalDocumento:0,subTotal:0,totalDesconto:0,totalPercentualDesconto:0,totalBonus:0,tokenBonusUtilizado:""},vendas:[],vendasOriginal:[],documentosEnvelope:[],documentosEnvelopeOriginal:[],documentosItem:[],documentosItemOriginal:[],carnes:[],carnesOriginal:[],documentoStatus:[],faturaTitulos:[],faturaMovimentacoes:[],livroDiario:{},erroCalculo:!1,erroCalculoMsg:"",erroCalculoBonusMsg:"",erroTokenBonusMsg:"",sistemaPai:"",impressaoVisivel:!1,configImpressaoCarne:[],configImpressaoConvenio:[],configImpressaoFatura:[],configImpressaoEnvelope:[],configImpressosWhatsapp:[],configImpressosEmail:[],permissaoDesconto:!1,permissaoDescontoFaturaSinal:!1,permissaoBonus:!1,pesoTotal:null,pesoBrutoTotal:null,metroCubicoTotal:null}},emits:["executar"],mixins:[Do],methods:{async executarRecebimentoMultiplos(r){console.log(r)},async calcularPesoTotal(){var m,B;const r=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),e=[],d={};let F=0,o=0;for(const l of r){const f=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:l.id}});for(const j of f)e.push(j)}for(const l of e)if(l.operacaoFator===-1){if(l.idItem&&!d[l.idItem]){const f=await $erp().item.get(l.idItem);f&&(d[l.idItem]=f)}F+=(((m=d[l.idItem])==null?void 0:m.peso)||0)*(l.quantidade||0),o+=(((B=d[l.idItem])==null?void 0:B.pesoBruto)||0)*(l.quantidade||0)}F=$utils.arredondar(F,4),o=$utils.arredondar(o,4),this.pesoTotal=F?$filters.numeroZerosDireita(F,4,2):null,this.pesoBrutoTotal=o?$filters.numeroZerosDireita(o,4,2):null},async calcularMetroCubicoTotal(){var o,m,B;const r=await $db.hibrido.lista({table:"documento",where:{idFatura:this.fatura.id}}),e=[],d={};let F=0;for(const l of r){const f=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:l.id}});for(const j of f)e.push(j)}for(const l of e){if(l.operacaoFator!==-1||l.tipoItem!=="Produto")continue;if(l.idItem&&!d[l.idItem]){const v=await $erp().item.get(l.idItem);v&&(d[l.idItem]=v)}const f=((o=d[l.idItem])==null?void 0:o.altura)*((m=d[l.idItem])==null?void 0:m.largura)*((B=d[l.idItem])==null?void 0:B.comprimento)||0,j=l.quantidade||0;F+=f>0?f*j:0}F=$utils.arredondar(F,4),this.metroCubicoTotal=F?$filters.numeroZerosDireita(F,4,2):null},atualizarDocumentoMetas(){!this.$refs.documentoMetas||(this.$refs.documentoMetas.documento=$utils.clonarV2(this.fatura))},...To,async atualizar(){let r=!1;if(this.permissaoDesconto=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura"),this.permissaoDescontoFaturaSinal=await $db.permissao.objeto("Diretiva_Caixa_DescontoFatura_Sinal"),this.permissaoBonus=await $db.permissao.objetoClienteSistema("configuracoes/bonus"),this.vendas=[],this.vendasOriginal=[],this.documentosEnvelope=[],this.documentosEnvelopeOriginal=[],this.documentosItem=[],this.documentosItemOriginal=[],this.carnes=[],this.carnesOriginal=[],this.documentoStatus=[],this.contatos={},this.erroCalculo=!1,this.erroCalculoMsg="",this.erroCalculoBonusMsg="",this.erroTokenBonusMsg="",this.prop.id){const e=await $db.fatura.leCompleto(this.prop.id);this.faturaOriginal=$utils.clonar(e.fatura),this.fatura=e.fatura,this.$refs.faturamento&&(this.$refs.faturamento.condicaoPagamentoOriginal=$utils.clonar(e.condicaoPagamento),this.$refs.faturamento.condicaoPagamento=e.condicaoPagamento),this.vendasOriginal=$utils.clonar(e.vendas),this.vendas=e.vendas.sort((o,m)=>new Date(o.dataHoraFinalizado)<new Date(m.dataHoraFinalizado)?-1:1);const d=e.documentosEnvelope.sort((o,m)=>new Date(o.dataHoraFinalizado)<new Date(m.dataHoraFinalizado)?-1:1);if(this.documentosEnvelopeOriginal=$utils.clonar(d),this.documentosEnvelope=$utils.clonar(d),typeof this.receberTitulo.id!="object"&&this.receberTitulo.id&&!e.carnes.find(o=>o.id===this.receberTitulo.id)&&(e.carnes.push(await $db.financeiroTitulo.le({id:this.receberTitulo.id})),r=!0),typeof this.receberTitulo.id=="object")for(let o of this.receberTitulo.id)o&&!e.carnes.find(m=>m.id===o)&&(e.carnes.push(await $db.financeiroTitulo.le({id:o})),r=!0);this.carnesOriginal=$utils.clonar(e.carnes),this.carnes=e.carnes.sort((o,m)=>new Date(o.dataVencimento)<new Date(m.dataVencimento)?-1:1);const F={};if(e.fatura.idContato){const o=e.fatura.idContato;F[o]||(F[o]=await $db.contato.le({id:o}))}this.configuraImpressaoCarne(e.fatura.idEmpresa),this.configuraImpressaoConvenio(e.fatura.idEmpresa),this.configuraImpressaoEnvelope(e.fatura.idEmpresa),this.configuraImpressaoFatura(e.fatura.idEmpresa),this.configuraImpressosWhatsapp(e.fatura.idEmpresa),this.configuraImpressosEmail(e.fatura.idEmpresa),this.contatos=F,await this.atualizarDocumentoMetas(),await this.calculaTotais(),await this.calcularPesoTotal(),await this.calcularMetroCubicoTotal();try{r&&await this.salvarFatura()}catch(o){console.error(o)}}},async executar(r){if(r==="recalcular"){if(this.prop.id){const e=await $db.fatura.leCompleto(this.prop.id);this.carnesOriginal=$utils.clonar(e.carnes),this.carnes=e.carnes,await this.calculaTotais()}}else r==="salvarFatura"?(await this.salvarFatura(),await this.atualizar(),this.$emit("executar","atualizarSemFechar")):(await this.atualizar(),this.$emit("executar",r))},async calculaTotais(r){const e=$utils.arredondar(this.vendas.reduce((o,m)=>o+m.totalDocumento||0,0)),d=$utils.arredondar(this.documentosEnvelope.reduce((o,m)=>o+m.totalDocumento||0,0)),F=$utils.arredondar(this.carnes.reduce((o,m)=>o+m.valorARealizar||0,0));if(r||(this.fatura.subTotal=$utils.arredondar(e+d+F),r="desconto"),r==="descontoPercentual"&&(this.fatura.totalDesconto=$utils.arredondar((this.fatura.totalPercentualDesconto||0)/100*this.fatura.subTotal)),r==="desconto"&&(this.fatura.totalPercentualDesconto=$utils.arredondar((this.fatura.totalDesconto||0)/this.fatura.subTotal*100)),await this.checarTokenBonus(),this.fatura.totalDocumento=$utils.arredondar(this.fatura.subTotal-(this.fatura.totalDesconto||0)-(this.fatura.totalBonus||0)),this.erroCalculo=!1,this.erroCalculoMsg="",this.erroCalculoBonusMsg="",this.fatura.totalDesconto!==0){const o=e+d;o===0&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto n\xE3o permitido para fatura sem venda"),o>0&&this.fatura.totalDesconto>o&&(this.erroCalculo=!0,this.erroCalculoMsg="Desconto maior que o total das vendas")}if(this.fatura.totalDesconto!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculo=!0),this.fatura.totalBonus!==0){const o=e+d;o===0&&(this.erroCalculoBonusMsg="B\xF4nus n\xE3o permitido para fatura sem venda"),o>0&&this.fatura.totalBonus>o&&(this.erroCalculoBonusMsg="B\xF4nus maior que o total das vendas")}this.fatura.totalBonus!==0&&this.fatura.totalDocumento>this.fatura.subTotal&&(this.erroCalculoBonus="B\xF4nus com valor Inv\xE1lido");try{await this.$refs.faturamento.resumeCondicaoPagamento(),await this.$refs.faturamento.atualizaValorRestante(),await this.$refs.faturamento.redefinirCampos()}catch{}},async checarTokenBonus(){var r,e,d,F,o,m,B;if(!(this.ultimoTokenBonusVerificado===this.fatura.tokenBonusUtilizado&&this.ultimoDescontoVerificado===this.fatura.totalDesconto&&this.ultimoPercentualDescontoVerificado===this.fatura.totalPercentualDesconto)){if(!this.fatura.tokenBonusUtilizado){this.fatura.totalBonus=0,this.erroTokenBonusMsg="";return}try{this.ultimoTokenBonusVerificado=this.fatura.tokenBonusUtilizado,this.ultimoDescontoVerificado=this.fatura.totalDesconto,this.ultimoPercentualDescontoVerificado=this.fatura.totalPercentualDesconto;const l=$utils.arredondar(this.vendas.reduce((N,R)=>N+R.totalDocumento||0,0)),f=$utils.arredondar(this.documentosEnvelope.reduce((N,R)=>N+R.totalDocumento||0,0)),j=l+f-(this.fatura.totalDesconto||0),v=await $utils.geeksApi({verificaBonus:{funcao:"1A130FC6-C9BA-4121-B9CF-069CEAEC36CB",tokenBonus:this.fatura.tokenBonusUtilizado,valorVenda:j,cnpjEmissor:this.fatura.numeroDocumentoEmpresa,cpfCliente:this.fatura.numeroDocumentoContato,idDocumentoDestino:this.fatura.id,utiliza:!1}});$utils.verificarErro(!["Ativo","Utilizado"].includes((e=(r=v.data)==null?void 0:r.verificaBonus)==null?void 0:e.status),"B\xF4nus inv\xE1lido"),$utils.verificarErro(!((F=(d=v.data)==null?void 0:d.verificaBonus)!=null&&F.valor),"Valor do B\xF4nus inv\xE1lido"),this.fatura.totalBonus=(B=(m=(o=v.data)==null?void 0:o.verificaBonus)==null?void 0:m.valor)!=null?B:0,this.erroTokenBonusMsg=""}catch(l){this.fatura.totalBonus=0,this.erroTokenBonusMsg=l.message}}},async configuraImpressaoConvenio(r){const e=await $db.configuracoes.porNome("impressao.convenio",r);this.configImpressaoConvenio=[...e.length?e.map(d=>({texto:"Imprimir Conv\xEAnio",...d})):[{valor:"convenio",texto:"Imprimir Conv\xEAnio"}]]},async configuraImpressaoCarne(r){const e=await $db.configuracoes.porNome("impressao.carne",r);this.configImpressaoCarne=[...e.length?e.map(d=>({texto:"Imprimir Carn\xEA",...d})):[{valor:"carne-crediario",texto:"Reimprimir carn\xEA e notas promiss\xF3rias da fatura"}]]},async configuraImpressaoEnvelope(r){const e=await $db.configuracoes.porNome("impressao.envelope",r);this.configImpressaoEnvelope=[...e.length?e.map(d=>({texto:"Imprimir Envelope",...d})):[{valor:"envelope",texto:"Imprimir Envelope"},{valor:"envelopeMini",texto:"Imprimir Envelope Mini"}]]},async configuraImpressaoFatura(r){const e=await $db.configuracoes.porNome("impressao.fatura",r),d=[{valor:"invoice",texto:"Fatura (Invoice)"},{valor:"fatura-recibo",texto:"Recibo"}];this.sistemaPai==="optisoul"&&d.push({valor:"termoGarantia",texto:"Termo de Garantia"}),this.configImpressaoFatura=[...e.length?e.map(F=>({texto:"Imprimir Fatura",...F})):d]},async configuraImpressosWhatsapp(r){let e=await $db.configuracoes.le({prefixoNome:"fatura.whatsapp.enviar."});e=e.filter(d=>d.idEmpresa===r||!d.idEmpresa),this.configImpressosWhatsapp=e.map(d=>{var F;return{...d,idFatura:(F=this.fatura)==null?void 0:F.id}})},async configuraImpressosEmail(r){let e=await $db.configuracoes.le({prefixoNome:"fatura.email.enviar."});e=e.filter(d=>d.idEmpresa===r||!d.idEmpresa),this.configImpressosEmail=e.map(d=>{var F,o;return{...d,idFatura:(o=(F=this.dados)==null?void 0:F.fatura)==null?void 0:o.id}})},async enviarImpresso(r,e){var d,F;r==="whatsapp"&&await $utils.enviarWhatsapp({configuracao:$utils.clonar(e),documento:$utils.clonar((d=this.dados)==null?void 0:d.fatura),loading:!0,dialog:!0}),r==="email"&&await $utils.enviarEmail({configuracao:$utils.clonar(e),documento:$utils.clonar((F=this.dados)==null?void 0:F.fatura),loading:!0,dialog:!0})},async reabrir(r){var e;if(!((e=this.fatura)!=null&&e.id)){this.$q.notifyError("N\xE3o foi poss\xEDvel encontrar o ID da fatura");return}if(!r)try{$q.loading.show(),await vo({idDocumento:this.fatura.id})}catch(d){this.$q.notifyError(d.message);return}finally{$q.loading.hide()}if(!r)try{await new Promise((d,F)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 reabrir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{d()}).onCancel(()=>{F()})})}catch{return}try{this.$q.loading.show({message:"Processando..."});const d=$utils.clonar(this.fatura),F=$utils.clonar(this.vendas),o=$utils.clonar(this.documentosEnvelope),m=$utils.clonar(this.documentosItem),B=this.$refs.faturamento.condicaoPagamento.filter(v=>v.valor);if(!r){const v=[];B.reduce((N,R)=>(R.idDocumentoCaixa&&!N[R.idDocumentoCaixa]&&(N[R.idDocumentoCaixa]=!0,v.push($db.hibrido.le({table:"documento",id:R.idDocumentoCaixa}))),N),{});for await(const N of v)if(N.status!=="Aberto")return this.$q.notify({message:"N\xE3o \xE9 poss\xEDvel reabrir fatura de caixas fechados!"}),!1}try{await $db.fatura.checarTitulosLiquidados({condicoesPagamento:this.$refs.faturamento.condicaoPagamentoOriginal})}catch(v){$q.notifyError(v.message);return}let l=[],f=[],j=[];if(!r){l=await $db.financeiroTitulo.le({documentoId:d.id});for(const h of l)if(h.idFinanceiroBoleto){const p=await $erp().financeiroBoleto.get(h.idFinanceiroBoleto),n=await $db.financeiroBanco.le({id:p.idFinanceiroBanco}),$=await $db.banco.le({id:n.idBanco}),W=p.revisao,D=$.baixa,A=$.registro;if(p.remessaOperacao!==D){const q=h.idFinanceiroBoleto,ga=$utils.uuid(),Y={id:ga,idFinanceiroBanco:p.idFinanceiroBanco,nossoNumero:p.nossoNumero,nossoNumeroDv:p.nossoNumeroDv,revisao:W+1,idEmpresa:p.idEmpresa,idContato:p.idContato,empresaNome:p.empresaNome,empresaNumeroDocumento:p.empresaNumeroDocumento,contatoNome:p.contatoNome,contatoNumeroDocumento:p.contatoNumeroDocumento,contatoLogradouro:p.contatoLogradouro,contatoCEP:p.contatoCEP,contatoBairro:p.contatoBairro,contatoCidade:p.contatoCidade,contatoUF:p.contatoUF,dataEmissao:$utils.dataAtual(),dataVencimento:p.dataVencimento,dataImpressao:p.dataImpressao,valor:p.valor,valorJuros:p.valorJuros,tipoJuros:p.tipoJuros,valorMulta:p.valorMulta,valorDesconto:p.valorDesconto,valorTotal:p.valorTotal,codigoBarras:p.codigoBarras,linhaDigitavel:p.linhaDigitavel,mensagem1:p.mensagem1,mensagem2:p.mensagem2,mensagem3:p.mensagem3,mensagem4:p.mensagem4,mensagem5:p.mensagem5,gerarRemessa:1,remessaOperacao:D};await $db.financeiroBoleto.grava({atual:Y});let ra=[];q&&(ra=await $db.financeiroTitulo.le({idFinanceiroBoleto:q}));for(const na of ra){const da=$utils.clonar(na);na.idFinanceiroBoleto=ga;let ca=[];q&&(ca=await $db.financeiroBoletoTitulo.le({idFinanceiroBoleto:q}));for(const Pa of ca){const ba={id:$utils.uuid(),idFinanceiroBoleto:ga,idFinanceiroTitulo:Pa.idFinanceiroTitulo};await $db.financeiroBoletoTitulo.grava({atual:ba})}await $db.financeiroTitulo.grava({atual:na,original:da})}if(p.remessaOperacao===A&&p.gerarRemessa===1)for(const na of[p,Y]){const da={...na,gerarRemessa:0};await $db.financeiroBoleto.grava({original:na,atual:da})}}}let v=[];this.$refs.faturamento.idDocumentoCaixa&&(v=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa})),l=await $db.financeiroTitulo.le({idFatura:d.id});let N=await $db.financeiroTitulo.le({idFatura:d.id});for(const h of $utils.clonar(l)){if(!h.idFinanceiroMovimentacaoAgrupamento)continue;const p=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:h.idFinanceiroMovimentacaoAgrupamento});for(const n of p){const $=await $db.financeiroTitulo.le({id:n.idFinanceiroTitulo});$.idDocumentoCaixa===this.$refs.faturamento.idDocumentoCaixa&&(l=l.concat($))}}let R=!1;for(const h of B){const p=await $db.financeiroTitulo.le({id:h.idFinanceiroTitulo});if(Object.keys(p).length){let n=[];n=v.filter($=>$.idFinanceiroMovimentacaoN===p.idFinanceiroMovimentacaoAgrupamento),f=f.concat(n),n=v.filter($=>$.idFinanceiroTitulo===p.id),f=f.concat(n),n=v.filter($=>$.idFinanceiroCheque===p.id),f=f.concat(n),l=l.concat(p)}h.idFinanceiroTitulo="",h.sinal===1&&(R=!0)}N=await $db.financeiroTitulo.le({idFatura:d.id,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const h of N){if(!h.idFinanceiroMovimentacaoAgrupamento)continue;const p=await $db.financeiroMovimentacao.le({idFinanceiroMovimentacaoN:h.idFinanceiroMovimentacaoAgrupamento});f=f.concat(p);const n=await $db.financeiroRenegociacao.le({idFinanceiroMovimentacaoN:h.idFinanceiroMovimentacaoAgrupamento});j=j.concat(n)}if(N=await $db.financeiroTitulo.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:d.id}),l=l.concat(N),d.id){let h=await $db.financeiroMovimentacao.lerV2({documentoTipo:"Devolu\xE7\xE3o",documentoId:d.id});f=f.concat(h),h=await $db.financeiroMovimentacao.lerV2({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:d.id}),f=f.concat(h),h=await $db.financeiroMovimentacao.lerV2({documentoId:d.id});for(const p of h)(await $db.financeiroTitulo.le({id:p.idFinanceiroTitulo})).id||(f=f.concat(p))}const y=await $db.hibrido.lista({table:"documento",where:{idFatura:d.id}});for(const h of y){const p=await $db.financeiroMovimentacao.le({idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa,documentoId:h.id});f=f.concat(p)}let i=[];for(const h in l){const p=l[h].id;i.includes(p)?delete l[h]:i.push(p)}l=l.filter(h=>h),i=[];for(const h in f){const p=f[h].id;i.includes(p)?delete f[h]:i.push(p)}f=f.filter(h=>h),i=[];for(const h in j){const p=j[h].id;i.includes(p)?delete j[h]:i.push(p)}j=j.filter(h=>h);let w=$utils.dataAtual(),T=R?"Aguardando Pagamento":"Aberta";this.documentoStatus=[{id:$utils.uuid(),idDocumento:d.id,operacao:"Fatura",statusOriginal:d.status,statusFinalizado:T,dataHoraEmissao:w,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}],d.status=T,T==="Aberta"&&(d.dataHoraFinalizado=""),T=R?"Aguardando Pagamento":"Aguardando Faturamento";for(const h of F)this.documentoStatus.push({id:$utils.uuid(),idDocumento:h.id,operacao:"Venda de Mercadoria",statusOriginal:h.status,statusFinalizado:T,dataHoraEmissao:w,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa}),h.status=T;for(const h of o)this.documentoStatus.push({id:$utils.uuid(),idDocumento:h.id,operacao:"Envelope",statusOriginal:h.status,statusFinalizado:h.status,dataHoraEmissao:w,cpfUsuario:$db.usuario.logado.numeroDocumentoNacional,idDocumentoCaixa:this.$refs.faturamento.idDocumentoCaixa});for(const h of m)h.status=T;this.fatura=d,this.vendas=F,this.documentosEnvelope=o,this.documentosItem=m}if(this.$q.loading.hide(),r&&await this.finalizar(r),this.$q.loading.show({message:"Processando..."}),r){let v=[],N=[],R=[],y=[],i=[],w=[];v=this.$refs.faturamento.condicaoPagamento.map(T=>T.id),N=this.$refs.faturamento.condicaoPagamentoOriginal.filter(T=>!v.includes(T.id));for(const T of N)if(T.idFinanceiroTitulo&&R.push(T.idFinanceiroTitulo),T.idFormaPagamento){let h;h=await $erp().formaPagamento.get(T.idFormaPagamento),(h||{}).aliquota&&(T.idFinanceiroTituloPagar?R.push(T.idFinanceiroTituloPagar):this.$q.notify("N\xE3o foi poss\xEDvel excluir as movimenta\xE7\xF5es referentes \xE0 aliquota. Exclua-as manualmente."))}for(const T of R){let h;if(h=await $erp().financeiroTitulo.get(T),h.id&&y.push(h),h.idFinanceiroMovimentacaoAgrupamento){let p,n;if(p=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:h.idFinanceiroMovimentacaoAgrupamento}}),n=(p.find($=>$.idFinanceiroCheque)||{}).idFinanceiroCheque,n){let $=await $erp().financeiroTitulo.get(n);$.id&&y.push($)}i.push(...p)}}for(let T of this.carnes){if(!T.id||(T=await $erp().financeiroTitulo.get(T.id),!(T||{}).idFinanceiroMovimentacaoAgrupamento))continue;let h,p;h=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{idFinanceiroMovimentacaoN:T.idFinanceiroMovimentacaoAgrupamento}}),p=await $db.hibrido.lista({table:"financeiroRenegociacao",where:{idFinanceiroMovimentacaoN:T.idFinanceiroMovimentacaoAgrupamento}}),i.push(...h),w.push(...p)}await $db.financeiroTitulo.remove(y),await $db.financeiroMovimentacao.remove(i),await $db.financeiroRenegociacao.remove(w)}else{await $db.financeiroTitulo.remove(l.filter(v=>!(v.carne&&v.idFatura===d.id))),await $db.financeiroMovimentacao.remove(f),await $db.financeiroRenegociacao.remove(j);for(const v of l.filter(N=>N.carne&&N.idFatura===d.id))await $db.financeiroTitulo.grava({original:v,atual:{valorRealizado:0,receberPagar:1,dataPagamento:""}})}return this.fatura.tokenBonusGerado&&!r&&($db.bonus.cancela(this.fatura),this.fatura.tokenBonusGerado=""),await this.salvarFatura(),await this.atualizar(),r?this.$q.notifyPositive("Fatura corrigida."):this.$q.notifyPositive("Fatura reaberta."),!0}catch{this.$q.notify("N\xE3o foi poss\xEDvel reabrir a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async corrigir(){let r,e,d,F;if(r=this.$refs.faturamento.condicaoPagamentoOriginal,e=this.$refs.faturamento.condicaoPagamento,F=$utils.arredondar(this.fatura.totalDocumento||0),d=$utils.arredondar(e.reduce((o,m)=>o+m.valor||0,0)),d!==F){this.$q.notify("Total das condi\xE7\xF5es de pagamento difere do total da fatura");return}if(r.length){let o=!1;e.length||(o=!0);for(const m of e)if(!r.find(B=>B.id===m.id)){o=!0;break}if(!o){this.$q.notify("N\xE3o h\xE1 corre\xE7\xE3o a ser realizada");return}}try{return await new Promise((o,m)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 corrigir esta fatura",title:"Tem certeza?",cancel:{label:"CANCELAR",push:!0,color:"tertiary",flat:!0},ok:{label:"CONTINUAR",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{o()}).onCancel(()=>{m()})}),await this.reabrir(!0),!0}catch{return!1}},async salvarFatura(){var r,e,d,F,o;try{this.$q.loading.show({message:"Processando..."});let m=$utils.clonar(((d=(e=(r=this==null?void 0:this.$refs)==null?void 0:r.faturamento)==null?void 0:e.condicaoPagamento)==null?void 0:d.filter(l=>l==null?void 0:l.valor))||{});for(let l in m)delete m[l].idDocumentoCondicaoPagamento,delete m[l].parcelas,delete m[l].formaPagamento,delete m[l].edicao,delete m[l].codigoDocumento,delete m[l].codigoDocumentoCaixa;const B=(this.carnesOriginal||[]).filter(l=>(this.financeiroTitulo||[]).find(f=>f.id===l.id));if(await $db.fatura.grava({faturaOriginal:this.faturaOriginal,fatura:this.fatura,vendasOriginal:this.vendasOriginal,vendas:this.vendas,documentosEnvelope:this.documentosEnvelope,documentosEnvelopeOriginal:this.documentosEnvelopeOriginal,documentosItemOriginal:this.documentosItemOriginal,documentosItem:this.documentosItem,condicaoPagamentoOriginal:((o=(F=this.$refs)==null?void 0:F.faturamento)==null?void 0:o.condicaoPagamentoOriginal)||{},condicaoPagamento:m,documentoStatus:this.documentoStatus,financeiroTitulo:this.financeiroTitulo,financeiroTituloOriginal:B,financeiroMovimentacao:this.financeiroMovimentacao,financeiroRenegociacao:this.financeiroRenegociacao}),this.receberTitulo.id&&typeof this.receberTitulo.id!="object"){let l=this.carnes.find(f=>f.id===this.receberTitulo.id);l.id&&await $db.financeiroTitulo.grava({original:l,atual:{idFatura:this.fatura.id}}),delete this.receberTitulo.id,await this.atualizar()}if(this.receberTitulo.id&&typeof this.receberTitulo.id=="object"){for(let l of this.receberTitulo.id){let f=this.carnes.find(j=>j.id===l);f.id&&await $db.financeiroTitulo.grava({original:f,atual:{idFatura:this.fatura.id}})}delete this.receberTitulo.id,await this.atualizar()}}catch{this.$q.notify("N\xE3o foi poss\xEDvel salvar a fatura."),this.$q.loading.hide()}finally{this.$q.loading.hide()}},async dialogImpressao(){if(this.carnes.length>0&&(this.fatura.status==="Finalizada"||this.fatura.status!=="Aguardando Pagamento"&&this.fatura.dataHoraFinalizado))return this.impressaoVisivel=!0,new Promise(r=>{this.resolveDialogImpressao=r})},async showContabilidade(){this.faturaTitulos=await $db.hibrido.lista({table:"financeiroTitulo",where:{documentoId:this.fatura.id}}),this.faturaMovimentacoes=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{documentoId:this.fatura.id}});const r={};for(const e of this.faturaMovimentacoes){const d=e.idFinanceiroMovimentacaoN||e.id;r[d]||(r[d]={data:e.dataCompetencia,agrupamento:e.codigoFinanceiroMovimentacaoN,automatico:e.automatico,debito:[],credito:[]}),e.valorCredito?r[d].credito.push(e):r[d].debito.push(e)}this.livroDiario=r},fecharDialogImpressao(){this.impressaoVisivel=!1,this.resolveDialogImpressao()},async reenviarBonus(r){try{$q.loading.show();const d=(await $utils.geeksApi({reenviaWhatsAppBonus:{funcao:"9F17EED5-57F2-4FFD-99B5-5D0C1757DFB7",idFatura:r}})).data.reenviaWhatsAppBonus;d.mensagem.includes("Falha ao enviar mensagem")?$q.notifyError(d.mensagem):$q.notifyPositive(d.mensagem),console.log("REENVIAR BONUS RESP: ",d.mensagem)}catch(e){$q.notifyError("Erro ao reenviar b\xF4nus pelo WhatsApp.",e)}finally{$q.loading.hide()}}},props:{prop:{default:()=>({}),required:!0,type:Object},receberTitulo:{default:()=>({}),type:Object}},mounted(){this.sistemaPai=$utils.sistemaPai(),this.atualizar()}},xo={id:"Fatura",class:"bg-white rounded-borders"},_o={class:"bg-grey-2 rounded-borders q-px-xs q-pb-lg"},ko={class:"bg-grey-2 bordered-radius q-px-xs q-py-md q-mb-md"},qo={class:"q-pa-sm",style:{"margin-top":"-16px"}},Vo={class:"q-pa-sm",style:{"margin-top":"-16px"}};function Mo(r,e,d,F,o,m){const B=J("avatar"),l=J("g-col"),f=J("g-label"),j=J("DocumentoCodigo"),v=J("g-row"),N=J("DocumentoMetas"),R=J("VendaCard"),y=J("EnvelopeCard"),i=J("TituloCard"),w=J("campo"),T=J("Faturamento"),h=J("DocumentosFiscais"),p=J("nomeValor");return c(),O("div",xo,[a(v,{gutter:"sm",items:"center"},{default:t(()=>[a(l,{order:"1 sm0",col:"shrink"},{default:t(()=>[a(B,{imagem:(o.contatos[o.fatura.idContato]||{}).imagem,rotulo:o.fatura.descricaoContato,tamanho:"50"},null,8,["imagem","rotulo"])]),_:1}),a(l,{order:"2 sm1"},{default:t(()=>[a(f,{text:"sub1 medium",lines:"2"},{default:t(()=>[C(z(o.fatura.descricaoContato),1)]),_:1})]),_:1}),a(l,{order:"0 sm3",col:"12 sm-shrink"},{default:t(()=>[a(v,{items:"center",justify:"end"},{default:t(()=>[o.fatura.id?(c(),b(j,{key:0,documento:o.fatura,class:"q-mr-xs"},null,8,["documento"])):P("",!0),o.fatura.status==="Finalizada"||o.fatura.status!=="Aguardando Pagamento"&&o.fatura.dataHoraFinalizado?(c(),b(Z,{key:1,icon:"print",size:"md",color:"primary",round:"",flat:""},{default:t(()=>[a(Ma,null,{default:t(()=>[ea((c(),b(fa,{link:"",separator:""},{default:t(()=>[(c(!0),O(L,null,H(o.configImpressaoFatura,n=>(c(),b(G,{clickable:"",key:n.valor,onClick:$=>r.$imprimir(n.valor,(o.fatura||{}).id||"0")},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"print"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>[C(z(n.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),o.sistemaPai==="optisoul"?(c(!0),O(L,{key:0},H(o.configImpressaoEnvelope,n=>(c(),b(G,{clickable:"",key:n.valor,onClick:$=>r.$imprimir(n.valor,(o.fatura||{}).id||"0")},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"print"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>[C(z(n.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):P("",!0),(c(!0),O(L,null,H(o.configImpressaoCarne,n=>(c(),b(G,{clickable:"",key:n.valor,onClick:$=>r.$imprimir(n.valor,(o.fatura||{}).id||"0")},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"print"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>[C(z(n.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(c(!0),O(L,null,H(o.configImpressaoConvenio,n=>(c(),b(G,{clickable:"",key:n.valor,onClick:$=>r.$imprimir(n.valor,(o.fatura||{}).id||"0")},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"print"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>[C(z(n.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[ia]])]),_:1})]),_:1})):P("",!0),a(Z,{icon:"more_vert",size:"md",color:"tertiary",flat:"",round:""},{default:t(()=>[a(Ma,null,{default:t(()=>[a(fa,{link:"",separator:""},{default:t(()=>{var n;return[o.fatura.id&&!!((n=o.fatura)!=null&&n.tokenBonusGerado)?ea((c(),b(G,{key:0,onClick:e[0]||(e[0]=$=>m.reenviarBonus(o.fatura.id)),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"card_giftcard"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>e[13]||(e[13]=[C("Reenviar o B\xF4nus")])),_:1})]),_:1})]),_:1})),[[ia]]):P("",!0),(c(!0),O(L,null,H(o.configImpressosWhatsapp.filter($=>$.valor),$=>(c(),b(G,{key:$.valor,onClick:W=>m.enviarImpresso("whatsapp",$),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"mdi-whatsapp"})]),_:1}),a(I,null,{default:t(()=>[C(z($.valor),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(c(!0),O(L,null,H(o.configImpressosEmail.filter($=>$.valor),$=>(c(),b(G,{key:$.valor,onClick:W=>m.enviarImpresso("email",$),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"mail"})]),_:1}),a(I,null,{default:t(()=>[C(z($.valor),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),o.fatura.id?ea((c(),b(G,{key:1,clickable:"",onClick:e[1]||(e[1]=$=>r.$refs.documentosFiscais.emitirCupom(o.fatura.id))},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"account_balance"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>e[14]||(e[14]=[C("Emitir cupom")])),_:1})]),_:1})]),_:1})),[[ia]]):P("",!0),o.fatura.id&&r.$utils.mapearStatus(o.fatura).permiteNota?(c(),O(L,{key:2},[ea((c(),b(G,{onClick:e[2]||(e[2]=$=>r.emitirNFeV2({idFatura:o.fatura.id},1,"Venda")),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"account_balance"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>e[15]||(e[15]=[C("NFe de Sa\xEDda/Venda")])),_:1})]),_:1})]),_:1})),[[ia]]),ea((c(),b(G,{onClick:e[3]||(e[3]=$=>r.emitirNFeV2({idFatura:o.fatura.id},0,"Devolu\xE7\xE3o")),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"account_balance"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>e[16]||(e[16]=[C("NFe de Entrada/Devolu\xE7\xE3o")])),_:1})]),_:1})]),_:1})),[[ia]]),ea((c(),b(G,{onClick:e[4]||(e[4]=$=>r.emitirNFeV2({idFatura:o.fatura.id},1,"Remessa")),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"account_balance"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>e[17]||(e[17]=[C("NFe de Remessa")])),_:1})]),_:1})]),_:1})),[[ia]])],64)):P("",!0),o.fatura.id?ea((c(),b(G,{key:3,clickable:"",onClick:e[5]||(e[5]=$=>r.$db.log.show({documentoTipo:"Fatura",documentoId:o.fatura.id}))},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"description"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>e[18]||(e[18]=[C("Ver Log")])),_:1})]),_:1})]),_:1})),[[ia]]):P("",!0)]}),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(v,{gutter:"sm"},{default:t(()=>[a(l,{col:"12"},{default:t(()=>[a(N,{ref:"documentoMetas"},null,512)]),_:1})]),_:1}),a(v,{gutter:"sm"},{default:t(()=>[a(l,{col:"12"},{default:t(()=>[wa("div",_o,[o.vendas.length?(c(),b(v,{key:0},{default:t(()=>[a(l,{col:"12"},{default:t(()=>[a(f,{icon:"shopping_cart sm tertiary left",text:"sub2 medium",class:"q-mt-lg"},{default:t(()=>e[19]||(e[19]=[C(" Vendas ")])),_:1}),a(ya)]),_:1}),(c(!0),O(L,null,H(o.vendas,n=>(c(),b(l,{key:n.id,col:"12"},{default:t(()=>[a(R,{id:n.id,onAtualizar:m.atualizar,onExecutar:m.executar},null,8,["id","onAtualizar","onExecutar"])]),_:2},1024))),128))]),_:1})):P("",!0),o.documentosEnvelope.length?(c(),b(v,{key:1},{default:t(()=>[a(l,{col:"12"},{default:t(()=>[a(f,{icon:"mdi-glasses sm tertiary left",text:"sub2 medium",class:"q-mt-lg"},{default:t(()=>e[20]||(e[20]=[C(" Envelopes ")])),_:1}),a(ya)]),_:1}),(c(!0),O(L,null,H(o.documentosEnvelope,n=>(c(),b(l,{key:n.id,col:"12"},{default:t(()=>[a(y,{id:n.id,onExecutar:m.executar},null,8,["id","onExecutar"])]),_:2},1024))),128))]),_:1})):P("",!0),o.carnes.length?(c(),b(v,{key:2},{default:t(()=>[a(l,{col:"12"},{default:t(()=>[a(f,{icon:"mdi-file-document sm tertiary left",text:"sub2 medium",class:"q-mt-lg"},{default:t(()=>e[21]||(e[21]=[C(" Titulos (Carn\xEAs/Boletos) ")])),_:1}),a(ya)]),_:1}),(c(!0),O(L,null,H(o.carnes,n=>(c(),b(l,{key:n.id,col:"12"},{default:t(()=>[a(i,{onExecutar:m.executar,dados:n},null,8,["onExecutar","dados"])]),_:2},1024))),128))]),_:1})):P("",!0)])]),_:1})]),_:1}),a(v,{gutter:"sm",items:"center",justify:"end"},{default:t(()=>[a(l,{col:"12 md6"},{default:t(()=>[a(v,{items:"center"},{default:t(()=>[a(l,{col:"4 lg3"},{default:t(()=>[a(f,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[22]||(e[22]=[C("Subtotal")])),_:1})]),_:1}),a(l,null,{default:t(()=>[a(f,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[C(z(r.$filters.numero(o.fatura.subTotal,2)),1)]),_:1})]),_:1})]),_:1}),o.permissaoDesconto?(c(),b(v,{key:0,items:"center"},{default:t(()=>[a(l,{col:"4"},{default:t(()=>[a(f,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[23]||(e[23]=[C("Desconto")])),_:1})]),_:1}),a(l,{col:"4"},{default:t(()=>[a(w,{modelValue:o.fatura.totalPercentualDesconto,"onUpdate:modelValue":[e[6]||(e[6]=n=>o.fatura.totalPercentualDesconto=n),e[7]||(e[7]=n=>m.calculaTotais("descontoPercentual"))],error:o.erroCalculo,debounce:500,decimals:"2",suffix:"%","somente-leitura":m.descontoSomenteLeitura,ocultarAjuda:"",tipo:"decimal"},null,8,["modelValue","error","somente-leitura"])]),_:1}),a(l,{col:"4"},{default:t(()=>[a(w,{modelValue:o.fatura.totalDesconto,"onUpdate:modelValue":[e[8]||(e[8]=n=>o.fatura.totalDesconto=n),e[9]||(e[9]=n=>m.calculaTotais("desconto"))],error:o.erroCalculo,errorMessage:o.erroCalculoMsg,"somente-leitura":m.descontoSomenteLeitura,debounce:500,ocultarAjuda:"",tipo:"decimal",decimals:"2"},null,8,["modelValue","error","errorMessage","somente-leitura"])]),_:1})]),_:1})):P("",!0),o.permissaoBonus?(c(),b(v,{key:1,items:"center"},{default:t(()=>[a(l,{col:"4"},{default:t(()=>[a(f,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[24]||(e[24]=[C("B\xF4nus")])),_:1})]),_:1}),a(l,{col:"4"},{default:t(()=>[a(w,{modelValue:o.fatura.tokenBonusUtilizado,"onUpdate:modelValue":[e[10]||(e[10]=n=>o.fatura.tokenBonusUtilizado=n),e[11]||(e[11]=n=>m.calculaTotais("bonus"))],"somente-leitura":m.bonusSomenteLeitura,error:!!o.erroTokenBonusMsg,debounce:500,errorMessage:o.erroTokenBonusMsg,ocultarAjuda:"","rotulo-fixo":"Token do B\xF4nus",mask:"NNNN-NNNN"},null,8,["modelValue","somente-leitura","error","errorMessage"])]),_:1}),a(l,{col:"4"},{default:t(()=>[a(f,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[C(z(r.$filters.numero(o.fatura.totalBonus,2)),1)]),_:1})]),_:1})]),_:1})):P("",!0),a(v,{items:"center"},{default:t(()=>[a(l,{col:"4 lg3"},{default:t(()=>[a(f,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[25]||(e[25]=[C("Total")])),_:1})]),_:1}),a(l,null,{default:t(()=>[a(f,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[C(z(r.$filters.numero(o.fatura.totalDocumento,2)),1)]),_:1})]),_:1})]),_:1}),o.pesoTotal?(c(),b(v,{key:2,items:"center"},{default:t(()=>[a(l,{col:"4 lg3"},{default:t(()=>[a(f,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[26]||(e[26]=[C("Peso Total")])),_:1})]),_:1}),a(l,null,{default:t(()=>[a(f,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[C(" 1,2 "+z(o.pesoTotal),1)]),_:1})]),_:1})]),_:1})):P("",!0),o.pesoBrutoTotal?(c(),b(v,{key:3,items:"center"},{default:t(()=>[a(l,{col:"4 lg3"},{default:t(()=>[a(f,{bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>e[27]||(e[27]=[C("Peso Bruto Total")])),_:1})]),_:1}),a(l,null,{default:t(()=>[a(f,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[C(" 3231,0 "+z(o.pesoBrutoTotal),1)]),_:1})]),_:1})]),_:1})):P("",!0),o.metroCubicoTotal?(c(),b(v,{key:4,items:"center"},{default:t(()=>[a(l,{col:"4 lg3"},{default:t(()=>[a(f,{style:{"line-height":"40px"},bordered:"bottom"},{default:t(()=>e[28]||(e[28]=[C("Metro C\xFAbico Total")])),_:1})]),_:1}),a(l,null,{default:t(()=>[a(f,{text:"right bold",bordered:"bottom",style:{"line-height":"40px"}},{default:t(()=>[C(" 3412,08 "+z(o.metroCubicoTotal),1)]),_:1})]),_:1})]),_:1})):P("",!0)]),_:1})]),_:1}),a(T,{onExecutar:m.executar,onSalvarFatura:m.salvarFatura,documento:o.fatura,ref:"faturamento",class:"q-my-md"},null,8,["onExecutar","onSalvarFatura","documento"]),a(v,{gutter:"sm",items:"center"},{default:t(()=>[a(l,{col:"12"},{default:t(()=>[wa("div",ko,[a(h,{ref:"documentosFiscais",idFatura:o.fatura.id},null,8,["idFatura"])])]),_:1})]),_:1}),r.$db.usuario.desenvolvedor()?(c(),b(v,{key:0,gutter:"sm"},{default:t(()=>[a(l,{col:"12"},{default:t(()=>[a(Va,{onShow:m.showContabilidade,"expand-separator":"",dense:"","expand-icon-class":"q-px-sm","header-class":"q-pa-sm border-bottom",class:"bg-amber-2 border-full bordered-radius"},{header:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"credit_card",size:"sm"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>e[29]||(e[29]=[C("Contabilidade")])),_:1}),a(K,{caption:""},{default:t(()=>e[30]||(e[30]=[C("Apenas desenvolvedores")])),_:1})]),_:1})]),default:t(()=>[o.faturaTitulos.length?(c(),b(fa,{key:0,class:"q-pa-xs"},{default:t(()=>[a(f,{icon:"list sm tertiary left",text:"sub2 medium"},{default:t(()=>e[31]||(e[31]=[C("Titulos")])),_:1}),(c(!0),O(L,null,H(o.faturaTitulos,n=>(c(),b(Va,{key:n.id,dense:"","hide-expand-icon":"","expand-separator":"","header-class":"q-pa-none border-bottom",class:"border-full"},{header:t(()=>[a(v,{gutter:"xs-x",width:"100%",class:"cursor-pointer"},{default:t(()=>[a(l,{col:"6 sm3 md2"},{default:t(()=>[a(w,{modelValue:n.dataVencimento,dense:"",borderless:"","somente-leitura":"",rotulo:"Data vencimento",tipo:"data"},null,8,["modelValue"])]),_:2},1024),a(l,{col:"6 sm3 md2"},{default:t(()=>[a(w,{modelValue:n.dataPagamento||"A pagar",tipo:n.dataPagamento?"data":"texto",dense:"",borderless:"","somente-leitura":"",rotulo:"Data pagamento"},null,8,["modelValue","tipo"])]),_:2},1024),a(l,{col:"6 sm3 md2"},{default:t(()=>[a(w,{modelValue:n.parcela,"somente-leitura":"",borderless:"",align:"left",rotulo:"Parcela"},null,8,["modelValue"])]),_:2},1024),a(l,{col:"6 sm6 md2"},{default:t(()=>[a(w,{modelValue:n.valor,"somente-leitura":"",borderless:"",align:"left",rotulo:"Valor",decimals:"2",tipo:"decimal"},null,8,["modelValue"])]),_:2},1024),a(l,{col:"12 sm6 md2"},{default:t(()=>[a(w,{modelValue:n.formaDePagamento,borderless:"","somente-leitura":"",rotulo:"Forma de pagamento"},null,8,["modelValue"])]),_:2},1024),a(l,{col:"12 sm12 md2"},{default:t(()=>[a(w,{modelValue:n.observacao,borderless:"","somente-leitura":"",rotulo:"Observa\xE7\xE3o"},null,8,["modelValue"])]),_:2},1024)]),_:2},1024)]),default:t(()=>[wa("div",qo,[(c(!0),O(L,null,H(n,($,W)=>(c(),b(f,{key:W,inline:""},{default:t(()=>[a(p,{nome:W,valor:String($)},null,8,["nome","valor"])]),_:2},1024))),128))])]),_:2},1024))),128))]),_:1})):P("",!0),o.faturaMovimentacoes.length?(c(),b(fa,{key:1,class:"q-pa-xs q-pt-lg"},{default:t(()=>[a(f,{icon:"list sm tertiary left",text:"sub2 medium"},{default:t(()=>e[32]||(e[32]=[C("Movimenta\xE7\xF4es")])),_:1}),(c(!0),O(L,null,H(o.faturaMovimentacoes,n=>(c(),b(Va,{key:n.id,dense:"","hide-expand-icon":"","expand-separator":"","header-class":"q-pa-none border-bottom",class:"border-full"},{header:t(()=>[a(v,{gutter:"xs-x",width:"100%",class:"cursor-pointer"},{default:t(()=>[a(l,{col:"6 sm12 md-grow"},{default:t(()=>[a(w,{modelValue:n.descricao,ocultarAjuda:"","somente-leitura":"",borderless:"",rotulo:"Descri\xE7\xE3o"},null,8,["modelValue"])]),_:2},1024),a(l,{col:"6 sm md2"},{default:t(()=>[a(w,{modelValue:n.dataCompetencia,"somente-leitura":"",borderless:"",ocultarAjuda:"",dense:"",rotulo:"Data competencia",tipo:"data"},null,8,["modelValue"])]),_:2},1024),n.valorCredito?(c(),b(l,{key:0,col:"xs sm md2"},{default:t(()=>[a(w,{modelValue:n.valorCredito,"somente-leitura":"",borderless:"",ocultarAjuda:"",align:"left",rotulo:"Valor Credito",decimals:"2",tipo:"decimal"},null,8,["modelValue"])]),_:2},1024)):P("",!0),n.valorDebito?(c(),b(l,{key:1,col:"xs sm md2"},{default:t(()=>[a(w,{modelValue:n.valorDebito,"somente-leitura":"",borderless:"",ocultarAjuda:"",align:"left",rotulo:"Valor Debito",decimals:"2",tipo:"decimal"},null,8,["modelValue"])]),_:2},1024)):P("",!0),a(l,{col:"12 md-grow"},{default:t(()=>[a(w,{modelValue:n.observacao,ocultarAjuda:"",borderless:"","somente-leitura":"",rotulo:"Observa\xE7\xE3o"},null,8,["modelValue"])]),_:2},1024)]),_:2},1024)]),default:t(()=>[wa("div",Vo,[(c(!0),O(L,null,H(n,($,W)=>(c(),b(f,{key:W,inline:""},{default:t(()=>[a(p,{nome:W,valor:String($)},null,8,["nome","valor"])]),_:2},1024))),128))])]),_:2},1024))),128))]),_:1})):P("",!0),Object.keys(o.livroDiario).length?(c(),b(fa,{key:2,class:"q-pa-xs q-pt-lg"},{default:t(()=>[a(f,{icon:"list sm tertiary left",text:"sub2 medium"},{default:t(()=>e[33]||(e[33]=[C("Livro Di\xE1rio - Movimenta\xE7\xE3oN")])),_:1}),(c(!0),O(L,null,H(o.livroDiario,n=>(c(),O("div",{key:n.id,class:"border-full rounded-borders"},[a(v,{class:"q-pl-md q-pt-md"},{default:t(()=>[a(p,{nome:"Data",valor:r.$filters.data(n.data)},null,8,["valor"]),a(p,{nome:"Hora",valor:r.$filters.hora(n.data)},null,8,["valor"]),a(p,{nome:"Autom\xE1tico",valor:n.automatico?"Sim":"N\xE3o"},null,8,["valor"]),a(p,{nome:"C\xF3digo agrupamento",valor:n.agrupamento},null,8,["valor"])]),_:2},1024),n.debito.length?(c(),b(v,{key:0,class:"q-pl-lg q-py-xs"},{default:t(()=>[(c(!0),O(L,null,H(n.debito,$=>(c(),O("div",{key:$.id},[a(p,{nome:"Debito",valor:$.descricao},null,8,["valor"]),a(p,{nome:"Valor",valor:$.valorDebito},null,8,["valor"]),a(p,{nome:"Observa\xE7\xE3o",valor:$.Observa\u00E7\u00E3oervacao},null,8,["valor"])]))),128))]),_:2},1024)):P("",!0),n.credito.length?(c(),b(v,{key:1,class:"q-pl-lg q-py-xs"},{default:t(()=>[(c(!0),O(L,null,H(n.credito,$=>(c(),O("div",{key:$.id},[a(p,{nome:"Credito",valor:$.descricao},null,8,["valor"]),a(p,{nome:"Valor",valor:$.valorCredito},null,8,["valor"]),a(p,{nome:"Observa\xE7\xE3o",valor:$.observacao},null,8,["valor"])]))),128))]),_:2},1024)):P("",!0)]))),128))]),_:1})):P("",!0)]),_:1},8,["onShow"])]),_:1})]),_:1})):P("",!0),a(Sa,{modelValue:o.impressaoVisivel,"onUpdate:modelValue":e[12]||(e[12]=n=>o.impressaoVisivel=n),onKeyup:Ra(m.fecharDialogImpressao,["esc"]),persistent:""},{default:t(()=>[a(za,{container:"",view:"hHh LpR fFf",class:"bg-white rounded-borders",style:{height:"100%","max-height":"350px","max-width":"400px"}},{default:t(()=>[a(Ba,null,{default:t(()=>[a(Ta,null,{default:t(()=>[a(Z,{icon:"arrow_back",flat:"",round:"",dense:"",onClick:m.fecharDialogImpressao},null,8,["onClick"]),a(Na,null,{default:t(()=>e[34]||(e[34]=[C("Imprimir")])),_:1})]),_:1})]),_:1}),a(Aa,null,{default:t(()=>[a(Oa,null,{default:t(()=>[a(fa,{link:"",separator:""},{default:t(()=>[(c(!0),O(L,null,H(o.configImpressaoFatura,n=>(c(),b(G,{clickable:"",key:n.valor,onClick:$=>r.$imprimir(n.valor,(o.fatura||{}).id||"0")},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"print"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>[C(z(n.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),o.sistemaPai==="optisoul"?(c(!0),O(L,{key:0},H(o.configImpressaoEnvelope,n=>(c(),b(G,{key:n.valor,onClick:$=>r.$imprimir(n.valor,(o.fatura||{}).id||"0"),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"print"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>[C(z(n.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)):P("",!0),(c(!0),O(L,null,H(o.configImpressaoCarne,n=>(c(),b(G,{clickable:"",key:n.valor,onClick:$=>r.$imprimir(n.valor,(o.fatura||{}).id||"0")},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"print"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>[C(z(n.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(c(!0),O(L,null,H(o.configImpressaoConvenio,n=>(c(),b(G,{clickable:"",key:n.valor,onClick:$=>r.$imprimir(n.valor,(o.fatura||{}).id||"0")},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"print"})]),_:1}),a(I,null,{default:t(()=>[a(K,null,{default:t(()=>[C(z(n.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(c(!0),O(L,null,H(o.configImpressosWhatsapp.filter(n=>n.valor),n=>(c(),b(G,{key:n.valor,onClick:$=>m.enviarImpresso("whatsapp",n),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"mdi-whatsapp"})]),_:1}),a(I,null,{default:t(()=>[C(z(n.valor),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128)),(c(!0),O(L,null,H(o.configImpressosEmail.filter(n=>n.valor),n=>(c(),b(G,{key:n.valor,onClick:$=>m.enviarImpresso("email",n),clickable:""},{default:t(()=>[a(I,{avatar:""},{default:t(()=>[a(Q,{name:"mail"})]),_:1}),a(I,null,{default:t(()=>[C(z(n.valor),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"])])}var Io=Ia(Po,[["render",Mo]]);const zo={components:{CpfCnpjNoCupom:bo,Fatura:Io},data(){return{fatura:{},cpfCnpjNoCupom:{visivel:!1,incluirCpfCnpjNoCupom:!1,idEmpresa:"",cpfCnpj:"",nomeCliente:"",tipoCaixa:""},visivel:!1,visibilidade:{botao:{finalizar:!1,reabrir:!1,corrigir:!1}},temPermissaoCorrigir:!1}},emits:["executar"],methods:{async atualizar(){let r;try{r=setTimeout(()=>{$q.loading.show({message:"Carregando informa\xE7\xF5es...",boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"})},500);let e=await $db.hibrido.le({table:"documento",id:this.id});this.fatura=e,await this.verificarPermissoes(),this.desativarBotoes(),e.status==="Aberta"&&(this.visibilidade.botao.salvar=!0),e.status==="Finalizada"||e.status!=="Aguardando Pagamento"&&e.dataHoraFinalizado?this.visibilidade.botao.reabrir=!0:this.visibilidade.botao.finalizar=!0,await $db.contato.exibirCondutaObservacao(e.idContato,$q.notify)}finally{clearTimeout(r),$q.loading.hide()}},desativarBotoes(){this.visibilidade.botao.finalizar=!1,this.visibilidade.botao.reabrir=!1,this.visibilidade.botao.salvar=!1},desativarEsc(){this.lockEsc=!0},reativarEsc(){this.lockEsc=!1},async reabrir(){await this.$refs.fatura.reabrir(),await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"))},voltar(r){r.stopPropagation(),!this.lockEsc&&this.fechar()},async finalizar(r){const d={cpfCnpjNoCupom:this.cpfCnpjNoCupom};if(this.lockEsc=!0,!await this.$refs.fatura.finalizar(!1,d)){this.lockEsc=!1;return}await this.$refs.fatura.atualizar(),await this.atualizar(),await this.$refs.fatura.dialogImpressao(),this.$emit("executar","finalizar"),this.fechar()},async executar(r){switch(r){case"finalizar":if(!await this.$refs.fatura.finalizar())return;break;case"retornarOrcamento":case"remover":await this.atualizar(),this.runOnHide.push(()=>$utils.emitter.emit("atualizarAtendimentoFatura"));return}if(r==="atualizarSemFechar"){await this.atualizar(),this.runOnHide.push(()=>this.$emit("executar","atualizar")),await this.$forceUpdate();return}this.$emit("executar",r),this.fechar()},fechar(){this.visivel=!1},async executarRecebimentoMultiplos(r){return await this.$refs.fatura.executarRecebimentoMultiplos(r)},async mostrar(r={}){this.id=r.id,await this.atualizar(),this.visivel=!0},onHide(){this.fatura={},this.visibilidade={botao:{finalizar:!1,reabrir:!1,corrigir:!1}},this.temPermissaoCorrigir=!1,this.runOnHide.forEach(r=>r()),this.runOnHide=[]},async salvar(){try{await new Promise((r,e)=>{$q.dialog({message:"Esta a\xE7\xE3o ir\xE1 salvar esta fatura",title:"Tem certeza?",cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Continuar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(()=>{r()}).onCancel(()=>{e()})})}catch{return}await this.$refs.fatura.salvarFatura(),this.$emit("executar","atualizar"),this.fechar()},corrigir(){this.$refs.fatura.corrigir().then(()=>{this.$emit("executar","atualizar"),this.fechar()})},async verificarPermissoes(){this.temPermissaoCorrigir=await $db.permissao.objeto("caixa/tesouraria")}},props:{receberTitulo:{default:()=>({}),type:Object}},created(){this.runOnHide=[]},mounted(){$utils.emitter.on("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.on("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.on("reativarVoltarEscModal",this.reativarEsc)},beforeUnmount(){$utils.emitter.off("desativarBotoesFaturaModal",this.desativarBotoes),$utils.emitter.off("desativarVoltarEscModal",this.desativarEsc),$utils.emitter.off("reativarVoltarEscModal",this.reativarEsc)}},Bo={id:"FaturaModal"};function No(r,e,d,F,o,m){const B=J("Fatura"),l=J("CpfCnpjNoCupom");return c(),O("div",Bo,[a(Sa,{modelValue:o.visivel,"onUpdate:modelValue":e[0]||(e[0]=f=>o.visivel=f),onKeyup:Ra(m.voltar,["esc"]),onHide:m.onHide,maximized:"",persistent:""},{default:t(()=>[a(za,{container:"",view:"hHh LpR fFf",class:"bg-grey-3"},{default:t(()=>[a(Ba,null,{default:t(()=>[a(Ta,null,{default:t(()=>[ea(a(Z,{icon:"arrow_back",round:"",flat:"",dense:""},null,512),[[ia]]),a(Na,null,{default:t(()=>e[3]||(e[3]=[C("Fatura")])),_:1}),o.visibilidade.botao.salvar?(c(),b(Z,{key:0,onClick:m.salvar,label:"Salvar",color:"white","text-color":"primary",unelevated:""},null,8,["onClick"])):P("",!0),o.visibilidade.botao.reabrir&&o.temPermissaoCorrigir?(c(),b(Z,{key:1,onClick:m.corrigir,label:"Corrigir",color:"white","text-color":"negative",unelevated:""},null,8,["onClick"])):P("",!0)]),_:1})]),_:1}),a(Aa,null,{default:t(()=>[a(Oa,{class:"u-container q-py-md"},{default:t(()=>[o.fatura.id?(c(),b(B,{key:0,onExecutar:m.executar,ref:"fatura",prop:{id:o.fatura.id},receberTitulo:d.receberTitulo},null,8,["onExecutar","prop","receberTitulo"])):P("",!0)]),_:1})]),_:1}),a(Wa,{class:"bg-white",bordered:""},{default:t(()=>[a(Ta,{class:"q-pa-sm u-container"},{default:t(()=>[a(ho),o.visibilidade.botao.reabrir?(c(),b(Z,{key:0,onClick:m.reabrir,label:"Reabrir",color:"negative",flat:"",class:"q-ml-sm"},null,8,["onClick"])):P("",!0),o.visibilidade.botao.reabrir?ea((c(),b(Z,{key:1,label:"Fechar",color:"tertiary",flat:"",class:"q-ml-sm"},null,512)),[[ia]]):P("",!0),o.visibilidade.botao.reabrir?P("",!0):(c(),b(Z,{key:2,onClick:m.finalizar,disabled:!o.visibilidade.botao.finalizar,label:"Finalizar",color:"primary",dark:"",unelevated:"",class:"q-ml-sm"},null,8,["onClick","disabled"]))]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup","onHide"]),a(l,{modelValue:o.cpfCnpjNoCupom.visivel,"onUpdate:modelValue":e[1]||(e[1]=f=>o.cpfCnpjNoCupom.visivel=f),onConfirmar:e[2]||(e[2]=f=>m.finalizar()),dados:o.cpfCnpjNoCupom},null,8,["modelValue","dados"])])}var Lo=Ia(zo,[["render",No]]);export{Lo as F,yo as T};
