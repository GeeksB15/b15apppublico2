import{_ as Co,a5 as ua,r as k,o as C,d as y,w as t,f as o,M as Vo,G as wo,h as lo,i as ho,k as h,t as w,m as X,e as B,H as O,Q as z,N as J,I as yo,J as Do,p as Q,b0 as pa,b1 as qo,b6 as fa,b7 as xo,W as eo,b8 as la,d6 as ia,d7 as K,K as zo,aW as da,D as _o,bj as ma,at as $,b5 as W,s as ko,bg as fo,P as Y,S as j,T as D,j as L,U as H,A as ha,F as oo,u as ro,C as M,l as No,aQ as sa,E as ga,bs as ca,d$ as ba,e0 as va,av as Ia,d8 as Ca,aP as na}from"./index.05370f25.js";import{L as Va}from"./Lista.fc829e5c.js";import{S as wa}from"./SeletorCfop.14fb89ba.js";import{C as ya}from"./Campo.5bec5cdd.js";import"./xlsx.2a90b241.js";const Da={components:{SeletorNcm:ua,SeletorCfop:wa,Campo:ya},data(){return{abaSelecionada:"tab1",historicoItem:[],tabelaHistoricoItem:{colunas:[{name:"fornecedor",label:"Fornecedor",align:"left"},{name:"dataCompra",label:"Data Compra",align:"right"},{name:"quantidade",label:"Quantidade",align:"right"},{name:"valorCusto",label:"Valor de Custo",align:"right"},{name:"valorTotal",label:"Valor Total (Custo)",align:"right"}],paginacao:{page:1,rowsPerPage:5}},estoqueItem:[],tabelaEstoqueItem:{colunas:[{name:"empresa",label:"Empresa",align:"left"},{name:"tipoEstoque",label:"Tipo estoque",align:"right"},{name:"lote",label:"Lote",align:"right"},{name:"quantidade",label:"Quantidade",align:"right"}],paginacao:{page:1,rowsPerPage:5}},compra:{},cfop:null,cstIcms:"",cstIpi:"",contaEstoque:[],impostoCstIpi:[],impostoIcmsModalidade:[],impostoCstIcms:[],impostoCstIcmsSt:[],documentoItem:{},imposto:{},item:{},visivel:!1,contasOpcoes:[],exibirIcms:!1,exibirIcmsSt:!1,exibirIpi:!1,somenteLeituraIcms:!1,somenteLeituraIcmsSt:!1,exibirHistorico:!1,exibirEstoque:!1,exibeCfop:!1}},emits:["salvar"],methods:{async mostrar(r,e,n){var g,l,u,v,p,I,f,c,V,m;this.compra=n,this.documentoItem=$utils.clonarV2(r),this.item=$utils.clonarV2(e),await this.consultarHistoricoItem(this.item),await this.consultarEstoqueItem(this.item);const d=await $db.hibrido.lista({table:"impostoParametro",where:{impParamTipoCod:1}}),a=await $db.hibrido.lista({table:"impostoParametro",where:{impParamTipoCod:21}});this.impostoCstIcms=d.concat(a).map(s=>({rotulo:s.numero.trim()+" - "+s.descr,valor:Number(s.numero)})).sort((s,b)=>Number(s.valor)-Number(b.valor)),this.impostoIcmsModalidade=(await $db.hibrido.lista({table:"impostoParametro",where:{impParamTipoCod:3}})).map(s=>({rotulo:s.numero.trim()+" - "+s.descr,valor:Number(s.numero)})).sort((s,b)=>Number(s.valor)-Number(b.valor)),this.impostoCstIcmsSt=(await $db.hibrido.lista({table:"impostoParametro",where:{impParamTipoCod:4}})).map(s=>({rotulo:s.numero.trim()+" - "+s.descr,valor:Number(s.numero)})).sort((s,b)=>Number(s.valor)-Number(b.valor)),this.impostoCstIpi=(await $db.hibrido.lista({table:"impostoParametro",where:{impParamTipoCod:5}})).map(s=>({rotulo:s.numero.trim()+" - "+s.descr,valor:Number(s.numero)})).sort((s,b)=>Number(s.valor)-Number(b.valor)),this.contaEstoque=(await $db.hibrido.lista({table:"financeiroPlanoConta"})).map(s=>{var b,P,x;return{rotulo:(x=(P=(b=s==null?void 0:s.descricao)!=null?b:" - "+(s==null?void 0:s.classificacao))!=null?P:" - "+(s==null?void 0:s.caminho))!=null?x:"",valor:s.id}}).sort((s,b)=>Number(s.valor)-Number(b.valor));let i;(g=this.documentoItem)!=null&&g.idCfop&&(i=await $erp().cfop.where({id:this.documentoItem.idCfop}).first()),i===void 0&&console.log("CFOP inv\xE1lido"),this.documentoItem.cfop=(l=i==null?void 0:i.cfop.toString())!=null?l:"",this.documentoItem.codigoCfop=(u=i==null?void 0:i.codigoCfop)!=null?u:null,this.documentoItem.idCfop=(v=i.id)!=null?v:null,this.documentoItem.valorBaseIcms=(I=(p=this.documentoItem.valorBaseIcms)!=null?p:this.documentoItem.total)!=null?I:0,this.documentoItem.valorBaseIpi=(c=(f=this.documentoItem.valorBaseIpi)!=null?f:this.documentoItem.total)!=null?c:0,this.documentoItem.valorBaseIcmsSt=(m=(V=this.documentoItem.valorBaseIcmsSt)!=null?V:this.documentoItem.total)!=null?m:0,this.calcularImpostos(),this.exibeCfop=!0,this.visivel=!0},async salvar(){try{if(Object.keys(this.documentoItem.cfop).length>0){const r=await $db.hibrido.lista({table:"cfop",where:{cfop:Number(this.documentoItem.cfop)}});this.documentoItem.codigoCfop=r[0].codigoCfop,this.documentoItem.idCfop=r[0].id}this.documentoItem.cfop&&delete this.documentoItem.cfop,this.$emit("salvar",this.documentoItem),this.exibirIcms=!1,this.exibirIcmsSt=!1,this.exibirIpi=!1,this.visivel=!1}catch(r){$q.notifyError("Ocorreu um erro ao salvar o produto: ",r.message)}finally{$q.notifyPositive("Produto salvo com sucesso.")}},calcularImpostos(r){var I,f,c,V,m,s,b,P,x,E;let e=(I=this.documentoItem.valorBaseIcms)!=null?I:0,n=(f=this.documentoItem.valorBaseIpi)!=null?f:0,d=(c=this.documentoItem.valorBaseIcmsSt)!=null?c:0,a=(V=this.documentoItem.percentualIcms)!=null?V:0,i=(m=this.documentoItem.percentualIpi)!=null?m:0,g=(s=this.documentoItem.percentualIVA)!=null?s:0,l=(b=this.documentoItem.percentualIcmsSt)!=null?b:0,u=(P=this.documentoItem.valorIcms)!=null?P:0,v=(x=this.documentoItem.valorIpi)!=null?x:0,p=(E=this.documentoItem.valorIcmsSt)!=null?E:0;["valorBaseIcms","percentualIcms"].includes(r)&&(u=e*a/100),r==="valorIcms"&&(a=u/e*100),["valorBaseIpi","percentualIpi"].includes(r)&&(v=n*i/100),r==="valorIpi"&&(i=v/n*100),r==="valorBaseIcmsSt"&&(g=0,d>0&&e>0&&d>=e&&(g=(d-e)/e*100),p=d*l/100-u),r==="percentualIVA"&&(d=e*(1+g/100),p=d*l/100-u),r==="percentualIcmsSt"&&(p=d*l/100-u),r==="valorIcmsSt"&&(l=p/d*100),this.documentoItem.valorBaseIcmsSt=parseFloat(d.toFixed(2)),this.documentoItem.percentualIcms=parseFloat(a.toFixed(2)),this.documentoItem.percentualIcmsSt=parseFloat(l.toFixed(2)),this.documentoItem.percentualIpi=parseFloat(i.toFixed(2)),this.documentoItem.percentualIVA=parseFloat(g.toFixed(2)),this.documentoItem.valorIcms=parseFloat(u.toFixed(2)),this.documentoItem.valorIcmsSt=parseFloat(p.toFixed(2)),this.documentoItem.valorIpi=parseFloat(v.toFixed(2)),(this.documentoItem.modalidadeBaseCalculo||this.documentoItem.codigoCst||this.documentoItem.percentualIcms>0||this.documentoItem.valorIcms>0)&&(this.exibirIcms=!0),(this.documentoItem.modalidadeBaseCalculoST||this.documentoItem.percentualIcmsSt>0||this.documentoItem.valorIcmsSt>0)&&(this.exibirIcmsSt=!0),(this.documentoItem.codigoCstIpi||this.documentoItem.percentualIpi>0||this.documentoItem.valorIpi>0)&&(this.exibirIpi=!0)},async consultarCFOP(){var n,d;const r=this.documentoItem.cfop,e=await $erp().cfop.where({cfop:Number(r)}).first();e===void 0&&console.log("CFOP inv\xE1lido"),this.documentoItem.idCfop=(n=e==null?void 0:e.id)!=null?n:null,this.documentoItem.codigoCfop=(d=e==null?void 0:e.CodigoCFOP)!=null?d:null},async consultarHistoricoItem(r){const e={};(r==null?void 0:r.atual)&&Object.keys(r.atual).length>0&&(r=r.atual);const d=(await $db.hibrido.lista({table:"documentoItem",where:{idItem:r.id}})).filter(a=>(a.operacao==="Compra"||a.operacao==="Compra de Mercadoria")&&a.status==="Finalizado"&&a.operacaoFator===1&&a.quantidade>0);for(const a of d){const i=await $db.hibrido.le({table:"documento",id:a.idDocumento}),g=await $db.hibrido.le({table:"contato",id:i.idContato});e[a.idItem]||(e[a.idItem]={fornecedores:[]}),e[a.idItem].fornecedores.push({fornecedor:g.apelido||"",dataCompra:i.dataCompra||"",quantidade:a.quantidade||"",valorCusto:a.valorItem||"",valorTotal:a.valorItem*a.quantidade||""})}Object.keys(e).length>0?(this.historicoItem=e,this.historicoItem[r.id].fornecedores.sort((a,i)=>{const g=new Date(a.dataCompra||"1900-01-01");return new Date(i.dataCompra||"1900-01-01")-g})):this.historicoItem[r.id]={fornecedores:[]},this.exibirHistorico=!0},async consultarEstoqueItem(r){const e={};(r==null?void 0:r.atual)&&Object.keys(r.atual).length>0&&(r=r.atual);const n=await $db.hibrido.lista({table:"estoqueSaldoProdutoEmpresa",where:{idItem:r.id},whereFilter:{tipoEstoque:"Dispon\xEDvel"}});for(const d of n){const a=await $db.hibrido.le({table:"contato",id:d.idEmpresa});e[d.idItem]||(e[d.idItem]={estoques:[]}),e[d.idItem].estoques.push({empresa:a.apelido||"",tipoEstoque:d.tipoEstoque||"",lote:d.lote||"-",quantidade:d.saldo||""})}Object.keys(e).length>0?(this.estoqueItem=e,this.estoqueItem[r.id].estoques.sort((d,a)=>{const i=Number(d.quantidade||0);return Number(a.quantidade||0)-i})):this.estoqueItem[r.id]={estoques:[]},this.exibirEstoque=!0},async fechar(){this.documentoItem.cfop&&delete this.documentoItem.cfop,this.exibirIcms=!1,this.exibirIcmsSt=!1,this.exibirIpi=!1}}},_a=["src"],Ea={key:0},Pa={key:0};function Fa(r,e,n,d,a,i){const g=k("badge"),l=k("g-col"),u=k("g-row"),v=k("campo"),p=k("SeletorNcm"),I=k("SeletorCfop"),f=k("g-label");return C(),y(_o,{modelValue:a.visivel,"onUpdate:modelValue":e[36]||(e[36]=c=>a.visivel=c),persistent:""},{default:t(()=>[o(Vo,{container:"",view:"hHh Lpr fFf",class:"bg-white",style:{"max-width":"980px"}},{default:t(()=>[o(wo,{class:"bg-primary"},{default:t(()=>[o(lo,{class:"bg-primary text-white"},{default:t(()=>[o(ho,null,{default:t(()=>[h(w(a.documentoItem.descricaoItem),1)]),_:1}),a.item.referencia?(C(),y(g,{key:0,cor:"tertiary",class:"q-mr-sm"},{default:t(()=>[h(w(a.item.referencia)+" ",1),o(X,null,{default:t(()=>[h(" Refer\xEAncia ")]),_:1})]),_:1})):B("",!0),a.item.codigoItem?(C(),y(g,{key:1,cor:"positive",class:"q-mr-sm"},{default:t(()=>[h(" #"+w(a.item.codigoItem.toString().padStart(4,"0"))+" ",1),o(X,null,{default:t(()=>[h(" C\xF3digo Item ")]),_:1})]),_:1})):B("",!0),O(o(z,{onClick:i.fechar,dense:"",flat:"",icon:"close",round:""},null,8,["onClick"]),[[J]])]),_:1})]),_:1}),o(yo,null,{default:t(()=>[o(Do,null,{default:t(()=>[o(u,{gutter:"md"},{default:t(()=>[o(l,null,{default:t(()=>[o(u,{class:"col-12 text-center"},{default:t(()=>[o(l,null,{default:t(()=>{var c,V,m,s,b,P;return[((c=a.item)==null?void 0:c.imagem)||((m=(V=a.item)==null?void 0:V.atual)==null?void 0:m.imagem)?(C(),Q("img",{key:0,src:((s=a.item)==null?void 0:s.imagem)||((P=(b=a.item)==null?void 0:b.atual)==null?void 0:P.imagem),alt:"",style:{"max-width":"33%"}},null,8,_a)):B("",!0)]}),_:1})]),_:1}),o(pa,{modelValue:a.abaSelecionada,"onUpdate:modelValue":e[0]||(e[0]=c=>a.abaSelecionada=c),align:"justify",dense:"","indicator-color":"light-blue-4",class:"text-primary q-px-sm"},{default:t(()=>[o(qo,{default:"",name:"tab1",icon:"info",label:"Detalhes",class:"cinza"}),o(qo,{name:"tab2",icon:"history",label:"Compras",class:"cinza"}),o(qo,{name:"tab3",icon:"compare_arrows",label:"Estoque",class:"cinza"})]),_:1},8,["modelValue"]),o(fa,{modelValue:a.abaSelecionada,"onUpdate:modelValue":e[35]||(e[35]=c=>a.abaSelecionada=c),animated:"",class:"text-tertiary"},{default:t(()=>[o(xo,{name:"tab1",class:"q-px-sm"},{default:t(()=>[o(u,null,{default:t(()=>[o(l,null,{default:t(()=>[o(v,{modelValue:a.documentoItem.observacao,"onUpdate:modelValue":e[1]||(e[1]=c=>a.documentoItem.observacao=c),tipo:"textoArea",rotulo:"Observa\xE7\xE3o",dense:"",rows:"4"},null,8,["modelValue"])]),_:1})]),_:1}),o(u,{mg:"lg-t"},{default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(v,{modelValue:a.documentoItem.referenciaFornecedor,"onUpdate:modelValue":e[2]||(e[2]=c=>a.documentoItem.referenciaFornecedor=c),rotulo:"Refer\xEAncia Fornecedor"},null,8,["modelValue"])]),_:1})]),_:1}),o(u,{mg:"lg-t"},{default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(p,{modelValue:a.documentoItem.ncm,"onUpdate:modelValue":e[3]||(e[3]=c=>a.documentoItem.ncm=c),class:"col-12 col-md-6",outlined:""},null,8,["modelValue"])]),_:1})]),_:1}),o(u,{mg:"lg-t"},{default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(I,{modelValue:a.documentoItem.cfop,"onUpdate:modelValue":e[4]||(e[4]=c=>a.documentoItem.cfop=c),class:"col-12 col-md-6",outlined:""},null,8,["modelValue"])]),_:1})]),_:1}),o(u,{mg:"lg-t"},{default:t(()=>[o(l,null,{default:t(()=>[o(f,{text:"sub1 medium"},{default:t(()=>[h("Estoque")]),_:1})]),_:1})]),_:1}),o(u,{items:"center"},{default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(v,{modelValue:a.documentoItem.idPlanoContaEstoque,"onUpdate:modelValue":e[5]||(e[5]=c=>a.documentoItem.idPlanoContaEstoque=c),opcoes:a.contaEstoque,tipo:"seletor",ajuda:"Plano de Conta de Estoque para Entrada de Mercadoria",dense:"",outlined:"",rotulo:"Conta Estoque"},null,8,["modelValue","opcoes"])]),_:1})]),_:1}),o(u,{mg:"lg-t"},{default:t(()=>[o(l,null,{default:t(()=>[o(f,{text:"sub1 medium"},{default:t(()=>[h("Impostos")]),_:1})]),_:1})]),_:1}),o(u,null,{default:t(()=>[o(eo,{label:"ICMS",modelValue:a.exibirIcms,"onUpdate:modelValue":e[6]||(e[6]=c=>a.exibirIcms=c)},null,8,["modelValue"])]),_:1}),a.exibirIcms?(C(),y(u,{key:0,items:"center"},{default:t(()=>[o(l,{col:"12 sm6"},{default:t(()=>[o(v,{modelValue:a.documentoItem.modalidadeBaseCalculo,"onUpdate:modelValue":e[7]||(e[7]=c=>a.documentoItem.modalidadeBaseCalculo=c),opcoes:a.impostoIcmsModalidade,"somente-leitura":a.somenteLeituraIcms,tipo:"seletor",outlined:"",rotulo:"ICMS (Modalidade)"},null,8,["modelValue","opcoes","somente-leitura"])]),_:1}),o(l,{col:"12 sm6"},{default:t(()=>[o(v,{modelValue:a.documentoItem.codigoCst,"onUpdate:modelValue":e[8]||(e[8]=c=>a.documentoItem.codigoCst=c),opcoes:a.impostoCstIcms,"somente-leitura":a.somenteLeituraIcms,tipo:"seletor",outlined:"",rotulo:"CST ICMS"},null,8,["modelValue","opcoes","somente-leitura"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.valorBaseIcms,"onUpdate:modelValue":e[9]||(e[9]=c=>a.documentoItem.valorBaseIcms=c),onBlur:e[10]||(e[10]=c=>i.calcularImpostos("valorBaseIcms")),"somente-leitura":a.somenteLeituraIcms,tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"Base ICMS"},null,8,["modelValue","somente-leitura"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.percentualIcms,"onUpdate:modelValue":e[11]||(e[11]=c=>a.documentoItem.percentualIcms=c),onBlur:e[12]||(e[12]=c=>i.calcularImpostos("percentualIcms")),"somente-leitura":a.somenteLeituraIcms,tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"ICMS %"},null,8,["modelValue","somente-leitura"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.valorIcms,"onUpdate:modelValue":e[13]||(e[13]=c=>a.documentoItem.valorIcms=c),onBlur:e[14]||(e[14]=c=>i.calcularImpostos("valorIcms")),"somente-leitura":a.somenteLeituraIcms,tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"Valor ICMS"},null,8,["modelValue","somente-leitura"])]),_:1})]),_:1})):B("",!0),o(u,null,{default:t(()=>[o(eo,{label:"ICMS ST",modelValue:a.exibirIcmsSt,"onUpdate:modelValue":e[15]||(e[15]=c=>a.exibirIcmsSt=c)},null,8,["modelValue"])]),_:1}),a.exibirIcmsSt?(C(),y(u,{key:1,items:"center"},{default:t(()=>[o(l,{col:"12 sm6"},{default:t(()=>[o(v,{modelValue:a.documentoItem.modalidadeBaseCalculoST,"onUpdate:modelValue":e[16]||(e[16]=c=>a.documentoItem.modalidadeBaseCalculoST=c),opcoes:a.impostoCstIcmsSt,"somente-leitura":a.somenteLeituraIcmsSt,tipo:"seletor",outlined:"",rotulo:"ICMS ST (Modalidade)"},null,8,["modelValue","opcoes","somente-leitura"])]),_:1}),o(l,{col:"12 sm6"},{default:t(()=>[o(v,{modelValue:a.documentoItem.percentualIVA,"onUpdate:modelValue":e[17]||(e[17]=c=>a.documentoItem.percentualIVA=c),onBlur:e[18]||(e[18]=c=>i.calcularImpostos("percentualIVA")),tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"IVA (%)"},null,8,["modelValue"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.valorBaseIcmsSt,"onUpdate:modelValue":e[19]||(e[19]=c=>a.documentoItem.valorBaseIcmsSt=c),onBlur:e[20]||(e[20]=c=>i.calcularImpostos("valorBaseIcmsSt")),"somente-leitura":a.somenteLeituraIcmsSt,tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"Base ICMS ST"},null,8,["modelValue","somente-leitura"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.percentualIcmsSt,"onUpdate:modelValue":e[21]||(e[21]=c=>a.documentoItem.percentualIcmsSt=c),onBlur:e[22]||(e[22]=c=>i.calcularImpostos("percentualIcmsSt")),"somente-leitura":a.somenteLeituraIcmsSt,tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"ICMS ST (%)"},null,8,["modelValue","somente-leitura"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.valorIcmsSt,"onUpdate:modelValue":e[23]||(e[23]=c=>a.documentoItem.valorIcmsSt=c),onBlur:e[24]||(e[24]=c=>i.calcularImpostos("valorIcmsSt")),"somente-leitura":a.somenteLeituraIcmsSt,tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"Valor ICMS ST"},null,8,["modelValue","somente-leitura"])]),_:1})]),_:1})):B("",!0),o(u,null,{default:t(()=>[o(eo,{label:"IPI",modelValue:a.exibirIpi,"onUpdate:modelValue":e[25]||(e[25]=c=>a.exibirIpi=c)},null,8,["modelValue"])]),_:1}),a.exibirIpi?(C(),y(u,{key:2,items:"center"},{default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(v,{modelValue:a.documentoItem.codigoCstIpi,"onUpdate:modelValue":e[26]||(e[26]=c=>a.documentoItem.codigoCstIpi=c),opcoes:a.impostoCstIpi,tipo:"seletor",dense:"",outlined:"",rotulo:"CST IPI"},null,8,["modelValue","opcoes"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.valorBaseIpi,"onUpdate:modelValue":e[27]||(e[27]=c=>a.documentoItem.valorBaseIpi=c),onBlur:e[28]||(e[28]=c=>i.calcularImpostos("valorBaseIpi")),tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"Base IPI"},null,8,["modelValue"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.percentualIpi,"onUpdate:modelValue":e[29]||(e[29]=c=>a.documentoItem.percentualIpi=c),onBlur:e[30]||(e[30]=c=>i.calcularImpostos("percentualIpi")),tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"IPI %"},null,8,["modelValue"])]),_:1}),o(l,{col:"12 sm4"},{default:t(()=>[o(v,{modelValue:a.documentoItem.valorIpi,"onUpdate:modelValue":e[31]||(e[31]=c=>a.documentoItem.valorIpi=c),onBlur:e[32]||(e[32]=c=>i.calcularImpostos("valorIpi")),tipo:"decimal",decimals:"2",zerosDireita:"2",dense:"",outlined:"",rotulo:"Valor IPI"},null,8,["modelValue"])]),_:1})]),_:1})):B("",!0)]),_:1}),o(xo,{name:"tab2",class:"q-px-sm"},{default:t(()=>[a.exibirHistorico?(C(),y(la,{key:0,rows:a.historicoItem[a.documentoItem.idItem].fornecedores,columns:a.tabelaHistoricoItem.colunas,pagination:a.tabelaHistoricoItem.paginacao,"onUpdate:pagination":e[33]||(e[33]=c=>a.tabelaHistoricoItem.paginacao=c),"row-key":"index",class:"no-shadow text-left"},{body:t(c=>[o(ia,{props:c},{default:t(()=>[o(K,{key:"fornecedor",props:c},{default:t(()=>[h(w(c.row.fornecedor),1)]),_:2},1032,["props"]),o(K,{key:"dataCompra",props:c},{default:t(()=>[c.row.dataCompra!==""?(C(),Q("span",Ea,w(r.$filters.data(c.row.dataCompra)),1)):B("",!0)]),_:2},1032,["props"]),o(K,{key:"quantidade",props:c},{default:t(()=>[h(w(c.row.quantidade),1)]),_:2},1032,["props"]),o(K,{key:"valorCusto",props:c},{default:t(()=>[h(w(r.$filters.numero(c.row.valorCusto,2)),1)]),_:2},1032,["props"]),o(K,{key:"valorTotal",props:c},{default:t(()=>[h(w(r.$filters.numero(c.row.valorTotal,2)),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","pagination"])):B("",!0)]),_:1}),o(xo,{name:"tab3",class:"q-px-sm"},{default:t(()=>[a.exibirEstoque?(C(),y(la,{key:0,rows:a.estoqueItem[a.documentoItem.idItem].estoques,columns:a.tabelaEstoqueItem.colunas,pagination:a.tabelaEstoqueItem.paginacao,"onUpdate:pagination":e[34]||(e[34]=c=>a.tabelaEstoqueItem.paginacao=c),"row-key":"index",class:"no-shadow text-left"},{body:t(c=>[o(ia,{props:c},{default:t(()=>[o(K,{key:"empresa",props:c},{default:t(()=>[h(w(c.row.empresa),1)]),_:2},1032,["props"]),o(K,{key:"tipoEstoque",props:c},{default:t(()=>[h(w(c.row.tipoEstoque),1)]),_:2},1032,["props"]),o(K,{key:"lote",props:c},{default:t(()=>[c.row.lote!==""?(C(),Q("span",Pa,w(c.row.lote),1)):B("",!0)]),_:2},1032,["props"]),o(K,{key:"quantidade",props:c},{default:t(()=>[h(w(c.row.quantidade),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows","columns","pagination"])):B("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),o(zo,{class:"bg-light q-pa-sm",bordered:""},{default:t(()=>[o(lo,null,{default:t(()=>[o(da),O(o(z,{onClick:i.fechar,label:"Cancelar",size:"md",flat:"","no-ripple":"",color:"tertiary",class:"q-mr-sm"},null,8,["onClick"]),[[J]]),o(z,{onClick:i.salvar,label:"Salvar",color:"primary","no-ripple":"",unelevated:""},null,8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])}var Sa=Co(Da,[["render",Fa]]);const qa={components:{ModalEditarProdutoCompras:Sa,PromptItemV2:ma},data(){return{ehOrcamento:!0,adicionar:{modal:{value:!1,name:""}},dataPrevistaEntrega:"",horaPrevistaEntrega:"",contatos:{},compraOriginal:{},compra:{id:$utils.uuid(),codigoDocumento:null,tipo:"Compra",operacao:"Pedido de Compra",status:"Digita\xE7\xE3o",codigoEmpresa:null,descricaoEmpresa:"",numeroDocumentoEmpresa:"",codigoContato:null,descricaoContato:"",codigoContatoComprador:null,codigoContatoVendedor:null,idContatoComprador:null,dataHoraEmissao:new Date,tipoFrete:"CIF",tipoTransporte:null,idEmpresa:null,idContato:null,totalDesconto:0,totalPercentualDesconto:0,calcularTributacao:!0,totalComImposto:!0,naoGerarFinanceiro:!1,freteSeparado:!1,dataHoraPrevisto:null,valorBaseIcms:0,valorIcms:0,valorBaseIcmsSt:0,valorIcmsSt:0},compraItens:[],compraItensOriginal:[],produtos:[],condicoesDePagamento:[],formasDePagamento:[],visivel:!1,somenteLeitura:!1,condicaoPagamentoRules:[async()=>{const r=this.compra.condicaoPagamento;return/^[\d/]*$/.test(r)}],formaPagamentoRules:[async()=>{const r=this.compra.formaDePagamento;return/^[^\d\s][a-zA-Z\s]*[^\d\s]$/.test(r)}],erroDesconto:!1,erroFrete:!1,erroSeguro:!1,erroOutrasDespesas:!1,itensImagens:{},exibeInfNota:!1,documentoNovo:!1,valorTotalPagamento:0,sku:0,operacao:"",excluir:!1,alterarPrevisaoEntrega:!1}},emits:["atualizar"],computed:{skus(){return this.compraItens.length>0?`${Number(this.compraItens.length)}`:"0"}},methods:{editarProduto(r){const e=this.produtos[r.idItem],n=this.compra;this.$refs.ModalEditarProdutoCompras.mostrar(r,e,n)},removerItem(r){this.compraItens=this.compraItens.filter(e=>e.id!==r.id),this.calcularTotais()},fecharEdicaoProduto(r){const e=this.compraItens.findIndex(n=>n.id===r.id);this.compraItens[e]=$utils.clonarV2(r),this.calcularTotaisItem(e)},async atualizar({id:r}){var e,n,d,a,i,g,l;try{if(this.$q.loading.show(),(e=this.compra)!=null&&e.idEmpresa){const u=this.compra.idEmpresa||null;u&&!this.contatos[u]&&(this.contatos[u]=await $db.contato.le({id:u}))}if((n=this.compra)!=null&&n.idContato){const u=this.compra.idContato;this.contatos[u]||(this.contatos[u]=await $db.contato.le({id:u}))}if((d=this.compra)!=null&&d.idContatoComprador){const u=this.compra.idContatoComprador;this.contatos[u]||(this.contatos[u]=await $db.contato.le({id:u}))}if((a=this.compra)!=null&&a.idContatoVendedor){const u=this.compra.idContatoVendedor;this.contatos[u]||(this.contatos[u]=await $db.contato.le({id:u}))}if((i=this.compra)!=null&&i.idContatoTransportadora){const u=this.compra.idContatoTransportadora;this.contatos[u]||(this.contatos[u]=await $db.contato.le({id:u}))}this.compraItensOriginal=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:(g=this.compra)==null?void 0:g.id}}),this.compraItensImagens=$utils.clonarV2(this.compraItensOriginal),await this.processarImagem(this.compraItensImagens),this.compraItens=$utils.clonarV2(this.compraItensOriginal);for(let u in this.compraItens)this.produtos[this.compraItens[u].idItem]=await $db.item.leNew({id:this.compraItens[u].idItem});if(this.condicoesDePagamento=await $db.hibrido.lista({table:"documentoCondicaoPagamento",where:{idDocumento:(l=this.compra)==null?void 0:l.id}}),this.condicoesDePagamento.sort((u,v)=>{let p=new Date(u.dataVencimento),I=new Date(v.dataVencimento);return p-I}),this.valorTotalPagamento===0)for(const u of this.condicoesDePagamento)this.valorTotalPagamento=this.valorTotalPagamento+u.valor;this.compra.dataHoraPrevisto&&(this.dataPrevistaEntrega=this.compra.dataHoraPrevisto.slice(0,10),this.horaPrevistaEntrega=this.compra.dataHoraPrevisto.slice(11,16)),this.exibeInfNota=!0}catch(u){console.log(u.message)}finally{this.$q.loading.hide()}},verificarSeAlterouCampos(){return $utils.diferencaObjetos(this.compraOriginal,this.compra)},async salvar_click(){try{if(this.compra.idContato||(this.compra.idContato=$db.usuario.logado.id),this.dataPrevistaEntrega){const r=`${this.dataPrevistaEntrega} ${this.horaPrevistaEntrega||"00:00:00"}`;this.compra.dataHoraPrevisto=$.formatDate(r)}$q.loading.show(),await this.salvar(),this.$emit("atualizar",{aba:"Digita\xE7\xE3o"}),this.ocultarModal()}catch(r){$q.notifyError("Ocorreu um erro ao salvar",r)}finally{$q.loading.hide(),this.compra.operacao==="Pedido de Compra"?$q.notifyPositive("O Pedido de Compra foi salvo com sucesso."):this.compra.operacao==="Nota de Entrada"&&$q.notifyPositive("A Nota de Compra foi salva com sucesso.")}},async excluir_click(){$q.dialog({title:"Excluir compra",message:`Deseja excluir ${this.compra.operacao==="Pedido de Compra"?`o ${this.compra.operacao}?`:`a ${this.compra.operacao}?`}`,cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-negative",textColor:"white",flat:!0},persistent:!0}).onOk(async()=>{try{$q.loading.show(),this.excluir=!0,this.operacao=this.compra.operacao,await $db.compra.remove(this.compra),await this.fechar()}catch(r){$q.notifyError(`Erro ao excluir o documento de ${this.operacao}!`),console.log(r)}finally{$q.loading.hide(),$q.notifyPositive(`${this.operacao} foi excluido com sucesso!`)}}).onCancel(async()=>{})},async criar(){try{let r,e,n;if(e=(await $db.contato.ler({filtros:{ativo:!0,empresas:!0}})).data,!(e.length>0)){this.$q.notify({message:"N\xE3o h\xE1 empresa configurada",timeout:0,type:"negative",closeBtn:!0});return}if(r=e[0],e.length>1){const a={ativo:!0,empresas:!0};if(r=await $g.promptContato.show({filtro:a,placeholder:"Selecione a empresa"}),!r){this.ocultarModal(),this.$q.notifyError("Empresa n\xE3o selecionada");return}}if(n=(await $db.hibrido.lista({table:"empresa",where:{idContato:r.id}}))[0],!n){this.ocultarModal(),this.$q.notifyError("Erro ao selecionar empresa");return}if(this.contatos[r.id]||(this.contatos[r.id]=await $db.contato.le({id:r.id})),this.compra.descricaoEmpresa=n.nome,this.compra.idEmpresa=n.idContato,this.compra.numeroDocumentoEmpresa=n.numeroDocumentoNacional,this.compra.InscricaoMunicipalEmpresa=n.InscricaoMunicipalEmpresa,this.compra.codigoEmpresa=n.codigoContato,this.compra.dataHoraPrevisto=null,!await this.abrirModalFornecedor()){this.ocultarModal(),this.$q.notifyError("Fornecedor n\xE3o selecionado");return}this.documentoNovo=!0,this.exibeInfNota=!0}catch(r){console.log(r.message)}this.campanha={id:$utils.uuid(),descricao:"Descri\xE7\xE3o",dataHoraCriacao:$utils.dataAtual(),status:"Rascunho",tipo:"Whatsapp",mensagem:"Mensagem",idContato:$db.usuario.logado.id,responsavel:$db.usuario.logado.nome},this.campanhaContato=[],this.campanhaAnexo=[],this.campanhaOriginal={},this.visivel=!0,this.somenteLeitura=!1},async finalizar_click(){if(!this.compra.descricaoContato)return $q.notifyError("N\xE3o \xE9 permitido finalizar a compra sem informar o fornecedor!");if(!this.compra.formaDePagamento&&!this.compra.naoGerarFinanceiro)return $q.notifyError("N\xE3o \xE9 permitido finalizar a compra sem informar a forma de pagamento!");if(this.compraItens.length===0){this.$q.notifyError("N\xE3o \xE9 permitido finalizar compra sem itens!");return}const r=$utils.arredondar(this.condicoesDePagamento.reduce((e,n)=>e+n.valor,0));if(!this.compra.naoGerarFinanceiro&&this.condicoesDePagamento.length>0&&this.compra.totalDocumento!==r)return $q.notifyError("N\xE3o \xE9 permitido finalizar a compra se o valor Total difere da soma das parcelas!");if(!this.compra.naoGerarFinanceiro&&this.condicoesDePagamento.length===0)return $q.notifyError('Verifique se a op\xE7\xE3o "N\xE3o gerar financeiro" est\xE1 marcada, ou adicione as parcelas para finalizar a compra!');if(this.compra.operacao==="Pedido de Compra")try{this.compra.naoGerarFinanceiro?this.compra.naoGerarFinanceiro&&($q.loading.show(),this.compra.status="Finalizado",this.compra.dataHoraFinalizado=$utils.dataAtual(),await this.finalizarItens(),await this.salvar(),this.$emit("atualizar"),this.ocultarModal(),$q.notifyPositive("Compra finalizada com sucesso!")):$q.dialog({title:"Gerar Financeiro",message:"Deseja gerar as provis\xF5es financeiras?",cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},persistent:!0}).onOk(async()=>{this.adicionar.modal.name="GerarFinanceiro",$q.loading.show(),this.compra.status="Finalizado",this.compra.dataHoraFinalizado=$utils.dataAtual(),await this.finalizarItens(),await this.salvar(),this.gerarFinanceiro(this.compra.id),this.$emit("atualizar",{aba:"Finalizado"}),this.ocultarModal(),$q.notifyPositive("Compra finalizada com sucesso!"),$q.notifyPositive("Provisionamento gerado com sucesso!")}).onCancel(async()=>{$q.loading.show(),this.compra.status="Finalizado",this.compra.dataHoraFinalizado=$utils.dataAtual(),await this.finalizarItens(),await this.salvar(),this.$emit("atualizar"),this.ocultarModal(),$q.notifyPositive("Compra finalizada com sucesso!")})}catch(e){$q.notifyError("Ocorreu um erro!",e)}finally{$q.loading.hide()}if(this.compra.operacao==="Nota de Entrada"){if(!this.compra.notaNumero)return $q.notifyError("N\xE3o \xE9 permitido finalizar a compra sem informar o n\xFAmero da Nota de Entrada!");if(!this.compra.notaSerie)return $q.notifyError("N\xE3o \xE9 permitido finalizar a compra sem informara s\xE9rie da Nota de Entrada!");if(!this.compra.naturezaOperacao)return $q.notifyError("N\xE3o \xE9 permitido finalizar a compra sem informar natureza de opera\xE7\xE3o da Nota de Entrada!");if(!this.compra.dataCompra)return $q.notifyError("N\xE3o \xE9 permitido finalizar a compra sem informar a data de compra da Nota de Entrada!");if(!this.compra.chaveAcesso)return $q.notifyError("N\xE3o \xE9 permitido finalizar a compra sem informar a chave de acesso da Nota de Entrada!");if($q.loading.show(),this.compra.naoGerarFinanceiro){if(this.compra.naoGerarFinanceiro){try{this.compra.dataHoraFinalizado=$utils.dataAtual(),this.compra.status="Finalizado",await this.finalizarItens()}catch(e){console.log(e.message())}await this.salvar(),this.$emit("atualizar"),this.ocultarModal(),$q.notifyPositive("Compra finalizada com sucesso!")}}else{try{this.compra.dataHoraFinalizado=$utils.dataAtual(),this.compra.status="Finalizado",await this.finalizarItens()}catch(e){console.log(e.message())}await this.salvar(),this.gerarFinanceiro(this.compra.id),this.$emit("atualizar"),this.ocultarModal(),$q.notifyPositive("Compra finalizada com sucesso!"),$q.notifyPositive("Provisionamento gerado com sucesso!")}}},async finalizarItens(){var r,e,n,d,a,i,g,l,u,v,p,I,f,c,V,m,s,b,P,x,E,A,T,U,Z,R,io,go,so,no,mo,N,G,ao,bo,to,vo,co,To,Uo,Mo,Bo,Oo,Ho,Ao,Lo,$o,jo,Ro,Xo,Qo,Go,Wo,Zo,Jo,Ko,Yo,oa,aa,ea,ta;try{const _=this.compraItens,Eo=$utils.dataAtual();let Po=1,ra=0,Fo=0,So=!1;const q=this.compra;if(q.subTotalProduto>0&&(q.tipoFrete==="FOB"&&q.freteSeparado===0&&(ra=q.valorFrete+q.valorSeguro),Po=(q.subTotalProduto+q.valorOutrasDespesas-q.totalDesconto+ra)/q.subTotalProduto),Fo=_.reduce((F,uo)=>F+uo.valorIcmsSt,Fo),Fo!==q.valorIcmsSt&&(So=!0),q.operacao==="Nota de Entrada")for(let F in _){let uo=$utils.clonarV2(_[F]),S=$utils.clonarV2(_[F]);S.status="Finalizado",S.dataCompra=Eo,S.dataHoraFinalizado=Eo,So&&(S.valorIcmsSt=q.valorIcmsSt*(((e=(r=_[F])==null?void 0:r.total)!=null?e:0)/(q.subTotalProduto>0?q.subTotalProduto:1))),S.valorFreteRateado=q.valorFrete*(((d=(n=_[F])==null?void 0:n.total)!=null?d:0)/((a=q.subTotalProduto)!=null?a:1)),S.valorSeguroRateado=q.valorSeguro*(((g=(i=_[F])==null?void 0:i.total)!=null?g:0)/((l=q.subTotalProduto)!=null?l:1)),S.valorOutrasDespesasRateado=((u=q.valorOutrasDespesas)!=null?u:0)*(((p=(v=_[F])==null?void 0:v.total)!=null?p:0)/((I=q.subTotalProduto)!=null?I:1)),S.descontoTotalRateado=((f=q.totalDesconto)!=null?f:0)*(((V=(c=_[F])==null?void 0:c.total)!=null?V:0)/((m=q.subTotalProduto)!=null?m:1));let po=0;((s=_[F])==null?void 0:s.valorIcmsSt)-((b=_[F])==null?void 0:b.valorIcms)>0&&(po=((x=(P=_[F])==null?void 0:P.valorIcmsSt)!=null?x:0)-((A=(E=_[F])==null?void 0:E.valorIcms)!=null?A:0)),S.valorRealTotal=((U=(T=_[F])==null?void 0:T.total)!=null?U:0)*Po+((R=(Z=_[F])==null?void 0:Z.valorIpi)!=null?R:0)+((go=(io=_[F])==null?void 0:io.valorIcms)!=null?go:0),S.valorRealTotalImpostos=((no=(so=_[F])==null?void 0:so.total)!=null?no:0)+S.valorFreteRateado+S.valorSeguroRateado+S.valorOutrasDespesasRateado-S.descontoTotalRateado+((N=(mo=_[F])==null?void 0:mo.valorIpi)!=null?N:0)+((ao=(G=_[F])==null?void 0:G.valorIcmsSt)!=null?ao:0),S.valorReal=S.valorRealTotalImpostos/((to=(bo=_[F])==null?void 0:bo.quantidade)!=null?to:1),S.valorCustoReposicao=(To=(co=await $db.item.leNew({id:(vo=_[F])==null?void 0:vo.idItem}))==null?void 0:co.valorCustoReposicao)!=null?To:0,await $db.documentoItem.grava({original:uo,atual:S})}if(q.operacao==="Pedido de Compra")for(const F in _){let uo=$utils.clonarV2(_[F]),S=$utils.clonarV2(_[F]);S.status="Finalizado",S.dataHoraFinalizado=Eo,So&&(S.valorIcmsSt=$utils.arredondar(q.valorIcmsSt*(((Uo=_[F].total)!=null?Uo:0)/(q.subTotalProduto>0?q.subTotalProduto:1)))),S.valorFreteRateado=$utils.arredondar(((Mo=q.valorFrete)!=null?Mo:0)*(((Bo=_[F].total)!=null?Bo:0)/((Oo=q.subTotalProduto)!=null?Oo:1)),4),S.valorSeguroRateado=$utils.arredondar(((Ho=q.valorSeguro)!=null?Ho:0)*(((Ao=_[F].total)!=null?Ao:0)/((Lo=q.subTotalProduto)!=null?Lo:1)),4),S.valorOutrasDespesasRateado=$utils.arredondar((($o=q.valorOutrasDespesas)!=null?$o:0)*(((jo=_[F].total)!=null?jo:0)/((Ro=q.subTotalProduto)!=null?Ro:1)),4),S.descontoTotalRateado=$utils.arredondar(((Xo=q.totalDesconto)!=null?Xo:0)*(((Qo=_[F].total)!=null?Qo:0)/((Go=q.subTotalProduto)!=null?Go:1)),4);let po=0;_[F].valorIcmsSt-_[F].valorIcms>0&&(po=$utils.arredondar(((Wo=_[F].valorIcmsSt)!=null?Wo:0)-((Zo=_[F].valorIcms)!=null?Zo:0),2)),S.valorRealTotal=$utils.arredondar(((Jo=_[F].total)!=null?Jo:0)*Po+((Ko=_[F].valorIpi)!=null?Ko:0)+(po>0?po:0),2),S.valorRealTotalImpostos=$utils.arredondar(((Yo=_[F].total)!=null?Yo:0)+S.valorFreteRateado+S.valorSeguroRateado+S.valorOutrasDespesasRateado-S.descontoTotalRateado+((oa=_[F].valorIpi)!=null?oa:0)+((aa=_[F].valorIcmsSt)!=null?aa:0),4),S.valorReal=$utils.arredondar(S.valorRealTotalImpostos/((ea=_[F].quantidade)!=null?ea:1),4),S.valorCustoReposicao=$utils.arredondar((ta=(await $db.item.leNew({id:_[F].idItem})).valorCustoReposicao)!=null?ta:0,2),await $db.documentoItem.grava({original:uo,atual:S})}}catch(_){console.log(_.message)}},async enviar_click(){if(this.compra.operacao==="Pedido de Compra")try{$q.loading.show();const r=this.compraItens,e=(await $db.itemFornecedor.ler()).filter(n=>n.idContato===this.compra.idContato);for(let n in r){const d=r[n];if(!e.map(a=>a.idItem).includes(d.idItem)){const a={id:$utils.uuid(),idItem:d.idItem,idContato:this.compra.idContato,referencia:"",descricao:d.descricaoItem};await $db.itemFornecedor.gravar({atual:a,original:{}})}}this.compra.status="Digita\xE7\xE3o",this.compra.dataHoraFinalizado="",this.compra.operacao="Nota de Entrada",this.salvar(),this.$emit("atualizar"),this.ocultarModal(),this.$router.push({name:"Nota de Entrada",params:{id:this.compra.id}})}catch(r){$q.notifyError("Ocorreu um erro!",r)}finally{$q.loading.hide()}},async mostrar({id:r}){var e,n;this.visivel=!0,r&&(this.compraOriginal=await $db.hibrido.le({table:"documento",id:r}),this.compra=$utils.clonarV2(this.compraOriginal),this.compra.totalComImposto=!0,this.compra.calcularTributacao=(e=this.compra.calcularTributacao)!=null?e:!0,this.compra.naoGerarFinanceiro=(n=this.compra.naoGerarFinanceiro)!=null?n:!1),await this.atualizar({id:r})},fechar(){this.$router.replace({params:{id:""}}),this.compra.status==="Finalizado"?this.$emit("atualizar",{aba:"Finalizado"}):this.$emit("atualizar",{aba:"Digita\xE7\xE3o"}),this.ocultarModal(),this.dataPrevistaEntrega="",this.horaPrevistaEntrega="",this.compraOriginal={},this.compraItens=[],this.produtos=[],this.compra={id:$utils.uuid(),codigoDocumento:null,tipo:"Compra",operacao:"Pedido de Compra",status:"Digita\xE7\xE3o",codigoEmpresa:null,descricaoEmpresa:"",numeroDocumentoEmpresa:"",codigoContato:null,descricaoContato:"",codigoContatoComprador:null,codigoContatoVendedor:null,idContatoComprador:null,dataHoraEmissao:new Date,tipoFrete:"CIF",tipoTransporte:null,idEmpresa:null,idContato:null,calcularTributacao:!0,totalComImposto:!0,naoGerarFinanceiro:!1,freteSeparado:!1},this.condicoesDePagamento=[],this.formasDePagamento=[],this.documentoNovo=!1,this.exibeInfNota=!1,this.valorTotalPagamento=0},ocultarModal(){this.$router.replace({params:{id:""}}),this.visivel=!1},async abrirModalEmpresa(){const r={ativo:!0,empresas:!0},e=await $g.promptContato.show({filtro:r,placeholder:"Selecione"});if(!e)return;let n=(await $db.hibrido.lista({table:"empresa",where:{idContato:e.id}}))[0];if(!n){this.ocultarModal(),this.$q.notifyError("Erro ao selecionar empresa");return}this.contatos[e.id]||(this.contatos[e.id]=await $db.contato.le({id:e.id})),this.compra.descricaoEmpresa=n.nome,this.compra.idEmpresa=n.idContato,this.compra.codigoEmpresa=n.codigoContato,this.compra.numeroDocumentoEmpresa=n.numeroDocumentoNacional,this.compra.InscricaoMunicipalEmpresa=n.InscricaoMunicipalEmpresa},async abrirModalComprador(){const r=await this.selecionarContato({placeholder:"Selecione o comprador",filtro:{ativo:!0,compradores:!0}});r.id&&(this.compra.idContatoComprador=r.id),this.contatos[r.id]||(this.contatos[r.id]=await $db.contato.le({id:r.id}))},async abrirModalFornecedor(){const r={ativo:!0},e=await $g.promptContato.show({filtro:r,placeholder:"Selecione o fornecedor"});if(!e)return e;const n=await $db.contatoTelefone.le({idContato:e.id}),d=await $db.contatoEndereco.le({idContato:e.id}),a=n.find(l=>l.tipoTelefone==="Principal"||l.tipoTelefone==="WhatsApp")||n[0]||null,i=d.find(l=>l.grupo==="Principal")||d[0]||null;let g;return i&&Object.keys(i).length>0&&(g=`${i.logradouro}, ${i.numero} ${i.complemento} - ${i.bairro} - ${i.municipio}/${i.uf}`),e.id&&(this.compra.idContato=e.id,this.compra.codigoContato=e.codigoContato,this.compra.descricaoContato=e.nome,this.compra.numeroDocumentoContato=e.numeroDocumentoNacional,this.compra.emailContato=(e==null?void 0:e.email)||null,this.compra.regimeContato=(e==null?void 0:e.regime)||null,this.compra.telefoneContato=(a==null?void 0:a.telefone)||null,this.compra.descricaoContatoEndereco=g||null),this.contatos[e.id]||(this.contatos[e.id]=await $db.contato.le({id:e.id})),e},async abrirModalVendedor(){const r=(await $db.contato.leFilhos(this.compra.idContato)).map(n=>n.id),e=await this.selecionarContato({placeholder:"Selecione o vendedor",filtro:{ativo:!0,usuarios:r}});e.id&&(this.compra.CodigoContatoVendedor=e.codigoContato,this.compra.idContatoVendedor=e.id),this.contatos[e.id]||(this.contatos[e.id]=await $db.contato.le({id:e.id}))},async abrirModalTransportador(){const r=await this.selecionarContato({placeholder:"Selecione o transportadora",filtro:{ativo:!0,transportadoras:!0}});r.id&&(this.compra.idContatoTransportadora=r.id),this.contatos[r.id]||(this.contatos[r.id]=await $db.contato.le({id:r.id}))},async selecionarContato(r){const{placeholder:e,filtro:n}={placeholder:"Selecione o contato",filtro:{ativo:!0},...r},d=await $g.promptContato.show({filtro:n,placeholder:e});if(!d)throw new Error("Contato n\xE3o selecionado");return d},async adicionarItem(){let r={},e=[];for(const n of e)r[n.idItem]={item:await $db.hibrido.le({table:"item",id:n.idItem}),quantidade:n.quantidade};this.adicionar.modal.value=!0,this.adicionar.modal.name="Item"},async selecionarItens(r){var e,n,d;for(const a in r){let i=await $db.hibrido.lista({table:"estoqueSaldoProdutoEmpresa",where:{idEmpresa:this.compra.idEmpresa,tipoEstoque:"Dispon\xEDvel",idItem:a}});i=i[0];const g=await $db.configuracoes.porNome("vendas.checaestoque",this.compra.idEmpresa);Number((e=g.find(V=>V.id))==null?void 0:e.valor);const l=r[a].item||{},u=r[a].quantidade||0,v=(n=(l==null?void 0:l.valorCustoReposicao)||(i==null?void 0:i.valorCustoMedio))!=null?n:0;let p=this.compraItens.find(V=>V.idItem===a);const I=(await $erp().cfop.where({cfop:5102}).toArray())[0],f=(await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0],c=(await $erp().financeiroPlanoConta.where({codigoFinanceiroPlanoConta:Number(f==null?void 0:f.valor)}).toArray())[0];if(p)p.quantidade=$utils.arredondar(u,4),p.quantidadeRealizado=$utils.arredondar(u,4),p.subTotal=$utils.arredondar(v,2),p.total=$utils.arredondar(u*v,2);else{let V={dataHoraEmissao:$utils.dataAtual(),dataHoraFinalizado:"",descricaoItem:l.descricao,id:$utils.uuid(),idDocumento:this.compra.id,idItem:l.id,codigoItem:l.codigoItem,referencia:l.referencia,operacao:"Compra de Mercadoria",operacaoFator:1,idCfop:I==null?void 0:I.id,idPlanoContaEstoque:c==null?void 0:c.id,quantidade:$utils.arredondar(u,4),quantidadeRealizado:$utils.arredondar(u,4),status:"Digita\xE7\xE3o",tipoItem:l.tipo,subTotal:$utils.arredondar(v,2),total:$utils.arredondar(u*v,2),unidade:l.unidade,valorCustoMedio:(d=i==null?void 0:i.valorCustoMedio)!=null?d:0,valorItem:v,valorOriginal:v};this.produtos[l.id]=await $db.item.leCompleto({id:l.id}),this.compraItens.push(V),await this.processarImagem(this.compraItens)}this.compra.subTotal=0,this.compra.subTotalProduto=0;for(let V in this.compraItens)this.compra.subTotal+=this.compraItens[V].total,this.compra.subTotalProduto+=this.compraItens[V].total;this.compra.subTotal=$utils.arredondar(this.compra.subTotal,2),this.compra.totalDocumento=this.compra.subTotal}},calcularTotaisItem(r,e){var p,I,f,c,V,m,s;const n=$utils.clonarV2(this.compraItens[r]),d=(p=n.valorOriginal)!=null?p:0,a=(I=n.quantidade)!=null?I:0;let i=(f=n.valorItem)!=null?f:0,g=(c=n.descontoPercentualItem)!=null?c:0,l=(V=n.descontoItem)!=null?V:0,u=(m=n.subTotal)!=null?m:0,v=(s=n.total)!=null?s:0;e==="descontoPercentualItem"&&((g<0||g>100)&&(g=0),l=i*g/100,u=i-l),e==="descontoItem"&&((l<0||l>i)&&(l=0),g=l/i*100,u=i-l),e==="valorItem"&&(i<d&&(i=d),l>i&&(l=0,g=0),u=i-l),e==="subTotal"&&((u<0||u>i)&&(u=i),l=i-u,g=l/i*100),v=a*u,n.valorItem=i,n.descontoItem=l,n.descontoPercentualItem=g,n.subTotal=u,n.total=v,this.compraItens[r]=n,this.calcularTotais()},calcularTotais(r){var m,s,b,P,x,E,A,T,U,Z;const e=$utils.clonarV2(this.compra);let n=0,d=0,a=0,i=(m=e.totalDesconto)!=null?m:0,g=(s=e.totalPercentualDesconto)!=null?s:0,l=(b=e.valorFrete)!=null?b:0,u=(P=e.valorSeguro)!=null?P:0,v=(x=e.valorOutrasDespesas)!=null?x:0,p=0,I=0,f=0,c=0,V=0;this.erroFrete=!1,this.erroSeguro=!1,this.erroOutrasDespesas=!1;for(const R of this.compraItens)n+=R.total,p+=(E=R.valorBaseIcms)!=null?E:0,I+=(A=R.valorIcms)!=null?A:0,f+=(T=R.valorBaseIcmsSt)!=null?T:0,c+=(U=R.valorIcmsSt)!=null?U:0,V+=(Z=R.valorIpi)!=null?Z:0;r==="totalPercentualDesconto"&&(this.erroDesconto=!1,(g<0||g>100)&&(this.erroDesconto=!0),i=n*g/100),r==="totalDesconto"&&(this.erroDesconto=!1,(i<0||i>n)&&(this.erroDesconto=!0),g=i/n*100),l<0&&(this.erroFrete=!0),l=e.tipoFrete==="FOB"?l:0,u<0&&(this.erroSeguro=!0),u=e.tipoFrete==="FOB"?u:0,v<0&&(this.erroOutrasDespesas=!0),e.calcularTributacao||(p=0,I=0,f=0,c=0),e.totalComImposto||(V=0),d=n-i+l+u+v,a=d+V,e.valorBaseIcms=$utils.arredondar(p,2),e.valorIcms=$utils.arredondar(I),e.valorBaseIcmsSt=$utils.arredondar(f),e.valorIcmsSt=$utils.arredondar(c),e.valorIpi=$utils.arredondar(V),e.totalDesconto=$utils.arredondar(i),e.totalPercentualDesconto=$utils.arredondar(g),e.subTotalProduto=$utils.arredondar(n),e.totalProduto=$utils.arredondar(n)-$utils.arredondar(i),e.subTotal=$utils.arredondar(d),e.totalDocumento=$utils.arredondar(a),this.compra=e},async salvar(){try{this.compra.totalComImposto&&delete this.compra.totalComImposto,await $db.documento.grava({original:this.compraOriginal,atual:this.compra}),await $db.documentoItem.remove(this.compraItensOriginal.filter(e=>!this.compraItens.find(n=>n.id===e.id)));for(const e of this.compraItens){const n=this.compraItensOriginal.find(d=>d.id===e.id);await $db.documentoItem.grava({original:n,atual:e})}const r=await $db.hibrido.lista({table:"documentoCondicaoPagamento",where:{idDocumento:this.compra.id}});for(const e of this.condicoesDePagamento){const n=r.find(a=>a.id===e.id),d=$utils.clonarV2(e);await $db.documentoCondicaoPagamento.grava({original:$utils.clonarV2(n),atual:d})}for(const e of r)this.condicoesDePagamento.some(d=>d.id===e.id)||await $db.documentoCondicaoPagamento.remover(e.id);this.compra.totalComImposto=!0}catch(r){console.log(r.message)}},async retornarParaDigitacao(){$q.dialog({title:"Reabrir compra",message:`Deseja realmente reabrir ${this.compra.operacao==="Pedido de Compra"?`esse ${this.compra.operacao}?`:`essa ${this.compra.operacao}?`}
            <br>
            O Financeiro ser\xE1 apagado !
          `,html:!0,cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},persistent:!0}).onOk(async()=>{try{if($q.loading.show(),this.compra.status!=="Finalizado")throw new Error("N\xE3o foi possivel reabrir o documento");if((await $db.hibrido.lista({table:"financeiroTitulo",whereFilter:{documentoId:this.compra.id}})).filter(n=>n.dataPagamento&&n.valorRealizado!==0).length>0)return $q.notifyError("N\xE3o \xE9 poss\xEDvel excluir o Financeiro. Parcelas provisionadas j\xE1 pagas!");this.compra.dataHoraFinalizado="",this.compra.status="Digita\xE7\xE3o",await this.retornarItensParaDigitacao(),this.compra.naoGerarFinanceiro||await this.removerTitulosAPagar(),await this.salvar(),this.compraOriginal=$utils.clonarV2(this.compra),this.$q.notify({message:"A compra foi reaberta para digita\xE7\xE3o",timeout:500,type:"positive"})}catch(r){$q.notifyError(`Erro ao reabrir o documento de ${this.operacao}!`),console.log(r)}finally{$q.loading.hide()}}).onCancel(async()=>{})},async removerTitulosAPagar(){try{const r=await $db.hibrido.lista({table:"financeiroMovimentacao",where:{documentoId:this.compra.id}}),e=await $db.hibrido.lista({table:"financeiroTitulo",where:{documentoId:this.compra.id}});await $db.hibrido.remove(r,"financeiroMovimentacao"),await $db.hibrido.remove(e,"financeiroTitulo")}catch(r){console.log(r.message)}},async retornarItensParaDigitacao(){var r;try{const e=await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:(r=this.compra)==null?void 0:r.id}});for(let n in e){let d=$utils.clonarV2(e[n]),a=$utils.clonarV2(e[n]);a.status="Digita\xE7\xE3o",a.dataHoraFinalizado="",await $db.documentoItem.grava({original:d,atual:a})}}catch(e){console.log(e.message)}},async alterarPagamento(r){try{const e=await $db.hibrido.le({table:"documentoCondicaoPagamento",id:r==null?void 0:r.id});await $db.documentoCondicaoPagamento.grava({original:e,atual:r})}catch(e){console.log(e.message)}},async removerPagamento(r){try{this.condicoesDePagamento=this.condicoesDePagamento.filter(e=>e.id!==r.id),this.condicoesDePagamento.sort((e,n)=>{let d=new Date(e.dataVencimento),a=new Date(n.dataVencimento);return d-a}),await this.atualizaValorTotalPagamento({condicao:r,acao:"remover"})}catch(e){console.log(e.message)}},async gerarCondicoesDePagamento(){var r;try{let e=this.compra.id,n=this.compra.codigoDocumento,d=this.compra.condicaoPagamento,a=(r=this.compra.notaNumero)!=null?r:null;this.compra.naoGerarFinanceiro||await this.gerarParcelamento(e,d,a),this.compra.naoGerarFinanceiro&&(this.condicoesDePagamento=[])}catch(e){console.log(e.message)}finally{}},async gerarParcelamento(r,e,n){var I,f,c,V;this.condicoesDePagamento=[];const d=$utils.clonarV2(this.compra),a=e.split("/").length,i=!!(d!=null&&d.dataCompra)&&(d==null?void 0:d.dataCompra)!==""?d.dataCompra:!!(d!=null&&d.dataHoraPrevisto)&&(d==null?void 0:d.dataHoraPrevisto)!==""?d.dataHoraPrevisto:!!this.dataPrevistaEntrega&&this.dataPrevistaEntrega!==""?new Date(this.dataPrevistaEntrega):$utils.dataAtual(),g=(I=d==null?void 0:d.freteSeparado)!=null?I:0;let l=$utils.arredondar(d==null?void 0:d.totalDocumento,2);const u=((f=d==null?void 0:d.valorFrete)!=null?f:0)+((c=d==null?void 0:d.valorSeguro)!=null?c:0);if(g&&(d==null?void 0:d.tipoFrete)==="FOB"&&u>0){let m={id:$utils.uuid(),codigoDocumento:d==null?void 0:d.codigoDocumento,idDocumento:d==null?void 0:d.id,dataVencimento:i,valor:u,observacao:"Valor Frete + Seguro",freteSeparado:!0};this.condicoesDePagamento.push(m),l-=u}let v=0,p=l/a;for(let m in e.split("/")){let s=!!(d!=null&&d.dataCompra)&&(d==null?void 0:d.dataCompra)!==""?d.dataCompra:!!(d!=null&&d.dataHoraPrevisto)&&(d==null?void 0:d.dataHoraPrevisto)!==""?d.dataHoraPrevisto:!!this.dataPrevistaEntrega&&this.dataPrevistaEntrega!==""?new Date(this.dataPrevistaEntrega):$utils.dataAtual();typeof s=="string"&&(s=(V=new Date(s))!=null?V:$utils.dataAtual()),s.setDate(s.getDate()+parseInt(e.split("/")[m]));let b={id:$utils.uuid(),codigoDocumento:d==null?void 0:d.codigoDocumento,idDocumento:d==null?void 0:d.id,dataVencimento:$.formatDate(s),valor:p,observacao:""};this.condicoesDePagamento.push(b),v+=p!=null?p:0}l!==v&&(this.condicoesDePagamento[0].valor+=(l!=null?l:0)-(v!=null?v:0)),this.valorTotalPagamento=g&&(d==null?void 0:d.tipoFrete)==="FOB"?l+u:l},async gerarFinanceiro(r){var e,n,d;try{if(!r)throw new Error("idDocumento n\xE3o fornecido");const a=await $db.hibrido.le({table:"documento",id:r});if(!a)throw new Error("N\xE3o foi poss\xEDvel obter o documento");const i=a.idEmpresa,g=a.idContato,l=(e=a.notaNumero)!=null?e:0,u=(n=a.observacaoFaturamento)!=null?n:"",v=new Date,p=a.totalDocumento,I=(await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}))[0],f=await $db.financeiroPlanoConta.leV2({codigoFinanceiroPlanoConta:Number(I.valor)}),c=0;let V=(d=a.formaDePagamento)!=null?d:"",m=`Provisionamento de pedido de compra ${a.observacaoFaturamento||""}`;l!==0&&(m=`${m} | Nota nro: ${l}`),V=`${V}`;let s=[],b=0,E=(await(await $db.hibrido.lista({table:"documentoItem",where:{idDocumento:a.id}})).filter(T=>T.idPlanoContaEstoque!==(f==null?void 0:f.id))).map(T=>{var U,Z,R;return{idPlanoContaEstoque:(U=T==null?void 0:T.idPlanoContaEstoque)!=null?U:null,totalItem:((Z=T.total)!=null?Z:0)-((R=T.descontoTotalRateado)!=null?R:0)}});E=[...new Set(E.map(T=>T))];for(let T in E)if(s.some(U=>U.idPlanoContaEstoque===E[T].codigoPlanoContaEstoque)){let U=s.findIndex(Z=>Z.idPlanoContaEstoque===E[T].codigoPlanoContaEstoque);s[U].valor+=E[T].totalItem}else s.push({idPlanoContaEstoque:E[T].idPlanoContaEstoque,idPlanoContaDestino:"",valor:E[T].totalItem,porcentagem:0});s.length>0&&(s[0].porcentagem=$utils.arredondar(s[0].valor/p,4)),this.financeiroGerarNotaEntrada(a.id,a.operacao,u,0,c,p,g,V,v,a.codigoDocumento,a.operacao,f,0,i,s);const A={atual:$utils.clonarV2(a),original:$utils.clonarV2(a)};A.atual.provisaoCompra=1,await $db.documento.grava({original:A.original,atual:A.atual})}catch(a){$q.notifyError(a)}},async financeiroGerarNotaEntrada(r,e,n,d,a,i,g,l,u,v,p,I,f,c,V){var m,s,b;try{if(!r)throw new Error("N\xE3o foi informado o Id do documento");if(!await $db.hibrido.le({table:"documento",id:r}))throw new Error("N\xE3o foi possivel recuperar o documento");const x=parseInt((await $db.hibrido.lista({table:"configuracoes",where:{nome:"financeiro.planocontas.freteaquisicao"}}))[0].valor),E=(await $db.hibrido.lista({table:"financeiroPlanoConta",where:{codigoFinanceiroPlanoConta:x}}))[0],A=await $db.hibrido.lista({table:"financeiroTitulo",where:{documentoId:r}});let T=[];for(let N in A)A[N].dataPagamento&&T.push(A[N]);if(T.length>0)throw new Error("N\xE3o \xE9 poss\xEDvel regerar o Financeiro. Parcelas provisionadas j\xE1 pagas!");T.length<=0&&A.length>0&&await $db.hibrido.remove(A,"financeiroTitulo");const U=await $db.hibrido.lista({table:"documentoCondicaoPagamento",where:{idDocumento:r}});U.sort(function(N,G){return new Date(N.dataVencimento)-new Date(G.dataVencimento)});const Z=U.length;for(let N in U){const G=(m=U[N].observacao)!=null?m:"",ao={id:$utils.uuid(),codigoFinanceiroPlanoConta:G==="Valor Frete + Seguro"?E.codigoFinanceiroPlanoConta:I==null?void 0:I.codigoFinanceiroPlanoConta,dataEmissao:$.formatDate(new Date().setHours(0,0,0,0)),dataCompetencia:$.formatDate(new Date(u).setHours(0,0,0,0)),dataVencimento:$.formatDate(new Date(U[N].dataVencimento).setHours(0,0,0,0)),dataVencimentoOriginal:$.formatDate(new Date(U[N].dataVencimento).setHours(0,0,0,0)),valor:$utils.arredondar(U[N].valor,2),tipoJuros:"dia",valorMulta:0,percentualJuros:0,documentoTipo:p,parcela:`${Number(N)+1}/${Z}`,descricao:e,observacao:`${G}`,formaDePagamento:`Provis\xE3o Pedido - ${l}`,receberPagar:d,valorOriginal:$utils.arredondar(U[N].valor,2),documentoVinculado:1,valorTotal:$utils.arredondar(U[N].valor,2),valorARealizar:$utils.arredondar(U[N].valor,2),valorDesconto:0,percentualDesconto:0,idEmpresa:c,idContato:((s=U[N])==null?void 0:s.freteSeparado)&&!!this.compra.idContatoTransportadora?this.compra.idContatoTransportadora:g,idFinanceiroPlanoConta:G==="Valor Frete + Seguro"?E.id:I==null?void 0:I.id,documentoId:r,cobrancaAtivo:1};await $db.financeiroTitulo.grava({atual:ao,original:{}})}let R=await $db.financeiroMovimentacao.le();R=R.map(N=>{var G;return(G=N==null?void 0:N.codigoFinanceiroMovimentacaoN)!=null?G:0});const io=((b=Math.max.apply(null,R))!=null?b:0)+1,go=await $db.configuracoes.le({nome:"financeiro.planocontas.comprageral"}),so=await $db.financeiroPlanoConta.le();let no="",mo="";so.forEach(N=>{N.codigoFinanceiroPlanoConta===go[0].valor&&(no=N.id,mo=N.descrContaCG)});for(let N in V){const G=V[N].idPlanoContaEstoque,ao=V[N].porcentagem,bo={id:$utils.uuid(),codigoFinanceiroMovimentacaoN:io,idEmpresa:c,idFinanceiroPlanoConta:no,dataEmissao:$.formatDate(new Date().setHours(0,0,0,0)),valorCredito:i*ao,valorDebito:0,descricao:mo,observacao:"Contabiliza\xE7\xE3o automatica",automatico:0,liquidando:0,dataCompetencia:$.formatDate(new Date().setHours(0,0,0,0)),dataVencimento:$.formatDate(new Date().setHours(0,0,0,0)),dataMovimento:$.formatDate(new Date().setHours(0,0,0,0)),documentoTipo:p,documentoId:r};await $db.financeiroMovimentacao.grava({atual:bo,original:{}});let to="";so.forEach(co=>{co.idFinanceiroPlanoConta===G&&(to=co.descricao)});const vo={id:$utils.uuid(),codigoFinanceiroMovimentacaoN:io,idEmpresa:c,codigoFinanceiroPlanoConta:to,dataEmissao:$.formatDate(new Date().setHours(0,0,0,0)),valorCredito:0,valorDebito:i*ao,descricao:to,observacao:"Contabiliza\xE7\xE3o automatica",automatico:0,liquidando:0,dataCompetencia:$.formatDate(new Date().setHours(0,0,0,0)),dataVencimento:$.formatDate(new Date().setHours(0,0,0,0)),dataMovimento:$.formatDate(new Date().setHours(0,0,0,0)),documentoTipo:p,documentoId:r};await $db.financeiroMovimentacao.grava({atual:vo,original:{}})}}catch(P){console.log(P.message)}},async processarImagem(r){if(!!r){for(const e of r)if(!this.itensImagens.hasOwnProperty(e.idItem)){const n=await $db.item.leCompleto({id:e.idItem});Object.keys(n.atual).length>0&&(n.atual.imagem===""||n.atual.imagem)?this.itensImagens[e.idItem]={imagem:n.atual.imagem}:Object.keys(n.original).length>0&&(n.original.imagem===""||n.original.imagem)&&(this.itensImagens[e.idItem]={imagem:n.original.imagem})}}},async atualizaValorTotalPagamento({condicao:r,acao:e}){!r||e==="remover"&&(this.valorTotalPagamento=this.valorTotalPagamento-r.valor)},async ajustarPrevisaoEntrega(r){if(r==="alterar"&&(this.alterarPrevisaoEntrega=!0),r==="salvar"){const e=`${this.dataPrevistaEntrega} ${this.horaPrevistaEntrega||"00:00:00"}`;if(!this.dataPrevistaEntrega&&this.horaPrevistaEntrega)return $q.notifyError("\xC9 necess\xE1rio preencher uma data em conjunto com a hora.");if($.formatDate(e)!==$.formatDate(this.compra.dataHoraPrevisto)){try{this.compra.dataHoraPrevisto=$.formatDate(e)||"",await $db.documento.grava({original:this.compraOriginal,atual:this.compra})}catch{$q.notifyError("Erro ao gravar os dados da compra.")}$q.notifyPositive("Os dados da compra foram salvos com sucesso.")}else $q.notifyPositive("N\xE3o h\xE1 dados alterados.");this.alterarPrevisaoEntrega=!1}}}},xa={class:"row items-center"},ka={class:"col-auto"},Na={class:"col-auto"},za=M("span",{class:"q-px-xs"},"|",-1);function Ta(r,e,n,d,a,i){const g=k("g-label"),l=k("g-col"),u=k("Badge"),v=k("BadgeCopiarUid"),p=k("g-row"),I=k("avatar"),f=k("campo"),c=k("ModalEditarProdutoCompras"),V=k("PromptItemV2");return C(),Q(oo,null,[o(_o,{modelValue:a.visivel,"onUpdate:modelValue":e[36]||(e[36]=m=>a.visivel=m),persistent:"",maximized:"",onKeyup:ca(i.fechar,["esc"])},{default:t(()=>[o(Vo,{view:"hHh lpR lFr",container:"",class:"bg-light"},{default:t(()=>[o(wo,null,{default:t(()=>[o(lo,null,{default:t(()=>[o(z,{onClick:i.fechar,icon:"arrow_back",flat:"",round:"",dense:""},null,8,["onClick"]),o(ho,null,{default:t(()=>[h(w(a.compra.operacao),1)]),_:1}),O(o(z,{onClick:i.salvar_click,label:"Salvar",color:"white","text-color":"primary",unelevated:"",class:"q-ml-sm"},null,8,["onClick"]),[[W,a.compra.status==="Digita\xE7\xE3o"]])]),_:1})]),_:1}),o(yo,{class:"u-container"},{default:t(()=>[o(Do,null,{default:t(()=>[o(p,{gutter:"md",mg:"md",bg:"bg-white"},{default:t(()=>[o(l,{col:"12 sm12 md6"},{default:t(()=>[o(p,{items:"center",justify:"end",class:"hideondesktop",style:{border:"1px solid salmon"}},{default:t(()=>[o(l,{col:"xs-shrink",order:"1 sm0"},{default:t(()=>[O(o(g,{text:"caption",icon:"mdi-calendar-today sm tertiary left",tip:`Emitido \xE1s ${r.$filters.hora(a.compra.dataHoraEmissao)}`},{default:t(()=>[h(w(r.$filters.data(a.compra.dataHoraEmissao)),1)]),_:1},8,["tip"]),[[W,a.compra.dataHoraEmissao]])]),_:1}),o(l,{col:"xs-shrink",order:"1 sm0"},{default:t(()=>[O(o(g,{text:"caption",icon:"mdi-calendar-today sm tertiary left",tip:`Finalizado \xE1s ${r.$filters.hora(a.compra.dataHoraFinalizado)}`},{default:t(()=>[h(w(r.$filters.data(a.compra.dataHoraFinalizado)),1)]),_:1},8,["tip"]),[[W,a.compra.dataHoraFinalizado]])]),_:1}),o(l,{col:"xs12 sm-shrink",order:"0 sm1",text:"right"},{default:t(()=>[o(u,{cor:a.compra.status!=="Digita\xE7\xE3o"?"tertiary":"light",escuro:a.compra.status!=="Digita\xE7\xE3o",class:"q-ml-sm"},{default:t(()=>[h(w(a.compra.status),1)]),_:1},8,["cor","escuro"]),a.compra.numero?(C(),y(v,{key:0,cor:"positive",escuro:"",class:"q-ml-sm",id:a.compra.id,numero:a.compra.id.slice(-8)},null,8,["id","numero"])):(C(),y(v,{key:1,id:a.compra.id,numero:a.compra.id.slice(-8),cor:"positive",class:"q-ml-sm"},null,8,["id","numero"]))]),_:1})]),_:1}),o(p,null,{default:t(()=>[o(l,{col:"12 sm6"},{default:t(()=>[o(p,null,{default:t(()=>[o(l,{col:"xs-shrink"},{default:t(()=>[o(I,{imagem:(a.contatos[a.compra.idContato]||{}).imagem,rotulo:(a.contatos[a.compra.idContato]||{}).apelido,tamanho:"50"},null,8,["imagem","rotulo"])]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{modelValue:(a.contatos[a.compra.idContato]||{}).apelido,"onUpdate:modelValue":e[0]||(e[0]=m=>(a.contatos[a.compra.idContato]||{}).apelido=m),after:[{icon:"edit",handler(){i.abrirModalFornecedor()}}],disable:a.compra.status!=="Digita\xE7\xE3o",rotulo:"Fornecedor",dense:"",borderless:"",class:"q-mb-sm"},null,8,["modelValue","after","disable"])]),_:1})]),_:1})]),_:1}),o(l,{col:"12 sm6"},{default:t(()=>[o(f,{modelValue:(a.contatos[a.compra.idContatoVendedor]||{}).apelido,"onUpdate:modelValue":e[1]||(e[1]=m=>(a.contatos[a.compra.idContatoVendedor]||{}).apelido=m),disable:a.compra.status!=="Digita\xE7\xE3o",after:[{icon:"edit",handler(){i.abrirModalVendedor()}}],rotulo:"Vendedor",dense:"",borderless:"",class:"q-mb-sm"},null,8,["modelValue","disable","after"])]),_:1}),o(l,{col:"12 sm6"},{default:t(()=>[o(f,{modelValue:(a.contatos[a.compra.idEmpresa]||{}).apelido,"onUpdate:modelValue":e[2]||(e[2]=m=>(a.contatos[a.compra.idEmpresa]||{}).apelido=m),after:[{icon:"edit",handler(){i.abrirModalEmpresa()}}],disable:a.compra.status!=="Digita\xE7\xE3o",rotulo:"Empresa",dense:"",borderless:"",class:"q-mb-sm"},null,8,["modelValue","after","disable"])]),_:1}),o(l,{col:"12 sm6"},{default:t(()=>[o(f,{modelValue:(a.contatos[a.compra.idContatoComprador]||{}).apelido,"onUpdate:modelValue":e[3]||(e[3]=m=>(a.contatos[a.compra.idContatoComprador]||{}).apelido=m),disable:a.compra.status!=="Digita\xE7\xE3o",after:[{icon:"edit",handler(){i.abrirModalComprador()}}],rotulo:"Comprador",dense:"",borderless:"",class:"q-mb-sm"},null,8,["modelValue","disable","after"])]),_:1}),o(l,{col:"12 sm6"},{default:t(()=>[o(f,{modelValue:(a.contatos[a.compra.idContatoTransportadora]||{}).apelido,"onUpdate:modelValue":e[4]||(e[4]=m=>(a.contatos[a.compra.idContatoTransportadora]||{}).apelido=m),disable:a.compra.status!=="Digita\xE7\xE3o",after:[{icon:"edit",handler(){i.abrirModalTransportador()}}],rotulo:"Transportadora",dense:"",borderless:"",class:"q-mb-sm"},null,8,["modelValue","disable","after"])]),_:1}),o(l,{col:"12 sm6"},{default:t(()=>[o(p,null,{default:t(()=>[o(l,{col:"7"},{default:t(()=>[o(ko,{modelValue:a.dataPrevistaEntrega,"onUpdate:modelValue":e[5]||(e[5]=m=>a.dataPrevistaEntrega=m),disable:!this.alterarPrevisaoEntrega&&this.compra.status!=="Digita\xE7\xE3o",type:"date",label:"Data Prevista de Entrega",clearable:"",dense:"","stack-label":"",borderless:"",class:"q-mb-sm"},null,8,["modelValue","disable"])]),_:1}),o(l,{col:"5"},{default:t(()=>[o(ko,{modelValue:a.horaPrevistaEntrega,"onUpdate:modelValue":e[6]||(e[6]=m=>a.horaPrevistaEntrega=m),disable:!this.alterarPrevisaoEntrega&&this.compra.status!=="Digita\xE7\xE3o",type:"time",label:"Hora Prevista de Entrega",clearable:"",dense:"","stack-label":"",borderless:"",class:"q-mb-sm"},null,8,["modelValue","disable"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),o(l,{col:"12 sm12 md6"},{default:t(()=>[o(p,{justify:"end",items:"center",text:"right",class:"hideonmobile"},{default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(p,{justify:"end",items:"center"},{default:t(()=>[o(u,{cor:a.compra.status!=="Digita\xE7\xE3o"?"tertiary":"light",escuro:a.compra.status!=="Digita\xE7\xE3o"},{default:t(()=>[h(w(a.compra.status),1)]),_:1},8,["cor","escuro"]),a.compra.numero?(C(),y(u,{key:0,cor:"positive",escuro:"",class:"q-mx-sm"},{default:t(()=>[h("#"+w(a.compra.numero.toString().padStart(6,"0")),1)]),_:1})):(C(),y(v,{key:1,id:a.compra.id,numero:a.compra.id.slice(-8),cor:"positive",class:"q-mx-sm"},null,8,["id","numero"])),o(z,{color:"tertiary",flat:"",icon:"more_vert",round:""},{default:t(()=>[o(fo,null,{default:t(()=>[O((C(),y(Y,{link:"",separator:""},{default:t(()=>[a.alterarPrevisaoEntrega?(C(),y(j,{key:1,clickable:"",onClick:e[8]||(e[8]=m=>i.ajustarPrevisaoEntrega("salvar"))},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"local_shipping"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h("Salvar Previs\xE3o de Entrega")]),_:1})]),_:1})]),_:1})):(C(),y(j,{key:0,disable:a.compra.status==="Digita\xE7\xE3o",clickable:"",onClick:e[7]||(e[7]=m=>i.ajustarPrevisaoEntrega("alterar"))},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"local_shipping"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h("Alterar Previs\xE3o de Entrega")]),_:1})]),_:1})]),_:1},8,["disable"]))]),_:1})),[[J]])]),_:1})]),_:1})]),_:1})]),_:1}),o(l,{col:"shrink"},{default:t(()=>[O(o(g,{text:"caption",icon:"mdi-calendar-today sm tertiary left",tip:`Emitido \xE1s ${r.$filters.hora(a.compra.dataHoraEmissao)}`},{default:t(()=>[h(w(r.$filters.data(a.compra.dataHoraEmissao)),1)]),_:1},8,["tip"]),[[W,a.compra.dataHoraEmissao]])]),_:1}),o(l,{col:"shrink"},{default:t(()=>[O(o(g,{text:"caption",icon:"mdi-calendar sm tertiary left",tip:`Finalizado \xE1s ${r.$filters.hora(a.compra.dataHoraFinalizado)}`},{default:t(()=>[h(w(r.$filters.data(a.compra.dataHoraFinalizado)),1)]),_:1},8,["tip"]),[[W,a.compra.dataHoraFinalizado]])]),_:1})]),_:1}),o(p,null,{default:t(()=>[o(l,null,{default:t(()=>[o(f,{modelValue:a.compra.observacao,"onUpdate:modelValue":e[9]||(e[9]=m=>a.compra.observacao=m),"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",tipo:"textoArea",rotulo:"Observa\xE7\xE3o",rows:"4"},null,8,["modelValue","somente-leitura"])]),_:1})]),_:1})]),_:1})]),_:1}),o(p,{gutter:"md",mg:"md",bg:"bg-white"},{default:t(()=>[a.exibeInfNota?(C(),y(ha,{key:0,"default-opened":a.compra.notaNumero>0||a.documentoNovo,"header-class":"q-px-sm",class:"notaEntrada g-col col-12"},{header:t(()=>[o(D,null,{default:t(()=>[o(g,{text:"sub1 medium",icon:"mdi-file-replace sm tertiary left"},{default:t(()=>[h("Nota de Entrada")]),_:1})]),_:1})]),default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(p,null,{default:t(()=>[o(l,{col:"12 sm6 md3"},{default:t(()=>[o(f,{modelValue:a.compra.notaNumero,"onUpdate:modelValue":e[10]||(e[10]=m=>a.compra.notaNumero=m),"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",rotulo:"Numero",dense:""},null,8,["modelValue","somente-leitura"])]),_:1}),o(l,{col:"12 sm6 md3"},{default:t(()=>[o(f,{modelValue:a.compra.notaSerie,"onUpdate:modelValue":e[11]||(e[11]=m=>a.compra.notaSerie=m),"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",rotulo:"Serie",dense:""},null,8,["modelValue","somente-leitura"])]),_:1}),o(l,{col:"12 sm6 md3"},{default:t(()=>[o(f,{modelValue:a.compra.naturezaOperacao,"onUpdate:modelValue":e[12]||(e[12]=m=>a.compra.naturezaOperacao=m),"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",rotulo:"Natureza da Opera\xE7\xE3o",dense:""},null,8,["modelValue","somente-leitura"])]),_:1}),o(l,{col:"12 sm6 md3"},{default:t(()=>[o(f,{modelValue:a.compra.dataCompra,"onUpdate:modelValue":e[13]||(e[13]=m=>a.compra.dataCompra=m),"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",rotulo:"Data compra",tipo:"data",dense:""},null,8,["modelValue","somente-leitura"])]),_:1}),o(l,{col:"12"},{default:t(()=>[o(f,{modelValue:a.compra.chaveAcesso,"onUpdate:modelValue":e[14]||(e[14]=m=>a.compra.chaveAcesso=m),"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",rotulo:"Chave",dense:""},null,8,["modelValue","somente-leitura"])]),_:1})]),_:1})]),_:1})]),_:1},8,["default-opened"])):B("",!0)]),_:1}),o(p,{gutter:"md",mg:"md",bg:"bg-white"},{default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(g,{text:"sub1 medium",icon:"shopping_cart sm tertiary left"},{default:t(()=>[h("Carrinhos "),o(z,{onClick:e[15]||(e[15]=m=>i.adicionarItem()),disable:a.compra.status!=="Digita\xE7\xE3o",icon:"add",label:"Produto",size:"md",color:"primary",flat:"",dense:"",class:"float-right q-px-sm"},null,8,["disable"])]),_:1})]),_:1}),(C(!0),Q(oo,null,ro(a.compraItens,(m,s)=>(C(),y(l,{col:"12",key:s},{default:t(()=>[o(Y,{class:"full-width"},{default:t(()=>[o(j,{class:"q-px-none"},{default:t(()=>{var b;return[o(D,{avatar:"",class:"col-auto"},{default:t(()=>[o(I,{imagem:(a.itensImagens[m.idItem]||{}).imagem,rotulo:m.descricaoItem,tamanho:"50"},null,8,["imagem","rotulo"])]),_:2},1024),o(D,{class:"q-px-none"},{default:t(()=>[o(H,null,{default:t(()=>[h(w(m.descricaoItem),1)]),_:2},1024),o(H,{caption:""},{default:t(()=>{var P,x;return[h(w((x=(P=a.produtos[m.idItem])==null?void 0:P.marca)!=null?x:""),1)]}),_:2},1024)]),_:2},1024),O(o(D,{avatar:""},{default:t(()=>[o(u,{denso:""},{default:t(()=>{var P,x;return[h(w((x=(P=a.produtos[m.idItem])==null?void 0:P.referencia)!=null?x:""),1)]}),_:2},1024)]),_:2},1536),[[W,(b=a.produtos[m.idItem])==null?void 0:b.referencia]]),o(D,{avatar:""},{default:t(()=>[M("div",xa,[M("div",ka,[o(z,{color:"primary",dense:"",flat:"",icon:"edit",round:"",onClick:P=>i.editarProduto(m),disable:a.compra.status!=="Digita\xE7\xE3o"},null,8,["onClick","disable"])]),M("div",Na,[o(z,{color:"tertiary",dense:"",flat:"",icon:"delete",round:"",onClick:P=>i.removerItem(m),disable:a.compra.status!=="Digita\xE7\xE3o"},{default:t(()=>[o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("Remover Item")]),_:1})]),_:2},1032,["onClick","disable"])])])]),_:2},1024)]}),_:2},1024)]),_:2},1024),o(p,null,{default:t(()=>[o(l,{col:"4 md"},{default:t(()=>[o(f,{dense:"",align:"left",tipo:"decimal",decimals:"4",zerosDireita:"2",outlined:"",rotulo:"Valor do produto",modelValue:m.valorItem,"onUpdate:modelValue":b=>m.valorItem=b,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",onBlur:b=>i.calcularTotaisItem(s,"valorItem")},null,8,["modelValue","onUpdate:modelValue","somente-leitura","onBlur"])]),_:2},1024),o(l,{col:"4 md"},{default:t(()=>[o(p,{items:"center"},{default:t(()=>[o(l,{col:"shrink"},{default:t(()=>[o(L,{name:"mdi-minus",color:"primary"})]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{dense:"",opcoes:{maximumValue:100},tipo:"decimal",decimals:"2",rotulo:"Desconto percentual",modelValue:m.descontoPercentualItem,"onUpdate:modelValue":b=>m.descontoPercentualItem=b,outlined:"",suffix:"%","somente-leitura":a.compra.status!=="Digita\xE7\xE3o",onBlur:b=>i.calcularTotaisItem(s,"descontoPercentualItem")},null,8,["modelValue","onUpdate:modelValue","somente-leitura","onBlur"])]),_:2},1024)]),_:2},1024)]),_:2},1024),o(l,{col:"4 md"},{default:t(()=>[o(f,{dense:"",tipo:"decimal",modelValue:m.descontoItem,"onUpdate:modelValue":b=>m.descontoItem=b,decimals:"4",zerosDireita:"2",outlined:"",rotulo:"Desconto em reais",prefix:"R$",onBlur:b=>i.calcularTotaisItem(s,"descontoItem"),"somente-leitura":a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onUpdate:modelValue","onBlur","somente-leitura"])]),_:2},1024),o(l,{col:"6 md"},{default:t(()=>[o(p,{items:"center"},{default:t(()=>[o(l,{col:"shrink",class:"hideonmobile"},{default:t(()=>[o(L,{name:"mdi-equal",color:"primary"})]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{dense:"",outlined:"",opcoes:{maximumValue:10,minimumValue:0},rotulo:"Subtotal",tipo:"decimal",decimals:"4",zerosDireita:"2",modelValue:m.subTotal,"onUpdate:modelValue":b=>m.subTotal=b,onBlur:b=>i.calcularTotaisItem(s,"subTotal"),"somente-leitura":a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onUpdate:modelValue","onBlur","somente-leitura"])]),_:2},1024)]),_:2},1024)]),_:2},1024),o(l,{col:"6 md"},{default:t(()=>[o(p,{items:"center"},{default:t(()=>[o(l,{col:"shrink"},{default:t(()=>[o(L,{name:"mdi-close",color:"primary"})]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{dense:"",max:"100",min:"0",outlined:"",modelValue:m.quantidade,"onUpdate:modelValue":b=>m.quantidade=b,decimals:"4",zerosDireita:"0",tipo:"quantidade",onBlur:b=>i.calcularTotaisItem(s),disable:a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onUpdate:modelValue","onBlur","disable"]),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("Quantidade")]),_:1})]),_:2},1024)]),_:2},1024)]),_:2},1024),o(l,{col:"12 md"},{default:t(()=>[o(p,{items:"center"},{default:t(()=>[o(l,{col:"shrink",class:"hideonmobile"},{default:t(()=>[o(L,{name:"mdi-equal",color:"primary"})]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{dense:"",tipo:"decimal",decimals:"2",rotulo:"Total","somente-leitura":!0,modelValue:m.total,"onUpdate:modelValue":b=>m.total=b,outlined:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128)),o(l,{col:"12"},{default:t(()=>[o(p,{gutter:"md",mg:"md-y",justify:"end",items:"center",bg:"bg-light","rounded-borders":"","min-height":"49px"},{default:t(()=>[o(l,{col:"3 sm2 md-shrink",text:"bold"},{default:t(()=>[h(" Calcular ")]),_:1}),o(l,{col:"9 sm10 md"},{default:t(()=>[o(eo,{modelValue:a.compra.calcularTributacao,"onUpdate:modelValue":[e[16]||(e[16]=m=>a.compra.calcularTributacao=m),i.calcularTotais],"checked-icon":"check",color:"green","unchecked-icon":"clear",disable:a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onUpdate:modelValue","disable"])]),_:1}),o(l,{col:"6 md-shrink"},{default:t(()=>[h(" Base ICMS ")]),_:1}),o(l,{col:"6 md",text:"right"},{default:t(()=>[o(f,{dense:"",outlined:"",decimals:"2",zerosDireita:"2",tipo:"decimal",modelValue:a.compra.valorBaseIcms,"onUpdate:modelValue":e[17]||(e[17]=m=>a.compra.valorBaseIcms=m),somenteLeitura:a.compra.calcularTributacao||a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","somenteLeitura"])]),_:1}),o(l,{col:"6 md-shrink"},{default:t(()=>[h(" Valor ICMS ")]),_:1}),o(l,{col:"6 md",text:"right"},{default:t(()=>[o(f,{dense:"",outlined:"",modelValue:a.compra.valorIcms,"onUpdate:modelValue":e[18]||(e[18]=m=>a.compra.valorIcms=m),decimals:"2",zerosDireita:"2",tipo:"decimal",somenteLeitura:a.compra.calcularTributacao||a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","somenteLeitura"])]),_:1}),o(l,{col:"6 md-shrink"},{default:t(()=>[h(" Base ICMS ST ")]),_:1}),o(l,{col:"6 md",text:"right"},{default:t(()=>[o(f,{dense:"",outlined:"",modelValue:a.compra.valorBaseIcmsSt,"onUpdate:modelValue":e[19]||(e[19]=m=>a.compra.valorBaseIcmsSt=m),decimals:"2",zerosDireita:"2",tipo:"decimal",somenteLeitura:a.compra.calcularTributacao||a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","somenteLeitura"])]),_:1}),o(l,{col:"6 md-shrink"},{default:t(()=>[h(" ICMS ST ")]),_:1}),o(l,{col:"6 md",text:"right"},{default:t(()=>[o(f,{dense:"",outlined:"",modelValue:a.compra.valorIcmsSt,"onUpdate:modelValue":e[20]||(e[20]=m=>a.compra.valorIcmsSt=m),decimals:"2",zerosDireita:"2",tipo:"decimal",somenteLeitura:a.compra.calcularTributacao||a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","somenteLeitura"])]),_:1})]),_:1}),o(p,{mg:"lg-t",justify:"end"},{default:t(()=>[o(l,{col:"xs12 sm8 md4"},{default:t(()=>[o(p,{items:"center"},{default:t(()=>[o(l,{col:"3",text:"bold"},{default:t(()=>[h(" Subtotal ")]),_:1}),o(l,{col:"xs",text:"right bold"},{default:t(()=>[h(w(r.$filters.numero(a.compra.subTotalProduto,2)),1)]),_:1})]),_:1}),o(No,{class:"q-mb-md q-mt-xs"}),o(p,{items:"center"},{default:t(()=>[o(l,{col:"xs3"},{default:t(()=>[h(" Desconto ")]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{tipo:"decimal",decimals:"2",modelValue:a.compra.totalPercentualDesconto,"onUpdate:modelValue":e[21]||(e[21]=m=>a.compra.totalPercentualDesconto=m),onBlur:e[22]||(e[22]=m=>i.calcularTotais("totalPercentualDesconto")),suffix:"%",error:a.erroDesconto,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","error","somente-leitura"])]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{tipo:"decimal",decimals:"2",modelValue:a.compra.totalDesconto,"onUpdate:modelValue":e[23]||(e[23]=m=>a.compra.totalDesconto=m),onBlur:e[24]||(e[24]=m=>i.calcularTotais("totalDesconto")),error:a.erroDesconto,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","error","somente-leitura"])]),_:1})]),_:1}),o(p,{items:"center"},{default:t(()=>[o(l,{col:"xs3"},{default:t(()=>[h(" Frete ")]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(sa,{class:"q-mr-md",label:"CIF",val:"CIF",modelValue:a.compra.tipoFrete,"onUpdate:modelValue":[e[25]||(e[25]=m=>a.compra.tipoFrete=m),i.calcularTotais],dense:"",disable:a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onUpdate:modelValue","disable"]),o(sa,{label:"FOB",val:"FOB",modelValue:a.compra.tipoFrete,"onUpdate:modelValue":[e[26]||(e[26]=m=>a.compra.tipoFrete=m),i.calcularTotais],dense:"",disable:a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onUpdate:modelValue","disable"])]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{tipo:"decimal",decimals:"2",modelValue:a.compra.valorFrete,"onUpdate:modelValue":e[27]||(e[27]=m=>a.compra.valorFrete=m),onBlur:i.calcularTotais,error:a.erroFrete,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onBlur","error","somente-leitura"])]),_:1})]),_:1}),o(p,{items:"center"},{default:t(()=>[o(l,{col:"xs3"},{default:t(()=>[h(" Seguro ")]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{tipo:"decimal",decimals:"2",modelValue:a.compra.valorSeguro,"onUpdate:modelValue":e[28]||(e[28]=m=>a.compra.valorSeguro=m),onBlur:i.calcularTotais,error:a.erroSeguro,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onBlur","error","somente-leitura"])]),_:1})]),_:1}),o(p,{items:"center"},{default:t(()=>[o(l,{col:"xs5"},{default:t(()=>[h(" Outras despesas ")]),_:1}),o(l,{col:"xs"},{default:t(()=>[o(f,{tipo:"decimal",decimals:"2",modelValue:a.compra.valorOutrasDespesas,"onUpdate:modelValue":e[29]||(e[29]=m=>a.compra.valorOutrasDespesas=m),onBlur:i.calcularTotais,error:a.erroOutrasDespesas,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o"},null,8,["modelValue","onBlur","error","somente-leitura"])]),_:1})]),_:1}),o(No,{class:"q-mt-md q-mb-xs"}),o(p,{items:"center"},{default:t(()=>[o(l,{col:"xs4",text:"bold"},{default:t(()=>[h(" Total ")]),_:1}),o(l,{col:"xs",text:"right bold"},{default:t(()=>[h(w(r.$filters.numero(a.compra.totalProduto,2)),1)]),_:1})]),_:1}),a.compra.totalComImposto?(C(),y(p,{key:0,items:"center"},{default:t(()=>[o(l,{col:"xs4",text:"bold"},{default:t(()=>[h(" Total IPI ")]),_:1}),o(l,{col:"xs",text:"right bold"},{default:t(()=>[h(w(r.$filters.numero(a.compra.valorIpi,2)),1)]),_:1})]),_:1})):B("",!0),o(p,{items:"center"},{default:t(()=>[o(l,{col:"xs5",text:"bold"},{default:t(()=>[h(" Total c/ Impostos ")]),_:1}),o(l,{col:"xs-shrink"},{default:t(()=>[o(eo,{disable:a.compra.status!=="Digita\xE7\xE3o",modelValue:a.compra.totalComImposto,"onUpdate:modelValue":[e[30]||(e[30]=m=>a.compra.totalComImposto=m),i.calcularTotais],"checked-icon":"check",color:"green","unchecked-icon":"clear"},null,8,["disable","modelValue","onUpdate:modelValue"])]),_:1}),o(l,{col:"xs",text:"right bold"},{default:t(()=>[h(w(r.$filters.numero(a.compra.totalDocumento,2)),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),o(p,{gutter:"md",mg:"md",bg:"bg-white"},{default:t(()=>[o(l,{col:"12"},{default:t(()=>[o(g,{text:"sub1 medium",icon:"credit_card sm tertiary left"},{default:t(()=>[h("Faturar")]),_:1})]),_:1}),o(l,{col:"12"},{default:t(()=>[o(f,{modelValue:a.compra.observacaoFaturamento,"onUpdate:modelValue":e[31]||(e[31]=m=>a.compra.observacaoFaturamento=m),tipo:"textoArea",rotulo:"Observa\xE7\xE3o faturamento",rows:"5"},null,8,["modelValue"])]),_:1}),o(l,{col:"12"},{default:t(()=>[o(ga,{ref:"formAdicionarPagamento"},{default:t(()=>[o(p,{mg:"md-y",items:"center"},{default:t(()=>[o(l,{col:"12 sm6 md"},{default:t(()=>[o(f,{modelValue:a.compra.formaDePagamento,"onUpdate:modelValue":e[32]||(e[32]=m=>a.compra.formaDePagamento=m),rules:a.formaPagamentoRules,ajuda:"Exemplo: Boleto","somente-leitura":a.compra.status!=="Digita\xE7\xE3o",rotulo:"Forma de pagamento",tipo:"text"},null,8,["modelValue","rules","somente-leitura"])]),_:1}),o(l,{col:"12 sm6 md"},{default:t(()=>[o(f,{modelValue:a.compra.condicaoPagamento,"onUpdate:modelValue":e[33]||(e[33]=m=>a.compra.condicaoPagamento=m),rules:a.condicaoPagamentoRules,ajuda:"Exemplo: 28/56/64","somente-leitura":a.compra.status!=="Digita\xE7\xE3o",rotulo:"Cond. Pag",tipo:"numero"},null,8,["modelValue","rules","somente-leitura"])]),_:1}),o(l,{col:"12 sm4 md",text:"bold",class:"q-my-sm"},{default:t(()=>[h(" Frete Separado "),o(eo,{modelValue:a.compra.freteSeparado,"onUpdate:modelValue":[e[34]||(e[34]=m=>a.compra.freteSeparado=m),i.calcularTotais],disable:a.compra.status!=="Digita\xE7\xE3o",dense:"",class:"q-ml-sm"},null,8,["modelValue","onUpdate:modelValue","disable"])]),_:1}),o(l,{col:"12 sm4 md",text:"bold",class:"q-my-sm"},{default:t(()=>[h(" N\xE3o gerar financeiro "),o(eo,{modelValue:a.compra.naoGerarFinanceiro,"onUpdate:modelValue":[e[35]||(e[35]=m=>a.compra.naoGerarFinanceiro=m),i.calcularTotais],disable:a.compra.status!=="Digita\xE7\xE3o",dense:"",class:"q-ml-sm"},null,8,["modelValue","onUpdate:modelValue","disable"])]),_:1}),o(l,{col:"12 sm4 md",text:"center"},{default:t(()=>[o(z,{onClick:i.gerarCondicoesDePagamento,disable:a.compra.status!=="Digita\xE7\xE3o",color:"positive",icon:"add",label:"Forma de pagamento",outline:"",size:"sm"},null,8,["onClick","disable"])]),_:1})]),_:1})]),_:1},512)]),_:1}),o(l,{col:"12"},{default:t(()=>[O(o(g,{text:"sub1 medium"},{default:t(()=>[h("Condi\xE7\xF5es de pagamento")]),_:1},512),[[W,a.condicoesDePagamento.length>0]]),(C(!0),Q(oo,null,ro(a.condicoesDePagamento,m=>(C(),y(Y,{highlight:"",class:"q-pa-none",key:m.id},{default:t(()=>[o(p,{gutter:"md",mg:"sm-y",items:"center",bordered:"","rounded-borders":""},{default:t(()=>[o(l,{col:"xs6 md-shrink"},{default:t(()=>[o(f,{modelValue:m.dataVencimento,"onUpdate:modelValue":s=>m.dataVencimento=s,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",rotulo:"Data vencimento",tipo:"data",dense:""},null,8,["modelValue","onUpdate:modelValue","somente-leitura"])]),_:2},1024),o(l,{col:"xs6 md2"},{default:t(()=>[o(f,{modelValue:m.valor,"onUpdate:modelValue":s=>m.valor=s,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o",align:"left",rotulo:"Valor",decimals:"2",zerosDireita:"2",tipo:"decimal"},null,8,["modelValue","onUpdate:modelValue","somente-leitura"])]),_:2},1024),o(l,{col:"xs-grow"},{default:t(()=>[o(f,{modelValue:m.observacao,"onUpdate:modelValue":s=>m.observacao=s,"somente-leitura":a.compra.status!=="Digita\xE7\xE3o"||m.observacao==="Valor Frete + Seguro",tipo:"text",rotulo:"Observa\xE7\xE3o"},null,8,["modelValue","onUpdate:modelValue","somente-leitura"])]),_:2},1024),o(l,{col:"xs-shrink",text:"right"},{default:t(()=>[o(z,{onClick:s=>i.removerPagamento(m),icon:"delete",round:"",dense:"",flat:"",color:"tertiary",disable:a.compra.status!=="Digita\xE7\xE3o"},null,8,["onClick","disable"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128)),a.valorTotalPagamento>0?(C(),y(p,{key:0,mg:"sm-t"},{default:t(()=>[o(l,{col:"xs-shrink",text:"bold"},{default:t(()=>[h(" Valor total: "+w(r.$filters.numero(a.valorTotalPagamento,2)),1)]),_:1})]),_:1})):B("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),o(zo,{class:"bg-light border-top"},{default:t(()=>[o(lo,{class:"bg-light text-tertiary q-px-md u-container"},{default:t(()=>[o(ho,{class:"text-subtitle2"},{default:t(()=>[h(" Valor Total: "+w(r.$filters.numero(a.compra.totalDocumento,2))+" ",1),za,h(" SKU: "+w(i.skus),1)]),_:1}),o(da),O(o(z,{onClick:i.excluir_click,type:"submit",class:"q-ml-sm",color:"white","text-color":"negative",flat:"",label:"Excluir"},null,8,["onClick"]),[[W,a.compra.status==="Digita\xE7\xE3o"]]),O(o(z,{onClick:i.finalizar_click,type:"submit",class:"q-ml-sm",color:"primary",unelevated:"",label:"Finalizar"},null,8,["onClick"]),[[W,a.compra.status==="Digita\xE7\xE3o"]]),O(o(z,{onClick:i.retornarParaDigitacao,color:"tertiary",flat:"",label:"Reabrir",type:"submit",class:"q-ml-sm"},null,8,["onClick"]),[[W,a.compra.status==="Finalizado"]]),O(o(z,{unelevated:"",onClick:i.enviar_click,class:"q-ml-sm",color:"primary",label:"Transformar em Nota de Compra",type:"submit"},null,8,["onClick"]),[[W,a.compra.status==="Finalizado"&&a.compra.operacao==="Pedido de Compra"]])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"]),o(c,{ref:"ModalEditarProdutoCompras",onSalvar:i.fecharEdicaoProduto},null,8,["onSalvar"]),o(V,{modelValue:a.adicionar.modal.value,"onUpdate:modelValue":e[37]||(e[37]=m=>a.adicionar.modal.value=m),filtro:{ativo:!0,idEmpresa:a.compra.idEmpresa},ref:"promptItem",habilitarQuantidade:!0,exibirValorVenda:!1,calculaItemCusto:!0,onSelecionarItens:i.selecionarItens},null,8,["modelValue","filtro","onSelecionarItens"])],64)}var Ua=Co(qa,[["render",Ta]]);const Ma={components:{PromptItemV2:ma},data(){return{mostrarItemModal:!1,idxItem:0,compraOriginal:{},compra:{id:$utils.uuid(),codigoDocumento:null,tipo:"Compra",operacao:"Pedido de Compra",status:"Digita\xE7\xE3o",codigoEmpresa:null,descricaoEmpresa:"",numeroDocumentoEmpresa:"",codigoContato:null,descricaoContato:"",codigoContatoComprador:null,codigoContatoVendedor:null,idContatoComprador:null,dataHoraEmissao:new Date,tipoFrete:"CIF",tipoTransporte:null,idEmpresa:null,idContato:null,calcularTributacao:!1,totalComImposto:!1,naoGerarFinanceiro:!1,freteSeparado:!1},compraItens:[],produtos:[],visivel:!1,somenteLeitura:!1,buttonLoading:[]}},emits:["atualizar"],methods:{editarProduto(r,e,n){r.referencia=this.produtos[r.idItem].referencia,this.$refs.ModalEditarProdutoCompras.mostrar(r,e,n)},async atualizar(r,e){try{this.$q.loading.show(),this.compraItens=e;for(const n in this.compraItens)this.buttonLoading[n]=!1;this.visivel=!0,$q.notify({type:"info",message:"Existe produtos da nota de entrada n\xE3o cadastrados no sistema."})}catch(n){console.log(n.message)}finally{this.$q.loading.hide()}},verificarSeAlterouCampos(){return $utils.diferencaObjetos(this.compraOriginal,this.compra)},async mostrar(r,e){this.visivel=!0,r.id&&(this.compraOriginal=await $db.hibrido.le({table:"documento",id:r.id}),this.compra=$utils.clonarV2(this.compraOriginal)),await this.atualizar(r,e)},async fechar(){$q.dialog({title:"Voltar?",message:`Ainda existe <b>${this.compraItens.length}</b> produto(s) n\xE3o cadastrado(s).<br><br>
            Ao <b>Confirmar</b> para voltar, ser\xE1 necess\xE1rio incluir o XML novamente e cadastrar os itens que faltam.
          `,html:!0,cancel:{label:"Cancelar",push:!0,color:"tertiary",flat:!0},ok:{label:"Confirmar",push:!0,class:"bg-primary",textColor:"white",flat:!0}}).onOk(async r=>{this.visivel=!1;try{$q.loading.show(),await $db.compra.remove(this.compra)}catch(e){console.error("Ocorreu um erro ao excluir a compra: ",e)}finally{$q.loading.hide(),this.$emit("atualizar")}}).onCancel(()=>{})},async selecionarItens(r){this.compraItens[this.idxItem].idItem=Object.keys(r)[0],this.compraItens[this.idxItem].itemAssociadoDescricao=r[Object.keys(r)[0]].item.descricao,this.compraItens[this.idxItem].itemCompra.idItem=Object.keys(r)[0];try{const e={id:$utils.uuid(),idItem:this.compraItens[this.idxItem].itemCompra.idItem,idContato:this.compra.idContato,referencia:this.compraItens[this.idxItem].referencia,descricao:this.compraItens[this.idxItem].descricaoItem};await $db.hibrido.grava("itemFornecedor",{original:{},atual:e}),await $db.hibrido.grava("documentoItem",{original:{},atual:this.compraItens[this.idxItem].itemCompra}),this.compraItens.splice(this.idxItem,1)}catch(e){console.log(e.error)}this.mostrarItemModal=!1},async recalcularItem(r){var g;let e=(g=this.compraItens[r].valorPreCusto)!=null?g:0,n=0,d=0,a=0,i=0;this.compraItens[r].ipi>0&&(n=$utils.arredondar(e*(this.compraItens[r].ipi/100),2)),this.compraItens[r].st>0&&(d=$utils.arredondar(e*(this.compraItens[r].st/100),2)),this.compraItens[r].difal>0&&(a=$utils.arredondar(e*(this.compraItens[r].difal/100),2)),this.compraItens[r].valorCustoReposicao=$utils.arredondar(e+n+d+a,2),this.compraItens[r].margemLucro>0&&(i=$utils.arredondar(this.compraItens[r].valorCustoReposicao*(this.compraItens[r].margemLucro/100),2)),this.compraItens[r].percentualMarkup=$utils.arredondar(this.compraItens[r].margemLucro,2),this.compraItens[r].valorVenda=$utils.arredondar(this.compraItens[r].valorCustoReposicao+i,2)},async addNovoItem(r,e){this.buttonLoading[e]=!0;const n={id:$utils.uuid(),descricao:r.descricaoItem,descricaoConcatenada:r.descricaoItem,referencia:r.referencia,marca:(r==null?void 0:r.marca)||null,codigoBarras:r.itemCompra.codigoBarrasItem,ncm:r.itemCompra.ncm,tipo:r.itemCompra.tipoItem,codigoNcm:r.itemCompra.codigoNcm,unidade:r.unidade,valorCustoReposicao:r.valorCustoReposicao,valorVenda:(r==null?void 0:r.valorVenda)||0,percentualMarkup:(r==null?void 0:r.percentualMarkup)||0,codigoOrigem:parseInt(r.codigoOrigem),unidade:r.unidade},d={id:$utils.uuid(),idItem:n.id,idContato:this.compra.idContato,referencia:r.referencia,descricao:r.descricaoItem};try{await $db.hibrido.grava("item",{original:{},atual:n}),await $db.hibrido.grava("itemFornecedor",{original:{},atual:d}),r.itemCompra.idItem=n.id,r.itemCompra.dataHoraEmissao=new Date(r.itemCompra.dataHoraEmissao).toISOString(),await $db.hibrido.grava("documentoItem",{original:{},atual:r.itemCompra}),this.compraItens.splice(e,1),$q.notifyPositive(`Item criado com sucesso: ${n.descricao}`)}catch(a){console.log(a.message),$q.notifyError(`Erro ao cadastrar novo produto: ${a.message}`)}this.buttonLoading[e]=!1},async finalizar_click(){console.log(this.compraItens.length),this.compraItens.length>0?$q.notifyError("Antes de continuar verifique todos os itens!"):(this.mostrarItemModal=!1,this.visivel=!1,this.$router.replace({params:{id:this.compra.id}}),this.$refs.fichaCompra.mostrar({id:this.compra.id}))},async addNovoItemAutomatico(r,e){r.id&&(this.compraOriginal=await $db.hibrido.le({table:"documento",id:r.id}),this.compra=$utils.clonarV2(this.compraOriginal)),this.compraItens=e;for(const n in this.compraItens)this.buttonLoading[n]=!1;for(let n=0;n<this.compraItens.length;n++)await this.addNovoItem(this.compraItens[n],n)}}},Ba={class:"layout-padding q-pa-none q-pb-md"},Oa=["id"],Ha={class:"col-12"},Aa={class:"col-4 col-md"},La={class:"col-4 col-md"},$a={class:"col-4 col-md"},ja={class:"col-6 col-md"},Ra={class:"col-12 col-md"},Xa={class:"col-6 col-md"},Qa={class:"col-12 col-md"},Ga={class:"col-12"},Wa={class:"col-12 col-md-4"},Za=M("div",{class:"col-12 col-md-auto"},"ou",-1),Ja={class:"col-12 col-md-auto q-pl-none"},Ka={class:"u-container relative-position"};function Ya(r,e,n,d,a,i){const g=k("ajuda"),l=k("campo"),u=k("row"),v=k("PromptItemV2");return C(),Q(oo,null,[o(_o,{modelValue:a.visivel,"onUpdate:modelValue":e[0]||(e[0]=p=>a.visivel=p),persistent:"",maximized:"",onKeyup:ca(i.fechar,["esc"])},{default:t(()=>[o(Vo,{container:"",view:"hHh LpR fFf",class:"bg-light"},{default:t(()=>[o(wo,null,{default:t(()=>[o(lo,null,{default:t(()=>[o(z,{icon:"arrow_back",flat:"",round:"",dense:"",onClick:i.fechar},null,8,["onClick"]),o(ho,null,{default:t(()=>[h("Importar XML x Cadastro")]),_:1}),o(g)]),_:1})]),_:1}),o(yo,null,{default:t(()=>[o(Do,null,{default:t(()=>[M("div",Ba,[o(ba,{style:{position:"absolute",top:"0",bottom:"0",left:"0",right:"0",height:"100%",width:"100%"},items:a.compraItens,separator:""},{default:t(({item:p,index:I})=>[M("div",{class:"items-carrinho items-center row q-pa-md bg-white rounded-borders u-container",style:{"margin-top":"12px","margin-bottom":"12px"},id:I},[o(Y,{class:"full-width"},{default:t(()=>[o(j,{class:"q-px-none"},{default:t(()=>[o(D,{class:"q-px-none"},{default:t(()=>[o(H,null,{default:t(()=>[o(l,{dense:"",align:"left",tipo:"texto",outlined:"",ajuda:"With placeholder",rotulo:"Descri\xE7\xE3o Item",modelValue:p.descricaoItem,"onUpdate:modelValue":f=>p.descricaoItem=f},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[o(l,{dense:"",align:"left",tipo:"texto",outlined:"",ajuda:"With placeholder",rotulo:"Marca",modelValue:p.marca,"onUpdate:modelValue":f=>p.marca=f},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[o(l,{dense:"",align:"left",tipo:"texto",outlined:"",ajuda:"With placeholder",rotulo:"Referencia",modelValue:p.referencia,"onUpdate:modelValue":f=>p.referencia=f},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),M("div",Ha,[o(u,{class:"q-col-gutter-sm"},{default:t(()=>[M("div",Aa,[o(l,{dense:"",align:"left",tipo:"decimal",decimals:"4",zerosDireita:"2",outlined:"",ajuda:"With placeholder",rotulo:"Valor pr\xE9 custo",modelValue:p.valorPreCusto,"onUpdate:modelValue":f=>p.valorPreCusto=f},null,8,["modelValue","onUpdate:modelValue"])]),M("div",La,[o(l,{dense:"",opcoes:{maximumValue:100},tipo:"decimal",decimals:"2",ajuda:"With placeholder",rotulo:"IPI",modelValue:p.ipi,"onUpdate:modelValue":f=>p.ipi=f,outlined:"",suffix:"%",onBlur:f=>i.recalcularItem(I)},null,8,["modelValue","onUpdate:modelValue","onBlur"])]),M("div",$a,[o(l,{dense:"",opcoes:{maximumValue:100},tipo:"decimal",decimals:"2",ajuda:"With placeholder",rotulo:"ST",modelValue:p.st,"onUpdate:modelValue":f=>p.st=f,outlined:"",suffix:"%",onBlur:f=>i.recalcularItem(I)},null,8,["modelValue","onUpdate:modelValue","onBlur"])]),M("div",ja,[o(l,{dense:"",opcoes:{maximumValue:100},tipo:"decimal",decimals:"2",ajuda:"With placeholder",rotulo:"DIFAL",modelValue:p.difal,"onUpdate:modelValue":f=>p.difal=f,outlined:"",suffix:"%",onBlur:f=>i.recalcularItem(I)},null,8,["modelValue","onUpdate:modelValue","onBlur"])]),M("div",Ra,[o(l,{dense:"",align:"left",tipo:"decimal",decimals:"4",zerosDireita:"2",outlined:"",ajuda:"With placeholder",rotulo:"Custo de reposi\xE7\xE3o",modelValue:p.valorCustoReposicao,"onUpdate:modelValue":f=>p.valorCustoReposicao=f},null,8,["modelValue","onUpdate:modelValue"])]),M("div",Xa,[o(l,{dense:"",opcoes:{maximumValue:100},tipo:"decimal",decimals:"2",ajuda:"With placeholder",rotulo:"Margem de Lucro",modelValue:p.margemLucro,"onUpdate:modelValue":f=>p.margemLucro=f,outlined:"",suffix:"%",onBlur:f=>i.recalcularItem(I)},null,8,["modelValue","onUpdate:modelValue","onBlur"])]),M("div",Qa,[o(l,{dense:"",align:"left",tipo:"decimal",decimals:"4",zerosDireita:"2",outlined:"",ajuda:"With placeholder",rotulo:"Valor de Venda",modelValue:p.valorVenda,"onUpdate:modelValue":f=>p.valorVenda=f},null,8,["modelValue","onUpdate:modelValue"])])]),_:2},1024)]),M("div",Ga,[o(u,{class:"q-mt-lg text-right full-width justify-end items-center"},{default:t(()=>[M("div",Wa,[o(ko,{debounce:500,modelValue:p.itemAssociadoDescricao,"onUpdate:modelValue":f=>p.itemAssociadoDescricao=f,placeholder:"Vincular produto",standout:"",filled:"",dense:"",clearable:"","clear-icon":"close",class:"items-center"},{append:t(()=>[o(L,{name:"search",onClick:()=>{a.mostrarItemModal=!a.mostrarItemModal,a.idxItem=I},class:"cursor-pointer text-tertiary"},null,8,["onClick"])]),_:2},1032,["modelValue","onUpdate:modelValue"])]),Za,M("div",Ja,[o(z,{loading:a.buttonLoading[I],class:"q-ml-sm no-shadow",color:"primary",icon:"add",unelevated:"",label:"Novo",type:"submit",onClick:f=>i.addNovoItem(p,I)},null,8,["loading","onClick"])])]),_:2},1024)])],8,Oa)]),_:1},8,["items"])])]),_:1})]),_:1}),o(zo,{class:"bg-light no-shadow q-pa-sm text-right u-bordaCima"},{default:t(()=>[M("div",Ka,[o(z,{class:"q-ml-sm no-shadow",color:"primary",icon:"send",unelevated:"",label:"Continuar",type:"submit",onClick:i.finalizar_click},null,8,["onClick"])])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeyup"]),o(v,{modelValue:a.mostrarItemModal,"onUpdate:modelValue":e[1]||(e[1]=p=>a.mostrarItemModal=p),habilitarQuantidade:!0,filtro:{ativo:!0,idEmpresa:a.compra.idEmpresa},exibirValorVenda:!1,onSelecionarItens:i.selecionarItens,ref:"promptItem"},null,8,["modelValue","filtro","onSelecionarItens"])],64)}var oe=Co(Ma,[["render",Ya]]);const Io={paginacao:{atual:1,maximo:1,total:1,limite:25},filtros:{numero:"",numeroCompra:null,termoBusca:"",periodoEmissao:{ini:"",fim:""},periodoFinalizado:{ini:"",fim:""},fornecedor:{id:"",nome:""}}},ae={components:{Lista:Va,ComprasFicha:Ua,ComprasImportacaoXML:oe},data(){return{lista:[],mostrar:{barraTopo:!0,toolbarTitulo:!0,icone:"factory",titulo:"Compras",filtroAvancado:!0,buscar:!0,btnAjuda:!0,btnAtualizar:!0,btnNovo:!0,toolbarAcoes:!0,checkBox:!1,btnRemover:!1,btnRestaurar:!1,centralizaTabs:!1,btnDetalhes:!1,btnExportaXLS:!1,btnMenuMais:!1,toolbarAdicao:!1,bannerMsg:""},resultado:{},busca:"",filtros:$utils.clonarV2(Io.filtros),tabSelecionada:{valor:"Digita\xE7\xE3o"},tabs:[{valor:"Digita\xE7\xE3o",rotulo:"Digita\xE7\xE3o"},{valor:"Finalizado",rotulo:"Finalizado"},{valor:"Todos",rotulo:"Todos"}],tabSelecionada2:{valor:"Pedido de Compra"},tabs2:[{valor:"Pedido de Compra",rotulo:"Pedido de Compra"},{valor:"Nota de Entrada",rotulo:"Nota de Entrada"}],paginacao:$utils.clonarV2(Io.paginacao),xmlDevolucao:!1,xmlEstrangeiro:!1,modalXMLNotaEntrada:!1,xmlNotaEntrada:{},configImpressao:[],abrirNotadeEntrada:null}},methods:{async atualizar(r){var e,n;try{let{buscarDadosRecentes:d}=r!=null?r:{};$q.loading.show();let a,i,g,l,u,v=["dataFinalizacao","dataHoraEmissao"],p=["desc","desc"];if(this.tabSelecionada2Anterior&&this.tabSelecionada2Anterior!==this.tabSelecionada2.valor&&(this.setOpcoesTabs(this.tabSelecionada2.valor),this.filtros=$utils.clonarV2(Io.filtros),this.paginacao=$utils.clonarV2(Io.paginacao),this.busca="",d=!0),(n=(e=this.$route)==null?void 0:e.params)!=null&&n.id||this.$router.replace({name:this.tabSelecionada2.valor}),this.tabSelecionada2Anterior=this.tabSelecionada2.valor,d&&(a=await $utils.localIDB.getItem({objectStore:"dadosRecentes",id:this.tabSelecionada2.valor}),a!=null&&a._id&&(this.filtros=a.filtros,this.busca=a.termoBusca,this.paginacao.limite=a.limit,this.paginacao.atual=a.page,v=a.sort,p=a.dir)),r!=null&&r.aba&&(this.tabSelecionada.valor=r.aba),i=$utils.eliminarVazios(this.filtros),g=this.busca,l=this.paginacao.limite,u=this.paginacao.atual,i.status=this.tabSelecionada.valor,i.operacao=this.tabSelecionada2.valor,this.tabSelecionada.valor==="Todos"&&delete i.status,i.operacao==="Nota no SEFAZ"){let I=await $db.hibrido.lista({table:"documentoFiscalEletronico",where:{tipo:"DFe",situacao:i.status}});const f=[];I.forEach(V=>{const m={id:V.id,descricaoContato:V.xNomeEmitente,dataHoraEmissao:V.dataHoraEmissao,dataHoraFinalizado:null,totalDocumento:V.vNF,qtdeContatos:null,status:V.situacao};f.push(m)});let c=(u-1)*l;this.paginacao.total=f.length,this.paginacao.maximo=Math.ceil(this.paginacao.total/l)||1,this.lista=f.splice(c,l),this.configuraImpressao(this.filtros.idEmpresa)}if(i.operacao!=="Nota no SEFAZ"){let I=await $db.compra.le({filtros:i,termoBusca:g,limit:l,page:u,sort:v,dir:p});this.paginacao.total=I.total,this.paginacao.maximo=I.totalPages,this.lista=I.data}for(let I in this.lista)this.lista.hasOwnProperty(I)&&(this.lista[I].contato=await $db.contato.le({id:this.lista[I].idContato}));a={_id:this.tabSelecionada2.valor,tabSelecionada:this.tabSelecionada.valor,filtros:$utils.clonarV2(i),termoBusca:this.busca,limit:this.paginacao.limite,page:this.paginacao.atual,sort:["dataFinalizacao","dataHoraEmissao"],dir:["desc","desc"]},await $utils.localIDB.setItem({objectStore:"dadosRecentes",data:a}),this.configuraImpressao(this.filtros.idEmpresa)}catch(d){$q.notifyError("Erro iniciar",d)}finally{$q.loading.hide()}},adicionarXml(r){this.xmlNotaEntrada.arquivo=r[0]},async dialogProtocoloSefaz(){return new Promise(r=>{$q.dialog({title:"Aviso importante",message:"O XML que est\xE1 sendo importado n\xE3o foi protocolado pela Sefaz, gostaria de importar o XML sem o protocolo?",cancel:{label:"N\xE3o",push:!0,color:"tertiary",flat:!0},ok:{label:"Sim",push:!0,class:"bg-primary",textColor:"white",flat:!0},persistent:!0}).onOk(()=>{r(!0)}).onCancel(()=>{r(!1)})})},async importarXmlNotaDeEntrada(r){if(!this.xmlNotaEntrada.arquivo)return this.$q.notify({type:"warning",message:"Adicione um arquivo XML antes de enviar!"});try{$q.loading.show();const n=await(f=>new Promise((c,V)=>{const m=new FileReader;m.readAsBinaryString(f),m.onload=()=>c(m.result),m.onerror=s=>V(s)}))(this.xmlNotaEntrada.arquivo),d=new DOMParser,a=new XMLSerializer,i=d.parseFromString(n,"text/xml"),g=a.serializeToString(i),l=this;if(i.documentElement.nodeName==="html")throw new Error("Arquivo inv\xE1lido ou corrompido");const u=new va.Parser;let v;u.parseString(g,(f,c)=>{f&&console.log(f),v=c});let p=null,I=!0;v&&v.nfeProc&&v.nfeProc.protNFe?p=v.nfeProc.protNFe[0].infProt[0].nProt[0]:p||(I=await this.dialogProtocoloSefaz()),I?(await $db.compra.importaXml({xmlString:g,tela:l,xmlEstrangeiro:!!this.xmlEstrangeiro}),this.$q.notify({type:"positive",message:"Importa\xE7\xE3o realizada com sucesso!"})):this.$q.notify({type:"warning",message:"Opera\xE7\xE3o para importa\xE7\xE3o de XML cancelada!"})}catch(e){this.$q.notifyError(e.message),console.error(e)}finally{delete this.xmlNotaEntrada.arquivo,this.modalXMLNotaEntrada=!1,this.xmlEstrangeiro=!1,await this.atualizar(),$q.loading.hide()}},async fecharXmlNotaDeEntrada(){delete this.xmlNotaEntrada.arquivo},async abrir(r){this.tabSelecionada2.valor!=="Nota no SEFAZ"&&(this.$router.replace({params:{id:r}}),this.$refs.comprasFicha.mostrar({id:r}))},criarClick(){this.$refs.comprasFicha.criar()},importarXmlClick(){this.modalXMLNotaEntrada=!0},limparFiltrosClick(){this.filtros.numero="",this.filtros.termoBusca="",this.filtros.numeroCompra="",this.filtros.periodoEmissao.ini="",this.filtros.periodoEmissao.fim="",this.filtros.periodoFinalizado.ini="",this.filtros.periodoFinalizado.fim="",this.filtros.fornecedor.id=null,this.filtros.fornecedor.nome="",this.atualizar()},async consultarSefazClick(){try{let r,e,n,d,a,i,g,l;if(e=(await $db.contato.ler({filtros:{ativo:!0,empresas:!0}})).data,!(e.length>0)){this.$q.notify({message:"N\xE3o h\xE1 empresa configurada",timeout:0,type:"negative",closeBtn:!0});return}if(r=e[0],e.length>1){const P={ativo:!0,empresas:!0};if(r=await $g.promptContato.show({filtro:P,placeholder:"Selecione a empresa"}),!r){this.visivel=!1,this.$q.notifyError("Empresa n\xE3o selecionada");return}}if(n=(await $erp().empresa.where({idContato:r.id}).toArray())[0],!n){this.visivel=!1,this.$q.notifyError("Erro ao selecionar empresa");return}n&&(d=await $db.contatoEndereco.leEnderecoPrincipal(r.id),a=await $db.configuracoes.leValorComFiltroEmpresa("compras.sefaz.nsu",n.id),a||(a="0"));const u=n.numeroDocumentoNacional.match(/\d+/g).join("");for(;a.length<15;)a=`0${a}`;const v=`<?xml version="1.0" encoding="utf-8"?><distDFeInt versao="1.01" xmlns="http://www.portalfiscal.inf.br/nfe"><tpAmb>2</tpAmb><cUFAutor>${d.ufCod}</cUFAutor><CNPJ>${u}</CNPJ><distNSU><ultNSU>${a}</ultNSU></distNSU></distDFeInt>`,p={xml:v,cnpj:u,dataHora:new Date},f={id:$utils.uuid(),tipo:"DFe",situacao:"",tpAmb:1,dhEmi:new Date,dataHoraEmissao:new Date,dataHoraCriacao:new Date,cpfCnpjEmitente:u,xNomeEmitente:n.nome,json:JSON.stringify(p)}.json,c=new Headers;c.append("Content-Type","application/json; charset=utf-8"),g=await fetch("https://api.b15.com.br/integradorjs/dfe/consultar",{method:"POST",headers:c,body:JSON.stringify({xml:v})});const V=await g.json();if(!g.ok){let P="Erro desconhecido";/GError:.+/.test(V.error)&&(P=V.error.slice(7)),$q.notifyError(P);return}if(V.cStat!=="100"){$q.notifyError(V.xMotivo);return}const m=g.dfe.retDistDFeInt,s=g.err,b=g.arquivos;if(m!==""&&Number(m==null?void 0:m.ultNSU[0])>Number(a)){const P=await $db.configuracoes.atualizaPorNome("compras.sefaz.nsu",n.id,m.ultNSU[0])}if(b){let P=0;for(let x in b)try{const E=b[x],A={id:$utils.uuid(),tipo:"DFe",situacao:"N\xE3o Importada",tpAmb:E.nfeProc.NFe[0].infNFe[0].ide[0].tpAmb[0],mod:E.nfeProc.NFe[0].infNFe[0].ide[0].mod[0],serie:E.nfeProc.NFe[0].infNFe[0].ide[0].serie[0],nNF:E.nfeProc.NFe[0].infNFe[0].ide[0].nNF[0],chNFe:E.nfeProc.protNFe[0].infProt[0].chNFe[0],vNF:E.nfeProc.NFe[0].infNFe[0].total[0].ICMSTot[0].vNF[0],dhEmi:E.nfeProc.NFe[0].infNFe[0].ide[0].dhEmi[0],dataHoraEmissao:E.nfeProc.NFe[0].infNFe[0].ide[0].dhEmi[0],dataHoraCriacao:null,dataHoraAlteracao:null,cpfCnpjEmitente:E.nfeProc.NFe[0].infNFe[0].emit[0].CNPJ[0],xNomeEmitente:E.nfeProc.NFe[0].infNFe[0].emit[0].xNome[0],xFantEmitente:E.nfeProc.NFe[0].infNFe[0].emit[0].xNome[0],cpfCnpjDestinatario:E.nfeProc.NFe[0].infNFe[0].dest[0].CNPJ[0],xNomeDestinatario:E.nfeProc.NFe[0].infNFe[0].dest[0].xNome[0],xFantDestinatario:E.nfeProc.NFe[0].infNFe[0].dest[0].xNome[0],json:JSON.stringify({xml:E.xml}),naturezaOperacao:E.nfeProc.NFe[0].infNFe[0].ide[0].natOp[0]};(await $db.hibrido.lista({table:"documentoFiscalEletronico",where:{tipo:"DFe"}})).some(U=>U.chNFe===A.chNFe)||(await $db.documentoFiscalEletronico.grava({atual:A,original:{}}),P++)}catch(E){console.log(E.message)}this.$q.notify(`Importa\xE7\xE3o via SEFAZ Finalizada, ${P} Notas Importadas`)}}catch(r){console.log(r.message)}},async configuraImpressao(r){const e=await $db.configuracoes.porNome("impressao.compra",r);this.configImpressao=[...e.length?e.map(n=>({texto:"Imprimir Compra",...n})):[{valor:"invoice",texto:"Compras e Estoque"}]]},setOpcoesTabs(r){r!=="Nota no SEFAZ"&&(this.tabSelecionada.valor="Digita\xE7\xE3o",this.tabs=[{valor:"Digita\xE7\xE3o",rotulo:"Digita\xE7\xE3o"},{valor:"Finalizado",rotulo:"Finalizado"},{valor:"Todos",rotulo:"Todos"}]),r==="Nota no SEFAZ"&&(this.tabSelecionada.valor="N\xE3o Importada",this.tabs=[{valor:"N\xE3o Importada",rotulo:"N\xE3o Importada"},{valor:"Importada",rotulo:"Importada"}])},async downloadXmlDFe(r){const e=await $db.hibrido.le({table:"documentoFiscalEletronico",id:r}),n=JSON.parse(e.json).xml;if(n){const d=document.createElement("a"),a=new Blob([n],{type:"text/plain"});d.setAttribute("href",window.URL.createObjectURL(a)),d.setAttribute("download",`${e.chNFe}.xml`),d.dataset.downloadurl=["text/plain",d.download,d.href].join(":"),d.click()}n||this.$q.notifyError("N\xE3o foi poss\xEDvel recuperar o XML")},async importarXmlDFe(r){try{const e=await $db.hibrido.le({table:"documentoFiscalEletronico",id:r}),n=JSON.parse(e.json).xml;if(n){const d=new DOMParser,a=new XMLSerializer,i=d.parseFromString(n,"text/xml"),g=a.serializeToString(i),l=this;await $db.compra.importaXml({xmlString:g,tela:l});const u={original:$utils.clonarV2(e),atual:$utils.clonarV2(e)};u.atual.situacao="Importada",await $db.documentoFiscalEletronico.grava(u),$q.notify("XML Importado para Compras")}}catch(e){console.log(e.message),$q.notifyError("Erro ao importar XML",e)}}},watch:{$route(){var r;this.tabSelecionada2.valor=this.$route.name,this.atualizar({buscarDadosRecentes:!0}),this.$route.name==="Nota de Entrada"&&((r=this.$route.params)==null?void 0:r.id)&&this.$refs.comprasFicha.mostrar({id:this.$route.params.id})}},async mounted(){this.tabSelecionada2.valor=this.$route.name,this.atualizar({buscarDadosRecentes:!0}),this.$route.name==="Nota de Entrada"&&this.$route.params.id&&this.$route.params.id.length&&this.$refs.comprasFicha.mostrar({id:this.$route.params.id})}},ee={id:"Compras"},te={class:"mw80 text-center"},re={class:"row q-ma-md"},le={key:0,class:"row q-ma-md"},ie={class:"certificado-error-messages"};function se(r,e,n,d,a,i){const g=k("campo"),l=k("BadgeCopiarUid"),u=k("avatar"),v=k("badge"),p=k("g-label"),I=k("g-col"),f=k("g-row"),c=k("Lista"),V=k("ComprasFicha"),m=k("ComprasImportacaoXML");return C(),Q("div",ee,[o(c,{busca:a.busca,"onUpdate:busca":e[9]||(e[9]=s=>a.busca=s),onAtualizar:i.atualizar,onLimparFiltrosClick:i.limparFiltrosClick,onCriarClick:i.criarClick,onConsultarSefazClick:i.consultarSefazClick,lista:a.lista,tabSelecionada:a.tabSelecionada,tabs:a.tabs,tabSelecionada2:a.tabSelecionada2,tabs2:a.tabs2,paginacao:a.paginacao,mostrar:a.mostrar},{botaoNovo:t(()=>[o(z,{label:"Novo",icon:"add",unelevated:"",color:"primary","text-color":"white",class:"hideonmobile"},{default:t(()=>[o(fo,null,{default:t(()=>[o(Y,{link:"","no-border":"",separator:""},{default:t(()=>[O((C(),y(j,{onClick:i.criarClick,clickable:""},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"add"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h("Incluir Manual")]),_:1})]),_:1})]),_:1},8,["onClick"])),[[J]]),O((C(),y(j,{onClick:i.importarXmlClick,clickable:""},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"add"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h("Importar XML")]),_:1})]),_:1})]),_:1},8,["onClick"])),[[J]])]),_:1})]),_:1})]),_:1}),o(z,{icon:"add",flat:"",round:"",color:"primary","text-color":"white",class:"hideondesktop"},{default:t(()=>[o(fo,null,{default:t(()=>[o(Y,{link:"","no-border":"",separator:""},{default:t(()=>[O((C(),y(j,{onClick:i.criarClick,clickable:""},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"add"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h("Incluir Manual")]),_:1})]),_:1})]),_:1},8,["onClick"])),[[J]]),O((C(),y(j,{onClick:i.importarXmlClick,clickable:""},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"add"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h("Importar XML")]),_:1})]),_:1})]),_:1},8,["onClick"])),[[J]])]),_:1})]),_:1})]),_:1})]),filtroCampos:t(()=>[o(g,{modelValue:a.filtros.numero,"onUpdate:modelValue":e[0]||(e[0]=s=>a.filtros.numero=s),rotulo:"N\xBA Nota",dense:"",class:"q-field--with-bottom"},null,8,["modelValue"]),o(g,{modelValue:a.filtros.termoBusca,"onUpdate:modelValue":e[1]||(e[1]=s=>a.filtros.termoBusca=s),rotulo:"Palavra Chave",dense:"",class:"q-field--with-bottom"},null,8,["modelValue"]),o(g,{modelValue:a.filtros.numeroCompra,"onUpdate:modelValue":e[2]||(e[2]=s=>a.filtros.numeroCompra=s),rotulo:"Ordem de compra",dense:"",class:"q-field--with-bottom"},null,8,["modelValue"]),o(g,{modelValue:a.filtros.fornecedor.nome,"onUpdate:modelValue":e[3]||(e[3]=s=>a.filtros.fornecedor.nome=s),rotulo:"Fornecedor",dense:"",class:"q-field--with-bottom q-mb-md"},null,8,["modelValue"]),o(g,{modelValue:a.filtros.periodoEmissao.ini,"onUpdate:modelValue":e[4]||(e[4]=s=>a.filtros.periodoEmissao.ini=s),rotulo:"Data Emiss\xE3o",dense:"",tipo:"data",class:"q-mb-x"},null,8,["modelValue"]),o(g,{modelValue:a.filtros.periodoEmissao.fim,"onUpdate:modelValue":e[5]||(e[5]=s=>a.filtros.periodoEmissao.fim=s),rotulo:"at\xE9",dense:"",tipo:"data",class:"q-mb-xl"},null,8,["modelValue"]),o(g,{modelValue:a.filtros.periodoFinalizado.ini,"onUpdate:modelValue":e[6]||(e[6]=s=>a.filtros.periodoFinalizado.ini=s),rotulo:"Data Finalizado",dense:"",tipo:"data",class:"q-mb-xs"},null,8,["modelValue"]),o(g,{modelValue:a.filtros.periodoFinalizado.fim,"onUpdate:modelValue":e[7]||(e[7]=s=>a.filtros.periodoFinalizado.fim=s),rotulo:"at\xE9",dense:"",tipo:"data",class:"q-mb-xl"},null,8,["modelValue"]),o(g,{modelValue:a.paginacao.limite,"onUpdate:modelValue":e[8]||(e[8]=s=>a.paginacao.limite=s),rotulo:"Quantidade por p\xE1gina",dense:"",tipo:"quantidade",min:"1",class:"q-field--with-bottom"},null,8,["modelValue"])]),itemLista:t(()=>[o(Y,{bordered:"",class:"bg-white q-mb-xs rounded-borders",style:{"min-height":"calc(100vh - 200px)"}},{default:t(()=>[(C(!0),Q(oo,null,ro(a.lista,s=>(C(),Q("div",{key:s.id,class:"itemHover"},[o(j,{"manual-focus":"",class:"q-py-sm q-px-xs items-center"},{default:t(()=>[o(D,{class:"hideonmobile col-auto q-px-sm no-margin"},{default:t(()=>[M("div",te,[s.numero?(C(),y(l,{key:0,id:s.id,numero:s.numero.toString(),cor:"positive",escuro:""},null,8,["id","numero"])):(C(),y(l,{key:1,id:s.id,numero:s.id.slice(-8),cor:"tertiary",escuro:""},null,8,["id","numero"])),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("N\xFAmero da Compra")]),_:1})])]),_:2},1024),o(D,{class:"col-md col-lg col-xl no-margin"},{default:t(()=>[o(j,{class:"q-pa-none"},{default:t(()=>[o(D,{onClick:b=>i.abrir(s.id),class:"col-auto items-center"},{default:t(()=>[o(u,{imagem:s.imagem,rotulo:s.descricaoContato,tamanho:"40",style:{display:"flex","align-self":"center"}},null,8,["imagem","rotulo"])]),_:2},1032,["onClick"]),o(D,{class:"col"},{default:t(()=>[o(H,{onClick:b=>i.abrir(s.id),lines:"2",class:"text-tertiary text-weight-bold ellipsis-2-lines"},{default:t(()=>[h(w(s.descricaoContato)+" ",1),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("Fornecedor")]),_:1})]),_:2},1032,["onClick"]),o(j,{class:"q-pa-none hideonmobile",style:{"min-height":"unset"}},{default:t(()=>[s.notaNumero?(C(),y(v,{key:0,cor:"tertiary",class:"mw50 text-center",escuro:""},{default:t(()=>[h(w(s.notaNumero)+" ",1),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("N\xFAmero da Nota")]),_:1})]),_:2},1024)):(C(),y(v,{key:1,cor:"warning",class:"mw50 text-center",escuro:""},{default:t(()=>[h(" S/N "),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("N\xFAmero da Nota")]),_:1})]),_:1}))]),_:2},1024),o(D,{class:"hideondesktop q-mt-sm"},{default:t(()=>[o(f,{mg:"xs-b"},{default:t(()=>[s.dataHoraEmissao?(C(),y(I,{key:0,col:"shrink"},{default:t(()=>[o(p,{icon:"mdi-calendar-today xs tertiary left",tip:`Emitido \xE1s ${r.$filters.hora(s.dataHoraEmissao)}`},{default:t(()=>[h(w(r.$filters.data(s.dataHoraEmissao)),1)]),_:2},1032,["tip"])]),_:2},1024)):B("",!0),s.dataHoraFinalizado?(C(),y(I,{key:1,col:"shrink",class:"q-ml-sm"},{default:t(()=>[o(p,{icon:"mdi-calendar xs tertiary left",tip:`Finalizado \xE1s ${r.$filters.hora(s.dataHoraFinalizado)}`},{default:t(()=>[h(w(r.$filters.data(s.dataHoraFinalizado)),1)]),_:2},1032,["tip"])]),_:2},1024)):B("",!0)]),_:2},1024),o(f,{mg:"xs-b"},{default:t(()=>[s.numero?(C(),y(I,{key:0,col:"shrink"},{default:t(()=>[o(v,{rotulo:`#${s.numero.toString().padStart(6,"0")}`,cor:"positive",escuro:""},null,8,["rotulo"])]),_:2},1024)):(C(),y(I,{key:1,col:"shrink"},{default:t(()=>[o(l,{id:s.id,numero:s.id.slice(-8),cor:"tertiary",escuro:""},null,8,["id","numero"])]),_:2},1024)),o(I,{col:"shrink",class:"q-ml-sm"},{default:t(()=>[s.notaNumero?(C(),y(v,{key:0,cor:"tertiary",class:"mw50",escuro:""},{default:t(()=>[h(w(s.notaNumero)+" ",1),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("N\xFAmero da Nota")]),_:1})]),_:2},1024)):(C(),y(v,{key:1,cor:"warning",class:"mw50",escuro:""},{default:t(()=>[h(" S/N "),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("N\xFAmero da Nota")]),_:1})]),_:1}))]),_:2},1024),o(I,{col:"shrink",class:"q-ml-sm"},{default:t(()=>[o(v,{rotulo:s.status,cor:s.status!=="Digita\xE7\xE3o"?"tertiary":"light",escuro:s.status!=="Digita\xE7\xE3o"},null,8,["rotulo","cor","escuro"])]),_:2},1024)]),_:2},1024),o(f,null,{default:t(()=>[o(I,{col:"shrink",text:"bold"},{default:t(()=>[h(w(r.$filters.numero(s.totalDocumento,2)),1)]),_:2},1024),O(o(I,{col:"grow",text:"center",class:"q-ml-sm"},{default:t(()=>[h(w(s.qtdeContatos)+" Itens ",1)]),_:2},1536),[[W,s.qtdeContatos>0]])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(D,{onClick:b=>i.abrir(s.id),class:"hideonmobile maxw110 q-pl-sm no-margin"},{default:t(()=>[s.dataHoraEmissao?(C(),y(H,{key:0,lines:"1",color:"tertiary",class:"ellipsis"},{default:t(()=>[o(L,{name:"mdi-calendar-today"}),h(" "+w(r.$filters.data(s.dataHoraEmissao))+" ",1),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h(" Emitido \xE1s "+w(r.$filters.hora(s.dataHoraEmissao)),1)]),_:2},1024)]),_:2},1024)):B("",!0),s.dataHoraFinalizado?(C(),y(H,{key:1,lines:"1",color:"tertiary",class:"ellipsis"},{default:t(()=>[o(L,{name:"mdi-calendar"}),h(" "+w(r.$filters.data(s.dataHoraFinalizado))+" ",1),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h(" Finalizado \xE1s "+w(r.$filters.hora(s.dataHoraFinalizado)),1)]),_:2},1024)]),_:2},1024)):B("",!0)]),_:2},1032,["onClick"]),o(D,{onClick:b=>i.abrir(s.id),class:"hideonmobile maxw90 q-pl-sm no-margin"},{default:t(()=>[o(v,{cor:s.status!=="Digita\xE7\xE3o"?"tertiary":"light",escuro:s.status!=="Digita\xE7\xE3o",class:"col-auto q-mx-auto"},{default:t(()=>[h(w(s.status)+" ",1),o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h(" Status ")]),_:1})]),_:2},1032,["cor","escuro"])]),_:2},1032,["onClick"]),o(D,{onClick:b=>i.abrir(s.id),class:"hideonmobile maxw120 q-pl-sm no-margin"},{default:t(()=>[o(H,{class:"text-tertiary text-weight-bold text-right"},{default:t(()=>[h(w(r.$filters.numero(s.totalDocumento,2)),1)]),_:2},1024),O(o(H,{class:"text-tertiary text-right"},{default:t(()=>[h(w(s.qtdeContatos)+" Itens ",1)]),_:2},1536),[[W,s.qtdeContatos>0]])]),_:2},1032,["onClick"]),o(D,{class:"hideonmobile col-auto q-pl-sm no-margin"},{default:t(()=>[o(j,{class:"q-pa-none"},{default:t(()=>[a.tabSelecionada2.valor!=="Nota no SEFAZ"?(C(),y(D,{key:0,class:"q-pr-sm no-margin"},{default:t(()=>[o(z,{onClick:b=>i.abrir(s.id),icon:"edit",size:"md",color:"primary",round:"",flat:"",dense:""},null,8,["onClick"])]),_:2},1024)):B("",!0),a.tabSelecionada2.valor==="Nota no SEFAZ"&&a.tabSelecionada.valor==="N\xE3o Importada"?(C(),y(D,{key:1,class:"q-pr-sm no-margin"},{default:t(()=>[o(z,{onClick:b=>i.importarXmlDFe(s.id),flat:"",round:"",dense:"",icon:"mdi-upload",size:"md",color:"tertiary",class:"buttons"},{default:t(()=>[o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("Importar XML")]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)):B("",!0),a.tabSelecionada2.valor==="Nota no SEFAZ"?(C(),y(D,{key:2,class:"q-pr-sm no-margin"},{default:t(()=>[o(z,{onClick:b=>i.downloadXmlDFe(s.id),flat:"",round:"",dense:"",icon:"mdi-download",color:"tertiary",size:"md",class:"buttons"},{default:t(()=>[o(X,{anchor:"bottom middle",self:"center middle"},{default:t(()=>[h("Exportar XML")]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)):B("",!0),o(D,{class:"no-margin"},{default:t(()=>[o(z,{icon:"print",size:"md",color:"tertiary",round:"",flat:"",dense:""},{default:t(()=>[o(fo,null,{default:t(()=>[O((C(),y(Y,{link:"","no-border":"",separator:""},{default:t(()=>[(C(!0),Q(oo,null,ro(a.configImpressao.filter(b=>b.valor),b=>(C(),y(j,{key:b.valor,onClick:P=>r.$imprimir(b.valor,(s==null?void 0:s.id)||"0"),clickable:""},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"print"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h(w(b.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)),[[J]])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(D,{class:"hideondesktop col-auto q-pl-sm no-margin"},{default:t(()=>[o(z,{icon:"more_vert",size:"md",color:"tertiary",round:"",flat:"",dense:""},{default:t(()=>[o(fo,null,{default:t(()=>[O((C(),y(Y,{link:"","no-border":"",separator:""},{default:t(()=>[a.tabSelecionada2.valor!=="Nota no SEFAZ"?(C(),y(j,{key:0,onClick:b=>i.abrir(s.id),clickable:"",class:"itemHover"},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"edit"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h(" Editar ")]),_:1})]),_:1})]),_:2},1032,["onClick"])):B("",!0),a.tabSelecionada2.valor==="Nota no SEFAZ"&&a.tabSelecionada.valor==="N\xE3o Importada"?(C(),y(j,{key:1,onClick:b=>i.importarXmlDFe(s.id),clickable:"",class:"itemHover"},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"mdi-upload"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h(" Importar XML ")]),_:1})]),_:1})]),_:2},1032,["onClick"])):B("",!0),a.tabSelecionada2.valor==="Nota no SEFAZ"?(C(),y(j,{key:2,onClick:b=>i.downloadXmlDFe(s.id),clickable:"",class:"itemHover"},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"mdi-download"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h(" Exportar XML ")]),_:1})]),_:1})]),_:2},1032,["onClick"])):B("",!0),(C(!0),Q(oo,null,ro(a.configImpressao.filter(b=>b.valor),b=>(C(),y(j,{key:b.valor,onClick:P=>r.$imprimir(b.valor,(s==null?void 0:s.id)||"0"),clickable:"",class:"itemHover"},{default:t(()=>[o(D,{avatar:""},{default:t(()=>[o(L,{name:"print"})]),_:1}),o(D,null,{default:t(()=>[o(H,null,{default:t(()=>[h(w(b.texto),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)),[[J]])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),o(No)]))),128))]),_:1})]),_:1},8,["busca","onAtualizar","onLimparFiltrosClick","onCriarClick","onConsultarSefazClick","lista","tabSelecionada","tabs","tabSelecionada2","tabs2","paginacao","mostrar"]),o(V,{ref:"comprasFicha",onAtualizar:i.atualizar},null,8,["onAtualizar"]),o(m,{ref:"comprasImportacaoXML",onAtualizar:i.atualizar},null,8,["onAtualizar"]),o(_o,{modelValue:a.modalXMLNotaEntrada,"onUpdate:modelValue":e[13]||(e[13]=s=>a.modalXMLNotaEntrada=s),persistent:""},{default:t(()=>[o(Vo,{container:"",class:"bg-light",style:{height:"40vh",width:"50vw","max-width":"100vw"}},{default:t(()=>[M("form",{onSubmit:e[12]||(e[12]=Ia((...s)=>i.importarXmlNotaDeEntrada&&i.importarXmlNotaDeEntrada(...s),["prevent"]))},[o(wo,null,{default:t(()=>[o(lo,null,{default:t(()=>[O(o(z,{onClick:i.fecharXmlNotaDeEntrada,flat:"",round:"",dense:"",icon:"close"},null,8,["onClick"]),[[J]]),o(ho,null,{default:t(()=>[h("Importar XML Nota de Entrada")]),_:1}),o(z,{color:"white","text-color":"primary",label:"Enviar",type:"submit",unelevated:""})]),_:1})]),_:1}),o(yo,{class:"u-container"},{default:t(()=>[o(Do,{style:{"min-height":"300px"}},{default:t(()=>{var s,b,P;return[M("div",re,[o(Ca,{class:"col-12","hide-upload-btn":"","auto-upload":"",factory:i.adicionarXml,filter:x=>x.filter(E=>E.type==="text/xml")},null,8,["factory","filter"]),o(na,{modelValue:a.xmlDevolucao,"onUpdate:modelValue":e[10]||(e[10]=x=>a.xmlDevolucao=x),label:"Devolu\xE7\xE3o"},null,8,["modelValue"]),o(na,{modelValue:a.xmlEstrangeiro,"onUpdate:modelValue":e[11]||(e[11]=x=>a.xmlEstrangeiro=x),label:"Importa\xE7\xE3o do exterior"},null,8,["modelValue"])]),Object.keys((P=(b=(s=a.xmlNotaEntrada.error)==null?void 0:s.data)==null?void 0:b.fields)!=null?P:{}).length?(C(),Q("div",le,[M("ul",ie,[(C(!0),Q(oo,null,ro(Object.keys(a.xmlNotaEntrada.error.data.fields),x=>(C(),Q("li",{key:x},[M("span",null,w(x),1),M("span",null,w(a.xmlNotaEntrada.error.data.fields[x]),1)]))),128))])])):B("",!0)]}),_:1})]),_:1})],32)]),_:1})]),_:1},8,["modelValue"])])}var pe=Co(ae,[["render",se]]);export{pe as default};
