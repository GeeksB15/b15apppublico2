import{_ as T,a as A,r as b,o as d,d as h,w as i,H as y,f as o,Q as c,N as F,e9 as I,bd as L,p as $,h as _,i as x,k as f,t as w,e as N,C as v,cM as j,be as Q,P as S,S as k,T as E,j as C,U as M,F as W,x as O,G as V,J as q,I as z,M as R,v as U,K as D,aU as P,D as H}from"./index.2cdc9160.js";import{o as J}from"./open-url.086626d9.js";import{V as B}from"./Visualizador.55fcf89c.js";const X={data(){return{email:{de:"",para:"",assunto:"",mensagem:""},ruleObrigatorio:e=>(e||"").trim().length||"Preenchimento obrigat\xF3rio"}},methods:{async enviarNFeEmail(e){const{showLoading:t,successMsg:r,errorMsg:s}=e!=null?e:{};try{(t==null||t)&&$q.loading.show({message:"Envio de e-mail em andamento...",html:!0,boxClass:"bg-grey-2 text-grey-9",spinnerColor:"primary"});const a=[{name:`danfe_${this.nota.nNF}.pdf`,content:this.html,method:"html2pdf"}];for(const m of this.xmls)a.push({name:`${m.tipo}_${m.nNF}_${m.operacao}${m.nSeqEvento>1?"_"+m.nSeqEvento:""}.xml`,content:m.xmlProt});const l={host:"smtp.gmail.com",port:587,ssl:!0,auth:{user:"auto@geekssolucoes.com.br",pass:"drab azmd uvtf izhd"},from:this.email.de,to:this.email.para,subject:this.email.assunto,text:this.email.mensagem,attachments:a},n=await A({baseURL:"https://api.b15.com.br",method:"post",url:"/email/v2",data:l});this.$q.notifyPositive((n==null?void 0:n.status)===200&&r?r:n.data.message)}catch(a){this.$q.notifyError(s||"Erro ao enviar e-mail",a)}finally{this.$q.loading.hide()}},async enviarNFeEmailAutomatico(e,t){var r,s,a,l,n,m,u;try{if(this.html=t,this.nota=await $db.hibrido.le({table:"documentoFiscalEletronico",id:e}),this.xmls=await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:e}}),this.json=JSON.parse((r=this.nota.json)!=null?r:null),!((l=(a=(s=this.json)==null?void 0:s.infNFe)==null?void 0:a.dest)!=null&&l.email)){this.$q.notify({type:"warning",message:"Cliente sem e-mail cadastrado. XML e DANFE n\xE3o enviado automaticamente."});return}this.email={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:(u=(m=(n=this.json)==null?void 0:n.infNFe)==null?void 0:m.dest)==null?void 0:u.email,assunto:`Nota Fiscal Eletr\xF4nica N\xBA ${this.nota.nNF}`,mensagem:`Voc\xEA est\xE1 recebendo os arquivos digitais NFe (Nota Fiscal Eletr\xF4nica) da empresa ${this.nota.xFantEmitente}`},this.enviarNFeEmail({successMsg:`XML e DANFE enviados para ${this.email.para} com sucesso.`,errorMsg:"Erro ao enviar e-mail. XML e DANFE n\xE3o enviado automaticamente."})}catch(g){this.$q.notifyError("Erro ao abrir a nota",g)}},async abrirNFeEmail(e,t){try{this.html=t,this.nota=await $db.hibrido.le({table:"documentoFiscalEletronico",id:e}),this.xmls=await $db.hibrido.lista({table:"documentoFiscalEletronicoXml",where:{idDocumentoFiscalEletronico:e}}),this.json=JSON.parse(this.nota.json),this.email={de:"Geeks Solu\xE7\xF5es <auto@geekssolucoes.com.br>",para:this.$lodash.get(this.json,"infNFe.dest.email",""),assunto:`Nota Fiscal Eletr\xF4nica N\xBA ${this.nota.nNF}`,mensagem:`Voc\xEA est\xE1 recebendo os arquivos digitais NFe (Nota Fiscal Eletr\xF4nica) da empresa ${this.nota.xFantEmitente}`},this.$refs.dialogNFeEmail.show()}catch(r){this.$q.notifyError("Erro ao abrir a nota",r)}}},mounted(){$utils.emitter.off("abrirNFeEmail"),$utils.emitter.on("abrirNFeEmail",this.abrirNFeEmail),$utils.emitter.off("enviarNFeEmailAutomatico"),$utils.emitter.on("enviarNFeEmailAutomatico",this.enviarNFeEmailAutomatico)},beforeUnmount(){$utils.emitter.off("enviarNFeEmailAutomatico"),$utils.emitter.off("abrirNFeEmail")}};function G(e,t,r,s,a,l){const n=b("campo"),m=b("row"),u=b("card"),g=b("dialogForm");return d(),h(g,{onSubmit:l.enviarNFeEmail,ref:"dialogNFeEmail",footer:"",title:"Nota Fiscal / Email",size:"md"},{buttonsFooter:i(()=>[y(o(c,{label:"Cancelar",color:"tertiary",flat:""},null,512),[[F]]),o(c,{label:"Enviar",type:"submit",color:"primary"})]),default:i(()=>[o(u,null,{default:i(()=>[o(m,{class:"q-col-gutter-y-md"},{default:i(()=>[o(n,{modelValue:a.email.de,"onUpdate:modelValue":t[0]||(t[0]=p=>a.email.de=p),"somente-leitura":"",filled:"",col:"12",rotulo:"De"},null,8,["modelValue"]),o(n,{modelValue:a.email.para,"onUpdate:modelValue":t[1]||(t[1]=p=>a.email.para=p),rules:[a.ruleObrigatorio],filled:"",col:"12",rotulo:"Para"},null,8,["modelValue","rules"]),o(n,{modelValue:a.email.assunto,"onUpdate:modelValue":t[2]||(t[2]=p=>a.email.assunto=p),rules:[a.ruleObrigatorio],filled:"",col:"12",rotulo:"Assunto"},null,8,["modelValue","rules"]),o(n,{modelValue:a.email.mensagem,"onUpdate:modelValue":t[3]||(t[3]=p=>a.email.mensagem=p),rules:[a.ruleObrigatorio],autogrow:"",autofocus:"",filled:"",col:"12",rotulo:"Mensagem",tipo:"textoArea"},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])}var K=T(X,[["render",G]]);const Y={components:{NFeEmail:K,Visualizador:B},computed:{nome(){return this.$route.params.nome},parametro(){const{parametro:e}=this.$route.params;return e?$utils.base64.decodeFromUrl(e):""}},data(){return{impressao:null,impressorasRemotas:[],botaoImprimir:!0,componente:null,objeto:{},urlCompartilhamento:"",editarMsgWhatsapp:!1,configuracoesTexto:""}},methods:{async visualizadorIsMounted(){if(this.nome==="nfe-danfe"&&I()==="emitirNFe"){let e=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML,t=0,r=0;const s=500,a=5e3;await new Promise(l=>{const n=setInterval(()=>{const m=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;e===m?(t++,r+=50):(t=0,r=0),e=m,(r>=s||t>=10)&&(clearInterval(n),l()),r>=a&&(clearInterval(n),l())},50)}),$utils.emitter.emit("enviarNFeEmailAutomatico",this.parametro,e)}},abrirNFeEmail(){$utils.emitter.emit("abrirNFeEmail",this.parametro,this.$refs.visualizador.$el.contentWindow.document.body.innerHTML)},async carregarObjeto(e){try{const t=await L.objeto.le({filtros:{nomeObjeto:e,tipo:"vue"}});if(!t||!t[0]||!t[0].codigoPersonalizado)return this.$q.notify("Relat\xF3rio indispon\xEDvel ou sem permiss\xE3o");this.objeto=t[0];const r=JSON.parse($utils.base64.decode(t[0].codigoPersonalizado));this.componente={parametro:this.parametro,estilo:r.estilo,script:r.script,template:r.template}}catch{$q.notify({message:"N\xE3o foi poss\xEDvel carregar a impress\xE3o.",type:"negative"})}},async copiarLink(){const e=this.$refs.urlCompartilhamento;e.type="text",await this.$nextTick();try{e.select(),document.execCommand("copy"),this.$q.notify({message:"Copiado para a \xE1rea de transfer\xEAncia",type:"info"})}catch(t){this.$q.notifyError("Erro ao copiar",t)}e.type="hidden",window.getSelection().removeAllRanges()},async compartilhar(){let e="";try{this.$q.loading.show();const s=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;e=(await A({baseURL:"https://api.b15.com.br",method:"post",url:"/html2pdf",data:{html:s}})).data.url,this.urlCompartilhamento=e}catch(s){return this.$q.notifyError("Erro ao gerar o link de compartilhamento.",s)}finally{this.$q.loading.hide()}const t=this.objeto.descricao||"Relat\xF3rio",r=[{label:"Copiar link",icon:"link",handler:this.copiarLink},{color:"green",label:"WhatsApp",icon:"message",handler:()=>{this.editarMsgWhatsapp=!0}}];navigator.share&&r.push({label:"Outros",icon:"more_horiz",handler:()=>{navigator.share({title:t,url:e})}}),this.$q.bottomSheet({grid:!0,title:"Compartilhar",actions:r}).onOk(s=>{s.handler()})},async enviarMensagemWhatsapp(){const e=await $erp().configuracoes.where({nome:"imprimir.compartilhar.whatsapp.mensagem"}).first()||null;e?await $db.configuracoes.grava({atual:{id:e==null?void 0:e.id,nome:(e==null?void 0:e.nome)||"",valor:(e==null?void 0:e.valor)||"",texto:this.configuracoesTexto||(e==null?void 0:e.texto)||"",observacao:(e==null?void 0:e.observacao)||"",idEmpresa:(e==null?void 0:e.idEmpresa)||""}}):await $db.configuracoes.grava({atual:{id:$utils.uuid(),nome:"imprimir.compartilhar.whatsapp.mensagem",valor:"",texto:this.configuracoesTexto||"Acesse o documento atrav\xE9s do link:",observacao:"",idEmpresa:""}});const t=`${this.configuracoesTexto} ${this.urlCompartilhamento}`;J(`https://wa.me/?text=${t}`)},async impressaoRemota(e){const t=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;await $utils.p2p.enviarMensagem(e,JSON.stringify({content:t}),"/print")},imprimirVisualizador(){if(window.cordova&&window.cordova.plugins&&window.cordova.plugins.printer){const e=this.$refs.visualizador.$el.contentWindow.document.body.innerHTML;return cordova.plugins.printer.print(e)}this.$refs.visualizador.$el.contentWindow.print()},voltar(){window&&window.history.back()}},async created(){var r;const e=await $db.configuracoes.leLista("integrador.idDispositivo"),t=[];for(const s of e)!/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/.test(s.valor)||!((r=s.texto)!=null&&r.trim())||t.push({idDispositivo:s.valor,nome:s.texto});this.impressorasRemotas=t},async mounted(){var t;/^\{.+\}$/gi.test(this.parametro)&&(this.impressao=((t=JSON.parse(this.parametro))==null?void 0:t.impressao)||null);const e=(await $db.configuracoes.le({nome:"imprimir.compartilhar.whatsapp.mensagem"}))[0]||[];if(this.configuracoesTexto=(e==null?void 0:e.texto)||"Acesse o documento atrav\xE9s do link:",this.nome&&this.nome!=="0")return this.carregarObjeto(this.nome);this.$q.notify("Impress\xE3o inv\xE1lida")}},Z={id:"imprimir"},ee={class:"Imprimir-visualizador"},te={class:"border-full border-radius q-mt-md q-pa-sm"};function oe(e,t,r,s,a,l){const n=b("visualizador"),m=b("NFeEmail");return d(),$("div",Z,[o(V,{elevated:"",class:"bg-gradiente text-white Imprimir-barraTopo"},{default:i(()=>[o(_,{class:"q-px-sm"},{default:i(()=>[o(c,{onClick:l.voltar,icon:"arrow_back",flat:"",round:"",dense:""},null,8,["onClick"]),o(x,null,{default:i(()=>[f(w(a.objeto.descricao||"Relat\xF3rio"),1)]),_:1}),l.nome==="nfe-danfe"?(d(),h(c,{key:0,onClick:l.abrirNFeEmail,label:"Email",icon:"email",flat:"",color:"white"},null,8,["onClick"])):N("",!0),y(v("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>a.urlCompartilhamento=u),ref:"urlCompartilhamento",type:"hidden"},null,512),[[j,a.urlCompartilhamento]]),a.impressao!=="etiquetas"?(d(),h(c,{key:1,onClick:t[1]||(t[1]=u=>e.tryLoading(l.compartilhar)),label:"Compartilhar",icon:"share",flat:"",color:"white"})):N("",!0),a.impressorasRemotas.length>0?(d(),h(c,{key:2,label:"Imprimir",icon:"print",flat:"",color:"white"},{default:i(()=>[o(Q,null,{default:i(()=>[y((d(),h(S,{link:"",separator:""},{default:i(()=>[o(k,{onClick:l.imprimirVisualizador,clickable:""},{default:i(()=>[o(E,{avatar:""},{default:i(()=>[o(C,{name:"mdi-printer"})]),_:1}),o(E,null,{default:i(()=>[o(M,null,{default:i(()=>t[5]||(t[5]=[f("Local")])),_:1})]),_:1})]),_:1},8,["onClick"]),(d(!0),$(W,null,O(a.impressorasRemotas,(u,g)=>(d(),h(k,{key:g,onClick:p=>l.impressaoRemota(u.idDispositivo),clickable:""},{default:i(()=>[o(E,{avatar:""},{default:i(()=>[o(C,{name:"mdi-cloud-print-outline"})]),_:1}),o(E,null,{default:i(()=>[o(M,null,{default:i(()=>[f(w(u.nome),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})),[[F]])]),_:1})]),_:1})):(d(),h(c,{key:3,onClick:l.imprimirVisualizador,label:"Imprimir",icon:"print",flat:"",color:"white"},null,8,["onClick"]))]),_:1})]),_:1}),o(z,{class:"Imprimir-pagina"},{default:i(()=>[o(q,null,{default:i(()=>[v("div",ee,[a.componente?(d(),h(n,{key:0,onMounted:l.visualizadorIsMounted,componente:a.componente,ref:"visualizador"},null,8,["onMounted","componente"])):N("",!0)])]),_:1})]),_:1}),o(m),o(H,{modelValue:a.editarMsgWhatsapp,"onUpdate:modelValue":t[4]||(t[4]=u=>a.editarMsgWhatsapp=u)},{default:i(()=>[o(R,{container:"",view:"hHh Lpr fFf",class:"bg-white",style:{"max-height":"400px"}},{default:i(()=>[o(V,null,{default:i(()=>[o(_,null,{default:i(()=>[y(o(c,{icon:"arrow_back",flat:"",round:""},null,512),[[F]]),o(x,null,{default:i(()=>t[6]||(t[6]=[f("Enviar mensagem WhatsApp")])),_:1})]),_:1})]),_:1}),o(z,null,{default:i(()=>[o(q,{class:"q-pa-md"},{default:i(()=>[o(U,{modelValue:a.configuracoesTexto,"onUpdate:modelValue":t[2]||(t[2]=u=>a.configuracoesTexto=u),type:"textarea",label:"Mensagem",filled:"",dense:""},null,8,["modelValue"]),v("p",te,[t[7]||(t[7]=v("span",{class:"text-weight-medium"},[f("Visualizar como esta \xE1 mensagem:"),v("br")],-1)),f(" "+w(a.configuracoesTexto)+" "+w(a.urlCompartilhamento),1)])]),_:1})]),_:1}),o(D,{class:"bg-light"},{default:i(()=>[o(_,null,{default:i(()=>[o(P),y(o(c,{flat:"",label:"Cancelar",color:"tertiary"},null,512),[[F]]),o(c,{onClick:t[3]||(t[3]=u=>l.enviarMensagemWhatsapp()),label:"Enviar",color:"primary",unelevated:""})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var se=T(Y,[["render",oe],["__scopeId","data-v-31b721ea"]]);export{se as default};
